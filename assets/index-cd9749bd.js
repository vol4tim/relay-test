(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();let ma=class ic extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.code=ic.code,this.type=ic.type}static code="ABORT_ERR";static type="aborted"},I=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}};class Js extends Error{code;constructor(e="Unexpected Peer"){super(e),this.code=Js.code}static code="ERR_UNEXPECTED_PEER"}class jn extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=jn.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}function $m(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var d=0,m=0,y=0,E=f.length;y!==E&&f[y]===0;)y++,d++;for(var b=(E-y)*l+1>>>0,x=new Uint8Array(b);y!==E;){for(var w=f[y],v=0,S=b-1;(w!==0||v<m)&&S!==-1;S--,v++)w+=256*x[S]>>>0,x[S]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");m=v,y++}for(var C=b-m;C!==b&&x[C]===0;)C++;for(var B=c.repeat(d);C<b;++C)B+=r.charAt(x[C]);return B}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var d=0;if(f[d]!==" "){for(var m=0,y=0;f[d]===c;)m++,d++;for(var E=(f.length-d)*u+1>>>0,b=new Uint8Array(E);f[d];){var x=t[f.charCodeAt(d)];if(x===255)return;for(var w=0,v=E-1;(x!==0||w<y)&&v!==-1;v--,w++)x+=a*b[v]>>>0,b[v]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");y=w,d++}if(f[d]!==" "){for(var S=E-y;S!==E&&b[S]===0;)S++;for(var C=new Uint8Array(m+(E-S)),B=m;S!==E;)C[B++]=b[S++];return C}}}function g(f){var d=p(f);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:g}}var Fm=$m,Km=Fm;const Vm=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Lo=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},zm=r=>new TextEncoder().encode(r),qm=r=>new TextDecoder().decode(r);let Hm=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Wm=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Xf(this,e)}},Gm=class{constructor(e){this.decoders=e}or(e){return Xf(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Xf=(r,e)=>new Gm({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Ym=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Hm(e,t,n),this.decoder=new Wm(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const ko=({name:r,prefix:e,encode:t,decode:n})=>new Ym(r,e,t,n),fs=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:i}=Km(t,e);return ko({prefix:r,name:e,encode:n,decode:s=>Lo(i(s))})},Qm=(r,e,t,n)=>{const i={};for(let l=0;l<e.length;++l)i[e[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,u=0;for(let l=0;l<s;++l){const h=i[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Xm=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},ct=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>ko({prefix:e,name:r,encode(i){return Xm(i,n,t)},decode(i){return Qm(i,n,t,r)}}),gt=fs({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Zm=fs({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),jm=Object.freeze(Object.defineProperty({__proto__:null,base58btc:gt,base58flickr:Zm},Symbol.toStringTag,{value:"Module"})),Nr=ct({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Jm=ct({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ey=ct({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ty=ct({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ry=ct({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ny=ct({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),iy=ct({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),sy=ct({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),oy=ct({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),ay=Object.freeze(Object.defineProperty({__proto__:null,base32:Nr,base32hex:ry,base32hexpad:iy,base32hexpadupper:sy,base32hexupper:ny,base32pad:ey,base32padupper:ty,base32upper:Jm,base32z:oy},Symbol.toStringTag,{value:"Module"}));var cy=Zf,nl=128,uy=127,ly=~uy,hy=Math.pow(2,31);function Zf(r,e,t){e=e||[],t=t||0;for(var n=t;r>=hy;)e[t++]=r&255|nl,r/=128;for(;r&ly;)e[t++]=r&255|nl,r>>>=7;return e[t]=r|0,Zf.bytes=t-n+1,e}var fy=sc,dy=128,il=127;function sc(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw sc.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&il)<<i:(o&il)*Math.pow(2,i),i+=7}while(o>=dy);return sc.bytes=s-n,t}var py=Math.pow(2,7),my=Math.pow(2,14),yy=Math.pow(2,21),gy=Math.pow(2,28),by=Math.pow(2,35),Ey=Math.pow(2,42),wy=Math.pow(2,49),xy=Math.pow(2,56),vy=Math.pow(2,63),_y=function(r){return r<py?1:r<my?2:r<yy?3:r<gy?4:r<by?5:r<Ey?6:r<wy?7:r<xy?8:r<vy?9:10},Sy={encode:cy,decode:fy,encodingLength:_y},eo=Sy;const oc=(r,e=0)=>[eo.decode(r,e),eo.decode.bytes],to=(r,e,t=0)=>(eo.encode(r,e,t),e),ro=r=>eo.encodingLength(r),ai=(r,e)=>{const t=e.byteLength,n=ro(r),i=n+ro(t),s=new Uint8Array(i+t);return to(r,s,0),to(t,s,n),s.set(e,i),new Jc(r,t,e,s)},Po=r=>{const e=Lo(r),[t,n]=oc(e),[i,s]=oc(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Jc(t,i,o,e)},Ay=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Vm(r.bytes,t.bytes)}};class Jc{constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}}const sl=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Iy(t,ac(r),e||gt.encoder);default:return Cy(t,ac(r),e||Nr.encoder)}},ol=new WeakMap,ac=r=>{const e=ol.get(r);if(e==null){const t=new Map;return ol.set(r,t),t}return e};class $e{constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Li)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Dy)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return $e.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=ai(e,t);return $e.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return $e.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Ay(e.multihash,n.multihash)}toString(e){return sl(this,e)}toJSON(){return{"/":sl(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof $e)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new $e(n,i,s,o||al(n,i,s.bytes))}else if(t[Ty]===!0){const{version:n,multihash:i,code:s}=t,o=Po(i);return $e.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Li)throw new Error(`Version 0 CID must use dag-pb (code: ${Li}) block encoding`);return new $e(e,t,n,n.bytes)}case 1:{const i=al(e,t,n.bytes);return new $e(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return $e.create(0,Li,e)}static createV1(e,t){return $e.create(1,e,t)}static decode(e){const[t,n]=$e.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=$e.inspectBytes(e),n=t.size-t.multihashSize,i=Lo(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new Jc(t.multihashCode,t.digestSize,s,i);return[t.version===0?$e.createV0(o):$e.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=oc(e.subarray(t));return t+=p,h};let i=n(),s=Li;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,i]=Ry(e,t),s=$e.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return ac(s).set(n,e),s}}const Ry=(r,e)=>{switch(r[0]){case"Q":{const t=e||gt;return[gt.prefix,t.decode(`${gt.prefix}${r}`)]}case gt.prefix:{const t=e||gt;return[gt.prefix,t.decode(r)]}case Nr.prefix:{const t=e||Nr;return[Nr.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Iy=(r,e,t)=>{const{prefix:n}=t;if(n!==gt.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i},Cy=(r,e,t)=>{const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i},Li=112,Dy=18,al=(r,e,t)=>{const n=ro(r),i=n+ro(e),s=new Uint8Array(i+t.byteLength);return to(r,s,0),to(e,s,n),s.set(t,i),s},Ty=Symbol.for("@ipld/js-cid/CID");function St(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}const Ly=fs({prefix:"9",name:"base10",alphabet:"0123456789"}),ky=Object.freeze(Object.defineProperty({__proto__:null,base10:Ly},Symbol.toStringTag,{value:"Module"})),Py=ct({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Ny=ct({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),By=Object.freeze(Object.defineProperty({__proto__:null,base16:Py,base16upper:Ny},Symbol.toStringTag,{value:"Module"})),Oy=ct({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),My=Object.freeze(Object.defineProperty({__proto__:null,base2:Oy},Symbol.toStringTag,{value:"Module"})),jf=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),Uy=jf.reduce((r,e,t)=>(r[t]=e,r),[]),$y=jf.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function Fy(r){return r.reduce((e,t)=>(e+=Uy[t],e),"")}function Ky(r){const e=[];for(const t of r){const n=$y[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const Vy=ko({prefix:"ðŸš€",name:"base256emoji",encode:Fy,decode:Ky}),zy=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:Vy},Symbol.toStringTag,{value:"Module"})),qy=fs({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Hy=fs({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Wy=Object.freeze(Object.defineProperty({__proto__:null,base36:qy,base36upper:Hy},Symbol.toStringTag,{value:"Module"})),No=ct({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Gy=ct({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Jf=ct({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Yy=ct({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Qy=Object.freeze(Object.defineProperty({__proto__:null,base64:No,base64pad:Gy,base64url:Jf,base64urlpad:Yy},Symbol.toStringTag,{value:"Module"})),Xy=ct({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Zy=Object.freeze(Object.defineProperty({__proto__:null,base8:Xy},Symbol.toStringTag,{value:"Module"})),jy=ko({prefix:"\0",name:"identity",encode:r=>qm(r),decode:r=>zm(r)}),Jy=Object.freeze(Object.defineProperty({__proto__:null,identity:jy},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const ed=0,eg="identity",td=Lo,tg=r=>ai(ed,td(r)),rs={code:ed,name:eg,encode:td,digest:tg},rg=({name:r,code:e,encode:t})=>new ng(r,e,t);class ng{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ai(this.code,t):t.then(n=>ai(this.code,n))}else throw Error("Unknown type, must be binary type")}}const ig=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Zt=rg({name:"sha2-256",code:18,encode:ig("SHA-256")}),ci={...Jy,...My,...Zy,...ky,...By,...ay,...Wy,...jm,...Qy,...zy};function Bo(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function Ur(r=0){return globalThis.Buffer?.alloc!=null?Bo(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function Mr(r=0){return globalThis.Buffer?.allocUnsafe!=null?Bo(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function rd(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const cl=rd("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),ya=rd("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=Mr(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),nd={utf8:cl,"utf-8":cl,hex:ci.base16,latin1:ya,ascii:ya,binary:ya,...ci};function ie(r,e="utf8"){const t=nd[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}const sg=Math.pow(2,7),og=Math.pow(2,14),ag=Math.pow(2,21),eu=Math.pow(2,28),tu=Math.pow(2,35),ru=Math.pow(2,42),nu=Math.pow(2,49),be=128,mt=127;function xr(r){if(r<sg)return 1;if(r<og)return 2;if(r<ag)return 3;if(r<eu)return 4;if(r<tu)return 5;if(r<ru)return 6;if(r<nu)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function cg(r,e,t=0){switch(xr(r)){case 8:e[t++]=r&255|be,r/=128;case 7:e[t++]=r&255|be,r/=128;case 6:e[t++]=r&255|be,r/=128;case 5:e[t++]=r&255|be,r/=128;case 4:e[t++]=r&255|be,r>>>=7;case 3:e[t++]=r&255|be,r>>>=7;case 2:e[t++]=r&255|be,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function ug(r,e,t=0){switch(xr(r)){case 8:e.set(t++,r&255|be),r/=128;case 7:e.set(t++,r&255|be),r/=128;case 6:e.set(t++,r&255|be),r/=128;case 5:e.set(t++,r&255|be),r/=128;case 4:e.set(t++,r&255|be),r>>>=7;case 3:e.set(t++,r&255|be),r>>>=7;case 2:e.set(t++,r&255|be),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function lg(r,e){let t=r[e],n=0;if(n+=t&mt,t<be||(t=r[e+1],n+=(t&mt)<<7,t<be)||(t=r[e+2],n+=(t&mt)<<14,t<be)||(t=r[e+3],n+=(t&mt)<<21,t<be)||(t=r[e+4],n+=(t&mt)*eu,t<be)||(t=r[e+5],n+=(t&mt)*tu,t<be)||(t=r[e+6],n+=(t&mt)*ru,t<be)||(t=r[e+7],n+=(t&mt)*nu,t<be))return n;throw new RangeError("Could not decode varint")}function hg(r,e){let t=r.get(e),n=0;if(n+=t&mt,t<be||(t=r.get(e+1),n+=(t&mt)<<7,t<be)||(t=r.get(e+2),n+=(t&mt)<<14,t<be)||(t=r.get(e+3),n+=(t&mt)<<21,t<be)||(t=r.get(e+4),n+=(t&mt)*eu,t<be)||(t=r.get(e+5),n+=(t&mt)*tu,t<be)||(t=r.get(e+6),n+=(t&mt)*ru,t<be)||(t=r.get(e+7),n+=(t&mt)*nu,t<be))return n;throw new RangeError("Could not decode varint")}function sn(r,e,t=0){return e==null&&(e=Mr(xr(r))),e instanceof Uint8Array?cg(r,e,t):ug(r,e,t)}function $n(r,e=0){return r instanceof Uint8Array?lg(r,e):hg(r,e)}function et(r,e){e==null&&(e=r.reduce((i,s)=>i+s.length,0));const t=Mr(e);let n=0;for(const i of r)t.set(i,n),n+=i.length;return Bo(t)}class fg{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,i){return this.readAtomically(()=>{let s=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",u=2**(8*i)-1;for(;;){const l=this.readAtomically(()=>{const h=this.readChar();if(h===void 0)return;const p=Number.parseInt(h,e);if(!Number.isNaN(p))return p});if(l===void 0)break;if(s*=e,s+=l,s>u||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const i=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[i]=o[0],t[i+1]=o[1],t[i+2]=o[2],t[i+3]=o[3],[i+4,!0]}const s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[i,!1];t[i]=s>>8,t[i+1]=s&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,i]=e(t);if(n===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const s=new Uint8Array(14),o=16-(n+2),[a]=e(s.subarray(0,o));return t.set(s.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const id=45,dg=15,ui=new fg;function pg(r){if(!(r.length>dg))return ui.new(r).parseWith(()=>ui.readIPv4Addr())}function mg(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>id))return ui.new(r).parseWith(()=>ui.readIPv6Addr())}function yg(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>id))return ui.new(r).parseWith(()=>ui.readIPAddr())}function re(r,e="utf8"){const t=nd[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Bo(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}function sd(r){return!!pg(r)}function od(r){return!!mg(r)}function iu(r){return!!yg(r)}const ul=sd,gg=od,ad=function(r){let e=0;if(r=r.toString().trim(),ul(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(gg(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const s=ul(t[n]);let o;s&&(o=ad(t[n]),t[n]=ie(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,ie(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const s=[n,1];for(n=9-t.length;n>0;n--)s.push("0");t.splice.apply(t,s)}const i=new Uint8Array(e+16);for(n=0;n<t.length;n++){const s=parseInt(t[n],16);i[e++]=s>>8&255,i[e++]=s&255}return i}throw new Error("invalid ip address")},bg=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const i=[];for(let s=0;s<t;s++)i.push(r[e+s]);return i.join(".")}if(t===16){const i=[];for(let s=0;s<t;s+=2)i.push(n.getUint16(e+s).toString(16));return i.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Ft=-1,ns={},cc={},Eg=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Ft,"ip6zone"],[43,8,"ipcidr"],[53,Ft,"dns",!0],[54,Ft,"dns4",!0],[55,Ft,"dns6",!0],[56,Ft,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Ft,"unix",!1,!0],[421,Ft,"ipfs"],[421,Ft,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Ft,"garlic64"],[448,0,"tls"],[449,Ft,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Ft,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Ft,"memory"]];Eg.forEach(r=>{const e=wg(...r);cc[e.code]=e,ns[e.name]=e});function wg(r,e,t,n,i){return{code:r,size:e,name:t,resolvable:!!n,path:!!i}}function he(r){if(typeof r=="number"){if(cc[r]!=null)return cc[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(ns[r]!=null)return ns[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}he("ip4");he("ip6");he("ipcidr");function cd(r,e){switch(he(r).code){case 4:case 41:return vg(e);case 42:return dl(e);case 6:case 273:case 33:case 132:return ud(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return dl(e);case 421:return Rg(e);case 444:return pl(e);case 445:return pl(e);case 466:return Ag(e);default:return ie(e,"base16")}}function ll(r,e){switch(he(r).code){case 4:return hl(e);case 41:return hl(e);case 42:return fl(e);case 6:case 273:case 33:case 132:return su(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return fl(e);case 421:return _g(e);case 444:return Ig(e);case 445:return Cg(e);case 466:return Sg(e);default:return re(e,"base16")}}const ga=Object.values(ci).map(r=>r.decoder),xg=function(){let r=ga[0].or(ga[1]);return ga.slice(2).forEach(e=>r=r.or(e)),r}();function hl(r){if(!iu(r))throw new Error("invalid ip address");return ad(r)}function vg(r){const e=bg(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!iu(e))throw new Error("invalid ip address");return e}function su(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function ud(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function fl(r){const e=re(r),t=Uint8Array.from(sn(e.length));return et([t,e],t.length+e.length)}function dl(r){const e=$n(r);if(r=r.slice(xr(e)),r.length!==e)throw new Error("inconsistent lengths");return ie(r)}function _g(r){let e;r[0]==="Q"||r[0]==="1"?e=Po(gt.decode(`z${r}`)).bytes:e=$e.parse(r).multihash.bytes;const t=Uint8Array.from(sn(e.length));return et([t,e],t.length+e.length)}function Sg(r){const e=xg.decode(r),t=Uint8Array.from(sn(e.length));return et([t,e],t.length+e.length)}function Ag(r){const e=$n(r),t=r.slice(xr(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+ie(t,"base64url")}function Rg(r){const e=$n(r),t=r.slice(xr(e));if(t.length!==e)throw new Error("inconsistent lengths");return ie(t,"base58btc")}function Ig(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Nr.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=su(n);return et([t,i],t.length+i.length)}function Cg(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Nr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=su(n);return et([t,i],t.length+i.length)}function pl(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=ie(e,"base32"),i=ud(t);return`${n}:${i}`}function Dg(r){r=uc(r);const e=[],t=[];let n=null;const i=r.split("/").slice(1);if(i.length===1&&i[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let s=0;s<i.length;s++){const o=i[s],a=he(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(s++,s>=i.length)throw fd("invalid address: "+r);if(a.path===!0){n=uc(i.slice(s).join("/")),e.push([a.code,ll(a.code,n)]),t.push([a.code,n]);break}const c=ll(a.code,i[s]);e.push([a.code,c]),t.push([a.code,cd(a.code,c)])}return{string:ld(t),bytes:hd(e),tuples:e,stringTuples:t,path:n}}function ml(r){const e=[],t=[];let n=null,i=0;for(;i<r.length;){const s=$n(r,i),o=xr(s),a=he(s),c=Tg(a,r.slice(i+o));if(c===0){e.push([s]),t.push([s]),i+=o;continue}const u=r.slice(i+o,i+o+c);if(i+=c+o,i>r.length)throw fd("Invalid address Uint8Array: "+ie(r,"base16"));e.push([s,u]);const l=cd(s,u);if(t.push([s,l]),a.path===!0){n=l;break}}return{bytes:Uint8Array.from(r),string:ld(t),tuples:e,stringTuples:t,path:n}}function ld(r){const e=[];return r.map(t=>{const n=he(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),uc(e.join("/"))}function hd(r){return et(r.map(e=>{const t=he(e[0]);let n=Uint8Array.from(sn(t.code));return e.length>1&&e[1]!=null&&(n=et([n,e[1]])),n}))}function Tg(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{const t=$n(e instanceof Uint8Array?e:Uint8Array.from(e));return t+xr(t)}}function uc(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function fd(r){return new Error("Error parsing address: "+r)}const Lg=Symbol.for("nodejs.util.inspect.custom"),kg=[he("dns").code,he("dns4").code,he("dns6").code,he("dnsaddr").code],dd=new Map,pd=Symbol.for("@multiformats/js-multiaddr/multiaddr");function Oo(r){return!!r?.[pd]}class _n{bytes;#e;#t;#r;#n;[pd]=!0;constructor(e){e==null&&(e="");let t;if(e instanceof Uint8Array)t=ml(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=Dg(e)}else if(Oo(e))t=ml(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,this.#e=t.string,this.#t=t.tuples,this.#r=t.stringTuples,this.#n=t.path}toString(){return this.#e}toJSON(){return this.toString()}toOptions(){let e,t,n,i,s="";const o=he("tcp"),a=he("udp"),c=he("ip4"),u=he("ip6"),l=he("dns6"),h=he("ip6zone");for(const[g,f]of this.stringTuples())g===h.code&&(s=`%${f??""}`),kg.includes(g)&&(t=o.name,i=443,n=`${f??""}${s}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=he(g).name,i=parseInt(f??"")),(g===c.code||g===u.code)&&(t=he(g).name,n=`${f??""}${s}`,e=g===u.code?6:4);if(e==null||t==null||n==null||i==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:i}}protos(){return this.#t.map(([e])=>Object.assign({},he(e)))}protoCodes(){return this.#t.map(([e])=>e)}protoNames(){return this.#t.map(([e])=>he(e).name)}tuples(){return this.#t}stringTuples(){return this.#r}encapsulate(e){return e=new _n(e),new _n(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),i=n.lastIndexOf(t);if(i<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new _n(n.slice(0,i))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new _n(hd(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,i])=>{n===ns.p2p.code&&e.push([n,i]),n===ns["p2p-circuit"].code&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?ie(gt.decode(`z${n}`),"base58btc"):ie($e.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#n}equals(e){return St(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(s=>s.resolvable);if(t==null)return[this];const n=dd.get(t.name);if(n==null)throw new I(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(s=>new _n(s))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[Lg](){return`Multiaddr(${this.#e})`}}function ge(r){return new _n(r)}function At(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class yl{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class ba{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new yl(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new yl(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let Pg=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ln(r={}){return md(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Ng(r={}){return md(t=>{let n;const i=[];for(;!t.isEmpty()&&(n=t.shift(),n!=null);){if(n.error!=null)throw n.error;n.done===!1&&i.push(n.value)}return n==null?{done:!0}:{done:n.done===!0,value:i}},r)}function md(r,e){e=e??{};let t=e.onEnd,n=new ba,i,s,o,a=At();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((m,y)=>{s=E=>{s=null,n.push(E);try{m(r(n))}catch(b){y(b)}return i}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=At()})}},u=m=>s!=null?s(m):(n.push(m),i),l=m=>(n=new ba,s!=null?s({error:m}):(n.push({error:m}),i)),h=m=>{if(o)return i;if(e?.objectMode!==!0&&m?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:m})},p=m=>o?i:(o=!0,m!=null?l(m):u({done:!0})),g=()=>(n=new ba,p(),{done:!0}),f=m=>(p(m),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:g,throw:f,push:h,end:p,get readableLength(){return n.size},onEmpty:async m=>{const y=m?.signal;if(y?.throwIfAborted(),n.isEmpty())return;let E,b;y!=null&&(E=new Promise((x,w)=>{b=()=>{w(new Pg)},y.addEventListener("abort",b)}));try{await Promise.race([a.promise,E])}finally{b!=null&&y!=null&&y?.removeEventListener("abort",b)}}},t==null)return i;const d=i;return i={[Symbol.asyncIterator](){return this},next(){return d.next()},throw(m){return d.throw(m),t!=null&&(t(m),t=void 0),{done:!0}},return(){return d.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(m){return d.end(m),t!=null&&(t(m),t=void 0),i},get readableLength(){return d.readableLength}},i}function Bg(r){return r[Symbol.asyncIterator]!=null}function no(...r){const e=[];for(const t of r)Bg(t)||e.push(t);return e.length===r.length?function*(){for(const t of e)yield*t}():async function*(){const t=ln({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(const i of n)t.push(i)})),t.end()}catch(n){t.end(n)}}),yield*t}()}function kn(r,...e){if(r==null)throw new Error("Empty pipeline");if(Ea(r)){const n=r;r=()=>n.source}else if(gd(r)||yd(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&Ea(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)Ea(t[n])&&(t[n]=Mg(t[n]));return Og(...t)}const Og=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},yd=r=>r?.[Symbol.asyncIterator]!=null,gd=r=>r?.[Symbol.iterator]!=null,Ea=r=>r==null?!1:r.sink!=null&&r.source!=null,Mg=r=>e=>{const t=r.sink(e);if(t?.then!=null){const n=ln({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let i;const s=r.source;if(yd(s))i=async function*(){yield*s,n.end()};else if(gd(s))i=function*(){yield*s,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return no(n,i())}return r.source},bd=Symbol.for("@libp2p/transport");var ti;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(ti||(ti={}));var Mo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function jt(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Ug(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var i=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return r[n]}})}),t}var lc={exports:{}},wa,gl;function Ed(){if(gl)return wa;gl=1;var r=1e3,e=r*60,t=e*60,n=t*24,i=n*7,s=n*365.25;wa=function(l,h){h=h||{};var p=typeof l;if(p==="string"&&l.length>0)return o(l);if(p==="number"&&isFinite(l))return h.long?c(l):a(l);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(l))};function o(l){if(l=String(l),!(l.length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(l);if(h){var p=parseFloat(h[1]),g=(h[2]||"ms").toLowerCase();switch(g){case"years":case"year":case"yrs":case"yr":case"y":return p*s;case"weeks":case"week":case"w":return p*i;case"days":case"day":case"d":return p*n;case"hours":case"hour":case"hrs":case"hr":case"h":return p*t;case"minutes":case"minute":case"mins":case"min":case"m":return p*e;case"seconds":case"second":case"secs":case"sec":case"s":return p*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function a(l){var h=Math.abs(l);return h>=n?Math.round(l/n)+"d":h>=t?Math.round(l/t)+"h":h>=e?Math.round(l/e)+"m":h>=r?Math.round(l/r)+"s":l+"ms"}function c(l){var h=Math.abs(l);return h>=n?u(l,h,n,"day"):h>=t?u(l,h,t,"hour"):h>=e?u(l,h,e,"minute"):h>=r?u(l,h,r,"second"):l+" ms"}function u(l,h,p,g){var f=h>=p*1.5;return Math.round(l/p)+" "+g+(f?"s":"")}return wa}function $g(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=i,t.enabled=o,t.humanize=Ed(),t.destroy=u,Object.keys(r).forEach(l=>{t[l]=r[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let h=0;for(let p=0;p<l.length;p++)h=(h<<5)-h+l.charCodeAt(p),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(l){let h,p=null,g,f;function d(...m){if(!d.enabled)return;const y=d,E=Number(new Date),b=E-(h||E);y.diff=b,y.prev=h,y.curr=E,h=E,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let x=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(v,S)=>{if(v==="%%")return"%";x++;const C=t.formatters[S];if(typeof C=="function"){const B=m[x];v=C.call(y,B),m.splice(x,1),x--}return v}),t.formatArgs.call(y,m),(y.log||t.log).apply(y,m)}return d.namespace=l,d.useColors=t.useColors(),d.color=t.selectColor(l),d.extend=n,d.destroy=t.destroy,Object.defineProperty(d,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(g!==t.namespaces&&(g=t.namespaces,f=t.enabled(l)),f),set:m=>{p=m}}),typeof t.init=="function"&&t.init(d),d}function n(l,h){const p=t(this.namespace+(typeof h>"u"?":":h)+l);return p.log=this.log,p}function i(l){t.save(l),t.namespaces=l,t.names=[],t.skips=[];let h;const p=(typeof l=="string"?l:"").split(/[\s,]+/),g=p.length;for(h=0;h<g;h++)p[h]&&(l=p[h].replace(/\*/g,".*?"),l[0]==="-"?t.skips.push(new RegExp("^"+l.slice(1)+"$")):t.names.push(new RegExp("^"+l+"$")))}function s(){const l=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),l}function o(l){if(l[l.length-1]==="*")return!0;let h,p;for(h=0,p=t.skips.length;h<p;h++)if(t.skips[h].test(l))return!1;for(h=0,p=t.names.length;h<p;h++)if(t.names[h].test(l))return!0;return!1}function a(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var Fg=$g;(function(r,e){e.formatArgs=n,e.save=i,e.load=s,e.useColors=t,e.storage=o(),e.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function t(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function n(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+r.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;c.splice(1,0,u,"color: inherit");let l=0,h=0;c[0].replace(/%[a-zA-Z%]/g,p=>{p!=="%%"&&(l++,p==="%c"&&(h=l))}),c.splice(h,0,u)}e.log=console.debug||console.log||(()=>{});function i(c){try{c?e.storage.setItem("debug",c):e.storage.removeItem("debug")}catch{}}function s(){let c;try{c=e.storage.getItem("debug")}catch{}return!c&&typeof process<"u"&&"env"in process&&(c={}.DEBUG),c}function o(){try{return localStorage}catch{}}r.exports=Fg(e);const{formatters:a}=r.exports;a.j=function(c){try{return JSON.stringify(c)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(lc,lc.exports);var Kg=lc.exports;const Z=jt(Kg);Z.formatters.b=r=>r==null?"undefined":gt.baseEncode(r);Z.formatters.t=r=>r==null?"undefined":Nr.baseEncode(r);Z.formatters.m=r=>r==null?"undefined":No.baseEncode(r);Z.formatters.p=r=>r==null?"undefined":r.toString();Z.formatters.c=r=>r==null?"undefined":r.toString();Z.formatters.k=r=>r==null?"undefined":r.toString();Z.formatters.a=r=>r==null?"undefined":r.toString();function Vg(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function ue(r){let e=Vg(`${r}:trace`);return Z.enabled(`${r}:trace`)&&Z.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Z(`${r}:trace`)),Object.assign(Z(r),{error:Z(`${r}:error`),trace:e})}const wd=Symbol.for("@libp2p/peer-id");function xd(r){return r!=null&&!!r[wd]}const zg=Symbol.for("nodejs.util.inspect.custom"),qg=Object.values(ci).map(r=>r.decoder).reduce((r,e)=>r.or(e),ci.identity.decoder),vd=114,ou=36,au=37;class cu{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[wd]=!0;toString(){return this.string==null&&(this.string=gt.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return $e.createV1(vd,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e instanceof Uint8Array)return St(this.multihash.bytes,e);if(typeof e=="string")return je(e).equals(this);if(e?.multihash?.bytes!=null)return St(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[zg](){return`PeerId(${this.toString()})`}}class ds extends cu{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class ps extends cu{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}}class ms extends cu{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}}function Hg(r){if(r.type==="RSA")return new ds(r);if(r.type==="Ed25519")return new ps(r);if(r.type==="secp256k1")return new ms(r);throw new I("Not a PeerId","ERR_INVALID_PARAMETERS")}function je(r,e){if(r.charAt(0)==="1"||r.charAt(0)==="Q"){const t=Po(gt.decode(`z${r}`));return r.startsWith("12D")?new ps({multihash:t}):r.startsWith("16U")?new ms({multihash:t}):new ds({multihash:t})}return Uo(qg.decode(r))}function Uo(r){try{const e=Po(r);if(e.code===rs.code){if(e.digest.length===ou)return new ps({multihash:e});if(e.digest.length===au)return new ms({multihash:e})}if(e.code===Zt.code)return new ds({multihash:e})}catch{return Wg($e.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function Wg(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==vd)throw new Error("Supplied PeerID CID is invalid");const e=r.multihash;if(e.code===Zt.code)return new ds({multihash:r.multihash});if(e.code===rs.code){if(e.digest.length===ou)return new ps({multihash:r.multihash});if(e.digest.length===au)return new ms({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function _i(r,e){return r.length===ou?new ps({multihash:ai(rs.code,r),privateKey:e}):r.length===au?new ms({multihash:ai(rs.code,r),privateKey:e}):new ds({multihash:await Zt.digest(r),publicKey:r,privateKey:e})}const Gg=r=>r.toString().split("/").slice(1),ys=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Ve=r=>({match:e=>ys(t=>t===r).match(e),pattern:r}),$o=()=>({match:r=>ys(e=>typeof e=="string").match(r),pattern:"{string}"}),_d=()=>({match:r=>ys(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),zt=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{gt.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),io=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{Jf.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),br=r=>({match:e=>{const t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),vr=(...r)=>({match:e=>{let t;for(const n of r){const i=n.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),ze=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function uu(...r){function e(i){let s=Gg(i);for(const o of r){const a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function n(i){const s=e(i);return s===!1?!1:s.length===0}return{matches:t,exactMatch:n}}const Sd=ze(Ve("dns4"),$o()),Ad=ze(Ve("dns6"),$o()),Rd=ze(Ve("dnsaddr"),$o()),Id=ze(Ve("dns"),$o());uu(vr(Id,Rd,Sd,Ad));const Yg=ze(Ve("ip4"),ys(sd)),Qg=ze(Ve("ip6"),ys(od)),Xg=vr(Yg,Qg),Fo=vr(Xg,Id,Sd,Ad,Rd),lu=ze(Fo,Ve("tcp"),_d()),Ko=ze(Fo,Ve("udp"),_d()),Zg=vr(lu,Ko),Cd=ze(Ko,Ve("quic")),hu=ze(Ko,Ve("quic-v1")),jg=vr(Cd,hu),hc=vr(Fo,lu,Ko,Cd,hu),Jg=vr(ze(hc,Ve("ws"),br(zt()))),eb=vr(ze(hc,Ve("wss"),br(zt())),ze(hc,Ve("tls"),Ve("ws"),br(zt()))),tb=ze(Zg,Ve("webrtc-direct"),io(),br(io()),br(zt())),rb=ze(hu,Ve("webtransport"),io(),io(),br(zt())),fc=vr(Jg,eb,ze(lu,br(zt())),ze(jg,br(zt())),ze(Fo,br(zt())),tb,rb,zt()),nb=ze(fc,Ve("p2p-circuit"),zt()),bl=uu(nb),ib=vr(ze(fc,Ve("p2p-circuit"),Ve("webrtc"),zt()),ze(fc,Ve("webrtc"),br(zt())),Ve("webrtc")),sb=uu(ib);var Jn;(function(r){r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",r.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",r.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(Jn||(Jn={}));var El=globalThis&&globalThis.__spreadArray||function(r,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return r.concat(s||Array.prototype.slice.call(e))},ob=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}(),ab=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}(),cb=function(){function r(e,t,n,i){this.name=e,this.version=t,this.os=n,this.bot=i,this.type="bot-device"}return r}(),ub=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}(),lb=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}(),hb=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,fb=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,wl=3,db=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",hb]],xl=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function pb(r){return r?vl(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new lb:typeof navigator<"u"?vl(navigator.userAgent):gb()}function mb(r){return r!==""&&db.reduce(function(e,t){var n=t[0],i=t[1];if(e)return e;var s=i.exec(r);return!!s&&[n,s]},!1)}function vl(r){var e=mb(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new ub;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<wl&&(i=El(El([],i,!0),bb(wl-i.length),!0)):i=[];var s=i.join("."),o=yb(r),a=fb.exec(r);return a&&a[1]?new cb(t,s,o,a[1]):new ob(t,s,o)}function yb(r){for(var e=0,t=xl.length;e<t;e++){var n=xl[e],i=n[0],s=n[1],o=s.exec(r);if(o)return i}return null}function gb(){var r=typeof process<"u"&&process.version;return r?new ab(process.version.slice(1)):null}function bb(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}let Dd=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Eb=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const _l=r=>globalThis.DOMException===void 0?new Eb(r):new DOMException(r),Sl=r=>{const e=r.reason===void 0?_l("This operation was aborted."):r.reason;return e instanceof Error?e:_l(e)};function gs(r,e){const{milliseconds:t,fallback:n,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o;const c=new Promise((u,l)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:p}=e;p.aborted&&l(Sl(p)),p.addEventListener("abort",()=>{l(Sl(p))})}if(t===Number.POSITIVE_INFINITY){r.then(u,l);return}const h=new Dd;o=s.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(p){l(p)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?u():i instanceof Error?l(i):(h.message=i??`Promise timed out after ${t} milliseconds`,l(h))},t),(async()=>{try{u(await r)}catch(p){l(p)}})()}).finally(()=>{c.clear()});return c.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},c}const xa=ue("libp2p:webrtc:utils"),Al=pb(),Rl=Al!=null&&Al.name==="firefox",Td=async function*(){},Ld=async r=>{},wb=30*1e3;function Il(r,e,t=wb){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){xa("%s drain channel with %d buffered bytes",e,r.bufferedAmount);const n=At();let i=!1;r.bufferedAmountLowThreshold=0;const s=()=>{i||(xa("%s drain channel closed before drain",e),n.resolve())};r.addEventListener("close",s,{once:!0}),r.addEventListener("bufferedamountlow",()=>{i=!0,r.removeEventListener("close",s),n.resolve()}),await gs(n.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(n=>{xa.error("error closing outbound stream",n)})}const va=ue("libp2p:webrtc:maconn");class Cl{peerConnection;remoteAddr;timeline;metrics;source=Td();sink=Ld;constructor(e){this.remoteAddr=e.remoteAddr,this.timeline=e.timeline,this.peerConnection=e.peerConnection;const t=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{va.trace("peer connection state change",this.peerConnection.connectionState,"initial state",t),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){va.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){va.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}let Dl=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function xb(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function Pn(r,e,t){const n=t??{},i=xb(r);async function*s(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:h}=n;throw new Dl(l,h)}const u=new Promise((l,h)=>{o=()=>{const{abortMessage:p,abortCode:g}=n;h(new Dl(p,g))}});c=await Promise.race([u,i.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&n.onAbort(r),typeof i.return=="function")try{const h=i.return();h instanceof Promise&&h.catch(p=>{n.onReturnError!=null&&n.onReturnError(p)})}catch(h){n.onReturnError!=null&&n.onReturnError(h)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return s()}let dc=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};async function so(r,e,t){if(e==null)return r;if(e.aborted)return Promise.reject(new dc(t?.errorMessage,t?.errorCode));let n;const i=new dc(t?.errorMessage,t?.errorCode);try{return await Promise.race([r,new Promise((s,o)=>{n=()=>{o(i)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}const kd=Symbol.for("@achingbrain/uint8arraylist");function Tl(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const i=t+n.byteLength;if(e<i)return{buf:n,index:e-t};t=i}throw new RangeError("index is out of bounds")}function Rs(r){return!!r?.[kd]}class ve{constructor(...e){Object.defineProperty(this,kd,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Rs(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Rs(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=Tl(this.bufs,e);return t.buf[t.index]}set(e,t){const n=Tl(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Rs(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:i}=this._subList(e,t);return et(n,i)}subarray(e,t){const{bufs:n,length:i}=this._subList(e,t);return n.length===1?n[0]:et(n,i)}sublist(e,t){const{bufs:n,length:i}=this._subList(e,t),s=new ve;return s.length=i,s.bufs=n,s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};const n=[];let i=0;for(let s=0;s<this.bufs.length;s++){const o=this.bufs[s],a=i,c=a+o.byteLength;if(i=c,e>=c)continue;const u=e>=a&&e<c,l=t>a&&t<=c;if(u&&l){if(e===a&&t===c){n.push(o);break}const h=e-a;n.push(o.subarray(h,h+(t-e)));break}if(u){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(l){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Rs(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");const s=256,o=new Int32Array(s);for(let h=0;h<s;h++)o[h]=-1;for(let h=0;h<i;h++)o[n[h]]=h;const a=o,c=this.byteLength-n.byteLength,u=n.byteLength-1;let l;for(let h=t;h<=c;h+=l){l=0;for(let p=u;p>=0;p--){const g=this.get(h+p);if(n[p]!==g){l=Math.max(1,p-a[g]);break}}if(l===0)return h}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=Mr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const i=Ur(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,n),this.write(i,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const i=Ur(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,n),this.write(i,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const i=Ur(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,n),this.write(i,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=Mr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const i=Ur(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,n),this.write(i,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const i=Ur(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,n),this.write(i,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const i=Ur(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,n),this.write(i,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const i=Ur(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,n),this.write(i,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const i=Ur(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,n),this.write(i,e)}equals(e){if(e==null||!(e instanceof ve)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!St(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new ve;return n.bufs=e,t==null&&(t=e.reduce((i,s)=>i+s.byteLength,0)),n.length=t,n}}const vb="ERR_STREAM_RESET",_b="ERR_SINK_INVALID_STATE",Sb=5e3;function _a(r){return r!=null&&typeof r.then=="function"}let Ab=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;sinkController;sinkEnd;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;log;constructor(e){this.sinkController=new AbortController,this.sinkEnd=At(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??Sb,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=ln({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new I(`writable end state is "${this.writeStatus}" not "ready"`,_b);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const n=this.sendNewStream(t);_a(n)&&await n}e=Pn(e,this.sinkController.signal,{returnOnAbort:!0}),this.log.trace("sink reading from source");for await(let n of e){n=n instanceof Uint8Array?new ve(n):n;const i=this.sendData(n,t);_a(i)&&await i}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await Promise.all([this.closeRead(e),this.closeWrite(e)]),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue"),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await so(this.sink([]),e.signal)),this.writeStatus==="writing"&&await new Promise((t,n)=>{queueMicrotask(()=>{this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),so(this.sinkEnd.promise,e.signal).then(t,n)})}),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();_a(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new I("stream reset",vb);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};function Pd(r){return r[Symbol.asyncIterator]!=null}const Vo=r=>{const e=xr(r),t=Mr(e);return sn(r,t),Vo.bytes=e,t};Vo.bytes=0;function is(r,e){e=e??{};const t=e.lengthEncoder??Vo;function*n(i){const s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return Pd(r)?async function*(){for await(const i of r)yield*n(i)}():function*(){for(const i of r)yield*n(i)}()}is.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Vo;return new ve(t(r.byteLength),r)};function Ll(r,e){for(const t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function Rb(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return Ll(r,t)}catch{t.message=r.message,t.stack=r.stack;const i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(r)),Ll(new i,t)}}var Ib=Rb;const Zn=jt(Ib),Cb=8,Db=1024*1024*4;var Sn;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Sn||(Sn={}));const fu=r=>{const e=$n(r);return fu.bytes=xr(e),e};fu.bytes=0;function li(r,e){const t=new ve;let n=Sn.LENGTH,i=-1;const s=e?.lengthDecoder??fu,o=e?.maxLengthLength??Cb,a=e?.maxDataLength??Db;function*c(){for(;t.byteLength>0;){if(n===Sn.LENGTH)try{if(i=s(t),i<0)throw Zn(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>a)throw Zn(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const u=s.bytes;t.consume(u),e?.onLength!=null&&e.onLength(i),n=Sn.DATA}catch(u){if(u instanceof RangeError){if(t.byteLength>o)throw Zn(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw u}if(n===Sn.DATA){if(t.byteLength<i)break;const u=t.sublist(0,i);t.consume(i),e?.onData!=null&&e.onData(u),yield u,n=Sn.LENGTH}}}return Pd(r)?async function*(){for await(const u of r)t.append(u),yield*c();if(t.byteLength>0)throw Zn(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const u of r)t.append(u),yield*c();if(t.byteLength>0)throw Zn(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}li.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:s,value:o}=await r.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return li(n,{...e??{},onLength:s=>{t=s}})};const Tb=r=>{const e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Lb(r,e,t){let n;const i=new Promise((s,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const a=[e].flat(),c=[],{addListener:u,removeListener:l}=Tb(r),h=(...g)=>{const f=t.multiArgs?g:g[0];t.filter&&!t.filter(f)||(c.push(f),t.count===c.length&&(n(),s(c)))},p=g=>{n(),o(g)};n=()=>{for(const g of a)l(g,h);for(const g of t.rejectionEvents)l(g,p)};for(const g of a)u(g,h);for(const g of t.rejectionEvents)u(g,p);t.signal&&t.signal.addEventListener("abort",()=>{p(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=n,typeof t.timeout=="number"){const s=gs(i,{milliseconds:t.timeout});return s.cancel=n,s}return i}function kb(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=Lb(r,e,t),i=n.then(s=>s[0]);return i.cancel=n.cancel,i}const du=new Float32Array([-0]),Jr=new Uint8Array(du.buffer);function Pb(r,e,t){du[0]=r,e[t]=Jr[0],e[t+1]=Jr[1],e[t+2]=Jr[2],e[t+3]=Jr[3]}function Nb(r,e){return Jr[0]=r[e],Jr[1]=r[e+1],Jr[2]=r[e+2],Jr[3]=r[e+3],du[0]}const pu=new Float64Array([-0]),yt=new Uint8Array(pu.buffer);function Bb(r,e,t){pu[0]=r,e[t]=yt[0],e[t+1]=yt[1],e[t+2]=yt[2],e[t+3]=yt[3],e[t+4]=yt[4],e[t+5]=yt[5],e[t+6]=yt[6],e[t+7]=yt[7]}function Ob(r,e){return yt[0]=r[e],yt[1]=r[e+1],yt[2]=r[e+2],yt[3]=r[e+3],yt[4]=r[e+4],yt[5]=r[e+5],yt[6]=r[e+6],yt[7]=r[e+7],pu[0]}const Mb=BigInt(Number.MAX_SAFE_INTEGER),Ub=BigInt(Number.MIN_SAFE_INTEGER);class at{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Tn;if(e<Mb&&e>Ub)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,i=e-(n<<32n);return t&&(n=~n|0n,i=~i|0n,++i>kl&&(i=0n,++n>kl&&(n=0n))),new at(Number(i),Number(n))}static fromNumber(e){if(e===0)return Tn;const t=e<0;t&&(e=-e);let n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new at(n,i)}static from(e){return typeof e=="number"?at.fromNumber(e):typeof e=="bigint"?at.fromBigInt(e):typeof e=="string"?at.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new at(e.low>>>0,e.high>>>0):Tn}}const Tn=new at(0,0);Tn.toBigInt=function(){return 0n};Tn.zzEncode=Tn.zzDecode=function(){return this};Tn.length=function(){return 1};const kl=4294967296n;function $b(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function Fb(r,e,t){if(t-e<1)return"";let i;const s=[];let o=0,a;for(;e<t;)a=r[e++],a<128?s[o++]=a:a>191&&a<224?s[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,s[o++]=55296+(a>>10),s[o++]=56320+(a&1023)):s[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,s)),o=0);return i!=null?(o>0&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))}function Nd(r,e,t){const n=t;let i,s;for(let o=0;o<r.length;++o)i=r.charCodeAt(o),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((s=r.charCodeAt(o+1))&64512)===56320?(i=65536+((i&1023)<<10)+(s&1023),++o,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-n}function tr(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function Is(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class Kb{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,tr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw tr(this,4);return Is(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw tr(this,4);return Is(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw tr(this,4);const e=Nb(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw tr(this,4);const e=Ob(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw tr(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return Fb(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw tr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw tr(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new at(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw tr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw tr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw tr(this,8);const e=Is(this.buf,this.pos+=4),t=Is(this.buf,this.pos+=4);return new at(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){return this.readLongVarint().toNumber(!0)}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function Vb(r){return new Kb(r instanceof Uint8Array?r:r.subarray())}function Oe(r,e){const t=Vb(r);return e.decode(t)}function zb(r){const e=r??8192,t=e>>>1;let n,i=e;return function(o){if(o<1||o>t)return Mr(o);i+o>e&&(n=Mr(e),i=0);const a=n.subarray(i,i+=o);return i&7&&(i=(i|7)+1),a}}class Ki{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function Sa(){}class qb{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const Hb=zb();function Wb(r){return globalThis.Buffer!=null?Mr(r):Hb(r)}class pc{len;head;tail;states;constructor(){this.len=0,this.head=new Ki(Sa,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Ki(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Yb((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(ki,10,at.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=at.fromBigInt(e);return this._push(ki,t.length(),t)}uint64Number(e){const t=at.fromNumber(e);return this._push(ki,t.length(),t)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=at.fromBigInt(e).zzEncode();return this._push(ki,t.length(),t)}sint64Number(e){const t=at.fromNumber(e).zzEncode();return this._push(ki,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Aa,1,e?1:0)}fixed32(e){return this._push(Pi,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=at.fromBigInt(e);return this._push(Pi,4,t.lo)._push(Pi,4,t.hi)}fixed64Number(e){const t=at.fromNumber(e);return this._push(Pi,4,t.lo)._push(Pi,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(Pb,4,e)}double(e){return this._push(Bb,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(Aa,1,0):this.uint32(t)._push(Qb,t,e)}string(e){const t=$b(e);return t!==0?this.uint32(t)._push(Nd,t,e):this._push(Aa,1,0)}fork(){return this.states=new qb(this),this.head=this.tail=new Ki(Sa,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Ki(Sa,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=Wb(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function Aa(r,e,t){e[t]=r&255}function Gb(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class Yb extends Ki{next;constructor(e,t){super(Gb,e,t),this.next=void 0}}function ki(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Pi(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Qb(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(pc.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(Xb,e,r),this},pc.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(Zb,e,r),this});function Xb(r,e,t){e.set(r,t)}function Zb(r,e,t){r.length<40?Nd(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(re(r),t)}function jb(){return new pc}function Me(r,e){const t=jb();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var oo;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(oo||(oo={}));function Bd(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Si(r){function e(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}const t=function(s,o){const a=e(s);o.int32(a)},n=function(s){const o=s.int32();return e(o)};return Bd("enum",oo.VARINT,t,n)}function Ue(r,e){return Bd("message",oo.LENGTH_DELIMITED,r,e)}var kt;(function(r){(function(n){n.FIN="FIN",n.STOP_SENDING="STOP_SENDING",n.RESET="RESET",n.FIN_ACK="FIN_ACK"})(r.Flag||(r.Flag={}));let e;(function(n){n[n.FIN=0]="FIN",n[n.STOP_SENDING=1]="STOP_SENDING",n[n.RESET=2]="RESET",n[n.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(n){n.codec=()=>Si(e)}(r.Flag||(r.Flag={}));let t;r.codec=()=>(t==null&&(t=Ue((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.flag!=null&&(i.uint32(8),r.Flag.codec().encode(n.flag,i)),n.message!=null&&(i.uint32(18),i.bytes(n.message)),s.lengthDelimited!==!1&&i.ldelim()},(n,i)=>{const s={},o=i==null?n.len:n.pos+i;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:s.flag=r.Flag.codec().decode(n);break;case 2:s.message=n.bytes();break;default:n.skipType(a&7);break}}return s})),t),r.encode=n=>Me(n,r.codec()),r.decode=n=>Oe(n,r.codec())})(kt||(kt={}));const Jb=16*1024*1024,e1=30*1e3,t1=5,r1=2,n1=16*1024,i1=5e3;class s1 extends Ab{channel;incomingData;messageQueue;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;constructor(e){const t=e.onEnd;switch(e.onEnd=i=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await gs(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(s){this.log.error("error receiving FIN_ACK",s)}}).then(()=>{this.incomingData.end(),t?.(i)}).catch(s=>{this.log.error("error ending stream",s)})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=ln(),this.messageQueue=new ve,this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??e1,this.maxBufferedAmount=e.maxBufferedAmount??Jb,this.maxMessageSize=(e.maxMessageSize??n1)-t1-r1,this.receiveFinAck=At(),this.finAckTimeout=e.closeTimeout??i1,this.channel.readyState){case"open":break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new I("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=i=>{this.timeline.open=new Date().getTime(),this.messageQueue!=null&&this.messageQueue.byteLength>0&&(this.log.trace("dataChannel opened, sending queued messages",this.messageQueue.byteLength,this.channel.readyState),this._sendMessage(this.messageQueue).catch(s=>{this.log.error("error sending queued messages",s),this.abort(s)})),this.messageQueue=void 0},this.channel.onclose=i=>{this.receiveFinAck.resolve(),this.close().catch(s=>{this.log.error("error closing stream after channel closed",s)})},this.channel.onerror=i=>{const s=i.error;this.abort(s)},this.channel.onmessage=async i=>{const{data:s}=i;s===null||s.byteLength===0||this.incomingData.push(new Uint8Array(s,0,s.byteLength))};const n=this;Promise.resolve().then(async()=>{for await(const i of li(this.incomingData)){const s=n.processIncomingProtobuf(i);s!=null&&n.sourcePush(new ve(s))}}).catch(i=>{this.log.error("error processing incoming data channel messages",i)})}sendNewStream(){}async _sendMessage(e,t=!0){if(t&&this.channel.bufferedAmount>this.maxBufferedAmount)try{await kb(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(n){throw n instanceof Dd?new I(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):n}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new I(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");if(this.channel.readyState==="open")for(const n of e)this.channel.send(n);else if(this.channel.readyState==="connecting")this.messageQueue==null&&(this.messageQueue=new ve),this.messageQueue.append(e);else throw this.log.error("unknown datachannel state %s",this.channel.readyState),new I("Unknown datachannel state","ERR_INVALID_STATE")}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxMessageSize),n=e.subarray(0,t),i=kt.encode({message:n}),s=is.single(i);await this._sendMessage(s),e.consume(t)}}async sendReset(){await this._sendFlag(kt.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(kt.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await so(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(kt.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=kt.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===kt.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(kt.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===kt.Flag.RESET&&this.reset(),t.flag===kt.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===kt.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace("not sending flag %s because channel is not open",e.toString()),!1;this.log.trace("sending flag %s",e.toString());const t=kt.encode({flag:e}),n=is.single(t);try{return await this._sendMessage(n,!1),!0}catch(i){this.log.error("could not send flag %s",e.toString(),i)}return!1}}function mc(r){const{channel:e,direction:t}=r;return new s1({id:t==="inbound"?`i${e.id}`:`r${e.id}`,log:ue(`libp2p:webrtc:stream:${t}:${e.id}`),...r})}const Pl=ue("libp2p:webrtc:muxer"),Od="/webrtc";class Nl{protocol;peerConnection;streamBuffer=[];metrics;dataChannelOptions;constructor(e){this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??Od,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:t})=>{const n=mc({channel:t,direction:"inbound",onEnd:()=>{this.streamBuffer=this.streamBuffer.filter(i=>i.id!==n.id)},...this.dataChannelOptions});this.streamBuffer.push(n)}}createStreamMuxer(e){return new o1({...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.streamBuffer,protocol:this.protocol})}}class o1{init;streams;protocol;peerConnection;dataChannelOptions;metrics;constructor(e){this.init=e,this.streams=e.streams,this.peerConnection=e.peerConnection,this.protocol=e.protocol??Od,this.metrics=e.metrics,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{const i=mc({channel:n,direction:"inbound",onEnd:()=>{Pl.trace("stream %s %s %s onEnd",i.direction,i.id,i.protocol),Il(n,`inbound ${i.id} ${i.protocol}`,this.dataChannelOptions.drainTimeout),this.streams=this.streams.filter(s=>s.id!==i.id),this.metrics?.increment({stream_end:!0}),e?.onStreamEnd?.(i)},...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),e?.onIncomingStream?.(i)};const t=e?.onIncomingStream;t!=null&&this.streams.forEach(n=>{t(n)})}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}source=Td();sink=Ld;newStream(){const e=this.peerConnection.createDataChannel(""),t=mc({channel:e,direction:"outbound",onEnd:()=>{Pl.trace("stream %s %s %s onEnd",t.direction,t.id,t.protocol),Il(e,`outbound ${t.id} ${t.protocol}`,this.dataChannelOptions.drainTimeout),this.streams=this.streams.filter(n=>n.id!==t.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(t)},...this.dataChannelOptions});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}}const Bl=globalThis.RTCPeerConnection,Md=globalThis.RTCSessionDescription,a1=globalThis.RTCIceCandidate;let Ud=class extends Error{code;constructor(e,t){super(e),this.code=t}},c1=class extends Ud{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted"}};function u1(r){const e=ln();r.sink(e).catch(s=>{e.end(s)}),r.sink=async s=>{for await(const o of s)e.push(o);e.end()};let t=r.source;r.source[Symbol.iterator]!=null?t=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(t=r.source[Symbol.asyncIterator]());const n=new ve;return{read:async(s,o)=>{o?.signal?.throwIfAborted();let a;const c=new Promise((u,l)=>{a=()=>{l(new c1("Read aborted"))},o?.signal?.addEventListener("abort",a)});try{if(s==null){const{done:l,value:h}=await Promise.race([t.next(),c]);return l===!0?new ve:h}for(;n.byteLength<s;){const{value:l,done:h}=await Promise.race([t.next(),c]);if(h===!0)throw new Ud("unexpected end of input","ERR_UNEXPECTED_EOF");n.append(l)}const u=n.sublist(0,s);return n.consume(s),u}finally{a!=null&&o?.signal?.removeEventListener("abort",a)}},write:async(s,o)=>{o?.signal?.throwIfAborted(),s instanceof Uint8Array?e.push(s):e.push(s.subarray()),await e.onEmpty(o)},unwrap:()=>{const s=r.source;return r.source=async function*(){yield*n,yield*s}(),r}}}let Ol=class extends Error{code;constructor(e,t){super(e),this.code=t}};const $d=r=>$n(r);$d.bytes=0;function yc(r,e){const t=u1(r);return{read:async i=>{let s=-1;const o=new ve,a=e?.lengthDecoder??$d;for(;;){o.append(await t.read(1,i));try{s=a(o)}catch(c){if(c instanceof RangeError)continue;throw c}if(s>-1)break;if(e?.maxLengthLength!=null&&o.byteLength>e.maxLengthLength)throw new Ol("message length length too long","ERR_MSG_LENGTH_TOO_LONG")}if(e?.maxDataLength!=null&&s>e.maxDataLength)throw new Ol("message length too long","ERR_MSG_DATA_TOO_LONG");return t.read(s,i)},write:async(i,s)=>{await t.write(is.single(i,e),s)},unwrap:()=>t.unwrap()}}function kr(r,e){const t=yc(r,e),n={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},pb:i=>({read:async s=>n.read(i,s),write:async(s,o)=>n.write(s,i,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var qt;(function(r){(function(n){n.SDP_OFFER="SDP_OFFER",n.SDP_ANSWER="SDP_ANSWER",n.ICE_CANDIDATE="ICE_CANDIDATE"})(r.Type||(r.Type={}));let e;(function(n){n[n.SDP_OFFER=0]="SDP_OFFER",n[n.SDP_ANSWER=1]="SDP_ANSWER",n[n.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(n){n.codec=()=>Si(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ue((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.data!=null&&(i.uint32(18),i.string(n.data)),s.lengthDelimited!==!1&&i.ldelim()},(n,i)=>{const s={},o=i==null?n.len:n.pos+i;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:s.type=r.Type.codec().decode(n);break;case 2:s.data=n.string();break;default:n.skipType(a&7);break}}return s})),t),r.encode=n=>Me(n,r.codec()),r.decode=n=>Oe(n,r.codec())})(qt||(qt={}));function bs(r){const e=new globalThis.AbortController;function t(){e.abort();for(const s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",t)}for(const s of r){if(s?.aborted===!0){t();break}s?.addEventListener!=null&&s.addEventListener("abort",t)}function n(){for(const s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",t)}const i=e.signal;return i.clear=n,i}const An=ue("libp2p:webrtc:peer:util"),Fd=async(r,e,t,n)=>{const i=new AbortController;r.promise.then(()=>{i.abort()},()=>{i.abort()});const s=bs([i.signal,n.signal]),o=Pn(t.unwrap().unwrap().source,s,{returnOnAbort:!0});try{for await(const a of li(o)){const c=qt.decode(a);if(c.type!==qt.Type.ICE_CANDIDATE)throw new I("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");let u=JSON.parse(c.data??"null");u===""&&(An.trace("end-of-candidates for this generation received"),u={candidate:"",sdpMid:"0",sdpMLineIndex:0}),u===null&&(An.trace("end-of-candidates received"),u={candidate:null,sdpMid:"0",sdpMLineIndex:0});const l=new a1(u);An.trace("%s received new ICE candidate",n.direction,l);try{await e.addIceCandidate(l)}catch(h){An.error("%s bad candidate received",n.direction,h)}}}catch(a){An.error("%s error parsing ICE candidate",n.direction,a)}finally{s.clear()}if(n.signal?.aborted===!0)throw new dc("Aborted while reading ICE candidates","ERR_ICE_CANDIDATES_READ_ABORTED");await so(r.promise,n.signal,{errorMessage:"Aborted before connected",errorCode:"ERR_ABORTED_BEFORE_CONNECTED"})};function Kd(r,e){r[Rl?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(An.trace("receiver peerConnectionState state change: %s",r.connectionState),Rl?r.iceConnectionState:r.connectionState){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new I("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"));break}}}function Vd(r){const e=r.split(`\r
`).filter(n=>n.startsWith("a=candidate")).pop(),t=e?.split(" ");return e==null||t==null||t.length<5?(An("could not parse remote address from",e),"/webrtc"):`/dnsaddr/${t[4]}/${t[2].toLowerCase()}/${t[5]}/webrtc`}const Kt=ue("libp2p:webrtc:initiate-connection");async function l1({peerConnection:r,signal:e,metrics:t,multiaddr:n,connectionManager:i,transportManager:s}){const{baseAddr:o,peerId:a}=S1(n);t?.dialerEvents.increment({open:!0}),Kt.trace("dialing base address: %a",o);const c=o.getPeerId();if(c==null)throw new I("Relay peer was missing","ERR_INVALID_ADDRESS");const u=i.getConnections(je(c));let l,h=!1;u.length===0?(l=await s.dial(o,{signal:e}),h=!0):l=u[0];try{const p=await l.newStream(_c,{signal:e,runOnTransientConnection:!0}),g=kr(p).pb(qt),f=At(),d=()=>{f.reject(new I("SDP handshake aborted","ERR_SDP_HANDSHAKE_ABORTED"))};try{Kd(r,f),e?.addEventListener("abort",d);const m=r.createDataChannel("init");r.onicecandidate=({candidate:w})=>{const v=JSON.stringify(w?.toJSON()??null);Kt.trace("initiator sending ICE candidate %s",v),g.write({type:qt.Type.ICE_CANDIDATE,data:v},{signal:e}).catch(S=>{Kt.error("error sending ICE candidate",S)})},r.onicecandidateerror=w=>{Kt("initiator ICE candidate error",w)};const y=await r.createOffer();Kt.trace("initiator send SDP offer %s",y.sdp),await g.write({type:qt.Type.SDP_OFFER,data:y.sdp},{signal:e}),await r.setLocalDescription(y).catch(w=>{throw Kt.error("could not execute setLocalDescription",w),new I("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")});const E=await g.read({signal:e});if(E.type!==qt.Type.SDP_ANSWER)throw new I("remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");Kt.trace("initiator receive SDP answer %s",E.data);const b=new Md({type:"answer",sdp:E.data});await r.setRemoteDescription(b).catch(w=>{throw Kt.error("could not execute setRemoteDescription",w),new I("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),Kt.trace("initiator read candidates until connected"),await Fd(f,r,g,{direction:"initiator",signal:e}),Kt.trace("initiator connected, closing init channel"),m.close(),Kt.trace("initiator closing signalling stream"),await g.unwrap().unwrap().close({signal:e});const x=Vd(r.currentRemoteDescription?.sdp??"");return Kt.trace("initiator connected to remote address %s",x),{remoteAddress:ge(x).encapsulate(`/p2p/${a.toString()}`)}}catch(m){throw r.close(),p.abort(m),m}finally{e?.removeEventListener("abort",d),r.onicecandidate=null,r.onicecandidateerror=null}}finally{if(h)try{await l.close({signal:e})}catch(p){l.abort(p)}}}class hi extends EventTarget{#e=new Map;listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let i=this.#e.get(e);i==null&&(i=[],this.#e.set(e,i)),i.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let i=this.#e.get(e);i!=null&&(i=i.filter(({callback:s})=>s!==t),this.#e.set(e,i))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:i})=>!i),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t){return this.dispatchEvent(new zd(e,t))}}class h1 extends Event{detail;constructor(e,t){super(e,t),this.detail=t?.detail}}const zd=globalThis.CustomEvent??h1,f1=Y("dns4"),d1=Y("dns6"),p1=Y("dnsaddr"),Nn=ut(Y("dns"),p1,f1,d1),zo=ut(Y("ip4"),Y("ip6")),fi=ut(ce(zo,Y("tcp")),ce(Nn,Y("tcp"))),qo=ce(zo,Y("udp")),m1=ce(qo,Y("utp")),y1=ce(qo,Y("quic")),g1=ce(qo,Y("quic-v1")),gc=ut(ce(fi,Y("ws")),ce(Nn,Y("ws"))),bc=ut(ce(gc,Y("p2p")),gc),Ec=ut(ce(fi,Y("wss")),ce(Nn,Y("wss")),ce(fi,Y("tls"),Y("ws")),ce(Nn,Y("tls"),Y("ws"))),ao=ut(ce(Ec,Y("p2p")),Ec),wc=ut(ce(fi,Y("http")),ce(zo,Y("http")),ce(Nn,Y("http"))),xc=ut(ce(fi,Y("https")),ce(zo,Y("https")),ce(Nn,Y("https"))),Ml=ce(qo,Y("webrtc-direct"),Y("certhash")),qd=ut(ce(Ml,Y("p2p")),Ml),Ul=ce(g1,Y("webtransport"),Y("certhash"),Y("certhash")),Hd=ut(ce(Ul,Y("p2p")),Ul),Wd=ut(ce(bc,Y("p2p-webrtc-star"),Y("p2p")),ce(ao,Y("p2p-webrtc-star"),Y("p2p")),ce(bc,Y("p2p-webrtc-star")),ce(ao,Y("p2p-webrtc-star"))),Gd=ut(ce(wc,Y("p2p-webrtc-direct"),Y("p2p")),ce(xc,Y("p2p-webrtc-direct"),Y("p2p")),ce(wc,Y("p2p-webrtc-direct")),ce(xc,Y("p2p-webrtc-direct"))),vc=ut(gc,Ec,wc,xc,Wd,Gd,fi,m1,y1,Nn,qd,Hd),Cs=ut(ce(vc,Y("p2p")),Wd,Gd,qd,Hd,Y("p2p")),$l=ut(ce(Cs,Y("p2p-circuit"),Cs),ce(Cs,Y("p2p-circuit")),ce(Y("p2p-circuit"),Cs),ce(vc,Y("p2p-circuit")),ce(Y("p2p-circuit"),vc),Y("p2p-circuit")),Yd=()=>ut(ce($l,Yd),$l),Qd=Yd();function Xd(r){function e(t){let n;try{n=ge(t)}catch{return!1}const i=r(n.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function ce(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(i=>(n=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Xd(e),partialMatch:e}}function ut(...r){function e(n){let i=null;return r.some(s=>{const o=typeof s=="function"?s().partialMatch(n):s.partialMatch(n);return o!=null?(i=o,!0):!1}),i}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Xd(e),partialMatch:e}}function Y(r){const e=r;function t(i){let s;try{s=ge(i)}catch{return!1}const o=s.protoNames();return o.length===1&&o[0]===e}function n(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}class b1 extends hi{peerId;transportManager;shutdownController;constructor(e,t){super(),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(e=>e!==this).map(e=>e.getAddrs().filter(t=>Qd.matches(t)).map(t=>t.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}const Rt=ue("libp2p:webrtc:signaling-stream-handler");async function E1({peerConnection:r,stream:e,signal:t,connection:n}){Rt.trace("new inbound signaling stream");const i=kr(e).pb(qt);try{const o=At(),a=At();t.onabort=()=>{o.reject(new I("Timed out while trying to connect","ERR_TIMEOUT"))},r.onicecandidate=({candidate:h})=>{a.promise.then(async()=>{const p=JSON.stringify(h?.toJSON()??null);Rt.trace("recipient sending ICE candidate %s",p),await i.write({type:qt.Type.ICE_CANDIDATE,data:p},{signal:t})},p=>{Rt.error("cannot set candidate since sending answer failed",p),o.reject(p)})},Kd(r,o);const c=await i.read({signal:t});if(c.type!==qt.Type.SDP_OFFER)throw new I(`expected message type SDP_OFFER, received: ${c.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");Rt.trace("recipient receive SDP offer %s",c.data);const u=new Md({type:"offer",sdp:c.data});await r.setRemoteDescription(u).catch(h=>{throw Rt.error("could not execute setRemoteDescription",h),new I("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});const l=await r.createAnswer().catch(h=>{throw Rt.error("could not execute createAnswer",h),a.reject(h),new I("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});Rt.trace("recipient send SDP answer %s",l.sdp),await i.write({type:qt.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(h=>{throw Rt.error("could not execute setLocalDescription",h),a.reject(h),new I("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),a.resolve(),Rt.trace("recipient read candidates until connected"),await Fd(o,r,i,{direction:"recipient",signal:t}),Rt.trace("recipient connected, closing signaling stream"),await i.unwrap().unwrap().close({signal:t})}catch(o){if(r.connectionState!=="connected")throw Rt.error("error while handling signaling stream from peer %a",n.remoteAddr,o),r.close(),o;Rt("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,o)}const s=Vd(r.currentRemoteDescription?.sdp??"");return Rt.trace("recipient connected to remote address %s",s),{remoteAddress:s}}const Ra=ue("libp2p:webrtc:peer"),w1="/webrtc",x1="/p2p-circuit",_c="/webrtc-signaling/0.0.1",v1=30*1e3;class _1{components;init;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.shutdownController=new AbortController,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(_c,e=>{this._onProtocol(e).catch(t=>{Ra.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(_c),this._started=!1}createListener(e){return new b1(this.components,{shutdownController:this.shutdownController})}[Symbol.toStringTag]="@libp2p/webrtc";[bd]=!0;filter(e){return e.filter(sb.exactMatch)}async dial(e,t){Ra.trace("dialing address: %a",e);const n=new Bl(this.init.rtcConfiguration),i=new Nl({peerConnection:n,dataChannelOptions:this.init.dataChannel}),{remoteAddress:s}=await l1({peerConnection:n,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager}),o=new Cl({peerConnection:n,timeline:{open:Date.now()},remoteAddr:s,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i});return this._closeOnShutdown(n,o),a}async _onProtocol({connection:e,stream:t}){const n=AbortSignal.timeout(this.init.inboundConnectionTimeout??v1),i=new Bl(this.init.rtcConfiguration),s=new Nl({peerConnection:i,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:o}=await E1({peerConnection:i,connection:e,stream:t,signal:n}),a=new Cl({peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:ge(o).encapsulate(`/p2p/${e.remotePeer.toString()}`),metrics:this.metrics?.listenerEvents});this._closeOnShutdown(i,a),await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:s}),await t.close({signal:n})}catch(o){throw t.abort(o),o}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(i=>{Ra.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}function S1(r){const e=r.toString().split(w1+"/");if(e.length!==2)throw new I("webrtc protocol was not present in multiaddr",Jn.ERR_INVALID_MULTIADDR);if(!e[0].includes(x1))throw new I("p2p-circuit protocol was not present in multiaddr",Jn.ERR_INVALID_MULTIADDR);let t=ge(e[0]);const i=ge("/"+e[1]).getPeerId();if(i==null)throw new I("destination peer id was missing",Jn.ERR_INVALID_MULTIADDR);const s=t.protos().pop();if(s===void 0)throw new I("invalid multiaddr",Jn.ERR_INVALID_MULTIADDR);return s.name!=="p2p"&&(t=t.encapsulate(`/p2p/${i}`)),{baseAddr:t,peerId:je(i)}}function Fl(){const r=At();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function A1(){const r=Fl(),e=Fl();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}const ss=65535,Kl=ss-16,R1=!!globalThis.process?.env?.DUMP_SESSION_KEYS;/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const I1=r=>r instanceof Uint8Array,on=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),C1=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),D1=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!D1)throw new Error("Non little-endian hardware is not supported");function mu(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Sc(r){if(typeof r=="string")r=mu(r);else if(I1(r))r=r.slice();else throw new Error(`expected Uint8Array, got ${typeof r}`);return r}const T1=r=>Object.prototype.toString.call(r)==="[object Object]"&&r.constructor===Object;function L1(r,e){if(e!==void 0&&(typeof e!="object"||!T1(e)))throw new Error("options must be object or undefined");return Object.assign(r,e)}function Vi(r,e){if(!(r instanceof Uint8Array))throw new Error("Uint8Array expected");if(typeof e=="number"&&r.length!==e)throw new Error(`Uint8Array length ${e} expected`)}function k1(r,e){if(r.length!==e.length)throw new Error("equalBytes: Different size of Uint8Arrays");let t=!0;for(let n=0;n<r.length;n++)t&&(t=r[n]===e[n]);return t}const P1=(r,e)=>(Object.assign(e,r),e);function Vl(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,u=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+u,a,n)}function Ia(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function zl(r){if(typeof r!="boolean")throw new Error(`Expected boolean, not ${r}`)}function zi(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function ql(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function N1(r,e){zi(r);const t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}const nt=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class B1{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Sc(e),Vi(e,32);const t=nt(e,0),n=nt(e,2),i=nt(e,4),s=nt(e,6),o=nt(e,8),a=nt(e,10),c=nt(e,12),u=nt(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|u<<8)&8191,this.r[9]=u>>>5&127;for(let l=0;l<8;l++)this.pad[l]=nt(e,16+2*l)}process(e,t,n=!1){const i=n?0:2048,{h:s,r:o}=this,a=o[0],c=o[1],u=o[2],l=o[3],h=o[4],p=o[5],g=o[6],f=o[7],d=o[8],m=o[9],y=nt(e,t+0),E=nt(e,t+2),b=nt(e,t+4),x=nt(e,t+6),w=nt(e,t+8),v=nt(e,t+10),S=nt(e,t+12),C=nt(e,t+14);let B=s[0]+(y&8191),F=s[1]+((y>>>13|E<<3)&8191),U=s[2]+((E>>>10|b<<6)&8191),q=s[3]+((b>>>7|x<<9)&8191),W=s[4]+((x>>>4|w<<12)&8191),J=s[5]+(w>>>1&8191),D=s[6]+((w>>>14|v<<2)&8191),P=s[7]+((v>>>11|S<<5)&8191),L=s[8]+((S>>>8|C<<8)&8191),k=s[9]+(C>>>5|i),A=0,M=A+B*a+F*(5*m)+U*(5*d)+q*(5*f)+W*(5*g);A=M>>>13,M&=8191,M+=J*(5*p)+D*(5*h)+P*(5*l)+L*(5*u)+k*(5*c),A+=M>>>13,M&=8191;let $=A+B*c+F*a+U*(5*m)+q*(5*d)+W*(5*f);A=$>>>13,$&=8191,$+=J*(5*g)+D*(5*p)+P*(5*h)+L*(5*l)+k*(5*u),A+=$>>>13,$&=8191;let V=A+B*u+F*c+U*a+q*(5*m)+W*(5*d);A=V>>>13,V&=8191,V+=J*(5*f)+D*(5*g)+P*(5*p)+L*(5*h)+k*(5*l),A+=V>>>13,V&=8191;let X=A+B*l+F*u+U*c+q*a+W*(5*m);A=X>>>13,X&=8191,X+=J*(5*d)+D*(5*f)+P*(5*g)+L*(5*p)+k*(5*h),A+=X>>>13,X&=8191;let j=A+B*h+F*l+U*u+q*c+W*a;A=j>>>13,j&=8191,j+=J*(5*m)+D*(5*d)+P*(5*f)+L*(5*g)+k*(5*p),A+=j>>>13,j&=8191;let ae=A+B*p+F*h+U*l+q*u+W*c;A=ae>>>13,ae&=8191,ae+=J*a+D*(5*m)+P*(5*d)+L*(5*f)+k*(5*g),A+=ae>>>13,ae&=8191;let ee=A+B*g+F*p+U*h+q*l+W*u;A=ee>>>13,ee&=8191,ee+=J*c+D*a+P*(5*m)+L*(5*d)+k*(5*f),A+=ee>>>13,ee&=8191;let ne=A+B*f+F*g+U*p+q*h+W*l;A=ne>>>13,ne&=8191,ne+=J*u+D*c+P*a+L*(5*m)+k*(5*d),A+=ne>>>13,ne&=8191;let Se=A+B*d+F*f+U*g+q*p+W*h;A=Se>>>13,Se&=8191,Se+=J*l+D*u+P*c+L*a+k*(5*m),A+=Se>>>13,Se&=8191;let we=A+B*m+F*d+U*f+q*g+W*p;A=we>>>13,we&=8191,we+=J*h+D*l+P*u+L*c+k*a,A+=we>>>13,we&=8191,A=(A<<2)+A|0,A=A+M|0,M=A&8191,A=A>>>13,$+=A,s[0]=M,s[1]=$,s[2]=V,s[3]=X,s[4]=j,s[5]=ae,s[6]=ee,s[7]=ne,s[8]=Se,s[9]=we}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,n[0]=e[0]+5,i=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+i,i=n[a]>>>13,n[a]&=8191;n[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)n[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535}update(e){ql(this);const{buffer:t,blockLen:n}=this;e=Sc(e);const i=e.length;for(let s=0;s<i;){const o=Math.min(n-this.pos,i-s);if(o===n){for(;n<=i-s;s+=n)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){ql(this),N1(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=n[o]>>>0,e[s++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function O1(r){const e=(n,i)=>r(i).update(Sc(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const M1=O1(r=>new B1(r)),U1=mu("expand 16-byte k"),$1=mu("expand 32-byte k"),F1=on(U1),K1=on($1);function me(r,e){return r<<e|r>>>32-e}function Ac(r){return r.byteOffset%4===0}const Ds=64,V1=16,Zd=2**32-1,Hl=new Uint32Array;function z1(r,e,t,n,i,s,o,a){const c=i.length,u=new Uint8Array(Ds),l=on(u),h=Ac(i)&&Ac(s),p=h?on(i):Hl,g=h?on(s):Hl;for(let f=0;f<c;o++){if(r(e,t,n,l,o,a),o>=Zd)throw new Error("arx: counter overflow");const d=Math.min(Ds,c-f);if(h&&d===Ds){const m=f/4;if(f%4!==0)throw new Error("arx: invalid block position");for(let y=0,E;y<V1;y++)E=m+y,g[E]=p[E]^l[y];f+=Ds;continue}for(let m=0,y;m<d;m++)y=f+m,s[y]=i[y]^u[m];f+=d}}function q1(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:i,counterRight:s,rounds:o}=L1({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return Ia(i),Ia(o),zl(s),zl(t),(a,c,u,l,h=0)=>{zi(a),zi(c),zi(u);const p=u.length;if(l||(l=new Uint8Array(p)),zi(l),Ia(h),h<0||h>=Zd)throw new Error("arx: counter overflow");if(l.length<p)throw new Error(`arx: output (${l.length}) is shorter than data (${p})`);const g=[];let f=a.length,d,m;if(f===32)d=a.slice(),g.push(d),m=K1;else if(f===16&&t)d=new Uint8Array(32),d.set(a),d.set(a,16),m=F1,g.push(d);else throw new Error(`arx: invalid 32-byte key, got length=${f}`);Ac(c)||(c=c.slice(),g.push(c));const y=on(d);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(m,y,on(c.subarray(0,16)),y),c=c.subarray(16)}const E=16-i;if(E!==c.length)throw new Error(`arx: nonce must be ${E} or 16 bytes`);if(E!==12){const x=new Uint8Array(12);x.set(c,s?0:12-c.length),c=x,g.push(c)}const b=on(c);for(z1(r,m,y,b,u,l,h,o);g.length>0;)g.pop().fill(0);return l}}function H1(r,e,t,n,i,s=20){let o=r[0],a=r[1],c=r[2],u=r[3],l=e[0],h=e[1],p=e[2],g=e[3],f=e[4],d=e[5],m=e[6],y=e[7],E=i,b=t[0],x=t[1],w=t[2],v=o,S=a,C=c,B=u,F=l,U=h,q=p,W=g,J=f,D=d,P=m,L=y,k=E,A=b,M=x,$=w;for(let X=0;X<s;X+=2)v=v+F|0,k=me(k^v,16),J=J+k|0,F=me(F^J,12),v=v+F|0,k=me(k^v,8),J=J+k|0,F=me(F^J,7),S=S+U|0,A=me(A^S,16),D=D+A|0,U=me(U^D,12),S=S+U|0,A=me(A^S,8),D=D+A|0,U=me(U^D,7),C=C+q|0,M=me(M^C,16),P=P+M|0,q=me(q^P,12),C=C+q|0,M=me(M^C,8),P=P+M|0,q=me(q^P,7),B=B+W|0,$=me($^B,16),L=L+$|0,W=me(W^L,12),B=B+W|0,$=me($^B,8),L=L+$|0,W=me(W^L,7),v=v+U|0,$=me($^v,16),P=P+$|0,U=me(U^P,12),v=v+U|0,$=me($^v,8),P=P+$|0,U=me(U^P,7),S=S+q|0,k=me(k^S,16),L=L+k|0,q=me(q^L,12),S=S+q|0,k=me(k^S,8),L=L+k|0,q=me(q^L,7),C=C+W|0,A=me(A^C,16),J=J+A|0,W=me(W^J,12),C=C+W|0,A=me(A^C,8),J=J+A|0,W=me(W^J,7),B=B+F|0,M=me(M^B,16),D=D+M|0,F=me(F^D,12),B=B+F|0,M=me(M^B,8),D=D+M|0,F=me(F^D,7);let V=0;n[V++]=o+v|0,n[V++]=a+S|0,n[V++]=c+C|0,n[V++]=u+B|0,n[V++]=l+F|0,n[V++]=h+U|0,n[V++]=p+q|0,n[V++]=g+W|0,n[V++]=f+J|0,n[V++]=d+D|0,n[V++]=m+P|0,n[V++]=y+L|0,n[V++]=E+k|0,n[V++]=b+A|0,n[V++]=x+M|0,n[V++]=w+$|0}const W1=q1(H1,{counterRight:!1,counterLength:4,allowShortKeys:!1}),G1=new Uint8Array(16),Wl=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(G1.subarray(t))},Y1=new Uint8Array(32);function Gl(r,e,t,n,i){const s=r(e,t,Y1),o=M1.create(s);i&&Wl(o,i),Wl(o,n);const a=new Uint8Array(16),c=C1(a);Vl(c,0,BigInt(i?i.length:0),!0),Vl(c,8,BigInt(n.length),!0),o.update(a);const u=o.digest();return s.fill(0),u}const Q1=r=>(e,t,n)=>(Vi(e,32),Vi(t),{encrypt:(s,o)=>{const a=s.length,c=a+16;o?Vi(o,c):o=new Uint8Array(c),r(e,t,s,o,1);const u=Gl(r,e,t,o.subarray(0,-16),n);return o.set(u,a),o},decrypt:(s,o)=>{const a=s.length,c=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");o?Vi(o,c):o=new Uint8Array(c);const u=s.subarray(0,-16),l=s.subarray(-16),h=Gl(r,e,t,u,n);if(!k1(l,h))throw new Error("invalid tag");return r(e,t,u,o,1),o}}),Yl=P1({blockSize:64,nonceLength:12,tagLength:16},Q1(W1));function Rc(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function jd(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function yu(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Rc(r.outputLen),Rc(r.blockLen)}function co(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function X1(r,e){jd(r);const t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}const Ca=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Jd=r=>r instanceof Uint8Array,Da=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),ur=(r,e)=>r<<32-e|r>>>e,Z1=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Z1)throw new Error("Non little-endian hardware is not supported");function e0(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function os(r){if(typeof r=="string"&&(r=e0(r)),!Jd(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function t0(...r){const e=new Uint8Array(r.reduce((n,i)=>n+i.length,0));let t=0;return r.forEach(n=>{if(!Jd(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}class r0{clone(){return this._cloneInto()}}function n0(r){const e=n=>r().update(os(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Ho(r=32){if(Ca&&typeof Ca.getRandomValues=="function")return Ca.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function j1(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,u=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+u,a,n)}class i0 extends r0{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Da(this.buffer)}update(e){co(this);const{view:t,buffer:n,blockLen:i}=this;e=os(e);const s=e.length;for(let o=0;o<s;){const a=Math.min(i-this.pos,s-o);if(a===i){const c=Da(e);for(;i<=s-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){co(this),X1(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:i,isLE:s}=this;let{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>i-o&&(this.process(n,0),o=0);for(let h=o;h<i;h++)t[h]=0;j1(n,i-8,BigInt(this.length*8),s),this.process(n,0);const a=Da(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)a.setUint32(4*h,l[h],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:a}=this;return e.length=i,e.pos=a,e.finished=s,e.destroyed=o,i%t&&e.buffer.set(n),e}}const Ts=BigInt(2**32-1),Ic=BigInt(32);function s0(r,e=!1){return e?{h:Number(r&Ts),l:Number(r>>Ic&Ts)}:{h:Number(r>>Ic&Ts)|0,l:Number(r&Ts)|0}}function J1(r,e=!1){let t=new Uint32Array(r.length),n=new Uint32Array(r.length);for(let i=0;i<r.length;i++){const{h:s,l:o}=s0(r[i],e);[t[i],n[i]]=[s,o]}return[t,n]}const eE=(r,e)=>BigInt(r>>>0)<<Ic|BigInt(e>>>0),tE=(r,e,t)=>r>>>t,rE=(r,e,t)=>r<<32-t|e>>>t,nE=(r,e,t)=>r>>>t|e<<32-t,iE=(r,e,t)=>r<<32-t|e>>>t,sE=(r,e,t)=>r<<64-t|e>>>t-32,oE=(r,e,t)=>r>>>t-32|e<<64-t,aE=(r,e)=>e,cE=(r,e)=>r,uE=(r,e,t)=>r<<t|e>>>32-t,lE=(r,e,t)=>e<<t|r>>>32-t,hE=(r,e,t)=>e<<t-32|r>>>64-t,fE=(r,e,t)=>r<<t-32|e>>>64-t;function dE(r,e,t,n){const i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}const pE=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),mE=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,yE=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),gE=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,bE=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),EE=(r,e,t,n,i,s)=>e+t+n+i+s+(r/2**32|0)|0,wE={fromBig:s0,split:J1,toBig:eE,shrSH:tE,shrSL:rE,rotrSH:nE,rotrSL:iE,rotrBH:sE,rotrBL:oE,rotr32H:aE,rotr32L:cE,rotlSH:uE,rotlSL:lE,rotlBH:hE,rotlBL:fE,add:dE,add3L:pE,add3H:mE,add4L:yE,add4H:gE,add5H:EE,add5L:bE},oe=wE,[xE,vE]=(()=>oe.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))))(),$r=new Uint32Array(80),Fr=new Uint32Array(80);class _E extends i0{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:e,Al:t,Bh:n,Bl:i,Ch:s,Cl:o,Dh:a,Dl:c,Eh:u,El:l,Fh:h,Fl:p,Gh:g,Gl:f,Hh:d,Hl:m}=this;return[e,t,n,i,s,o,a,c,u,l,h,p,g,f,d,m]}set(e,t,n,i,s,o,a,c,u,l,h,p,g,f,d,m){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=l|0,this.Fh=h|0,this.Fl=p|0,this.Gh=g|0,this.Gl=f|0,this.Hh=d|0,this.Hl=m|0}process(e,t){for(let b=0;b<16;b++,t+=4)$r[b]=e.getUint32(t),Fr[b]=e.getUint32(t+=4);for(let b=16;b<80;b++){const x=$r[b-15]|0,w=Fr[b-15]|0,v=oe.rotrSH(x,w,1)^oe.rotrSH(x,w,8)^oe.shrSH(x,w,7),S=oe.rotrSL(x,w,1)^oe.rotrSL(x,w,8)^oe.shrSL(x,w,7),C=$r[b-2]|0,B=Fr[b-2]|0,F=oe.rotrSH(C,B,19)^oe.rotrBH(C,B,61)^oe.shrSH(C,B,6),U=oe.rotrSL(C,B,19)^oe.rotrBL(C,B,61)^oe.shrSL(C,B,6),q=oe.add4L(S,U,Fr[b-7],Fr[b-16]),W=oe.add4H(q,v,F,$r[b-7],$r[b-16]);$r[b]=W|0,Fr[b]=q|0}let{Ah:n,Al:i,Bh:s,Bl:o,Ch:a,Cl:c,Dh:u,Dl:l,Eh:h,El:p,Fh:g,Fl:f,Gh:d,Gl:m,Hh:y,Hl:E}=this;for(let b=0;b<80;b++){const x=oe.rotrSH(h,p,14)^oe.rotrSH(h,p,18)^oe.rotrBH(h,p,41),w=oe.rotrSL(h,p,14)^oe.rotrSL(h,p,18)^oe.rotrBL(h,p,41),v=h&g^~h&d,S=p&f^~p&m,C=oe.add5L(E,w,S,vE[b],Fr[b]),B=oe.add5H(C,y,x,v,xE[b],$r[b]),F=C|0,U=oe.rotrSH(n,i,28)^oe.rotrBH(n,i,34)^oe.rotrBH(n,i,39),q=oe.rotrSL(n,i,28)^oe.rotrBL(n,i,34)^oe.rotrBL(n,i,39),W=n&s^n&a^s&a,J=i&o^i&c^o&c;y=d|0,E=m|0,d=g|0,m=f|0,g=h|0,f=p|0,{h,l:p}=oe.add(u|0,l|0,B|0,F|0),u=a|0,l=c|0,a=s|0,c=o|0,s=n|0,o=i|0;const D=oe.add3L(F,q,J);n=oe.add3H(D,B,U,W),i=D|0}({h:n,l:i}=oe.add(this.Ah|0,this.Al|0,n|0,i|0)),{h:s,l:o}=oe.add(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l:c}=oe.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l}=oe.add(this.Dh|0,this.Dl|0,u|0,l|0),{h,l:p}=oe.add(this.Eh|0,this.El|0,h|0,p|0),{h:g,l:f}=oe.add(this.Fh|0,this.Fl|0,g|0,f|0),{h:d,l:m}=oe.add(this.Gh|0,this.Gl|0,d|0,m|0),{h:y,l:E}=oe.add(this.Hh|0,this.Hl|0,y|0,E|0),this.set(n,i,s,o,a,c,u,l,h,p,g,f,d,m,y,E)}roundClean(){$r.fill(0),Fr.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const o0=n0(()=>new _E);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const a0=BigInt(0),Wo=BigInt(1),SE=BigInt(2),Go=r=>r instanceof Uint8Array,AE=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Bn(r){if(!Go(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=AE[r[t]];return e}function c0(r){const e=r.toString(16);return e.length&1?`0${e}`:e}function gu(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return BigInt(r===""?"0":`0x${r}`)}function di(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);const e=r.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const t=new Uint8Array(e/2);for(let n=0;n<t.length;n++){const i=n*2,s=r.slice(i,i+2),o=Number.parseInt(s,16);if(Number.isNaN(o)||o<0)throw new Error("Invalid byte sequence");t[n]=o}return t}function Ln(r){return gu(Bn(r))}function an(r){if(!Go(r))throw new Error("Uint8Array expected");return gu(Bn(Uint8Array.from(r).reverse()))}function pi(r,e){return di(r.toString(16).padStart(e*2,"0"))}function mi(r,e){return pi(r,e).reverse()}function RE(r){return di(c0(r))}function Ke(r,e,t){let n;if(typeof e=="string")try{n=di(e)}catch(s){throw new Error(`${r} must be valid hex string, got "${e}". Cause: ${s}`)}else if(Go(e))n=Uint8Array.from(e);else throw new Error(`${r} must be hex string or Uint8Array`);const i=n.length;if(typeof t=="number"&&i!==t)throw new Error(`${r} expected ${t} bytes, got ${i}`);return n}function On(...r){const e=new Uint8Array(r.reduce((n,i)=>n+i.length,0));let t=0;return r.forEach(n=>{if(!Go(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}function IE(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function CE(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function DE(r){let e;for(e=0;r>a0;r>>=Wo,e+=1);return e}function TE(r,e){return r>>BigInt(e)&Wo}const LE=(r,e,t)=>r|(t?Wo:a0)<<BigInt(e),bu=r=>(SE<<BigInt(r-1))-Wo,Ta=r=>new Uint8Array(r),Ql=r=>Uint8Array.from(r);function u0(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=Ta(r),i=Ta(r),s=0;const o=()=>{n.fill(1),i.fill(0),s=0},a=(...h)=>t(i,n,...h),c=(h=Ta())=>{i=a(Ql([0]),h),n=a(),h.length!==0&&(i=a(Ql([1]),h),n=a())},u=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let h=0;const p=[];for(;h<e;){n=a();const g=n.slice();p.push(g),h+=n.length}return On(...p)};return(h,p)=>{o(),c(h);let g;for(;!(g=p(u()));)c();return o(),g}}const kE={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||r instanceof Uint8Array,isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function Fn(r,e,t={}){const n=(i,s,o)=>{const a=kE[s];if(typeof a!="function")throw new Error(`Invalid validator "${s}", expected function`);const c=r[i];if(!(o&&c===void 0)&&!a(c,r))throw new Error(`Invalid param ${String(i)}=${c} (${typeof c}), expected ${s}`)};for(const[i,s]of Object.entries(e))n(i,s,!1);for(const[i,s]of Object.entries(t))n(i,s,!0);return r}const PE=Object.freeze(Object.defineProperty({__proto__:null,bitGet:TE,bitLen:DE,bitMask:bu,bitSet:LE,bytesToHex:Bn,bytesToNumberBE:Ln,bytesToNumberLE:an,concatBytes:On,createHmacDrbg:u0,ensureBytes:Ke,equalBytes:IE,hexToBytes:di,hexToNumber:gu,numberToBytesBE:pi,numberToBytesLE:mi,numberToHexUnpadded:c0,numberToVarBytesBE:RE,utf8ToBytes:CE,validateObject:Fn},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Xe=BigInt(0),Ne=BigInt(1),Rn=BigInt(2),NE=BigInt(3),Cc=BigInt(4),Xl=BigInt(5),Zl=BigInt(8);BigInt(9);BigInt(16);function Ie(r,e){const t=r%e;return t>=Xe?t:e+t}function l0(r,e,t){if(t<=Xe||e<Xe)throw new Error("Expected power/modulo > 0");if(t===Ne)return Xe;let n=Ne;for(;e>Xe;)e&Ne&&(n=n*r%t),r=r*r%t,e>>=Ne;return n}function Pe(r,e,t){let n=r;for(;e-- >Xe;)n*=n,n%=t;return n}function Dc(r,e){if(r===Xe||e<=Xe)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=Ie(r,e),n=e,i=Xe,s=Ne;for(;t!==Xe;){const a=n/t,c=n%t,u=i-s*a;n=t,t=c,i=s,s=u}if(n!==Ne)throw new Error("invert: does not exist");return Ie(i,e)}function BE(r){const e=(r-Ne)/Rn;let t,n,i;for(t=r-Ne,n=0;t%Rn===Xe;t/=Rn,n++);for(i=Rn;i<r&&l0(i,e,r)!==r-Ne;i++);if(n===1){const o=(r+Ne)/Cc;return function(c,u){const l=c.pow(u,o);if(!c.eql(c.sqr(l),u))throw new Error("Cannot find square root");return l}}const s=(t+Ne)/Rn;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let u=n,l=a.pow(a.mul(a.ONE,i),t),h=a.pow(c,s),p=a.pow(c,t);for(;!a.eql(p,a.ONE);){if(a.eql(p,a.ZERO))return a.ZERO;let g=1;for(let d=a.sqr(p);g<u&&!a.eql(d,a.ONE);g++)d=a.sqr(d);const f=a.pow(l,Ne<<BigInt(u-g-1));l=a.sqr(f),h=a.mul(h,f),p=a.mul(p,l),u=g}return h}}function OE(r){if(r%Cc===NE){const e=(r+Ne)/Cc;return function(n,i){const s=n.pow(i,e);if(!n.eql(n.sqr(s),i))throw new Error("Cannot find square root");return s}}if(r%Zl===Xl){const e=(r-Xl)/Zl;return function(n,i){const s=n.mul(i,Rn),o=n.pow(s,e),a=n.mul(i,o),c=n.mul(n.mul(a,Rn),o),u=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(u),i))throw new Error("Cannot find square root");return u}}return BE(r)}const ME=(r,e)=>(Ie(r,e)&Ne)===Ne,UE=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function $E(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=UE.reduce((n,i)=>(n[i]="function",n),e);return Fn(r,t)}function FE(r,e,t){if(t<Xe)throw new Error("Expected power > 0");if(t===Xe)return r.ONE;if(t===Ne)return e;let n=r.ONE,i=e;for(;t>Xe;)t&Ne&&(n=r.mul(n,i)),i=r.sqr(i),t>>=Ne;return n}function KE(r,e){const t=new Array(e.length),n=e.reduce((s,o,a)=>r.is0(o)?s:(t[a]=s,r.mul(s,o)),r.ONE),i=r.inv(n);return e.reduceRight((s,o,a)=>r.is0(o)?s:(t[a]=r.mul(s,t[a]),r.mul(s,o)),i),t}function h0(r,e){const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function f0(r,e,t=!1,n={}){if(r<=Xe)throw new Error(`Expected Field ORDER > 0, got ${r}`);const{nBitLength:i,nByteLength:s}=h0(r,e);if(s>2048)throw new Error("Field lengths over 2048 bytes are not supported");const o=OE(r),a=Object.freeze({ORDER:r,BITS:i,BYTES:s,MASK:bu(i),ZERO:Xe,ONE:Ne,create:c=>Ie(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return Xe<=c&&c<r},is0:c=>c===Xe,isOdd:c=>(c&Ne)===Ne,neg:c=>Ie(-c,r),eql:(c,u)=>c===u,sqr:c=>Ie(c*c,r),add:(c,u)=>Ie(c+u,r),sub:(c,u)=>Ie(c-u,r),mul:(c,u)=>Ie(c*u,r),pow:(c,u)=>FE(a,c,u),div:(c,u)=>Ie(c*Dc(u,r),r),sqrN:c=>c*c,addN:(c,u)=>c+u,subN:(c,u)=>c-u,mulN:(c,u)=>c*u,inv:c=>Dc(c,r),sqrt:n.sqrt||(c=>o(a,c)),invertBatch:c=>KE(a,c),cmov:(c,u,l)=>l?u:c,toBytes:c=>t?mi(c,s):pi(c,s),fromBytes:c=>{if(c.length!==s)throw new Error(`Fp.fromBytes: expected ${s}, got ${c.length}`);return t?an(c):Ln(c)}});return Object.freeze(a)}function VE(r,e){if(!r.isOdd)throw new Error("Field doesn't have isOdd");const t=r.sqrt(e);return r.isOdd(t)?r.neg(t):t}function d0(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function p0(r){const e=d0(r);return e+Math.ceil(e/2)}function zE(r,e,t=!1){const n=r.length,i=d0(e),s=p0(e);if(n<16||n<s||n>1024)throw new Error(`expected ${s}-1024 bytes of input, got ${n}`);const o=t?Ln(r):an(r),a=Ie(o,e-Ne)+Ne;return t?mi(a,i):pi(a,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const qE=BigInt(0),La=BigInt(1);function m0(r,e){const t=(i,s)=>{const o=s.negate();return i?o:s},n=i=>{const s=Math.ceil(e/i)+1,o=2**(i-1);return{windows:s,windowSize:o}};return{constTimeNegate:t,unsafeLadder(i,s){let o=r.ZERO,a=i;for(;s>qE;)s&La&&(o=o.add(a)),a=a.double(),s>>=La;return o},precomputeWindow(i,s){const{windows:o,windowSize:a}=n(s),c=[];let u=i,l=u;for(let h=0;h<o;h++){l=u,c.push(l);for(let p=1;p<a;p++)l=l.add(u),c.push(l);u=l.double()}return c},wNAF(i,s,o){const{windows:a,windowSize:c}=n(i);let u=r.ZERO,l=r.BASE;const h=BigInt(2**i-1),p=2**i,g=BigInt(i);for(let f=0;f<a;f++){const d=f*c;let m=Number(o&h);o>>=g,m>c&&(m-=p,o+=La);const y=d,E=d+Math.abs(m)-1,b=f%2!==0,x=m<0;m===0?l=l.add(t(b,s[y])):u=u.add(t(x,s[E]))}return{p:u,f:l}},wNAFCached(i,s,o,a){const c=i._WINDOW_SIZE||1;let u=s.get(i);return u||(u=this.precomputeWindow(i,c),c!==1&&s.set(i,a(u))),this.wNAF(c,u,o)}}}function Eu(r){return $E(r.Fp),Fn(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...h0(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const rr=BigInt(0),It=BigInt(1),Ls=BigInt(2),HE=BigInt(8),WE={zip215:!0};function GE(r){const e=Eu(r);return Fn(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function wu(r){const e=GE(r),{Fp:t,n,prehash:i,hash:s,randomBytes:o,nByteLength:a,h:c}=e,u=Ls<<BigInt(a*8)-It,l=t.create,h=e.uvRatio||((k,A)=>{try{return{isValid:!0,value:t.sqrt(k*t.inv(A))}}catch{return{isValid:!1,value:rr}}}),p=e.adjustScalarBytes||(k=>k),g=e.domain||((k,A,M)=>{if(A.length||M)throw new Error("Contexts/pre-hash are not supported");return k}),f=k=>typeof k=="bigint"&&rr<k,d=(k,A)=>f(k)&&f(A)&&k<A,m=k=>k===rr||d(k,u);function y(k,A){if(d(k,A))return k;throw new Error(`Expected valid scalar < ${A}, got ${typeof k} ${k}`)}function E(k){return k===rr?k:y(k,n)}const b=new Map;function x(k){if(!(k instanceof w))throw new Error("ExtendedPoint expected")}class w{constructor(A,M,$,V){if(this.ex=A,this.ey=M,this.ez=$,this.et=V,!m(A))throw new Error("x required");if(!m(M))throw new Error("y required");if(!m($))throw new Error("z required");if(!m(V))throw new Error("t required")}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(A){if(A instanceof w)throw new Error("extended point not allowed");const{x:M,y:$}=A||{};if(!m(M)||!m($))throw new Error("invalid affine point");return new w(M,$,It,l(M*$))}static normalizeZ(A){const M=t.invertBatch(A.map($=>$.ez));return A.map(($,V)=>$.toAffine(M[V])).map(w.fromAffine)}_setWindowSize(A){this._WINDOW_SIZE=A,b.delete(this)}assertValidity(){const{a:A,d:M}=e;if(this.is0())throw new Error("bad point: ZERO");const{ex:$,ey:V,ez:X,et:j}=this,ae=l($*$),ee=l(V*V),ne=l(X*X),Se=l(ne*ne),we=l(ae*A),tt=l(ne*l(we+ee)),rt=l(Se+l(M*l(ae*ee)));if(tt!==rt)throw new Error("bad point: equation left != right (1)");const We=l($*V),ht=l(X*j);if(We!==ht)throw new Error("bad point: equation left != right (2)")}equals(A){x(A);const{ex:M,ey:$,ez:V}=this,{ex:X,ey:j,ez:ae}=A,ee=l(M*ae),ne=l(X*V),Se=l($*ae),we=l(j*V);return ee===ne&&Se===we}is0(){return this.equals(w.ZERO)}negate(){return new w(l(-this.ex),this.ey,this.ez,l(-this.et))}double(){const{a:A}=e,{ex:M,ey:$,ez:V}=this,X=l(M*M),j=l($*$),ae=l(Ls*l(V*V)),ee=l(A*X),ne=M+$,Se=l(l(ne*ne)-X-j),we=ee+j,tt=we-ae,rt=ee-j,We=l(Se*tt),ht=l(we*rt),Sr=l(Se*rt),dn=l(tt*we);return new w(We,ht,dn,Sr)}add(A){x(A);const{a:M,d:$}=e,{ex:V,ey:X,ez:j,et:ae}=this,{ex:ee,ey:ne,ez:Se,et:we}=A;if(M===BigInt(-1)){const Xu=l((X-V)*(ne+ee)),Zu=l((X+V)*(ne-ee)),pa=l(Zu-Xu);if(pa===rr)return this.double();const ju=l(j*Ls*we),Ju=l(ae*Ls*Se),el=Ju+ju,tl=Zu+Xu,rl=Ju-ju,Bm=l(el*pa),Om=l(tl*rl),Mm=l(el*rl),Um=l(pa*tl);return new w(Bm,Om,Um,Mm)}const tt=l(V*ee),rt=l(X*ne),We=l(ae*$*we),ht=l(j*Se),Sr=l((V+X)*(ee+ne)-tt-rt),dn=ht-We,Ti=ht+We,Qu=l(rt-M*tt),Lm=l(Sr*dn),km=l(Ti*Qu),Pm=l(Sr*Qu),Nm=l(dn*Ti);return new w(Lm,km,Nm,Pm)}subtract(A){return this.add(A.negate())}wNAF(A){return C.wNAFCached(this,b,A,w.normalizeZ)}multiply(A){const{p:M,f:$}=this.wNAF(y(A,n));return w.normalizeZ([M,$])[0]}multiplyUnsafe(A){let M=E(A);return M===rr?S:this.equals(S)||M===It?this:this.equals(v)?this.wNAF(M).p:C.unsafeLadder(this,M)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return C.unsafeLadder(this,n).is0()}toAffine(A){const{ex:M,ey:$,ez:V}=this,X=this.is0();A==null&&(A=X?HE:t.inv(V));const j=l(M*A),ae=l($*A),ee=l(V*A);if(X)return{x:rr,y:It};if(ee!==It)throw new Error("invZ was invalid");return{x:j,y:ae}}clearCofactor(){const{h:A}=e;return A===It?this:this.multiplyUnsafe(A)}static fromHex(A,M=!1){const{d:$,a:V}=e,X=t.BYTES;A=Ke("pointHex",A,X);const j=A.slice(),ae=A[X-1];j[X-1]=ae&-129;const ee=an(j);ee===rr||(M?y(ee,u):y(ee,t.ORDER));const ne=l(ee*ee),Se=l(ne-It),we=l($*ne-V);let{isValid:tt,value:rt}=h(Se,we);if(!tt)throw new Error("Point.fromHex: invalid y coordinate");const We=(rt&It)===It,ht=(ae&128)!==0;if(!M&&rt===rr&&ht)throw new Error("Point.fromHex: x=0 and x_0=1");return ht!==We&&(rt=l(-rt)),w.fromAffine({x:rt,y:ee})}static fromPrivateKey(A){return U(A).point}toRawBytes(){const{x:A,y:M}=this.toAffine(),$=mi(M,t.BYTES);return $[$.length-1]|=A&It?128:0,$}toHex(){return Bn(this.toRawBytes())}}w.BASE=new w(e.Gx,e.Gy,It,l(e.Gx*e.Gy)),w.ZERO=new w(rr,It,It,rr);const{BASE:v,ZERO:S}=w,C=m0(w,a*8);function B(k){return Ie(k,n)}function F(k){return B(an(k))}function U(k){const A=a;k=Ke("private key",k,A);const M=Ke("hashed private key",s(k),2*A),$=p(M.slice(0,A)),V=M.slice(A,2*A),X=F($),j=v.multiply(X),ae=j.toRawBytes();return{head:$,prefix:V,scalar:X,point:j,pointBytes:ae}}function q(k){return U(k).pointBytes}function W(k=new Uint8Array,...A){const M=On(...A);return F(s(g(M,Ke("context",k),!!i)))}function J(k,A,M={}){k=Ke("message",k),i&&(k=i(k));const{prefix:$,scalar:V,pointBytes:X}=U(A),j=W(M.context,$,k),ae=v.multiply(j).toRawBytes(),ee=W(M.context,ae,X,k),ne=B(j+ee*V);E(ne);const Se=On(ae,mi(ne,t.BYTES));return Ke("result",Se,a*2)}const D=WE;function P(k,A,M,$=D){const{context:V,zip215:X}=$,j=t.BYTES;k=Ke("signature",k,2*j),A=Ke("message",A),i&&(A=i(A));const ae=an(k.slice(j,2*j));let ee,ne,Se;try{ee=w.fromHex(M,X),ne=w.fromHex(k.slice(0,j),X),Se=v.multiplyUnsafe(ae)}catch{return!1}if(!X&&ee.isSmallOrder())return!1;const we=W(V,ne.toRawBytes(),ee.toRawBytes(),A);return ne.add(ee.multiplyUnsafe(we)).subtract(Se).clearCofactor().equals(w.ZERO)}return v._setWindowSize(8),{CURVE:e,getPublicKey:q,sign:J,verify:P,ExtendedPoint:w,utils:{getExtendedPublicKey:U,randomPrivateKey:()=>o(t.BYTES),precompute(k=8,A=w.BASE){return A._setWindowSize(k),A.multiply(BigInt(3)),A}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ni=BigInt(0),ka=BigInt(1);function YE(r){return Fn(r,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...r})}function QE(r){const e=YE(r),{P:t}=e,n=b=>Ie(b,t),i=e.montgomeryBits,s=Math.ceil(i/8),o=e.nByteLength,a=e.adjustScalarBytes||(b=>b),c=e.powPminus2||(b=>l0(b,t-BigInt(2),t));function u(b,x,w){const v=n(b*(x-w));return x=n(x-v),w=n(w+v),[x,w]}function l(b){if(typeof b=="bigint"&&Ni<=b&&b<t)return b;throw new Error("Expected valid scalar 0 < scalar < CURVE.P")}const h=(e.a-BigInt(2))/BigInt(4);function p(b,x){const w=l(b),v=l(x),S=w;let C=ka,B=Ni,F=w,U=ka,q=Ni,W;for(let D=BigInt(i-1);D>=Ni;D--){const P=v>>D&ka;q^=P,W=u(q,C,F),C=W[0],F=W[1],W=u(q,B,U),B=W[0],U=W[1],q=P;const L=C+B,k=n(L*L),A=C-B,M=n(A*A),$=k-M,V=F+U,X=F-U,j=n(X*L),ae=n(V*A),ee=j+ae,ne=j-ae;F=n(ee*ee),U=n(S*n(ne*ne)),C=n(k*M),B=n($*(k+n(h*$)))}W=u(q,C,F),C=W[0],F=W[1],W=u(q,B,U),B=W[0],U=W[1];const J=c(B);return n(C*J)}function g(b){return mi(n(b),s)}function f(b){const x=Ke("u coordinate",b,s);return o===s&&(x[o-1]&=127),an(x)}function d(b){const x=Ke("scalar",b);if(x.length!==s&&x.length!==o)throw new Error(`Expected ${s} or ${o} bytes, got ${x.length}`);return an(a(x))}function m(b,x){const w=f(x),v=d(b),S=p(w,v);if(S===Ni)throw new Error("Invalid private or public key received");return g(S)}const y=g(e.Gu);function E(b){return m(b,y)}return{scalarMult:m,scalarMultBase:E,getSharedSecret:(b,x)=>m(b,x),getPublicKey:b=>E(b),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:y}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const as=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),jl=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const XE=BigInt(1),Tc=BigInt(2),ZE=BigInt(5),Jl=BigInt(10),jE=BigInt(20),JE=BigInt(40),eh=BigInt(80);function y0(r){const e=as,n=r*r%e*r%e,i=Pe(n,Tc,e)*n%e,s=Pe(i,XE,e)*r%e,o=Pe(s,ZE,e)*s%e,a=Pe(o,Jl,e)*o%e,c=Pe(a,jE,e)*a%e,u=Pe(c,JE,e)*c%e,l=Pe(u,eh,e)*u%e,h=Pe(l,eh,e)*u%e,p=Pe(h,Jl,e)*o%e;return{pow_p_5_8:Pe(p,Tc,e)*r%e,b2:n}}function g0(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function ew(r,e){const t=as,n=Ie(e*e*e,t),i=Ie(n*n*e,t),s=y0(r*i).pow_p_5_8;let o=Ie(r*n*s,t);const a=Ie(e*o*o,t),c=o,u=Ie(o*jl,t),l=a===r,h=a===Ie(-r,t),p=a===Ie(-r*jl,t);return l&&(o=c),(h||p)&&(o=u),ME(o,t)&&(o=Ie(-o,t)),{isValid:l||h,value:o}}const Br=f0(as,void 0,!0),xu={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:Br,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:o0,randomBytes:Ho,adjustScalarBytes:g0,uvRatio:ew},cs=wu(xu);function b0(r,e,t){if(e.length>255)throw new Error("Context is too big");return t0(e0("SigEd25519 no Ed25519 collisions"),new Uint8Array([t?1:0,e.length]),e,r)}({...xu});({...xu});const ks=(()=>QE({P:as,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:r=>{const e=as,{pow_p_5_8:t,b2:n}=y0(r);return Ie(Pe(t,BigInt(3),e)*n,e)},adjustScalarBytes:g0,randomBytes:Ho}))(),tw=(Br.ORDER+BigInt(3))/BigInt(8);Br.pow(Tc,tw);Br.sqrt(Br.neg(Br.ONE));(Br.ORDER-BigInt(5))/BigInt(8);BigInt(486662);VE(Br,Br.neg(BigInt(486664)));BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235");BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578");BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838");BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952");BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");class E0 extends r0{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,yu(e);const n=os(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,s=new Uint8Array(i);s.set(n.length>i?e.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),s.fill(0)}update(e){return co(this),this.iHash.update(e),this}digestInto(e){co(this),jd(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Yo=(r,e,t)=>new E0(r,e).update(t).digest();Yo.create=(r,e)=>new E0(r,e);function rw(r,e,t){return yu(r),t===void 0&&(t=new Uint8Array(r.outputLen)),Yo(r,os(t),os(e))}const Pa=new Uint8Array([0]),th=new Uint8Array;function nw(r,e,t,n=32){if(yu(r),Rc(n),n>255*r.outputLen)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(n/r.outputLen);t===void 0&&(t=th);const s=new Uint8Array(i*r.outputLen),o=Yo.create(r,e),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let u=0;u<i;u++)Pa[0]=u+1,a.update(u===0?th:c).update(t).update(Pa).digestInto(c),s.set(c,r.outputLen*u),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),Pa.fill(0),s.slice(0,n)}const iw=(r,e,t)=>r&e^~r&t,sw=(r,e,t)=>r&e^r&t^e&t,ow=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Kr=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Vr=new Uint32Array(64);class aw extends i0{constructor(){super(64,32,8,!1),this.A=Kr[0]|0,this.B=Kr[1]|0,this.C=Kr[2]|0,this.D=Kr[3]|0,this.E=Kr[4]|0,this.F=Kr[5]|0,this.G=Kr[6]|0,this.H=Kr[7]|0}get(){const{A:e,B:t,C:n,D:i,E:s,F:o,G:a,H:c}=this;return[e,t,n,i,s,o,a,c]}set(e,t,n,i,s,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)Vr[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const p=Vr[h-15],g=Vr[h-2],f=ur(p,7)^ur(p,18)^p>>>3,d=ur(g,17)^ur(g,19)^g>>>10;Vr[h]=d+Vr[h-7]+f+Vr[h-16]|0}let{A:n,B:i,C:s,D:o,E:a,F:c,G:u,H:l}=this;for(let h=0;h<64;h++){const p=ur(a,6)^ur(a,11)^ur(a,25),g=l+p+iw(a,c,u)+ow[h]+Vr[h]|0,d=(ur(n,2)^ur(n,13)^ur(n,22))+sw(n,i,s)|0;l=u,u=c,c=a,a=o+g|0,o=s,s=i,i=n,n=g+d|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,i,s,o,a,c,u,l)}roundClean(){Vr.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const Ks=n0(()=>new aw),cw={hashSHA256(r){return Ks(r)},getHKDF(r,e){const t=rw(Ks,e,r),i=nw(Ks,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){const r=ks.utils.randomPrivateKey();return{publicKey:ks.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:ks.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return ks.getSharedSecret(r,e)},chaCha20Poly1305Encrypt(r,e,t,n){return Yl(n,e,t).encrypt(r)},chaCha20Poly1305Decrypt(r,e,t,n,i){return Yl(n,e,t).decrypt(r,i)}},uw=r=>globalThis.Buffer?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r),uo=r=>{const e=uw(2);return new DataView(e.buffer,e.byteOffset,e.byteLength).setUint16(0,r,!1),e};uo.bytes=2;const Vs=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");return r instanceof Uint8Array?new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,!1):r.getUint16(0)};Vs.bytes=2;function lw(r){return et([r.ne,r.ciphertext],r.ne.length+r.ciphertext.length)}function hw(r){return et([r.ne,r.ns,r.ciphertext],r.ne.length+r.ns.length+r.ciphertext.length)}function fw(r){return et([r.ns,r.ciphertext],r.ns.length+r.ciphertext.length)}function dw(r){if(r.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:r.subarray(0,32),ciphertext:r.subarray(32,r.length),ns:new Uint8Array(0)}}function pw(r){if(r.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:r.subarray(0,32),ns:r.subarray(32,80),ciphertext:r.subarray(80,r.length)}}function mw(r){if(r.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:r.subarray(0,48),ciphertext:r.subarray(48,r.length)}}const rh=16;function yw(r,e){return async function*(t){for await(const n of t)for(let i=0;i<n.length;i+=Kl){let s=i+Kl;s>n.length&&(s=n.length);const o=r.encrypt(n.subarray(i,s),r.session);e?.encryptedPackets.increment(),yield uo(o.byteLength),yield o}}}function gw(r,e){return async function*(t){for await(const n of t)for(let i=0;i<n.length;i+=ss){let s=i+ss;if(s>n.length&&(s=n.length),s-rh<i)throw new Error("Invalid chunk");const o=n.subarray(i,s),a=n.subarray(i,s-rh),{plaintext:c,valid:u}=r.decrypt(o,r.session,a);if(!u)throw e?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");e?.decryptedPackets.increment(),yield c}}}var Be={options:{usePureJavaScript:!1}};const Ze=jt(Be);var w0={exports:{}},vu={},bw=vu,nh={};vu.encode=function(r,e,t){if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');if(t!==void 0&&typeof t!="number")throw new TypeError('"maxline" must be a number.');var n="";if(!(r instanceof Uint8Array))n=Ew(r,e);else{var i=0,s=e.length,o=e.charAt(0),a=[0];for(i=0;i<r.length;++i){for(var c=0,u=r[i];c<a.length;++c)u+=a[c]<<8,a[c]=u%s,u=u/s|0;for(;u>0;)a.push(u%s),u=u/s|0}for(i=0;r[i]===0&&i<r.length-1;++i)n+=o;for(i=a.length-1;i>=0;--i)n+=e[a[i]]}if(t){var l=new RegExp(".{1,"+t+"}","g");n=n.match(l).join(`\r
`)}return n};vu.decode=function(r,e){if(typeof r!="string")throw new TypeError('"input" must be a string.');if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');var t=nh[e];if(!t){t=nh[e]=[];for(var n=0;n<e.length;++n)t[e.charCodeAt(n)]=n}r=r.replace(/\s/g,"");for(var i=e.length,s=e.charAt(0),o=[0],n=0;n<r.length;n++){var a=t[r.charCodeAt(n)];if(a===void 0)return;for(var c=0,u=a;c<o.length;++c)u+=o[c]*i,o[c]=u&255,u>>=8;for(;u>0;)o.push(u&255),u>>=8}for(var l=0;r[l]===s&&l<r.length-1;++l)o.push(0);return typeof Buffer<"u"?Buffer.from(o.reverse()):new Uint8Array(o.reverse())};function Ew(r,e){var t=0,n=e.length,i=e.charAt(0),s=[0];for(t=0;t<r.length();++t){for(var o=0,a=r.at(t);o<s.length;++o)a+=s[o]<<8,s[o]=a%n,a=a/n|0;for(;a>0;)s.push(a%n),a=a/n|0}var c="";for(t=0;r.at(t)===0&&t<r.length()-1;++t)c+=i;for(t=s.length-1;t>=0;--t)c+=e[s[t]];return c}var ih=Be,sh=bw,_=w0.exports=ih.util=ih.util||{};(function(){if(typeof process<"u"&&process.nextTick&&!process.browser){_.nextTick=process.nextTick,typeof setImmediate=="function"?_.setImmediate=setImmediate:_.setImmediate=_.nextTick;return}if(typeof setImmediate=="function"){_.setImmediate=function(){return setImmediate.apply(void 0,arguments)},_.nextTick=function(o){return setImmediate(o)};return}if(_.setImmediate=function(o){setTimeout(o,0)},typeof window<"u"&&typeof window.postMessage=="function"){let o=function(a){if(a.source===window&&a.data===r){a.stopPropagation();var c=e.slice();e.length=0,c.forEach(function(u){u()})}};var r="forge.setImmediate",e=[];_.setImmediate=function(a){e.push(a),e.length===1&&window.postMessage(r,"*")},window.addEventListener("message",o,!0)}if(typeof MutationObserver<"u"){var t=Date.now(),n=!0,i=document.createElement("div"),e=[];new MutationObserver(function(){var a=e.slice();e.length=0,a.forEach(function(c){c()})}).observe(i,{attributes:!0});var s=_.setImmediate;_.setImmediate=function(a){Date.now()-t>15?(t=Date.now(),s(a)):(e.push(a),e.length===1&&i.setAttribute("a",n=!n))}}_.nextTick=_.setImmediate})();_.isNodejs=typeof process<"u"&&process.versions&&process.versions.node;_.globalScope=function(){return _.isNodejs?Mo:typeof self>"u"?window:self}();_.isArray=Array.isArray||function(r){return Object.prototype.toString.call(r)==="[object Array]"};_.isArrayBuffer=function(r){return typeof ArrayBuffer<"u"&&r instanceof ArrayBuffer};_.isArrayBufferView=function(r){return r&&_.isArrayBuffer(r.buffer)&&r.byteLength!==void 0};function Es(r){if(!(r===8||r===16||r===24||r===32))throw new Error("Only 8, 16, 24, or 32 bits supported: "+r)}_.ByteBuffer=_u;function _u(r){if(this.data="",this.read=0,typeof r=="string")this.data=r;else if(_.isArrayBuffer(r)||_.isArrayBufferView(r))if(typeof Buffer<"u"&&r instanceof Buffer)this.data=r.toString("binary");else{var e=new Uint8Array(r);try{this.data=String.fromCharCode.apply(null,e)}catch{for(var t=0;t<e.length;++t)this.putByte(e[t])}}else(r instanceof _u||typeof r=="object"&&typeof r.data=="string"&&typeof r.read=="number")&&(this.data=r.data,this.read=r.read);this._constructedStringLength=0}_.ByteStringBuffer=_u;var ww=4096;_.ByteStringBuffer.prototype._optimizeConstructedString=function(r){this._constructedStringLength+=r,this._constructedStringLength>ww&&(this.data.substr(0,1),this._constructedStringLength=0)};_.ByteStringBuffer.prototype.length=function(){return this.data.length-this.read};_.ByteStringBuffer.prototype.isEmpty=function(){return this.length()<=0};_.ByteStringBuffer.prototype.putByte=function(r){return this.putBytes(String.fromCharCode(r))};_.ByteStringBuffer.prototype.fillWithByte=function(r,e){r=String.fromCharCode(r);for(var t=this.data;e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return this.data=t,this._optimizeConstructedString(e),this};_.ByteStringBuffer.prototype.putBytes=function(r){return this.data+=r,this._optimizeConstructedString(r.length),this};_.ByteStringBuffer.prototype.putString=function(r){return this.putBytes(_.encodeUtf8(r))};_.ByteStringBuffer.prototype.putInt16=function(r){return this.putBytes(String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};_.ByteStringBuffer.prototype.putInt24=function(r){return this.putBytes(String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};_.ByteStringBuffer.prototype.putInt32=function(r){return this.putBytes(String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};_.ByteStringBuffer.prototype.putInt16Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255))};_.ByteStringBuffer.prototype.putInt24Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255))};_.ByteStringBuffer.prototype.putInt32Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>24&255))};_.ByteStringBuffer.prototype.putInt=function(r,e){Es(e);var t="";do e-=8,t+=String.fromCharCode(r>>e&255);while(e>0);return this.putBytes(t)};_.ByteStringBuffer.prototype.putSignedInt=function(r,e){return r<0&&(r+=2<<e-1),this.putInt(r,e)};_.ByteStringBuffer.prototype.putBuffer=function(r){return this.putBytes(r.getBytes())};_.ByteStringBuffer.prototype.getByte=function(){return this.data.charCodeAt(this.read++)};_.ByteStringBuffer.prototype.getInt16=function(){var r=this.data.charCodeAt(this.read)<<8^this.data.charCodeAt(this.read+1);return this.read+=2,r};_.ByteStringBuffer.prototype.getInt24=function(){var r=this.data.charCodeAt(this.read)<<16^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2);return this.read+=3,r};_.ByteStringBuffer.prototype.getInt32=function(){var r=this.data.charCodeAt(this.read)<<24^this.data.charCodeAt(this.read+1)<<16^this.data.charCodeAt(this.read+2)<<8^this.data.charCodeAt(this.read+3);return this.read+=4,r};_.ByteStringBuffer.prototype.getInt16Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8;return this.read+=2,r};_.ByteStringBuffer.prototype.getInt24Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16;return this.read+=3,r};_.ByteStringBuffer.prototype.getInt32Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16^this.data.charCodeAt(this.read+3)<<24;return this.read+=4,r};_.ByteStringBuffer.prototype.getInt=function(r){Es(r);var e=0;do e=(e<<8)+this.data.charCodeAt(this.read++),r-=8;while(r>0);return e};_.ByteStringBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};_.ByteStringBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};_.ByteStringBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};_.ByteStringBuffer.prototype.at=function(r){return this.data.charCodeAt(this.read+r)};_.ByteStringBuffer.prototype.setAt=function(r,e){return this.data=this.data.substr(0,this.read+r)+String.fromCharCode(e)+this.data.substr(this.read+r+1),this};_.ByteStringBuffer.prototype.last=function(){return this.data.charCodeAt(this.data.length-1)};_.ByteStringBuffer.prototype.copy=function(){var r=_.createBuffer(this.data);return r.read=this.read,r};_.ByteStringBuffer.prototype.compact=function(){return this.read>0&&(this.data=this.data.slice(this.read),this.read=0),this};_.ByteStringBuffer.prototype.clear=function(){return this.data="",this.read=0,this};_.ByteStringBuffer.prototype.truncate=function(r){var e=Math.max(0,this.length()-r);return this.data=this.data.substr(this.read,e),this.read=0,this};_.ByteStringBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.length;++e){var t=this.data.charCodeAt(e);t<16&&(r+="0"),r+=t.toString(16)}return r};_.ByteStringBuffer.prototype.toString=function(){return _.decodeUtf8(this.bytes())};function xw(r,e){e=e||{},this.read=e.readOffset||0,this.growSize=e.growSize||1024;var t=_.isArrayBuffer(r),n=_.isArrayBufferView(r);if(t||n){t?this.data=new DataView(r):this.data=new DataView(r.buffer,r.byteOffset,r.byteLength),this.write="writeOffset"in e?e.writeOffset:this.data.byteLength;return}this.data=new DataView(new ArrayBuffer(0)),this.write=0,r!=null&&this.putBytes(r),"writeOffset"in e&&(this.write=e.writeOffset)}_.DataBuffer=xw;_.DataBuffer.prototype.length=function(){return this.write-this.read};_.DataBuffer.prototype.isEmpty=function(){return this.length()<=0};_.DataBuffer.prototype.accommodate=function(r,e){if(this.length()>=r)return this;e=Math.max(e||this.growSize,r);var t=new Uint8Array(this.data.buffer,this.data.byteOffset,this.data.byteLength),n=new Uint8Array(this.length()+e);return n.set(t),this.data=new DataView(n.buffer),this};_.DataBuffer.prototype.putByte=function(r){return this.accommodate(1),this.data.setUint8(this.write++,r),this};_.DataBuffer.prototype.fillWithByte=function(r,e){this.accommodate(e);for(var t=0;t<e;++t)this.data.setUint8(r);return this};_.DataBuffer.prototype.putBytes=function(r,e){if(_.isArrayBufferView(r)){var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=t.byteLength-t.byteOffset;this.accommodate(n);var i=new Uint8Array(this.data.buffer,this.write);return i.set(t),this.write+=n,this}if(_.isArrayBuffer(r)){var t=new Uint8Array(r);this.accommodate(t.byteLength);var i=new Uint8Array(this.data.buffer);return i.set(t,this.write),this.write+=t.byteLength,this}if(r instanceof _.DataBuffer||typeof r=="object"&&typeof r.read=="number"&&typeof r.write=="number"&&_.isArrayBufferView(r.data)){var t=new Uint8Array(r.data.byteLength,r.read,r.length());this.accommodate(t.byteLength);var i=new Uint8Array(r.data.byteLength,this.write);return i.set(t),this.write+=t.byteLength,this}if(r instanceof _.ByteStringBuffer&&(r=r.data,e="binary"),e=e||"binary",typeof r=="string"){var s;if(e==="hex")return this.accommodate(Math.ceil(r.length/2)),s=new Uint8Array(this.data.buffer,this.write),this.write+=_.binary.hex.decode(r,s,this.write),this;if(e==="base64")return this.accommodate(Math.ceil(r.length/4)*3),s=new Uint8Array(this.data.buffer,this.write),this.write+=_.binary.base64.decode(r,s,this.write),this;if(e==="utf8"&&(r=_.encodeUtf8(r),e="binary"),e==="binary"||e==="raw")return this.accommodate(r.length),s=new Uint8Array(this.data.buffer,this.write),this.write+=_.binary.raw.decode(s),this;if(e==="utf16")return this.accommodate(r.length*2),s=new Uint16Array(this.data.buffer,this.write),this.write+=_.text.utf16.encode(s),this;throw new Error("Invalid encoding: "+e)}throw Error("Invalid parameter: "+r)};_.DataBuffer.prototype.putBuffer=function(r){return this.putBytes(r),r.clear(),this};_.DataBuffer.prototype.putString=function(r){return this.putBytes(r,"utf16")};_.DataBuffer.prototype.putInt16=function(r){return this.accommodate(2),this.data.setInt16(this.write,r),this.write+=2,this};_.DataBuffer.prototype.putInt24=function(r){return this.accommodate(3),this.data.setInt16(this.write,r>>8&65535),this.data.setInt8(this.write,r>>16&255),this.write+=3,this};_.DataBuffer.prototype.putInt32=function(r){return this.accommodate(4),this.data.setInt32(this.write,r),this.write+=4,this};_.DataBuffer.prototype.putInt16Le=function(r){return this.accommodate(2),this.data.setInt16(this.write,r,!0),this.write+=2,this};_.DataBuffer.prototype.putInt24Le=function(r){return this.accommodate(3),this.data.setInt8(this.write,r>>16&255),this.data.setInt16(this.write,r>>8&65535,!0),this.write+=3,this};_.DataBuffer.prototype.putInt32Le=function(r){return this.accommodate(4),this.data.setInt32(this.write,r,!0),this.write+=4,this};_.DataBuffer.prototype.putInt=function(r,e){Es(e),this.accommodate(e/8);do e-=8,this.data.setInt8(this.write++,r>>e&255);while(e>0);return this};_.DataBuffer.prototype.putSignedInt=function(r,e){return Es(e),this.accommodate(e/8),r<0&&(r+=2<<e-1),this.putInt(r,e)};_.DataBuffer.prototype.getByte=function(){return this.data.getInt8(this.read++)};_.DataBuffer.prototype.getInt16=function(){var r=this.data.getInt16(this.read);return this.read+=2,r};_.DataBuffer.prototype.getInt24=function(){var r=this.data.getInt16(this.read)<<8^this.data.getInt8(this.read+2);return this.read+=3,r};_.DataBuffer.prototype.getInt32=function(){var r=this.data.getInt32(this.read);return this.read+=4,r};_.DataBuffer.prototype.getInt16Le=function(){var r=this.data.getInt16(this.read,!0);return this.read+=2,r};_.DataBuffer.prototype.getInt24Le=function(){var r=this.data.getInt8(this.read)^this.data.getInt16(this.read+1,!0)<<8;return this.read+=3,r};_.DataBuffer.prototype.getInt32Le=function(){var r=this.data.getInt32(this.read,!0);return this.read+=4,r};_.DataBuffer.prototype.getInt=function(r){Es(r);var e=0;do e=(e<<8)+this.data.getInt8(this.read++),r-=8;while(r>0);return e};_.DataBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};_.DataBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};_.DataBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};_.DataBuffer.prototype.at=function(r){return this.data.getUint8(this.read+r)};_.DataBuffer.prototype.setAt=function(r,e){return this.data.setUint8(r,e),this};_.DataBuffer.prototype.last=function(){return this.data.getUint8(this.write-1)};_.DataBuffer.prototype.copy=function(){return new _.DataBuffer(this)};_.DataBuffer.prototype.compact=function(){if(this.read>0){var r=new Uint8Array(this.data.buffer,this.read),e=new Uint8Array(r.byteLength);e.set(r),this.data=new DataView(e),this.write-=this.read,this.read=0}return this};_.DataBuffer.prototype.clear=function(){return this.data=new DataView(new ArrayBuffer(0)),this.read=this.write=0,this};_.DataBuffer.prototype.truncate=function(r){return this.write=Math.max(0,this.length()-r),this.read=Math.min(this.read,this.write),this};_.DataBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.byteLength;++e){var t=this.data.getUint8(e);t<16&&(r+="0"),r+=t.toString(16)}return r};_.DataBuffer.prototype.toString=function(r){var e=new Uint8Array(this.data,this.read,this.length());if(r=r||"utf8",r==="binary"||r==="raw")return _.binary.raw.encode(e);if(r==="hex")return _.binary.hex.encode(e);if(r==="base64")return _.binary.base64.encode(e);if(r==="utf8")return _.text.utf8.decode(e);if(r==="utf16")return _.text.utf16.decode(e);throw new Error("Invalid encoding: "+r)};_.createBuffer=function(r,e){return e=e||"raw",r!==void 0&&e==="utf8"&&(r=_.encodeUtf8(r)),new _.ByteBuffer(r)};_.fillString=function(r,e){for(var t="";e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return t};_.xorBytes=function(r,e,t){for(var n="",i="",s="",o=0,a=0;t>0;--t,++o)i=r.charCodeAt(o)^e.charCodeAt(o),a>=10&&(n+=s,s="",a=0),s+=String.fromCharCode(i),++a;return n+=s,n};_.hexToBytes=function(r){var e="",t=0;for(r.length&!0&&(t=1,e+=String.fromCharCode(parseInt(r[0],16)));t<r.length;t+=2)e+=String.fromCharCode(parseInt(r.substr(t,2),16));return e};_.bytesToHex=function(r){return _.createBuffer(r).toHex()};_.int32ToBytes=function(r){return String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255)};var en="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",tn=[62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,64,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51],x0="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";_.encode64=function(r,e){for(var t="",n="",i,s,o,a=0;a<r.length;)i=r.charCodeAt(a++),s=r.charCodeAt(a++),o=r.charCodeAt(a++),t+=en.charAt(i>>2),t+=en.charAt((i&3)<<4|s>>4),isNaN(s)?t+="==":(t+=en.charAt((s&15)<<2|o>>6),t+=isNaN(o)?"=":en.charAt(o&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};_.decode64=function(r){r=r.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(var e="",t,n,i,s,o=0;o<r.length;)t=tn[r.charCodeAt(o++)-43],n=tn[r.charCodeAt(o++)-43],i=tn[r.charCodeAt(o++)-43],s=tn[r.charCodeAt(o++)-43],e+=String.fromCharCode(t<<2|n>>4),i!==64&&(e+=String.fromCharCode((n&15)<<4|i>>2),s!==64&&(e+=String.fromCharCode((i&3)<<6|s)));return e};_.encodeUtf8=function(r){return unescape(encodeURIComponent(r))};_.decodeUtf8=function(r){return decodeURIComponent(escape(r))};_.binary={raw:{},hex:{},base64:{},base58:{},baseN:{encode:sh.encode,decode:sh.decode}};_.binary.raw.encode=function(r){return String.fromCharCode.apply(null,r)};_.binary.raw.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var i=t,s=0;s<r.length;++s)n[i++]=r.charCodeAt(s);return e?i-t:n};_.binary.hex.encode=_.bytesToHex;_.binary.hex.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/2))),t=t||0;var i=0,s=t;for(r.length&1&&(i=1,n[s++]=parseInt(r[0],16));i<r.length;i+=2)n[s++]=parseInt(r.substr(i,2),16);return e?s-t:n};_.binary.base64.encode=function(r,e){for(var t="",n="",i,s,o,a=0;a<r.byteLength;)i=r[a++],s=r[a++],o=r[a++],t+=en.charAt(i>>2),t+=en.charAt((i&3)<<4|s>>4),isNaN(s)?t+="==":(t+=en.charAt((s&15)<<2|o>>6),t+=isNaN(o)?"=":en.charAt(o&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};_.binary.base64.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/4)*3)),r=r.replace(/[^A-Za-z0-9\+\/\=]/g,""),t=t||0;for(var i,s,o,a,c=0,u=t;c<r.length;)i=tn[r.charCodeAt(c++)-43],s=tn[r.charCodeAt(c++)-43],o=tn[r.charCodeAt(c++)-43],a=tn[r.charCodeAt(c++)-43],n[u++]=i<<2|s>>4,o!==64&&(n[u++]=(s&15)<<4|o>>2,a!==64&&(n[u++]=(o&3)<<6|a));return e?u-t:n.subarray(0,u)};_.binary.base58.encode=function(r,e){return _.binary.baseN.encode(r,x0,e)};_.binary.base58.decode=function(r,e){return _.binary.baseN.decode(r,x0,e)};_.text={utf8:{},utf16:{}};_.text.utf8.encode=function(r,e,t){r=_.encodeUtf8(r);var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var i=t,s=0;s<r.length;++s)n[i++]=r.charCodeAt(s);return e?i-t:n};_.text.utf8.decode=function(r){return _.decodeUtf8(String.fromCharCode.apply(null,r))};_.text.utf16.encode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length*2));var i=new Uint16Array(n.buffer);t=t||0;for(var s=t,o=t,a=0;a<r.length;++a)i[o++]=r.charCodeAt(a),s+=2;return e?s-t:n};_.text.utf16.decode=function(r){return String.fromCharCode.apply(null,new Uint16Array(r.buffer))};_.deflate=function(r,e,t){if(e=_.decode64(r.deflate(_.encode64(e)).rval),t){var n=2,i=e.charCodeAt(1);i&32&&(n=6),e=e.substring(n,e.length-4)}return e};_.inflate=function(r,e,t){var n=r.inflate(_.encode64(e)).rval;return n===null?null:_.decode64(n)};var Su=function(r,e,t){if(!r)throw new Error("WebStorage not available.");var n;if(t===null?n=r.removeItem(e):(t=_.encode64(JSON.stringify(t)),n=r.setItem(e,t)),typeof n<"u"&&n.rval!==!0){var i=new Error(n.error.message);throw i.id=n.error.id,i.name=n.error.name,i}},Au=function(r,e){if(!r)throw new Error("WebStorage not available.");var t=r.getItem(e);if(r.init)if(t.rval===null){if(t.error){var n=new Error(t.error.message);throw n.id=t.error.id,n.name=t.error.name,n}t=null}else t=t.rval;return t!==null&&(t=JSON.parse(_.decode64(t))),t},vw=function(r,e,t,n){var i=Au(r,e);i===null&&(i={}),i[t]=n,Su(r,e,i)},_w=function(r,e,t){var n=Au(r,e);return n!==null&&(n=t in n?n[t]:null),n},Sw=function(r,e,t){var n=Au(r,e);if(n!==null&&t in n){delete n[t];var i=!0;for(var s in n){i=!1;break}i&&(n=null),Su(r,e,n)}},Aw=function(r,e){Su(r,e,null)},Qo=function(r,e,t){var n=null;typeof t>"u"&&(t=["web","flash"]);var i,s=!1,o=null;for(var a in t){i=t[a];try{if(i==="flash"||i==="both"){if(e[0]===null)throw new Error("Flash local storage not available.");n=r.apply(this,e),s=i==="flash"}(i==="web"||i==="both")&&(e[0]=localStorage,n=r.apply(this,e),s=!0)}catch(c){o=c}if(s)break}if(!s)throw o;return n};_.setItem=function(r,e,t,n,i){Qo(vw,arguments,i)};_.getItem=function(r,e,t,n){return Qo(_w,arguments,n)};_.removeItem=function(r,e,t,n){Qo(Sw,arguments,n)};_.clearItems=function(r,e,t){Qo(Aw,arguments,t)};_.isEmpty=function(r){for(var e in r)if(r.hasOwnProperty(e))return!1;return!0};_.format=function(r){for(var e=/%./g,t,n,i=0,s=[],o=0;t=e.exec(r);){n=r.substring(o,e.lastIndex-2),n.length>0&&s.push(n),o=e.lastIndex;var a=t[0][1];switch(a){case"s":case"o":i<arguments.length?s.push(arguments[i+++1]):s.push("<?>");break;case"%":s.push("%");break;default:s.push("<%"+a+"?>")}}return s.push(r.substring(o)),s.join("")};_.formatNumber=function(r,e,t,n){var i=r,s=isNaN(e=Math.abs(e))?2:e,o=t===void 0?",":t,a=n===void 0?".":n,c=i<0?"-":"",u=parseInt(i=Math.abs(+i||0).toFixed(s),10)+"",l=u.length>3?u.length%3:0;return c+(l?u.substr(0,l)+a:"")+u.substr(l).replace(/(\d{3})(?=\d)/g,"$1"+a)+(s?o+Math.abs(i-u).toFixed(s).slice(2):"")};_.formatSize=function(r){return r>=1073741824?r=_.formatNumber(r/1073741824,2,".","")+" GiB":r>=1048576?r=_.formatNumber(r/1048576,2,".","")+" MiB":r>=1024?r=_.formatNumber(r/1024,0)+" KiB":r=_.formatNumber(r,0)+" bytes",r};_.bytesFromIP=function(r){return r.indexOf(".")!==-1?_.bytesFromIPv4(r):r.indexOf(":")!==-1?_.bytesFromIPv6(r):null};_.bytesFromIPv4=function(r){if(r=r.split("."),r.length!==4)return null;for(var e=_.createBuffer(),t=0;t<r.length;++t){var n=parseInt(r[t],10);if(isNaN(n))return null;e.putByte(n)}return e.getBytes()};_.bytesFromIPv6=function(r){var e=0;r=r.split(":").filter(function(o){return o.length===0&&++e,!0});for(var t=(8-r.length+e)*2,n=_.createBuffer(),i=0;i<8;++i){if(!r[i]||r[i].length===0){n.fillWithByte(0,t),t=0;continue}var s=_.hexToBytes(r[i]);s.length<2&&n.putByte(0),n.putBytes(s)}return n.getBytes()};_.bytesToIP=function(r){return r.length===4?_.bytesToIPv4(r):r.length===16?_.bytesToIPv6(r):null};_.bytesToIPv4=function(r){if(r.length!==4)return null;for(var e=[],t=0;t<r.length;++t)e.push(r.charCodeAt(t));return e.join(".")};_.bytesToIPv6=function(r){if(r.length!==16)return null;for(var e=[],t=[],n=0,i=0;i<r.length;i+=2){for(var s=_.bytesToHex(r[i]+r[i+1]);s[0]==="0"&&s!=="0";)s=s.substr(1);if(s==="0"){var o=t[t.length-1],a=e.length;!o||a!==o.end+1?t.push({start:a,end:a}):(o.end=a,o.end-o.start>t[n].end-t[n].start&&(n=t.length-1))}e.push(s)}if(t.length>0){var c=t[n];c.end-c.start>0&&(e.splice(c.start,c.end-c.start+1,""),c.start===0&&e.unshift(""),c.end===7&&e.push(""))}return e.join(":")};_.estimateCores=function(r,e){if(typeof r=="function"&&(e=r,r={}),r=r||{},"cores"in _&&!r.update)return e(null,_.cores);if(typeof navigator<"u"&&"hardwareConcurrency"in navigator&&navigator.hardwareConcurrency>0)return _.cores=navigator.hardwareConcurrency,e(null,_.cores);if(typeof Worker>"u")return _.cores=1,e(null,_.cores);if(typeof Blob>"u")return _.cores=2,e(null,_.cores);var t=URL.createObjectURL(new Blob(["(",function(){self.addEventListener("message",function(o){var a=Date.now(),c=a+4;self.postMessage({st:a,et:c})})}.toString(),")()"],{type:"application/javascript"}));n([],5,16);function n(o,a,c){if(a===0){var u=Math.floor(o.reduce(function(l,h){return l+h},0)/o.length);return _.cores=Math.max(1,u),URL.revokeObjectURL(t),e(null,_.cores)}i(c,function(l,h){o.push(s(c,h)),n(o,a-1,c)})}function i(o,a){for(var c=[],u=[],l=0;l<o;++l){var h=new Worker(t);h.addEventListener("message",function(p){if(u.push(p.data),u.length===o){for(var g=0;g<o;++g)c[g].terminate();a(null,u)}}),c.push(h)}for(var l=0;l<o;++l)c[l].postMessage(l)}function s(o,a){for(var c=[],u=0;u<o;++u)for(var l=a[u],h=c[u]=[],p=0;p<o;++p)if(u!==p){var g=a[p];(l.st>g.st&&l.st<g.et||g.st>l.st&&g.st<l.et)&&h.push(p)}return c.reduce(function(f,d){return Math.max(f,d.length)},0)}};var Rw=w0.exports;const Iw=jt(Rw);var Yi=Be;Yi.pki=Yi.pki||{};var Lc=Yi.pki.oids=Yi.oids=Yi.oids||{};function O(r,e){Lc[r]=e,Lc[e]=r}function Ee(r,e){Lc[r]=e}O("1.2.840.113549.1.1.1","rsaEncryption");O("1.2.840.113549.1.1.4","md5WithRSAEncryption");O("1.2.840.113549.1.1.5","sha1WithRSAEncryption");O("1.2.840.113549.1.1.7","RSAES-OAEP");O("1.2.840.113549.1.1.8","mgf1");O("1.2.840.113549.1.1.9","pSpecified");O("1.2.840.113549.1.1.10","RSASSA-PSS");O("1.2.840.113549.1.1.11","sha256WithRSAEncryption");O("1.2.840.113549.1.1.12","sha384WithRSAEncryption");O("1.2.840.113549.1.1.13","sha512WithRSAEncryption");O("1.3.101.112","EdDSA25519");O("1.2.840.10040.4.3","dsa-with-sha1");O("1.3.14.3.2.7","desCBC");O("1.3.14.3.2.26","sha1");O("1.3.14.3.2.29","sha1WithRSASignature");O("2.16.840.1.101.3.4.2.1","sha256");O("2.16.840.1.101.3.4.2.2","sha384");O("2.16.840.1.101.3.4.2.3","sha512");O("2.16.840.1.101.3.4.2.4","sha224");O("2.16.840.1.101.3.4.2.5","sha512-224");O("2.16.840.1.101.3.4.2.6","sha512-256");O("1.2.840.113549.2.2","md2");O("1.2.840.113549.2.5","md5");O("1.2.840.113549.1.7.1","data");O("1.2.840.113549.1.7.2","signedData");O("1.2.840.113549.1.7.3","envelopedData");O("1.2.840.113549.1.7.4","signedAndEnvelopedData");O("1.2.840.113549.1.7.5","digestedData");O("1.2.840.113549.1.7.6","encryptedData");O("1.2.840.113549.1.9.1","emailAddress");O("1.2.840.113549.1.9.2","unstructuredName");O("1.2.840.113549.1.9.3","contentType");O("1.2.840.113549.1.9.4","messageDigest");O("1.2.840.113549.1.9.5","signingTime");O("1.2.840.113549.1.9.6","counterSignature");O("1.2.840.113549.1.9.7","challengePassword");O("1.2.840.113549.1.9.8","unstructuredAddress");O("1.2.840.113549.1.9.14","extensionRequest");O("1.2.840.113549.1.9.20","friendlyName");O("1.2.840.113549.1.9.21","localKeyId");O("1.2.840.113549.1.9.22.1","x509Certificate");O("1.2.840.113549.1.12.10.1.1","keyBag");O("1.2.840.113549.1.12.10.1.2","pkcs8ShroudedKeyBag");O("1.2.840.113549.1.12.10.1.3","certBag");O("1.2.840.113549.1.12.10.1.4","crlBag");O("1.2.840.113549.1.12.10.1.5","secretBag");O("1.2.840.113549.1.12.10.1.6","safeContentsBag");O("1.2.840.113549.1.5.13","pkcs5PBES2");O("1.2.840.113549.1.5.12","pkcs5PBKDF2");O("1.2.840.113549.1.12.1.1","pbeWithSHAAnd128BitRC4");O("1.2.840.113549.1.12.1.2","pbeWithSHAAnd40BitRC4");O("1.2.840.113549.1.12.1.3","pbeWithSHAAnd3-KeyTripleDES-CBC");O("1.2.840.113549.1.12.1.4","pbeWithSHAAnd2-KeyTripleDES-CBC");O("1.2.840.113549.1.12.1.5","pbeWithSHAAnd128BitRC2-CBC");O("1.2.840.113549.1.12.1.6","pbewithSHAAnd40BitRC2-CBC");O("1.2.840.113549.2.7","hmacWithSHA1");O("1.2.840.113549.2.8","hmacWithSHA224");O("1.2.840.113549.2.9","hmacWithSHA256");O("1.2.840.113549.2.10","hmacWithSHA384");O("1.2.840.113549.2.11","hmacWithSHA512");O("1.2.840.113549.3.7","des-EDE3-CBC");O("2.16.840.1.101.3.4.1.2","aes128-CBC");O("2.16.840.1.101.3.4.1.22","aes192-CBC");O("2.16.840.1.101.3.4.1.42","aes256-CBC");O("2.5.4.3","commonName");O("2.5.4.4","surname");O("2.5.4.5","serialNumber");O("2.5.4.6","countryName");O("2.5.4.7","localityName");O("2.5.4.8","stateOrProvinceName");O("2.5.4.9","streetAddress");O("2.5.4.10","organizationName");O("2.5.4.11","organizationalUnitName");O("2.5.4.12","title");O("2.5.4.13","description");O("2.5.4.15","businessCategory");O("2.5.4.17","postalCode");O("2.5.4.42","givenName");O("1.3.6.1.4.1.311.60.2.1.2","jurisdictionOfIncorporationStateOrProvinceName");O("1.3.6.1.4.1.311.60.2.1.3","jurisdictionOfIncorporationCountryName");O("2.16.840.1.113730.1.1","nsCertType");O("2.16.840.1.113730.1.13","nsComment");Ee("2.5.29.1","authorityKeyIdentifier");Ee("2.5.29.2","keyAttributes");Ee("2.5.29.3","certificatePolicies");Ee("2.5.29.4","keyUsageRestriction");Ee("2.5.29.5","policyMapping");Ee("2.5.29.6","subtreesConstraint");Ee("2.5.29.7","subjectAltName");Ee("2.5.29.8","issuerAltName");Ee("2.5.29.9","subjectDirectoryAttributes");Ee("2.5.29.10","basicConstraints");Ee("2.5.29.11","nameConstraints");Ee("2.5.29.12","policyConstraints");Ee("2.5.29.13","basicConstraints");O("2.5.29.14","subjectKeyIdentifier");O("2.5.29.15","keyUsage");Ee("2.5.29.16","privateKeyUsagePeriod");O("2.5.29.17","subjectAltName");O("2.5.29.18","issuerAltName");O("2.5.29.19","basicConstraints");Ee("2.5.29.20","cRLNumber");Ee("2.5.29.21","cRLReason");Ee("2.5.29.22","expirationDate");Ee("2.5.29.23","instructionCode");Ee("2.5.29.24","invalidityDate");Ee("2.5.29.25","cRLDistributionPoints");Ee("2.5.29.26","issuingDistributionPoint");Ee("2.5.29.27","deltaCRLIndicator");Ee("2.5.29.28","issuingDistributionPoint");Ee("2.5.29.29","certificateIssuer");Ee("2.5.29.30","nameConstraints");O("2.5.29.31","cRLDistributionPoints");O("2.5.29.32","certificatePolicies");Ee("2.5.29.33","policyMappings");Ee("2.5.29.34","policyConstraints");O("2.5.29.35","authorityKeyIdentifier");Ee("2.5.29.36","policyConstraints");O("2.5.29.37","extKeyUsage");Ee("2.5.29.46","freshestCRL");Ee("2.5.29.54","inhibitAnyPolicy");O("1.3.6.1.4.1.11129.2.4.2","timestampList");O("1.3.6.1.5.5.7.1.1","authorityInfoAccess");O("1.3.6.1.5.5.7.3.1","serverAuth");O("1.3.6.1.5.5.7.3.2","clientAuth");O("1.3.6.1.5.5.7.3.3","codeSigning");O("1.3.6.1.5.5.7.3.4","emailProtection");O("1.3.6.1.5.5.7.3.8","timeStamping");var De=Be,K=De.asn1=De.asn1||{};K.Class={UNIVERSAL:0,APPLICATION:64,CONTEXT_SPECIFIC:128,PRIVATE:192};K.Type={NONE:0,BOOLEAN:1,INTEGER:2,BITSTRING:3,OCTETSTRING:4,NULL:5,OID:6,ODESC:7,EXTERNAL:8,REAL:9,ENUMERATED:10,EMBEDDED:11,UTF8:12,ROID:13,SEQUENCE:16,SET:17,PRINTABLESTRING:19,IA5STRING:22,UTCTIME:23,GENERALIZEDTIME:24,BMPSTRING:30};K.create=function(r,e,t,n,i){if(De.util.isArray(n)){for(var s=[],o=0;o<n.length;++o)n[o]!==void 0&&s.push(n[o]);n=s}var a={tagClass:r,type:e,constructed:t,composed:t||De.util.isArray(n),value:n};return i&&"bitStringContents"in i&&(a.bitStringContents=i.bitStringContents,a.original=K.copy(a)),a};K.copy=function(r,e){var t;if(De.util.isArray(r)){t=[];for(var n=0;n<r.length;++n)t.push(K.copy(r[n],e));return t}return typeof r=="string"?r:(t={tagClass:r.tagClass,type:r.type,constructed:r.constructed,composed:r.composed,value:K.copy(r.value,e)},e&&!e.excludeBitStringContents&&(t.bitStringContents=r.bitStringContents),t)};K.equals=function(r,e,t){if(De.util.isArray(r)){if(!De.util.isArray(e)||r.length!==e.length)return!1;for(var n=0;n<r.length;++n)if(!K.equals(r[n],e[n]))return!1;return!0}if(typeof r!=typeof e)return!1;if(typeof r=="string")return r===e;var i=r.tagClass===e.tagClass&&r.type===e.type&&r.constructed===e.constructed&&r.composed===e.composed&&K.equals(r.value,e.value);return t&&t.includeBitStringContents&&(i=i&&r.bitStringContents===e.bitStringContents),i};K.getBerValueLength=function(r){var e=r.getByte();if(e!==128){var t,n=e&128;return n?t=r.getInt((e&127)<<3):t=e,t}};function qi(r,e,t){if(t>e){var n=new Error("Too few bytes to parse DER.");throw n.available=r.length(),n.remaining=e,n.requested=t,n}}var Cw=function(r,e){var t=r.getByte();if(e--,t!==128){var n,i=t&128;if(!i)n=t;else{var s=t&127;qi(r,e,s),n=r.getInt(s<<3)}if(n<0)throw new Error("Negative length: "+n);return n}};K.fromDer=function(r,e){e===void 0&&(e={strict:!0,parseAllBytes:!0,decodeBitStrings:!0}),typeof e=="boolean"&&(e={strict:e,parseAllBytes:!0,decodeBitStrings:!0}),"strict"in e||(e.strict=!0),"parseAllBytes"in e||(e.parseAllBytes=!0),"decodeBitStrings"in e||(e.decodeBitStrings=!0),typeof r=="string"&&(r=De.util.createBuffer(r));var t=r.length(),n=zs(r,r.length(),0,e);if(e.parseAllBytes&&r.length()!==0){var i=new Error("Unparsed DER bytes remain after ASN.1 parsing.");throw i.byteCount=t,i.remaining=r.length(),i}return n};function zs(r,e,t,n){var i;qi(r,e,2);var s=r.getByte();e--;var o=s&192,a=s&31;i=r.length();var c=Cw(r,e);if(e-=i-r.length(),c!==void 0&&c>e){if(n.strict){var u=new Error("Too few bytes to read ASN.1 value.");throw u.available=r.length(),u.remaining=e,u.requested=c,u}c=e}var l,h,p=(s&32)===32;if(p)if(l=[],c===void 0)for(;;){if(qi(r,e,2),r.bytes(2)===String.fromCharCode(0,0)){r.getBytes(2),e-=2;break}i=r.length(),l.push(zs(r,e,t+1,n)),e-=i-r.length()}else for(;c>0;)i=r.length(),l.push(zs(r,c,t+1,n)),e-=i-r.length(),c-=i-r.length();if(l===void 0&&o===K.Class.UNIVERSAL&&a===K.Type.BITSTRING&&(h=r.bytes(c)),l===void 0&&n.decodeBitStrings&&o===K.Class.UNIVERSAL&&a===K.Type.BITSTRING&&c>1){var g=r.read,f=e,d=0;if(a===K.Type.BITSTRING&&(qi(r,e,1),d=r.getByte(),e--),d===0)try{i=r.length();var m={strict:!0,decodeBitStrings:!0},y=zs(r,e,t+1,m),E=i-r.length();e-=E,a==K.Type.BITSTRING&&E++;var b=y.tagClass;E===c&&(b===K.Class.UNIVERSAL||b===K.Class.CONTEXT_SPECIFIC)&&(l=[y])}catch{}l===void 0&&(r.read=g,e=f)}if(l===void 0){if(c===void 0){if(n.strict)throw new Error("Non-constructed ASN.1 object of indefinite length.");c=e}if(a===K.Type.BMPSTRING)for(l="";c>0;c-=2)qi(r,e,2),l+=String.fromCharCode(r.getInt16()),e-=2;else l=r.getBytes(c),e-=c}var x=h===void 0?null:{bitStringContents:h};return K.create(o,a,p,l,x)}K.toDer=function(r){var e=De.util.createBuffer(),t=r.tagClass|r.type,n=De.util.createBuffer(),i=!1;if("bitStringContents"in r&&(i=!0,r.original&&(i=K.equals(r,r.original))),i)n.putBytes(r.bitStringContents);else if(r.composed){r.constructed?t|=32:n.putByte(0);for(var s=0;s<r.value.length;++s)r.value[s]!==void 0&&n.putBuffer(K.toDer(r.value[s]))}else if(r.type===K.Type.BMPSTRING)for(var s=0;s<r.value.length;++s)n.putInt16(r.value.charCodeAt(s));else r.type===K.Type.INTEGER&&r.value.length>1&&(r.value.charCodeAt(0)===0&&!(r.value.charCodeAt(1)&128)||r.value.charCodeAt(0)===255&&(r.value.charCodeAt(1)&128)===128)?n.putBytes(r.value.substr(1)):n.putBytes(r.value);if(e.putByte(t),n.length()<=127)e.putByte(n.length()&127);else{var o=n.length(),a="";do a+=String.fromCharCode(o&255),o=o>>>8;while(o>0);e.putByte(a.length|128);for(var s=a.length-1;s>=0;--s)e.putByte(a.charCodeAt(s))}return e.putBuffer(n),e};K.oidToDer=function(r){var e=r.split("."),t=De.util.createBuffer();t.putByte(40*parseInt(e[0],10)+parseInt(e[1],10));for(var n,i,s,o,a=2;a<e.length;++a){n=!0,i=[],s=parseInt(e[a],10);do o=s&127,s=s>>>7,n||(o|=128),i.push(o),n=!1;while(s>0);for(var c=i.length-1;c>=0;--c)t.putByte(i[c])}return t};K.derToOid=function(r){var e;typeof r=="string"&&(r=De.util.createBuffer(r));var t=r.getByte();e=Math.floor(t/40)+"."+t%40;for(var n=0;r.length()>0;)t=r.getByte(),n=n<<7,t&128?n+=t&127:(e+="."+(n+t),n=0);return e};K.utcTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,2),10);t=t>=50?1900+t:2e3+t;var n=parseInt(r.substr(2,2),10)-1,i=parseInt(r.substr(4,2),10),s=parseInt(r.substr(6,2),10),o=parseInt(r.substr(8,2),10),a=0;if(r.length>11){var c=r.charAt(10),u=10;c!=="+"&&c!=="-"&&(a=parseInt(r.substr(10,2),10),u+=2)}if(e.setUTCFullYear(t,n,i),e.setUTCHours(s,o,a,0),u&&(c=r.charAt(u),c==="+"||c==="-")){var l=parseInt(r.substr(u+1,2),10),h=parseInt(r.substr(u+4,2),10),p=l*60+h;p*=6e4,c==="+"?e.setTime(+e-p):e.setTime(+e+p)}return e};K.generalizedTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,4),10),n=parseInt(r.substr(4,2),10)-1,i=parseInt(r.substr(6,2),10),s=parseInt(r.substr(8,2),10),o=parseInt(r.substr(10,2),10),a=parseInt(r.substr(12,2),10),c=0,u=0,l=!1;r.charAt(r.length-1)==="Z"&&(l=!0);var h=r.length-5,p=r.charAt(h);if(p==="+"||p==="-"){var g=parseInt(r.substr(h+1,2),10),f=parseInt(r.substr(h+4,2),10);u=g*60+f,u*=6e4,p==="+"&&(u*=-1),l=!0}return r.charAt(14)==="."&&(c=parseFloat(r.substr(14),10)*1e3),l?(e.setUTCFullYear(t,n,i),e.setUTCHours(s,o,a,c),e.setTime(+e+u)):(e.setFullYear(t,n,i),e.setHours(s,o,a,c)),e};K.dateToUtcTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push((""+r.getUTCFullYear()).substr(2)),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};K.dateToGeneralizedTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push(""+r.getUTCFullYear()),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};K.integerToDer=function(r){var e=De.util.createBuffer();if(r>=-128&&r<128)return e.putSignedInt(r,8);if(r>=-32768&&r<32768)return e.putSignedInt(r,16);if(r>=-8388608&&r<8388608)return e.putSignedInt(r,24);if(r>=-2147483648&&r<2147483648)return e.putSignedInt(r,32);var t=new Error("Integer too large; max is 32-bits.");throw t.integer=r,t};K.derToInteger=function(r){typeof r=="string"&&(r=De.util.createBuffer(r));var e=r.length()*8;if(e>32)throw new Error("Integer too large; max is 32-bits.");return r.getSignedInt(e)};K.validate=function(r,e,t,n){var i=!1;if((r.tagClass===e.tagClass||typeof e.tagClass>"u")&&(r.type===e.type||typeof e.type>"u"))if(r.constructed===e.constructed||typeof e.constructed>"u"){if(i=!0,e.value&&De.util.isArray(e.value))for(var s=0,o=0;i&&o<e.value.length;++o)i=e.value[o].optional||!1,r.value[s]&&(i=K.validate(r.value[s],e.value[o],t,n),i?++s:e.value[o].optional&&(i=!0)),!i&&n&&n.push("["+e.name+'] Tag class "'+e.tagClass+'", type "'+e.type+'" expected value length "'+e.value.length+'", got "'+r.value.length+'"');if(i&&t&&(e.capture&&(t[e.capture]=r.value),e.captureAsn1&&(t[e.captureAsn1]=r),e.captureBitStringContents&&"bitStringContents"in r&&(t[e.captureBitStringContents]=r.bitStringContents),e.captureBitStringValue&&"bitStringContents"in r))if(r.bitStringContents.length<2)t[e.captureBitStringValue]="";else{var a=r.bitStringContents.charCodeAt(0);if(a!==0)throw new Error("captureBitStringValue only supported for zero unused bits");t[e.captureBitStringValue]=r.bitStringContents.slice(1)}}else n&&n.push("["+e.name+'] Expected constructed "'+e.constructed+'", got "'+r.constructed+'"');else n&&(r.tagClass!==e.tagClass&&n.push("["+e.name+'] Expected tag class "'+e.tagClass+'", got "'+r.tagClass+'"'),r.type!==e.type&&n.push("["+e.name+'] Expected type "'+e.type+'", got "'+r.type+'"'));return i};var oh=/[^\\u0000-\\u00ff]/;K.prettyPrint=function(r,e,t){var n="";e=e||0,t=t||2,e>0&&(n+=`
`);for(var i="",s=0;s<e*t;++s)i+=" ";switch(n+=i+"Tag: ",r.tagClass){case K.Class.UNIVERSAL:n+="Universal:";break;case K.Class.APPLICATION:n+="Application:";break;case K.Class.CONTEXT_SPECIFIC:n+="Context-Specific:";break;case K.Class.PRIVATE:n+="Private:";break}if(r.tagClass===K.Class.UNIVERSAL)switch(n+=r.type,r.type){case K.Type.NONE:n+=" (None)";break;case K.Type.BOOLEAN:n+=" (Boolean)";break;case K.Type.INTEGER:n+=" (Integer)";break;case K.Type.BITSTRING:n+=" (Bit string)";break;case K.Type.OCTETSTRING:n+=" (Octet string)";break;case K.Type.NULL:n+=" (Null)";break;case K.Type.OID:n+=" (Object Identifier)";break;case K.Type.ODESC:n+=" (Object Descriptor)";break;case K.Type.EXTERNAL:n+=" (External or Instance of)";break;case K.Type.REAL:n+=" (Real)";break;case K.Type.ENUMERATED:n+=" (Enumerated)";break;case K.Type.EMBEDDED:n+=" (Embedded PDV)";break;case K.Type.UTF8:n+=" (UTF8)";break;case K.Type.ROID:n+=" (Relative Object Identifier)";break;case K.Type.SEQUENCE:n+=" (Sequence)";break;case K.Type.SET:n+=" (Set)";break;case K.Type.PRINTABLESTRING:n+=" (Printable String)";break;case K.Type.IA5String:n+=" (IA5String (ASCII))";break;case K.Type.UTCTIME:n+=" (UTC time)";break;case K.Type.GENERALIZEDTIME:n+=" (Generalized time)";break;case K.Type.BMPSTRING:n+=" (BMP String)";break}else n+=r.type;if(n+=`
`,n+=i+"Constructed: "+r.constructed+`
`,r.composed){for(var o=0,a="",s=0;s<r.value.length;++s)r.value[s]!==void 0&&(o+=1,a+=K.prettyPrint(r.value[s],e+1,t),s+1<r.value.length&&(a+=","));n+=i+"Sub values: "+o+a}else{if(n+=i+"Value: ",r.type===K.Type.OID){var c=K.derToOid(r.value);n+=c,De.pki&&De.pki.oids&&c in De.pki.oids&&(n+=" ("+De.pki.oids[c]+") ")}if(r.type===K.Type.INTEGER)try{n+=K.derToInteger(r.value)}catch{n+="0x"+De.util.bytesToHex(r.value)}else if(r.type===K.Type.BITSTRING){if(r.value.length>1?n+="0x"+De.util.bytesToHex(r.value.slice(1)):n+="(none)",r.value.length>0){var u=r.value.charCodeAt(0);u==1?n+=" (1 unused bit shown)":u>1&&(n+=" ("+u+" unused bits shown)")}}else if(r.type===K.Type.OCTETSTRING)oh.test(r.value)||(n+="("+r.value+") "),n+="0x"+De.util.bytesToHex(r.value);else if(r.type===K.Type.UTF8)try{n+=De.util.decodeUtf8(r.value)}catch(l){if(l.message==="URI malformed")n+="0x"+De.util.bytesToHex(r.value)+" (malformed UTF8)";else throw l}else r.type===K.Type.PRINTABLESTRING||r.type===K.Type.IA5String?n+=r.value:oh.test(r.value)?n+="0x"+De.util.bytesToHex(r.value):r.value.length===0?n+="[null]":n+=r.value}return n};var Je=Be;Je.cipher=Je.cipher||{};Je.cipher.algorithms=Je.cipher.algorithms||{};Je.cipher.createCipher=function(r,e){var t=r;if(typeof t=="string"&&(t=Je.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new Je.cipher.BlockCipher({algorithm:t,key:e,decrypt:!1})};Je.cipher.createDecipher=function(r,e){var t=r;if(typeof t=="string"&&(t=Je.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new Je.cipher.BlockCipher({algorithm:t,key:e,decrypt:!0})};Je.cipher.registerAlgorithm=function(r,e){r=r.toUpperCase(),Je.cipher.algorithms[r]=e};Je.cipher.getAlgorithm=function(r){return r=r.toUpperCase(),r in Je.cipher.algorithms?Je.cipher.algorithms[r]:null};var Ru=Je.cipher.BlockCipher=function(r){this.algorithm=r.algorithm,this.mode=this.algorithm.mode,this.blockSize=this.mode.blockSize,this._finish=!1,this._input=null,this.output=null,this._op=r.decrypt?this.mode.decrypt:this.mode.encrypt,this._decrypt=r.decrypt,this.algorithm.initialize(r)};Ru.prototype.start=function(r){r=r||{};var e={};for(var t in r)e[t]=r[t];e.decrypt=this._decrypt,this._finish=!1,this._input=Je.util.createBuffer(),this.output=r.output||Je.util.createBuffer(),this.mode.start(e)};Ru.prototype.update=function(r){for(r&&this._input.putBuffer(r);!this._op.call(this.mode,this._input,this.output,this._finish)&&!this._finish;);this._input.compact()};Ru.prototype.finish=function(r){r&&(this.mode.name==="ECB"||this.mode.name==="CBC")&&(this.mode.pad=function(t){return r(this.blockSize,t,!1)},this.mode.unpad=function(t){return r(this.blockSize,t,!0)});var e={};return e.decrypt=this._decrypt,e.overflow=this._input.length()%this.blockSize,!(!this._decrypt&&this.mode.pad&&!this.mode.pad(this._input,e)||(this._finish=!0,this.update(),this._decrypt&&this.mode.unpad&&!this.mode.unpad(this.output,e))||this.mode.afterFinish&&!this.mode.afterFinish(this.output,e))};var Qe=Be;Qe.cipher=Qe.cipher||{};var le=Qe.cipher.modes=Qe.cipher.modes||{};le.ecb=function(r){r=r||{},this.name="ECB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};le.ecb.prototype.start=function(r){};le.ecb.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};le.ecb.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};le.ecb.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};le.ecb.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};le.cbc=function(r){r=r||{},this.name="CBC",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};le.cbc.prototype.start=function(r){if(r.iv===null){if(!this._prev)throw new Error("Invalid IV parameter.");this._iv=this._prev.slice(0)}else if("iv"in r)this._iv=Xo(r.iv,this.blockSize),this._prev=this._iv.slice(0);else throw new Error("Invalid IV parameter.")};le.cbc.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=this._prev[n]^r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n]);this._prev=this._outBlock};le.cbc.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._prev[n]^this._outBlock[n]);this._prev=this._inBlock.slice(0)};le.cbc.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};le.cbc.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};le.cfb=function(r){r=r||{},this.name="CFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialBlock=new Array(this._ints),this._partialOutput=Qe.util.createBuffer(),this._partialBytes=0};le.cfb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=Xo(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};le.cfb.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)this._inBlock[i]=r.getInt32()^this._outBlock[i],e.putInt32(this._inBlock[i]);return}var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialBlock[i]=r.getInt32()^this._outBlock[i],this._partialOutput.putInt32(this._partialBlock[i]);if(s>0)r.read-=this.blockSize;else for(var i=0;i<this._ints;++i)this._inBlock[i]=this._partialBlock[i];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};le.cfb.prototype.decrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)this._inBlock[i]=r.getInt32(),e.putInt32(this._inBlock[i]^this._outBlock[i]);return}var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialBlock[i]=r.getInt32(),this._partialOutput.putInt32(this._partialBlock[i]^this._outBlock[i]);if(s>0)r.read-=this.blockSize;else for(var i=0;i<this._ints;++i)this._inBlock[i]=this._partialBlock[i];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};le.ofb=function(r){r=r||{},this.name="OFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=Qe.util.createBuffer(),this._partialBytes=0};le.ofb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=Xo(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};le.ofb.prototype.encrypt=function(r,e,t){var n=r.length();if(r.length()===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)e.putInt32(r.getInt32()^this._outBlock[i]),this._inBlock[i]=this._outBlock[i];return}var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialOutput.putInt32(r.getInt32()^this._outBlock[i]);if(s>0)r.read-=this.blockSize;else for(var i=0;i<this._ints;++i)this._inBlock[i]=this._outBlock[i];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};le.ofb.prototype.decrypt=le.ofb.prototype.encrypt;le.ctr=function(r){r=r||{},this.name="CTR",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=Qe.util.createBuffer(),this._partialBytes=0};le.ctr.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=Xo(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};le.ctr.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize)for(var i=0;i<this._ints;++i)e.putInt32(r.getInt32()^this._outBlock[i]);else{var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialOutput.putInt32(r.getInt32()^this._outBlock[i]);if(s>0&&(r.read-=this.blockSize),this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}Zo(this._inBlock)};le.ctr.prototype.decrypt=le.ctr.prototype.encrypt;le.gcm=function(r){r=r||{},this.name="GCM",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints),this._partialOutput=Qe.util.createBuffer(),this._partialBytes=0,this._R=3774873600};le.gcm.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");var e=Qe.util.createBuffer(r.iv);this._cipherLength=0;var t;if("additionalData"in r?t=Qe.util.createBuffer(r.additionalData):t=Qe.util.createBuffer(),"tagLength"in r?this._tagLength=r.tagLength:this._tagLength=128,this._tag=null,r.decrypt&&(this._tag=Qe.util.createBuffer(r.tag).getBytes(),this._tag.length!==this._tagLength/8))throw new Error("Authentication tag does not match tag length.");this._hashBlock=new Array(this._ints),this.tag=null,this._hashSubkey=new Array(this._ints),this.cipher.encrypt([0,0,0,0],this._hashSubkey),this.componentBits=4,this._m=this.generateHashTable(this._hashSubkey,this.componentBits);var n=e.length();if(n===12)this._j0=[e.getInt32(),e.getInt32(),e.getInt32(),1];else{for(this._j0=[0,0,0,0];e.length()>0;)this._j0=this.ghash(this._hashSubkey,this._j0,[e.getInt32(),e.getInt32(),e.getInt32(),e.getInt32()]);this._j0=this.ghash(this._hashSubkey,this._j0,[0,0].concat(kc(n*8)))}this._inBlock=this._j0.slice(0),Zo(this._inBlock),this._partialBytes=0,t=Qe.util.createBuffer(t),this._aDataLength=kc(t.length()*8);var i=t.length()%this.blockSize;for(i&&t.fillWithByte(0,this.blockSize-i),this._s=[0,0,0,0];t.length()>0;)this._s=this.ghash(this._hashSubkey,this._s,[t.getInt32(),t.getInt32(),t.getInt32(),t.getInt32()])};le.gcm.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var i=0;i<this._ints;++i)e.putInt32(this._outBlock[i]^=r.getInt32());this._cipherLength+=this.blockSize}else{var s=(this.blockSize-n)%this.blockSize;s>0&&(s=this.blockSize-s),this._partialOutput.clear();for(var i=0;i<this._ints;++i)this._partialOutput.putInt32(r.getInt32()^this._outBlock[i]);if(s<=0||t){if(t){var o=n%this.blockSize;this._cipherLength+=o,this._partialOutput.truncate(this.blockSize-o)}else this._cipherLength+=this.blockSize;for(var i=0;i<this._ints;++i)this._outBlock[i]=this._partialOutput.getInt32();this._partialOutput.read-=this.blockSize}if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),s>0&&!t)return r.read-=this.blockSize,e.putBytes(this._partialOutput.getBytes(s-this._partialBytes)),this._partialBytes=s,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}this._s=this.ghash(this._hashSubkey,this._s,this._outBlock),Zo(this._inBlock)};le.gcm.prototype.decrypt=function(r,e,t){var n=r.length();if(n<this.blockSize&&!(t&&n>0))return!0;this.cipher.encrypt(this._inBlock,this._outBlock),Zo(this._inBlock),this._hashBlock[0]=r.getInt32(),this._hashBlock[1]=r.getInt32(),this._hashBlock[2]=r.getInt32(),this._hashBlock[3]=r.getInt32(),this._s=this.ghash(this._hashSubkey,this._s,this._hashBlock);for(var i=0;i<this._ints;++i)e.putInt32(this._outBlock[i]^this._hashBlock[i]);n<this.blockSize?this._cipherLength+=n%this.blockSize:this._cipherLength+=this.blockSize};le.gcm.prototype.afterFinish=function(r,e){var t=!0;e.decrypt&&e.overflow&&r.truncate(this.blockSize-e.overflow),this.tag=Qe.util.createBuffer();var n=this._aDataLength.concat(kc(this._cipherLength*8));this._s=this.ghash(this._hashSubkey,this._s,n);var i=[];this.cipher.encrypt(this._j0,i);for(var s=0;s<this._ints;++s)this.tag.putInt32(this._s[s]^i[s]);return this.tag.truncate(this.tag.length()%(this._tagLength/8)),e.decrypt&&this.tag.bytes()!==this._tag&&(t=!1),t};le.gcm.prototype.multiply=function(r,e){for(var t=[0,0,0,0],n=e.slice(0),i=0;i<128;++i){var s=r[i/32|0]&1<<31-i%32;s&&(t[0]^=n[0],t[1]^=n[1],t[2]^=n[2],t[3]^=n[3]),this.pow(n,n)}return t};le.gcm.prototype.pow=function(r,e){for(var t=r[3]&1,n=3;n>0;--n)e[n]=r[n]>>>1|(r[n-1]&1)<<31;e[0]=r[0]>>>1,t&&(e[0]^=this._R)};le.gcm.prototype.tableMultiply=function(r){for(var e=[0,0,0,0],t=0;t<32;++t){var n=t/8|0,i=r[n]>>>(7-t%8)*4&15,s=this._m[t][i];e[0]^=s[0],e[1]^=s[1],e[2]^=s[2],e[3]^=s[3]}return e};le.gcm.prototype.ghash=function(r,e,t){return e[0]^=t[0],e[1]^=t[1],e[2]^=t[2],e[3]^=t[3],this.tableMultiply(e)};le.gcm.prototype.generateHashTable=function(r,e){for(var t=8/e,n=4*t,i=16*t,s=new Array(i),o=0;o<i;++o){var a=[0,0,0,0],c=o/n|0,u=(n-1-o%n)*e;a[c]=1<<e-1<<u,s[o]=this.generateSubHashTable(this.multiply(a,r),e)}return s};le.gcm.prototype.generateSubHashTable=function(r,e){var t=1<<e,n=t>>>1,i=new Array(t);i[n]=r.slice(0);for(var s=n>>>1;s>0;)this.pow(i[2*s],i[s]=[]),s>>=1;for(s=2;s<n;){for(var o=1;o<s;++o){var a=i[s],c=i[o];i[s+o]=[a[0]^c[0],a[1]^c[1],a[2]^c[2],a[3]^c[3]]}s*=2}for(i[0]=[0,0,0,0],s=n+1;s<t;++s){var u=i[s^n];i[s]=[r[0]^u[0],r[1]^u[1],r[2]^u[2],r[3]^u[3]]}return i};function Xo(r,e){if(typeof r=="string"&&(r=Qe.util.createBuffer(r)),Qe.util.isArray(r)&&r.length>4){var t=r;r=Qe.util.createBuffer();for(var n=0;n<t.length;++n)r.putByte(t[n])}if(r.length()<e)throw new Error("Invalid IV length; got "+r.length()+" bytes and expected "+e+" bytes.");if(!Qe.util.isArray(r)){for(var i=[],s=e/4,n=0;n<s;++n)i.push(r.getInt32());r=i}return r}function Zo(r){r[r.length-1]=r[r.length-1]+1&4294967295}function kc(r){return[r/4294967296|0,r&4294967295]}var Ce=Be;Ce.aes=Ce.aes||{};Ce.aes.startEncrypting=function(r,e,t,n){var i=jo({key:r,output:t,decrypt:!1,mode:n});return i.start(e),i};Ce.aes.createEncryptionCipher=function(r,e){return jo({key:r,output:null,decrypt:!1,mode:e})};Ce.aes.startDecrypting=function(r,e,t,n){var i=jo({key:r,output:t,decrypt:!0,mode:n});return i.start(e),i};Ce.aes.createDecryptionCipher=function(r,e){return jo({key:r,output:null,decrypt:!0,mode:e})};Ce.aes.Algorithm=function(r,e){Iu||_0();var t=this;t.name=r,t.mode=new e({blockSize:16,cipher:{encrypt:function(n,i){return Nc(t._w,n,i,!1)},decrypt:function(n,i){return Nc(t._w,n,i,!0)}}}),t._init=!1};Ce.aes.Algorithm.prototype.initialize=function(r){if(!this._init){var e=r.key,t;if(typeof e=="string"&&(e.length===16||e.length===24||e.length===32))e=Ce.util.createBuffer(e);else if(Ce.util.isArray(e)&&(e.length===16||e.length===24||e.length===32)){t=e,e=Ce.util.createBuffer();for(var n=0;n<t.length;++n)e.putByte(t[n])}if(!Ce.util.isArray(e)){t=e,e=[];var i=t.length();if(i===16||i===24||i===32){i=i>>>2;for(var n=0;n<i;++n)e.push(t.getInt32())}}if(!Ce.util.isArray(e)||!(e.length===4||e.length===6||e.length===8))throw new Error("Invalid key parameter.");var s=this.mode.name,o=["CFB","OFB","CTR","GCM"].indexOf(s)!==-1;this._w=S0(e,r.decrypt&&!o),this._init=!0}};Ce.aes._expandKey=function(r,e){return Iu||_0(),S0(r,e)};Ce.aes._updateBlock=Nc;Ai("AES-ECB",Ce.cipher.modes.ecb);Ai("AES-CBC",Ce.cipher.modes.cbc);Ai("AES-CFB",Ce.cipher.modes.cfb);Ai("AES-OFB",Ce.cipher.modes.ofb);Ai("AES-CTR",Ce.cipher.modes.ctr);Ai("AES-GCM",Ce.cipher.modes.gcm);function Ai(r,e){var t=function(){return new Ce.aes.Algorithm(r,e)};Ce.cipher.registerAlgorithm(r,t)}var Iu=!1,qn=4,Et,Pc,v0,Cn,cr;function _0(){Iu=!0,v0=[0,1,2,4,8,16,32,64,128,27,54];for(var r=new Array(256),e=0;e<128;++e)r[e]=e<<1,r[e+128]=e+128<<1^283;Et=new Array(256),Pc=new Array(256),Cn=new Array(4),cr=new Array(4);for(var e=0;e<4;++e)Cn[e]=new Array(256),cr[e]=new Array(256);for(var t=0,n=0,i,s,o,a,c,u,l,e=0;e<256;++e){a=n^n<<1^n<<2^n<<3^n<<4,a=a>>8^a&255^99,Et[t]=a,Pc[a]=t,c=r[a],i=r[t],s=r[i],o=r[s],u=c<<24^a<<16^a<<8^(a^c),l=(i^s^o)<<24^(t^o)<<16^(t^s^o)<<8^(t^i^o);for(var h=0;h<4;++h)Cn[h][t]=u,cr[h][a]=l,u=u<<24|u>>>8,l=l<<24|l>>>8;t===0?t=n=1:(t=i^r[r[r[i^o]]],n^=r[r[n]])}}function S0(r,e){for(var t=r.slice(0),n,i=1,s=t.length,o=s+6+1,a=qn*o,c=s;c<a;++c)n=t[c-1],c%s===0?(n=Et[n>>>16&255]<<24^Et[n>>>8&255]<<16^Et[n&255]<<8^Et[n>>>24]^v0[i]<<24,i++):s>6&&c%s===4&&(n=Et[n>>>24]<<24^Et[n>>>16&255]<<16^Et[n>>>8&255]<<8^Et[n&255]),t[c]=t[c-s]^n;if(e){var u,l=cr[0],h=cr[1],p=cr[2],g=cr[3],f=t.slice(0);a=t.length;for(var c=0,d=a-qn;c<a;c+=qn,d-=qn)if(c===0||c===a-qn)f[c]=t[d],f[c+1]=t[d+3],f[c+2]=t[d+2],f[c+3]=t[d+1];else for(var m=0;m<qn;++m)u=t[d+m],f[c+(3&-m)]=l[Et[u>>>24]]^h[Et[u>>>16&255]]^p[Et[u>>>8&255]]^g[Et[u&255]];t=f}return t}function Nc(r,e,t,n){var i=r.length/4-1,s,o,a,c,u;n?(s=cr[0],o=cr[1],a=cr[2],c=cr[3],u=Pc):(s=Cn[0],o=Cn[1],a=Cn[2],c=Cn[3],u=Et);var l,h,p,g,f,d,m;l=e[0]^r[0],h=e[n?3:1]^r[1],p=e[2]^r[2],g=e[n?1:3]^r[3];for(var y=3,E=1;E<i;++E)f=s[l>>>24]^o[h>>>16&255]^a[p>>>8&255]^c[g&255]^r[++y],d=s[h>>>24]^o[p>>>16&255]^a[g>>>8&255]^c[l&255]^r[++y],m=s[p>>>24]^o[g>>>16&255]^a[l>>>8&255]^c[h&255]^r[++y],g=s[g>>>24]^o[l>>>16&255]^a[h>>>8&255]^c[p&255]^r[++y],l=f,h=d,p=m;t[0]=u[l>>>24]<<24^u[h>>>16&255]<<16^u[p>>>8&255]<<8^u[g&255]^r[++y],t[n?3:1]=u[h>>>24]<<24^u[p>>>16&255]<<16^u[g>>>8&255]<<8^u[l&255]^r[++y],t[2]=u[p>>>24]<<24^u[g>>>16&255]<<16^u[l>>>8&255]<<8^u[h&255]^r[++y],t[n?1:3]=u[g>>>24]<<24^u[l>>>16&255]<<16^u[h>>>8&255]<<8^u[p&255]^r[++y]}function jo(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="AES-"+e,n;r.decrypt?n=Ce.cipher.createDecipher(t,r.key):n=Ce.cipher.createCipher(t,r.key);var i=n.start;return n.start=function(s,o){var a=null;o instanceof Ce.util.ByteBuffer&&(a=o,o={}),o=o||{},o.output=a,o.iv=s,i.call(n,o)},n}var Le=Be;Le.des=Le.des||{};Le.des.startEncrypting=function(r,e,t,n){var i=Jo({key:r,output:t,decrypt:!1,mode:n||(e===null?"ECB":"CBC")});return i.start(e),i};Le.des.createEncryptionCipher=function(r,e){return Jo({key:r,output:null,decrypt:!1,mode:e})};Le.des.startDecrypting=function(r,e,t,n){var i=Jo({key:r,output:t,decrypt:!0,mode:n||(e===null?"ECB":"CBC")});return i.start(e),i};Le.des.createDecryptionCipher=function(r,e){return Jo({key:r,output:null,decrypt:!0,mode:e})};Le.des.Algorithm=function(r,e){var t=this;t.name=r,t.mode=new e({blockSize:8,cipher:{encrypt:function(n,i){return ah(t._keys,n,i,!1)},decrypt:function(n,i){return ah(t._keys,n,i,!0)}}}),t._init=!1};Le.des.Algorithm.prototype.initialize=function(r){if(!this._init){var e=Le.util.createBuffer(r.key);if(this.name.indexOf("3DES")===0&&e.length()!==24)throw new Error("Invalid Triple-DES key size: "+e.length()*8);this._keys=Mw(e),this._init=!0}};_r("DES-ECB",Le.cipher.modes.ecb);_r("DES-CBC",Le.cipher.modes.cbc);_r("DES-CFB",Le.cipher.modes.cfb);_r("DES-OFB",Le.cipher.modes.ofb);_r("DES-CTR",Le.cipher.modes.ctr);_r("3DES-ECB",Le.cipher.modes.ecb);_r("3DES-CBC",Le.cipher.modes.cbc);_r("3DES-CFB",Le.cipher.modes.cfb);_r("3DES-OFB",Le.cipher.modes.ofb);_r("3DES-CTR",Le.cipher.modes.ctr);function _r(r,e){var t=function(){return new Le.des.Algorithm(r,e)};Le.cipher.registerAlgorithm(r,t)}var Dw=[16843776,0,65536,16843780,16842756,66564,4,65536,1024,16843776,16843780,1024,16778244,16842756,16777216,4,1028,16778240,16778240,66560,66560,16842752,16842752,16778244,65540,16777220,16777220,65540,0,1028,66564,16777216,65536,16843780,4,16842752,16843776,16777216,16777216,1024,16842756,65536,66560,16777220,1024,4,16778244,66564,16843780,65540,16842752,16778244,16777220,1028,66564,16843776,1028,16778240,16778240,0,65540,66560,0,16842756],Tw=[-2146402272,-2147450880,32768,1081376,1048576,32,-2146435040,-2147450848,-2147483616,-2146402272,-2146402304,-2147483648,-2147450880,1048576,32,-2146435040,1081344,1048608,-2147450848,0,-2147483648,32768,1081376,-2146435072,1048608,-2147483616,0,1081344,32800,-2146402304,-2146435072,32800,0,1081376,-2146435040,1048576,-2147450848,-2146435072,-2146402304,32768,-2146435072,-2147450880,32,-2146402272,1081376,32,32768,-2147483648,32800,-2146402304,1048576,-2147483616,1048608,-2147450848,-2147483616,1048608,1081344,0,-2147450880,32800,-2147483648,-2146435040,-2146402272,1081344],Lw=[520,134349312,0,134348808,134218240,0,131592,134218240,131080,134217736,134217736,131072,134349320,131080,134348800,520,134217728,8,134349312,512,131584,134348800,134348808,131592,134218248,131584,131072,134218248,8,134349320,512,134217728,134349312,134217728,131080,520,131072,134349312,134218240,0,512,131080,134349320,134218240,134217736,512,0,134348808,134218248,131072,134217728,134349320,8,131592,131584,134217736,134348800,134218248,520,134348800,131592,8,134348808,131584],kw=[8396801,8321,8321,128,8396928,8388737,8388609,8193,0,8396800,8396800,8396929,129,0,8388736,8388609,1,8192,8388608,8396801,128,8388608,8193,8320,8388737,1,8320,8388736,8192,8396928,8396929,129,8388736,8388609,8396800,8396929,129,0,0,8396800,8320,8388736,8388737,1,8396801,8321,8321,128,8396929,129,1,8192,8388609,8193,8396928,8388737,8193,8320,8388608,8396801,128,8388608,8192,8396928],Pw=[256,34078976,34078720,1107296512,524288,256,1073741824,34078720,1074266368,524288,33554688,1074266368,1107296512,1107820544,524544,1073741824,33554432,1074266112,1074266112,0,1073742080,1107820800,1107820800,33554688,1107820544,1073742080,0,1107296256,34078976,33554432,1107296256,524544,524288,1107296512,256,33554432,1073741824,34078720,1107296512,1074266368,33554688,1073741824,1107820544,34078976,1074266368,256,33554432,1107820544,1107820800,524544,1107296256,1107820800,34078720,0,1074266112,1107296256,524544,33554688,1073742080,524288,0,1074266112,34078976,1073742080],Nw=[536870928,541065216,16384,541081616,541065216,16,541081616,4194304,536887296,4210704,4194304,536870928,4194320,536887296,536870912,16400,0,4194320,536887312,16384,4210688,536887312,16,541065232,541065232,0,4210704,541081600,16400,4210688,541081600,536870912,536887296,16,541065232,4210688,541081616,4194304,16400,536870928,4194304,536887296,536870912,16400,536870928,541081616,4210688,541065216,4210704,541081600,0,541065232,16,16384,541065216,4210704,16384,4194320,536887312,0,541081600,536870912,4194320,536887312],Bw=[2097152,69206018,67110914,0,2048,67110914,2099202,69208064,69208066,2097152,0,67108866,2,67108864,69206018,2050,67110912,2099202,2097154,67110912,67108866,69206016,69208064,2097154,69206016,2048,2050,69208066,2099200,2,67108864,2099200,67108864,2099200,2097152,67110914,67110914,69206018,69206018,2,2097154,67108864,67110912,2097152,69208064,2050,2099202,69208064,2050,67108866,69208066,69206016,2099200,0,2,69208066,0,2099202,69206016,2048,67108866,67110912,2048,2097154],Ow=[268439616,4096,262144,268701760,268435456,268439616,64,268435456,262208,268697600,268701760,266240,268701696,266304,4096,64,268697600,268435520,268439552,4160,266240,262208,268697664,268701696,4160,0,0,268697664,268435520,268439552,266304,262144,266304,262144,268701696,4096,64,268697664,4096,266304,268439552,64,268435520,268697600,268697664,268435456,262144,268439616,0,268701760,262208,268435520,268697600,268439552,268439616,0,268701760,266240,266240,4160,4160,262208,268435456,268701696];function Mw(r){for(var e=[0,4,536870912,536870916,65536,65540,536936448,536936452,512,516,536871424,536871428,66048,66052,536936960,536936964],t=[0,1,1048576,1048577,67108864,67108865,68157440,68157441,256,257,1048832,1048833,67109120,67109121,68157696,68157697],n=[0,8,2048,2056,16777216,16777224,16779264,16779272,0,8,2048,2056,16777216,16777224,16779264,16779272],i=[0,2097152,134217728,136314880,8192,2105344,134225920,136323072,131072,2228224,134348800,136445952,139264,2236416,134356992,136454144],s=[0,262144,16,262160,0,262144,16,262160,4096,266240,4112,266256,4096,266240,4112,266256],o=[0,1024,32,1056,0,1024,32,1056,33554432,33555456,33554464,33555488,33554432,33555456,33554464,33555488],a=[0,268435456,524288,268959744,2,268435458,524290,268959746,0,268435456,524288,268959744,2,268435458,524290,268959746],c=[0,65536,2048,67584,536870912,536936448,536872960,536938496,131072,196608,133120,198656,537001984,537067520,537004032,537069568],u=[0,262144,0,262144,2,262146,2,262146,33554432,33816576,33554432,33816576,33554434,33816578,33554434,33816578],l=[0,268435456,8,268435464,0,268435456,8,268435464,1024,268436480,1032,268436488,1024,268436480,1032,268436488],h=[0,32,0,32,1048576,1048608,1048576,1048608,8192,8224,8192,8224,1056768,1056800,1056768,1056800],p=[0,16777216,512,16777728,2097152,18874368,2097664,18874880,67108864,83886080,67109376,83886592,69206016,85983232,69206528,85983744],g=[0,4096,134217728,134221824,524288,528384,134742016,134746112,16,4112,134217744,134221840,524304,528400,134742032,134746128],f=[0,4,256,260,0,4,256,260,1,5,257,261,1,5,257,261],d=r.length()>8?3:1,m=[],y=[0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],E=0,b,x=0;x<d;x++){var w=r.getInt32(),v=r.getInt32();b=(w>>>4^v)&252645135,v^=b,w^=b<<4,b=(v>>>-16^w)&65535,w^=b,v^=b<<-16,b=(w>>>2^v)&858993459,v^=b,w^=b<<2,b=(v>>>-16^w)&65535,w^=b,v^=b<<-16,b=(w>>>1^v)&1431655765,v^=b,w^=b<<1,b=(v>>>8^w)&16711935,w^=b,v^=b<<8,b=(w>>>1^v)&1431655765,v^=b,w^=b<<1,b=w<<8|v>>>20&240,w=v<<24|v<<8&16711680|v>>>8&65280|v>>>24&240,v=b;for(var S=0;S<y.length;++S){y[S]?(w=w<<2|w>>>26,v=v<<2|v>>>26):(w=w<<1|w>>>27,v=v<<1|v>>>27),w&=-15,v&=-15;var C=e[w>>>28]|t[w>>>24&15]|n[w>>>20&15]|i[w>>>16&15]|s[w>>>12&15]|o[w>>>8&15]|a[w>>>4&15],B=c[v>>>28]|u[v>>>24&15]|l[v>>>20&15]|h[v>>>16&15]|p[v>>>12&15]|g[v>>>8&15]|f[v>>>4&15];b=(B>>>16^C)&65535,m[E++]=C^b,m[E++]=B^b<<16}}return m}function ah(r,e,t,n){var i=r.length===32?3:9,s;i===3?s=n?[30,-2,-2]:[0,32,2]:s=n?[94,62,-2,32,64,2,30,-2,-2]:[0,32,2,62,30,-2,64,96,2];var o,a=e[0],c=e[1];o=(a>>>4^c)&252645135,c^=o,a^=o<<4,o=(a>>>16^c)&65535,c^=o,a^=o<<16,o=(c>>>2^a)&858993459,a^=o,c^=o<<2,o=(c>>>8^a)&16711935,a^=o,c^=o<<8,o=(a>>>1^c)&1431655765,c^=o,a^=o<<1,a=a<<1|a>>>31,c=c<<1|c>>>31;for(var u=0;u<i;u+=3){for(var l=s[u+1],h=s[u+2],p=s[u];p!=l;p+=h){var g=c^r[p],f=(c>>>4|c<<28)^r[p+1];o=a,a=c,c=o^(Tw[g>>>24&63]|kw[g>>>16&63]|Nw[g>>>8&63]|Ow[g&63]|Dw[f>>>24&63]|Lw[f>>>16&63]|Pw[f>>>8&63]|Bw[f&63])}o=a,a=c,c=o}a=a>>>1|a<<31,c=c>>>1|c<<31,o=(a>>>1^c)&1431655765,c^=o,a^=o<<1,o=(c>>>8^a)&16711935,a^=o,c^=o<<8,o=(c>>>2^a)&858993459,a^=o,c^=o<<2,o=(a>>>16^c)&65535,c^=o,a^=o<<16,o=(a>>>4^c)&252645135,c^=o,a^=o<<4,t[0]=a,t[1]=c}function Jo(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="DES-"+e,n;r.decrypt?n=Le.cipher.createDecipher(t,r.key):n=Le.cipher.createCipher(t,r.key);var i=n.start;return n.start=function(s,o){var a=null;o instanceof Le.util.ByteBuffer&&(a=o,o={}),o=o||{},o.output=a,o.iv=s,i.call(n,o)},n}var lo=Be;lo.md=lo.md||{};lo.md.algorithms=lo.md.algorithms||{};var Dr=Be,Uw=Dr.hmac=Dr.hmac||{};Uw.create=function(){var r=null,e=null,t=null,n=null,i={};return i.start=function(s,o){if(s!==null)if(typeof s=="string")if(s=s.toLowerCase(),s in Dr.md.algorithms)e=Dr.md.algorithms[s].create();else throw new Error('Unknown hash algorithm "'+s+'"');else e=s;if(o===null)o=r;else{if(typeof o=="string")o=Dr.util.createBuffer(o);else if(Dr.util.isArray(o)){var a=o;o=Dr.util.createBuffer();for(var c=0;c<a.length;++c)o.putByte(a[c])}var u=o.length();u>e.blockLength&&(e.start(),e.update(o.bytes()),o=e.digest()),t=Dr.util.createBuffer(),n=Dr.util.createBuffer(),u=o.length();for(var c=0;c<u;++c){var a=o.at(c);t.putByte(54^a),n.putByte(92^a)}if(u<e.blockLength)for(var a=e.blockLength-u,c=0;c<a;++c)t.putByte(54),n.putByte(92);r=o,t=t.bytes(),n=n.bytes()}e.start(),e.update(t)},i.update=function(s){e.update(s)},i.getMac=function(){var s=e.digest().bytes();return e.start(),e.update(n),e.update(s),e.digest()},i.digest=i.getMac,i};const $w={},Fw=Object.freeze(Object.defineProperty({__proto__:null,default:$w},Symbol.toStringTag,{value:"Module"})),Kn=Ug(Fw);var wt=Be,Kw=wt.pkcs5=wt.pkcs5||{},Rr;wt.util.isNodejs&&!wt.options.usePureJavaScript&&(Rr=Kn);var Vw=wt.pbkdf2=Kw.pbkdf2=function(r,e,t,n,i,s){if(typeof i=="function"&&(s=i,i=null),wt.util.isNodejs&&!wt.options.usePureJavaScript&&Rr.pbkdf2&&(i===null||typeof i!="object")&&(Rr.pbkdf2Sync.length>4||!i||i==="sha1"))return typeof i!="string"&&(i="sha1"),r=Buffer.from(r,"binary"),e=Buffer.from(e,"binary"),s?Rr.pbkdf2Sync.length===4?Rr.pbkdf2(r,e,t,n,function(b,x){if(b)return s(b);s(null,x.toString("binary"))}):Rr.pbkdf2(r,e,t,n,i,function(b,x){if(b)return s(b);s(null,x.toString("binary"))}):Rr.pbkdf2Sync.length===4?Rr.pbkdf2Sync(r,e,t,n).toString("binary"):Rr.pbkdf2Sync(r,e,t,n,i).toString("binary");if((typeof i>"u"||i===null)&&(i="sha1"),typeof i=="string"){if(!(i in wt.md.algorithms))throw new Error("Unknown hash algorithm: "+i);i=wt.md[i].create()}var o=i.digestLength;if(n>4294967295*o){var a=new Error("Derived key is too long.");if(s)return s(a);throw a}var c=Math.ceil(n/o),u=n-(c-1)*o,l=wt.hmac.create();l.start(i,r);var h="",p,g,f;if(!s){for(var d=1;d<=c;++d){l.start(null,null),l.update(e),l.update(wt.util.int32ToBytes(d)),p=f=l.digest().getBytes();for(var m=2;m<=t;++m)l.start(null,null),l.update(f),g=l.digest().getBytes(),p=wt.util.xorBytes(p,g,o),f=g;h+=d<c?p:p.substr(0,u)}return h}var d=1,m;function y(){if(d>c)return s(null,h);l.start(null,null),l.update(e),l.update(wt.util.int32ToBytes(d)),p=f=l.digest().getBytes(),m=2,E()}function E(){if(m<=t)return l.start(null,null),l.update(f),g=l.digest().getBytes(),p=wt.util.xorBytes(p,g,o),f=g,++m,wt.util.setImmediate(E);h+=d<c?p:p.substr(0,u),++d,y()}y()};const zw=jt(Vw);var ho=Be,A0=ho.pem=ho.pem||{};A0.encode=function(r,e){e=e||{};var t="-----BEGIN "+r.type+`-----\r
`,n;if(r.procType&&(n={name:"Proc-Type",values:[String(r.procType.version),r.procType.type]},t+=Ps(n)),r.contentDomain&&(n={name:"Content-Domain",values:[r.contentDomain]},t+=Ps(n)),r.dekInfo&&(n={name:"DEK-Info",values:[r.dekInfo.algorithm]},r.dekInfo.parameters&&n.values.push(r.dekInfo.parameters),t+=Ps(n)),r.headers)for(var i=0;i<r.headers.length;++i)t+=Ps(r.headers[i]);return r.procType&&(t+=`\r
`),t+=ho.util.encode64(r.body,e.maxline||64)+`\r
`,t+="-----END "+r.type+`-----\r
`,t};A0.decode=function(r){for(var e=[],t=/\s*-----BEGIN ([A-Z0-9- ]+)-----\r?\n?([\x21-\x7e\s]+?(?:\r?\n\r?\n))?([:A-Za-z0-9+\/=\s]+?)-----END \1-----/g,n=/([\x21-\x7e]+):\s*([\x21-\x7e\s^:]+)/,i=/\r?\n/,s;s=t.exec(r),!!s;){var o=s[1];o==="NEW CERTIFICATE REQUEST"&&(o="CERTIFICATE REQUEST");var a={type:o,procType:null,contentDomain:null,dekInfo:null,headers:[],body:ho.util.decode64(s[3])};if(e.push(a),!!s[2]){for(var c=s[2].split(i),u=0;s&&u<c.length;){for(var l=c[u].replace(/\s+$/,""),h=u+1;h<c.length;++h){var p=c[h];if(!/\s/.test(p[0]))break;l+=p,u=h}if(s=l.match(n),s){for(var g={name:s[1],values:[]},f=s[2].split(","),d=0;d<f.length;++d)g.values.push(qw(f[d]));if(a.procType)if(!a.contentDomain&&g.name==="Content-Domain")a.contentDomain=f[0]||"";else if(!a.dekInfo&&g.name==="DEK-Info"){if(g.values.length===0)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must have at least one subfield.');a.dekInfo={algorithm:f[0],parameters:f[1]||null}}else a.headers.push(g);else{if(g.name!=="Proc-Type")throw new Error('Invalid PEM formatted message. The first encapsulated header must be "Proc-Type".');if(g.values.length!==2)throw new Error('Invalid PEM formatted message. The "Proc-Type" header must have two subfields.');a.procType={version:f[0],type:f[1]}}}++u}if(a.procType==="ENCRYPTED"&&!a.dekInfo)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must be present if "Proc-Type" is "ENCRYPTED".')}}if(e.length===0)throw new Error("Invalid PEM formatted message.");return e};function Ps(r){for(var e=r.name+": ",t=[],n=function(c,u){return" "+u},i=0;i<r.values.length;++i)t.push(r.values[i].replace(/^(\S+\r\n)/,n));e+=t.join(",")+`\r
`;for(var s=0,o=-1,i=0;i<e.length;++i,++s)if(s>65&&o!==-1){var a=e[o];a===","?(++o,e=e.substr(0,o)+`\r
 `+e.substr(o)):e=e.substr(0,o)+`\r
`+a+e.substr(o+1),s=i-o-1,o=-1,++i}else(e[i]===" "||e[i]==="	"||e[i]===",")&&(o=i);return e}function qw(r){return r.replace(/^\s+/,"")}var pr=Be,R0=pr.sha256=pr.sha256||{};pr.md.sha256=pr.md.algorithms.sha256=R0;R0.create=function(){I0||Hw();var r=null,e=pr.util.createBuffer(),t=new Array(64),n={algorithm:"sha256",blockLength:64,digestLength:32,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var i=n.messageLengthSize/4,s=0;s<i;++s)n.fullMessageLength.push(0);return e=pr.util.createBuffer(),r={h0:1779033703,h1:3144134277,h2:1013904242,h3:2773480762,h4:1359893119,h5:2600822924,h6:528734635,h7:1541459225},n},n.start(),n.update=function(i,s){s==="utf8"&&(i=pr.util.encodeUtf8(i));var o=i.length;n.messageLength+=o,o=[o/4294967296>>>0,o>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=o[1],o[1]=o[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,o[0]=o[1]/4294967296>>>0;return e.putBytes(i),ch(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var i=pr.util.createBuffer();i.putBytes(e.bytes());var s=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,o=s&n.blockLength-1;i.putBytes(Bc.substr(0,n.blockLength-o));for(var a,c,u=n.fullMessageLength[0]*8,l=0;l<n.fullMessageLength.length-1;++l)a=n.fullMessageLength[l+1]*8,c=a/4294967296>>>0,u+=c,i.putInt32(u>>>0),u=a>>>0;i.putInt32(u);var h={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4,h5:r.h5,h6:r.h6,h7:r.h7};ch(h,t,i);var p=pr.util.createBuffer();return p.putInt32(h.h0),p.putInt32(h.h1),p.putInt32(h.h2),p.putInt32(h.h3),p.putInt32(h.h4),p.putInt32(h.h5),p.putInt32(h.h6),p.putInt32(h.h7),p},n};var Bc=null,I0=!1,C0=null;function Hw(){Bc=String.fromCharCode(128),Bc+=pr.util.fillString(String.fromCharCode(0),64),C0=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],I0=!0}function ch(r,e,t){for(var n,i,s,o,a,c,u,l,h,p,g,f,d,m,y,E=t.length();E>=64;){for(u=0;u<16;++u)e[u]=t.getInt32();for(;u<64;++u)n=e[u-2],n=(n>>>17|n<<15)^(n>>>19|n<<13)^n>>>10,i=e[u-15],i=(i>>>7|i<<25)^(i>>>18|i<<14)^i>>>3,e[u]=n+e[u-7]+i+e[u-16]|0;for(l=r.h0,h=r.h1,p=r.h2,g=r.h3,f=r.h4,d=r.h5,m=r.h6,y=r.h7,u=0;u<64;++u)o=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),a=m^f&(d^m),s=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),c=l&h|p&(l^h),n=y+o+a+C0[u]+e[u],i=s+c,y=m,m=d,d=f,f=g+n>>>0,g=p,p=h,h=l,l=n+i>>>0;r.h0=r.h0+l|0,r.h1=r.h1+h|0,r.h2=r.h2+p|0,r.h3=r.h3+g|0,r.h4=r.h4+f|0,r.h5=r.h5+d|0,r.h6=r.h6+m|0,r.h7=r.h7+y|0,E-=64}}var dr=Be,qs=null;dr.util.isNodejs&&!dr.options.usePureJavaScript&&!process.versions["node-webkit"]&&(qs=Kn);var Ww=dr.prng=dr.prng||{};Ww.create=function(r){for(var e={plugin:r,key:null,seed:null,time:null,reseeds:0,generated:0,keyBytes:""},t=r.md,n=new Array(32),i=0;i<32;++i)n[i]=t.create();e.pools=n,e.pool=0,e.generate=function(u,l){if(!l)return e.generateSync(u);var h=e.plugin.cipher,p=e.plugin.increment,g=e.plugin.formatKey,f=e.plugin.formatSeed,d=dr.util.createBuffer();e.key=null,m();function m(y){if(y)return l(y);if(d.length()>=u)return l(null,d.getBytes(u));if(e.generated>1048575&&(e.key=null),e.key===null)return dr.util.nextTick(function(){s(m)});var E=h(e.key,e.seed);e.generated+=E.length,d.putBytes(E),e.key=g(h(e.key,p(e.seed))),e.seed=f(h(e.key,e.seed)),dr.util.setImmediate(m)}},e.generateSync=function(u){var l=e.plugin.cipher,h=e.plugin.increment,p=e.plugin.formatKey,g=e.plugin.formatSeed;e.key=null;for(var f=dr.util.createBuffer();f.length()<u;){e.generated>1048575&&(e.key=null),e.key===null&&o();var d=l(e.key,e.seed);e.generated+=d.length,f.putBytes(d),e.key=p(l(e.key,h(e.seed))),e.seed=g(l(e.key,e.seed))}return f.getBytes(u)};function s(u){if(e.pools[0].messageLength>=32)return a(),u();var l=32-e.pools[0].messageLength<<5;e.seedFile(l,function(h,p){if(h)return u(h);e.collect(p),a(),u()})}function o(){if(e.pools[0].messageLength>=32)return a();var u=32-e.pools[0].messageLength<<5;e.collect(e.seedFileSync(u)),a()}function a(){e.reseeds=e.reseeds===4294967295?0:e.reseeds+1;var u=e.plugin.md.create();u.update(e.keyBytes);for(var l=1,h=0;h<32;++h)e.reseeds%l===0&&(u.update(e.pools[h].digest().getBytes()),e.pools[h].start()),l=l<<1;e.keyBytes=u.digest().getBytes(),u.start(),u.update(e.keyBytes);var p=u.digest().getBytes();e.key=e.plugin.formatKey(e.keyBytes),e.seed=e.plugin.formatSeed(p),e.generated=0}function c(u){var l=null,h=dr.util.globalScope,p=h.crypto||h.msCrypto;p&&p.getRandomValues&&(l=function(w){return p.getRandomValues(w)});var g=dr.util.createBuffer();if(l)for(;g.length()<u;){var f=Math.max(1,Math.min(u-g.length(),65536)/4),d=new Uint32Array(Math.floor(f));try{l(d);for(var m=0;m<d.length;++m)g.putInt32(d[m])}catch(w){if(!(typeof QuotaExceededError<"u"&&w instanceof QuotaExceededError))throw w}}if(g.length()<u)for(var y,E,b,x=Math.floor(Math.random()*65536);g.length()<u;){E=16807*(x&65535),y=16807*(x>>16),E+=(y&32767)<<16,E+=y>>15,E=(E&2147483647)+(E>>31),x=E&4294967295;for(var m=0;m<3;++m)b=x>>>(m<<3),b^=Math.floor(Math.random()*256),g.putByte(b&255)}return g.getBytes(u)}return qs?(e.seedFile=function(u,l){qs.randomBytes(u,function(h,p){if(h)return l(h);l(null,p.toString())})},e.seedFileSync=function(u){return qs.randomBytes(u).toString()}):(e.seedFile=function(u,l){try{l(null,c(u))}catch(h){l(h)}},e.seedFileSync=c),e.collect=function(u){for(var l=u.length,h=0;h<l;++h)e.pools[e.pool].update(u.substr(h,1)),e.pool=e.pool===31?0:e.pool+1},e.collectInt=function(u,l){for(var h="",p=0;p<l;p+=8)h+=String.fromCharCode(u>>p&255);e.collect(h)},e.registerWorker=function(u){if(u===self)e.seedFile=function(h,p){function g(f){var d=f.data;d.forge&&d.forge.prng&&(self.removeEventListener("message",g),p(d.forge.prng.err,d.forge.prng.bytes))}self.addEventListener("message",g),self.postMessage({forge:{prng:{needed:h}}})};else{var l=function(h){var p=h.data;p.forge&&p.forge.prng&&e.seedFile(p.forge.prng.needed,function(g,f){u.postMessage({forge:{prng:{err:g,bytes:f}}})})};u.addEventListener("message",l)}},e};var Ge=Be;(function(){if(Ge.random&&Ge.random.getBytes){Ge.random;return}(function(r){var e={},t=new Array(4),n=Ge.util.createBuffer();e.formatKey=function(h){var p=Ge.util.createBuffer(h);return h=new Array(4),h[0]=p.getInt32(),h[1]=p.getInt32(),h[2]=p.getInt32(),h[3]=p.getInt32(),Ge.aes._expandKey(h,!1)},e.formatSeed=function(h){var p=Ge.util.createBuffer(h);return h=new Array(4),h[0]=p.getInt32(),h[1]=p.getInt32(),h[2]=p.getInt32(),h[3]=p.getInt32(),h},e.cipher=function(h,p){return Ge.aes._updateBlock(h,p,t,!1),n.putInt32(t[0]),n.putInt32(t[1]),n.putInt32(t[2]),n.putInt32(t[3]),n.getBytes()},e.increment=function(h){return++h[3],h},e.md=Ge.md.sha256;function i(){var h=Ge.prng.create(e);return h.getBytes=function(p,g){return h.generate(p,g)},h.getBytesSync=function(p){return h.generate(p)},h}var s=i(),o=null,a=Ge.util.globalScope,c=a.crypto||a.msCrypto;if(c&&c.getRandomValues&&(o=function(h){return c.getRandomValues(h)}),Ge.options.usePureJavaScript||!Ge.util.isNodejs&&!o){if(s.collectInt(+new Date,32),typeof navigator<"u"){var u="";for(var l in navigator)try{typeof navigator[l]=="string"&&(u+=navigator[l])}catch{}s.collect(u),u=null}r&&(r().mousemove(function(h){s.collectInt(h.clientX,16),s.collectInt(h.clientY,16)}),r().keypress(function(h){s.collectInt(h.charCode,8)}))}if(!Ge.random)Ge.random=s;else for(var l in s)Ge.random[l]=s[l];Ge.random.createInstance=i,Ge.random})(typeof jQuery<"u"?jQuery:null)})();var _t=Be,Na=[217,120,249,196,25,221,181,237,40,233,253,121,74,160,216,157,198,126,55,131,43,118,83,142,98,76,100,136,68,139,251,162,23,154,89,245,135,179,79,19,97,69,109,141,9,129,125,50,189,143,64,235,134,183,123,11,240,149,33,34,92,107,78,130,84,214,101,147,206,96,178,28,115,86,192,20,167,140,241,220,18,117,202,31,59,190,228,209,66,61,212,48,163,60,182,38,111,191,14,218,70,105,7,87,39,242,29,155,188,148,67,3,248,17,199,246,144,239,62,231,6,195,213,47,200,102,30,215,8,232,234,222,128,82,238,247,132,170,114,172,53,77,106,42,150,26,210,113,90,21,73,116,75,159,208,94,4,24,164,236,194,224,65,110,15,81,203,204,36,145,175,80,161,244,112,57,153,124,58,133,35,184,180,122,252,2,54,91,37,85,151,49,45,93,250,152,227,138,146,174,5,223,41,16,103,108,186,201,211,0,230,207,225,158,168,44,99,22,1,63,88,226,137,169,13,56,52,27,171,51,255,176,187,72,12,95,185,177,205,46,197,243,219,71,229,165,156,119,10,166,32,104,254,127,193,173],uh=[1,2,3,5],Gw=function(r,e){return r<<e&65535|(r&65535)>>16-e},Yw=function(r,e){return(r&65535)>>e|r<<16-e&65535};_t.rc2=_t.rc2||{};_t.rc2.expandKey=function(r,e){typeof r=="string"&&(r=_t.util.createBuffer(r)),e=e||128;var t=r,n=r.length(),i=e,s=Math.ceil(i/8),o=255>>(i&7),a;for(a=n;a<128;a++)t.putByte(Na[t.at(a-1)+t.at(a-n)&255]);for(t.setAt(128-s,Na[t.at(128-s)&o]),a=127-s;a>=0;a--)t.setAt(a,Na[t.at(a+1)^t.at(a+s)]);return t};var D0=function(r,e,t){var n=!1,i=null,s=null,o=null,a,c,u,l,h=[];for(r=_t.rc2.expandKey(r,e),u=0;u<64;u++)h.push(r.getInt16Le());t?(a=function(f){for(u=0;u<4;u++)f[u]+=h[l]+(f[(u+3)%4]&f[(u+2)%4])+(~f[(u+3)%4]&f[(u+1)%4]),f[u]=Gw(f[u],uh[u]),l++},c=function(f){for(u=0;u<4;u++)f[u]+=h[f[(u+3)%4]&63]}):(a=function(f){for(u=3;u>=0;u--)f[u]=Yw(f[u],uh[u]),f[u]-=h[l]+(f[(u+3)%4]&f[(u+2)%4])+(~f[(u+3)%4]&f[(u+1)%4]),l--},c=function(f){for(u=3;u>=0;u--)f[u]-=h[f[(u+3)%4]&63]});var p=function(f){var d=[];for(u=0;u<4;u++){var m=i.getInt16Le();o!==null&&(t?m^=o.getInt16Le():o.putInt16Le(m)),d.push(m&65535)}l=t?0:63;for(var y=0;y<f.length;y++)for(var E=0;E<f[y][0];E++)f[y][1](d);for(u=0;u<4;u++)o!==null&&(t?o.putInt16Le(d[u]):d[u]^=o.getInt16Le()),s.putInt16Le(d[u])},g=null;return g={start:function(f,d){f&&typeof f=="string"&&(f=_t.util.createBuffer(f)),n=!1,i=_t.util.createBuffer(),s=d||new _t.util.createBuffer,o=f,g.output=s},update:function(f){for(n||i.putBuffer(f);i.length()>=8;)p([[5,a],[1,c],[6,a],[1,c],[5,a]])},finish:function(f){var d=!0;if(t)if(f)d=f(8,i,!t);else{var m=i.length()===8?8:8-i.length();i.fillWithByte(m,m)}if(d&&(n=!0,g.update()),!t&&(d=i.length()===0,d))if(f)d=f(8,s,!t);else{var y=s.length(),E=s.at(y-1);E>y?d=!1:s.truncate(E)}return d}},g};_t.rc2.startEncrypting=function(r,e,t){var n=_t.rc2.createEncryptionCipher(r,128);return n.start(e,t),n};_t.rc2.createEncryptionCipher=function(r,e){return D0(r,e,!0)};_t.rc2.startDecrypting=function(r,e,t){var n=_t.rc2.createDecryptionCipher(r,128);return n.start(e,t),n};_t.rc2.createDecryptionCipher=function(r,e){return D0(r,e,!1)};var Oc=Be;Oc.jsbn=Oc.jsbn||{};var Pr;function N(r,e,t){this.data=[],r!=null&&(typeof r=="number"?this.fromNumber(r,e,t):e==null&&typeof r!="string"?this.fromString(r,256):this.fromString(r,e))}Oc.jsbn.BigInteger=N;function pe(){return new N(null)}function Qw(r,e,t,n,i,s){for(;--s>=0;){var o=e*this.data[r++]+t.data[n]+i;i=Math.floor(o/67108864),t.data[n++]=o&67108863}return i}function Xw(r,e,t,n,i,s){for(var o=e&32767,a=e>>15;--s>=0;){var c=this.data[r]&32767,u=this.data[r++]>>15,l=a*c+u*o;c=o*c+((l&32767)<<15)+t.data[n]+(i&1073741823),i=(c>>>30)+(l>>>15)+a*u+(i>>>30),t.data[n++]=c&1073741823}return i}function lh(r,e,t,n,i,s){for(var o=e&16383,a=e>>14;--s>=0;){var c=this.data[r]&16383,u=this.data[r++]>>14,l=a*c+u*o;c=o*c+((l&16383)<<14)+t.data[n]+i,i=(c>>28)+(l>>14)+a*u,t.data[n++]=c&268435455}return i}typeof navigator>"u"?(N.prototype.am=lh,Pr=28):navigator.appName=="Microsoft Internet Explorer"?(N.prototype.am=Xw,Pr=30):navigator.appName!="Netscape"?(N.prototype.am=Qw,Pr=26):(N.prototype.am=lh,Pr=28);N.prototype.DB=Pr;N.prototype.DM=(1<<Pr)-1;N.prototype.DV=1<<Pr;var Cu=52;N.prototype.FV=Math.pow(2,Cu);N.prototype.F1=Cu-Pr;N.prototype.F2=2*Pr-Cu;var Zw="0123456789abcdefghijklmnopqrstuvwxyz",ea=new Array,Ri,Ht;Ri="0".charCodeAt(0);for(Ht=0;Ht<=9;++Ht)ea[Ri++]=Ht;Ri="a".charCodeAt(0);for(Ht=10;Ht<36;++Ht)ea[Ri++]=Ht;Ri="A".charCodeAt(0);for(Ht=10;Ht<36;++Ht)ea[Ri++]=Ht;function hh(r){return Zw.charAt(r)}function T0(r,e){var t=ea[r.charCodeAt(e)];return t??-1}function jw(r){for(var e=this.t-1;e>=0;--e)r.data[e]=this.data[e];r.t=this.t,r.s=this.s}function Jw(r){this.t=1,this.s=r<0?-1:0,r>0?this.data[0]=r:r<-1?this.data[0]=r+this.DV:this.t=0}function rn(r){var e=pe();return e.fromInt(r),e}function e2(r,e){var t;if(e==16)t=4;else if(e==8)t=3;else if(e==256)t=8;else if(e==2)t=1;else if(e==32)t=5;else if(e==4)t=2;else{this.fromRadix(r,e);return}this.t=0,this.s=0;for(var n=r.length,i=!1,s=0;--n>=0;){var o=t==8?r[n]&255:T0(r,n);if(o<0){r.charAt(n)=="-"&&(i=!0);continue}i=!1,s==0?this.data[this.t++]=o:s+t>this.DB?(this.data[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this.data[this.t++]=o>>this.DB-s):this.data[this.t-1]|=o<<s,s+=t,s>=this.DB&&(s-=this.DB)}t==8&&r[0]&128&&(this.s=-1,s>0&&(this.data[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&N.ZERO.subTo(this,this)}function t2(){for(var r=this.s&this.DM;this.t>0&&this.data[this.t-1]==r;)--this.t}function r2(r){if(this.s<0)return"-"+this.negate().toString(r);var e;if(r==16)e=4;else if(r==8)e=3;else if(r==2)e=1;else if(r==32)e=5;else if(r==4)e=2;else return this.toRadix(r);var t=(1<<e)-1,n,i=!1,s="",o=this.t,a=this.DB-o*this.DB%e;if(o-- >0)for(a<this.DB&&(n=this.data[o]>>a)>0&&(i=!0,s=hh(n));o>=0;)a<e?(n=(this.data[o]&(1<<a)-1)<<e-a,n|=this.data[--o]>>(a+=this.DB-e)):(n=this.data[o]>>(a-=e)&t,a<=0&&(a+=this.DB,--o)),n>0&&(i=!0),i&&(s+=hh(n));return i?s:"0"}function n2(){var r=pe();return N.ZERO.subTo(this,r),r}function i2(){return this.s<0?this.negate():this}function s2(r){var e=this.s-r.s;if(e!=0)return e;var t=this.t;if(e=t-r.t,e!=0)return this.s<0?-e:e;for(;--t>=0;)if((e=this.data[t]-r.data[t])!=0)return e;return 0}function ta(r){var e=1,t;return(t=r>>>16)!=0&&(r=t,e+=16),(t=r>>8)!=0&&(r=t,e+=8),(t=r>>4)!=0&&(r=t,e+=4),(t=r>>2)!=0&&(r=t,e+=2),(t=r>>1)!=0&&(r=t,e+=1),e}function o2(){return this.t<=0?0:this.DB*(this.t-1)+ta(this.data[this.t-1]^this.s&this.DM)}function a2(r,e){var t;for(t=this.t-1;t>=0;--t)e.data[t+r]=this.data[t];for(t=r-1;t>=0;--t)e.data[t]=0;e.t=this.t+r,e.s=this.s}function c2(r,e){for(var t=r;t<this.t;++t)e.data[t-r]=this.data[t];e.t=Math.max(this.t-r,0),e.s=this.s}function u2(r,e){var t=r%this.DB,n=this.DB-t,i=(1<<n)-1,s=Math.floor(r/this.DB),o=this.s<<t&this.DM,a;for(a=this.t-1;a>=0;--a)e.data[a+s+1]=this.data[a]>>n|o,o=(this.data[a]&i)<<t;for(a=s-1;a>=0;--a)e.data[a]=0;e.data[s]=o,e.t=this.t+s+1,e.s=this.s,e.clamp()}function l2(r,e){e.s=this.s;var t=Math.floor(r/this.DB);if(t>=this.t){e.t=0;return}var n=r%this.DB,i=this.DB-n,s=(1<<n)-1;e.data[0]=this.data[t]>>n;for(var o=t+1;o<this.t;++o)e.data[o-t-1]|=(this.data[o]&s)<<i,e.data[o-t]=this.data[o]>>n;n>0&&(e.data[this.t-t-1]|=(this.s&s)<<i),e.t=this.t-t,e.clamp()}function h2(r,e){for(var t=0,n=0,i=Math.min(r.t,this.t);t<i;)n+=this.data[t]-r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n-=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n-=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n-=r.s}e.s=n<0?-1:0,n<-1?e.data[t++]=this.DV+n:n>0&&(e.data[t++]=n),e.t=t,e.clamp()}function f2(r,e){var t=this.abs(),n=r.abs(),i=t.t;for(e.t=i+n.t;--i>=0;)e.data[i]=0;for(i=0;i<n.t;++i)e.data[i+t.t]=t.am(0,n.data[i],e,i,0,t.t);e.s=0,e.clamp(),this.s!=r.s&&N.ZERO.subTo(e,e)}function d2(r){for(var e=this.abs(),t=r.t=2*e.t;--t>=0;)r.data[t]=0;for(t=0;t<e.t-1;++t){var n=e.am(t,e.data[t],r,2*t,0,1);(r.data[t+e.t]+=e.am(t+1,2*e.data[t],r,2*t+1,n,e.t-t-1))>=e.DV&&(r.data[t+e.t]-=e.DV,r.data[t+e.t+1]=1)}r.t>0&&(r.data[r.t-1]+=e.am(t,e.data[t],r,2*t,0,1)),r.s=0,r.clamp()}function p2(r,e,t){var n=r.abs();if(!(n.t<=0)){var i=this.abs();if(i.t<n.t){e?.fromInt(0),t!=null&&this.copyTo(t);return}t==null&&(t=pe());var s=pe(),o=this.s,a=r.s,c=this.DB-ta(n.data[n.t-1]);c>0?(n.lShiftTo(c,s),i.lShiftTo(c,t)):(n.copyTo(s),i.copyTo(t));var u=s.t,l=s.data[u-1];if(l!=0){var h=l*(1<<this.F1)+(u>1?s.data[u-2]>>this.F2:0),p=this.FV/h,g=(1<<this.F1)/h,f=1<<this.F2,d=t.t,m=d-u,y=e??pe();for(s.dlShiftTo(m,y),t.compareTo(y)>=0&&(t.data[t.t++]=1,t.subTo(y,t)),N.ONE.dlShiftTo(u,y),y.subTo(s,s);s.t<u;)s.data[s.t++]=0;for(;--m>=0;){var E=t.data[--d]==l?this.DM:Math.floor(t.data[d]*p+(t.data[d-1]+f)*g);if((t.data[d]+=s.am(0,E,t,m,0,u))<E)for(s.dlShiftTo(m,y),t.subTo(y,t);t.data[d]<--E;)t.subTo(y,t)}e!=null&&(t.drShiftTo(u,e),o!=a&&N.ZERO.subTo(e,e)),t.t=u,t.clamp(),c>0&&t.rShiftTo(c,t),o<0&&N.ZERO.subTo(t,t)}}}function m2(r){var e=pe();return this.abs().divRemTo(r,null,e),this.s<0&&e.compareTo(N.ZERO)>0&&r.subTo(e,e),e}function Vn(r){this.m=r}function y2(r){return r.s<0||r.compareTo(this.m)>=0?r.mod(this.m):r}function g2(r){return r}function b2(r){r.divRemTo(this.m,null,r)}function E2(r,e,t){r.multiplyTo(e,t),this.reduce(t)}function w2(r,e){r.squareTo(e),this.reduce(e)}Vn.prototype.convert=y2;Vn.prototype.revert=g2;Vn.prototype.reduce=b2;Vn.prototype.mulTo=E2;Vn.prototype.sqrTo=w2;function x2(){if(this.t<1)return 0;var r=this.data[0];if(!(r&1))return 0;var e=r&3;return e=e*(2-(r&15)*e)&15,e=e*(2-(r&255)*e)&255,e=e*(2-((r&65535)*e&65535))&65535,e=e*(2-r*e%this.DV)%this.DV,e>0?this.DV-e:-e}function zn(r){this.m=r,this.mp=r.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<r.DB-15)-1,this.mt2=2*r.t}function v2(r){var e=pe();return r.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),r.s<0&&e.compareTo(N.ZERO)>0&&this.m.subTo(e,e),e}function _2(r){var e=pe();return r.copyTo(e),this.reduce(e),e}function S2(r){for(;r.t<=this.mt2;)r.data[r.t++]=0;for(var e=0;e<this.m.t;++e){var t=r.data[e]&32767,n=t*this.mpl+((t*this.mph+(r.data[e]>>15)*this.mpl&this.um)<<15)&r.DM;for(t=e+this.m.t,r.data[t]+=this.m.am(0,n,r,e,0,this.m.t);r.data[t]>=r.DV;)r.data[t]-=r.DV,r.data[++t]++}r.clamp(),r.drShiftTo(this.m.t,r),r.compareTo(this.m)>=0&&r.subTo(this.m,r)}function A2(r,e){r.squareTo(e),this.reduce(e)}function R2(r,e,t){r.multiplyTo(e,t),this.reduce(t)}zn.prototype.convert=v2;zn.prototype.revert=_2;zn.prototype.reduce=S2;zn.prototype.mulTo=R2;zn.prototype.sqrTo=A2;function I2(){return(this.t>0?this.data[0]&1:this.s)==0}function C2(r,e){if(r>4294967295||r<1)return N.ONE;var t=pe(),n=pe(),i=e.convert(this),s=ta(r)-1;for(i.copyTo(t);--s>=0;)if(e.sqrTo(t,n),(r&1<<s)>0)e.mulTo(n,i,t);else{var o=t;t=n,n=o}return e.revert(t)}function D2(r,e){var t;return r<256||e.isEven()?t=new Vn(e):t=new zn(e),this.exp(r,t)}N.prototype.copyTo=jw;N.prototype.fromInt=Jw;N.prototype.fromString=e2;N.prototype.clamp=t2;N.prototype.dlShiftTo=a2;N.prototype.drShiftTo=c2;N.prototype.lShiftTo=u2;N.prototype.rShiftTo=l2;N.prototype.subTo=h2;N.prototype.multiplyTo=f2;N.prototype.squareTo=d2;N.prototype.divRemTo=p2;N.prototype.invDigit=x2;N.prototype.isEven=I2;N.prototype.exp=C2;N.prototype.toString=r2;N.prototype.negate=n2;N.prototype.abs=i2;N.prototype.compareTo=s2;N.prototype.bitLength=o2;N.prototype.mod=m2;N.prototype.modPowInt=D2;N.ZERO=rn(0);N.ONE=rn(1);function T2(){var r=pe();return this.copyTo(r),r}function L2(){if(this.s<0){if(this.t==1)return this.data[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this.data[0];if(this.t==0)return 0}return(this.data[1]&(1<<32-this.DB)-1)<<this.DB|this.data[0]}function k2(){return this.t==0?this.s:this.data[0]<<24>>24}function P2(){return this.t==0?this.s:this.data[0]<<16>>16}function N2(r){return Math.floor(Math.LN2*this.DB/Math.log(r))}function B2(){return this.s<0?-1:this.t<=0||this.t==1&&this.data[0]<=0?0:1}function O2(r){if(r==null&&(r=10),this.signum()==0||r<2||r>36)return"0";var e=this.chunkSize(r),t=Math.pow(r,e),n=rn(t),i=pe(),s=pe(),o="";for(this.divRemTo(n,i,s);i.signum()>0;)o=(t+s.intValue()).toString(r).substr(1)+o,i.divRemTo(n,i,s);return s.intValue().toString(r)+o}function M2(r,e){this.fromInt(0),e==null&&(e=10);for(var t=this.chunkSize(e),n=Math.pow(e,t),i=!1,s=0,o=0,a=0;a<r.length;++a){var c=T0(r,a);if(c<0){r.charAt(a)=="-"&&this.signum()==0&&(i=!0);continue}o=e*o+c,++s>=t&&(this.dMultiply(n),this.dAddOffset(o,0),s=0,o=0)}s>0&&(this.dMultiply(Math.pow(e,s)),this.dAddOffset(o,0)),i&&N.ZERO.subTo(this,this)}function U2(r,e,t){if(typeof e=="number")if(r<2)this.fromInt(1);else for(this.fromNumber(r,t),this.testBit(r-1)||this.bitwiseTo(N.ONE.shiftLeft(r-1),Du,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>r&&this.subTo(N.ONE.shiftLeft(r-1),this);else{var n=new Array,i=r&7;n.length=(r>>3)+1,e.nextBytes(n),i>0?n[0]&=(1<<i)-1:n[0]=0,this.fromString(n,256)}}function $2(){var r=this.t,e=new Array;e[0]=this.s;var t=this.DB-r*this.DB%8,n,i=0;if(r-- >0)for(t<this.DB&&(n=this.data[r]>>t)!=(this.s&this.DM)>>t&&(e[i++]=n|this.s<<this.DB-t);r>=0;)t<8?(n=(this.data[r]&(1<<t)-1)<<8-t,n|=this.data[--r]>>(t+=this.DB-8)):(n=this.data[r]>>(t-=8)&255,t<=0&&(t+=this.DB,--r)),n&128&&(n|=-256),i==0&&(this.s&128)!=(n&128)&&++i,(i>0||n!=this.s)&&(e[i++]=n);return e}function F2(r){return this.compareTo(r)==0}function K2(r){return this.compareTo(r)<0?this:r}function V2(r){return this.compareTo(r)>0?this:r}function z2(r,e,t){var n,i,s=Math.min(r.t,this.t);for(n=0;n<s;++n)t.data[n]=e(this.data[n],r.data[n]);if(r.t<this.t){for(i=r.s&this.DM,n=s;n<this.t;++n)t.data[n]=e(this.data[n],i);t.t=this.t}else{for(i=this.s&this.DM,n=s;n<r.t;++n)t.data[n]=e(i,r.data[n]);t.t=r.t}t.s=e(this.s,r.s),t.clamp()}function q2(r,e){return r&e}function H2(r){var e=pe();return this.bitwiseTo(r,q2,e),e}function Du(r,e){return r|e}function W2(r){var e=pe();return this.bitwiseTo(r,Du,e),e}function L0(r,e){return r^e}function G2(r){var e=pe();return this.bitwiseTo(r,L0,e),e}function k0(r,e){return r&~e}function Y2(r){var e=pe();return this.bitwiseTo(r,k0,e),e}function Q2(){for(var r=pe(),e=0;e<this.t;++e)r.data[e]=this.DM&~this.data[e];return r.t=this.t,r.s=~this.s,r}function X2(r){var e=pe();return r<0?this.rShiftTo(-r,e):this.lShiftTo(r,e),e}function Z2(r){var e=pe();return r<0?this.lShiftTo(-r,e):this.rShiftTo(r,e),e}function j2(r){if(r==0)return-1;var e=0;return r&65535||(r>>=16,e+=16),r&255||(r>>=8,e+=8),r&15||(r>>=4,e+=4),r&3||(r>>=2,e+=2),r&1||++e,e}function J2(){for(var r=0;r<this.t;++r)if(this.data[r]!=0)return r*this.DB+j2(this.data[r]);return this.s<0?this.t*this.DB:-1}function ex(r){for(var e=0;r!=0;)r&=r-1,++e;return e}function tx(){for(var r=0,e=this.s&this.DM,t=0;t<this.t;++t)r+=ex(this.data[t]^e);return r}function rx(r){var e=Math.floor(r/this.DB);return e>=this.t?this.s!=0:(this.data[e]&1<<r%this.DB)!=0}function nx(r,e){var t=N.ONE.shiftLeft(r);return this.bitwiseTo(t,e,t),t}function ix(r){return this.changeBit(r,Du)}function sx(r){return this.changeBit(r,k0)}function ox(r){return this.changeBit(r,L0)}function ax(r,e){for(var t=0,n=0,i=Math.min(r.t,this.t);t<i;)n+=this.data[t]+r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n+=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n+=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=r.s}e.s=n<0?-1:0,n>0?e.data[t++]=n:n<-1&&(e.data[t++]=this.DV+n),e.t=t,e.clamp()}function cx(r){var e=pe();return this.addTo(r,e),e}function ux(r){var e=pe();return this.subTo(r,e),e}function lx(r){var e=pe();return this.multiplyTo(r,e),e}function hx(r){var e=pe();return this.divRemTo(r,e,null),e}function fx(r){var e=pe();return this.divRemTo(r,null,e),e}function dx(r){var e=pe(),t=pe();return this.divRemTo(r,e,t),new Array(e,t)}function px(r){this.data[this.t]=this.am(0,r-1,this,0,0,this.t),++this.t,this.clamp()}function mx(r,e){if(r!=0){for(;this.t<=e;)this.data[this.t++]=0;for(this.data[e]+=r;this.data[e]>=this.DV;)this.data[e]-=this.DV,++e>=this.t&&(this.data[this.t++]=0),++this.data[e]}}function ws(){}function P0(r){return r}function yx(r,e,t){r.multiplyTo(e,t)}function gx(r,e){r.squareTo(e)}ws.prototype.convert=P0;ws.prototype.revert=P0;ws.prototype.mulTo=yx;ws.prototype.sqrTo=gx;function bx(r){return this.exp(r,new ws)}function Ex(r,e,t){var n=Math.min(this.t+r.t,e);for(t.s=0,t.t=n;n>0;)t.data[--n]=0;var i;for(i=t.t-this.t;n<i;++n)t.data[n+this.t]=this.am(0,r.data[n],t,n,0,this.t);for(i=Math.min(r.t,e);n<i;++n)this.am(0,r.data[n],t,n,0,e-n);t.clamp()}function wx(r,e,t){--e;var n=t.t=this.t+r.t-e;for(t.s=0;--n>=0;)t.data[n]=0;for(n=Math.max(e-this.t,0);n<r.t;++n)t.data[this.t+n-e]=this.am(e-n,r.data[n],t,0,0,this.t+n-e);t.clamp(),t.drShiftTo(1,t)}function Ii(r){this.r2=pe(),this.q3=pe(),N.ONE.dlShiftTo(2*r.t,this.r2),this.mu=this.r2.divide(r),this.m=r}function xx(r){if(r.s<0||r.t>2*this.m.t)return r.mod(this.m);if(r.compareTo(this.m)<0)return r;var e=pe();return r.copyTo(e),this.reduce(e),e}function vx(r){return r}function _x(r){for(r.drShiftTo(this.m.t-1,this.r2),r.t>this.m.t+1&&(r.t=this.m.t+1,r.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);r.compareTo(this.r2)<0;)r.dAddOffset(1,this.m.t+1);for(r.subTo(this.r2,r);r.compareTo(this.m)>=0;)r.subTo(this.m,r)}function Sx(r,e){r.squareTo(e),this.reduce(e)}function Ax(r,e,t){r.multiplyTo(e,t),this.reduce(t)}Ii.prototype.convert=xx;Ii.prototype.revert=vx;Ii.prototype.reduce=_x;Ii.prototype.mulTo=Ax;Ii.prototype.sqrTo=Sx;function Rx(r,e){var t=r.bitLength(),n,i=rn(1),s;if(t<=0)return i;t<18?n=1:t<48?n=3:t<144?n=4:t<768?n=5:n=6,t<8?s=new Vn(e):e.isEven()?s=new Ii(e):s=new zn(e);var o=new Array,a=3,c=n-1,u=(1<<n)-1;if(o[1]=s.convert(this),n>1){var l=pe();for(s.sqrTo(o[1],l);a<=u;)o[a]=pe(),s.mulTo(l,o[a-2],o[a]),a+=2}var h=r.t-1,p,g=!0,f=pe(),d;for(t=ta(r.data[h])-1;h>=0;){for(t>=c?p=r.data[h]>>t-c&u:(p=(r.data[h]&(1<<t+1)-1)<<c-t,h>0&&(p|=r.data[h-1]>>this.DB+t-c)),a=n;!(p&1);)p>>=1,--a;if((t-=a)<0&&(t+=this.DB,--h),g)o[p].copyTo(i),g=!1;else{for(;a>1;)s.sqrTo(i,f),s.sqrTo(f,i),a-=2;a>0?s.sqrTo(i,f):(d=i,i=f,f=d),s.mulTo(f,o[p],i)}for(;h>=0&&!(r.data[h]&1<<t);)s.sqrTo(i,f),d=i,i=f,f=d,--t<0&&(t=this.DB-1,--h)}return s.revert(i)}function Ix(r){var e=this.s<0?this.negate():this.clone(),t=r.s<0?r.negate():r.clone();if(e.compareTo(t)<0){var n=e;e=t,t=n}var i=e.getLowestSetBit(),s=t.getLowestSetBit();if(s<0)return e;for(i<s&&(s=i),s>0&&(e.rShiftTo(s,e),t.rShiftTo(s,t));e.signum()>0;)(i=e.getLowestSetBit())>0&&e.rShiftTo(i,e),(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),e.compareTo(t)>=0?(e.subTo(t,e),e.rShiftTo(1,e)):(t.subTo(e,t),t.rShiftTo(1,t));return s>0&&t.lShiftTo(s,t),t}function Cx(r){if(r<=0)return 0;var e=this.DV%r,t=this.s<0?r-1:0;if(this.t>0)if(e==0)t=this.data[0]%r;else for(var n=this.t-1;n>=0;--n)t=(e*t+this.data[n])%r;return t}function Dx(r){var e=r.isEven();if(this.isEven()&&e||r.signum()==0)return N.ZERO;for(var t=r.clone(),n=this.clone(),i=rn(1),s=rn(0),o=rn(0),a=rn(1);t.signum()!=0;){for(;t.isEven();)t.rShiftTo(1,t),e?((!i.isEven()||!s.isEven())&&(i.addTo(this,i),s.subTo(r,s)),i.rShiftTo(1,i)):s.isEven()||s.subTo(r,s),s.rShiftTo(1,s);for(;n.isEven();)n.rShiftTo(1,n),e?((!o.isEven()||!a.isEven())&&(o.addTo(this,o),a.subTo(r,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(r,a),a.rShiftTo(1,a);t.compareTo(n)>=0?(t.subTo(n,t),e&&i.subTo(o,i),s.subTo(a,s)):(n.subTo(t,n),e&&o.subTo(i,o),a.subTo(s,a))}if(n.compareTo(N.ONE)!=0)return N.ZERO;if(a.compareTo(r)>=0)return a.subtract(r);if(a.signum()<0)a.addTo(r,a);else return a;return a.signum()<0?a.add(r):a}var sr=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509],Tx=(1<<26)/sr[sr.length-1];function Lx(r){var e,t=this.abs();if(t.t==1&&t.data[0]<=sr[sr.length-1]){for(e=0;e<sr.length;++e)if(t.data[0]==sr[e])return!0;return!1}if(t.isEven())return!1;for(e=1;e<sr.length;){for(var n=sr[e],i=e+1;i<sr.length&&n<Tx;)n*=sr[i++];for(n=t.modInt(n);e<i;)if(n%sr[e++]==0)return!1}return t.millerRabin(r)}function kx(r){var e=this.subtract(N.ONE),t=e.getLowestSetBit();if(t<=0)return!1;for(var n=e.shiftRight(t),i=Px(),s,o=0;o<r;++o){do s=new N(this.bitLength(),i);while(s.compareTo(N.ONE)<=0||s.compareTo(e)>=0);var a=s.modPow(n,this);if(a.compareTo(N.ONE)!=0&&a.compareTo(e)!=0){for(var c=1;c++<t&&a.compareTo(e)!=0;)if(a=a.modPowInt(2,this),a.compareTo(N.ONE)==0)return!1;if(a.compareTo(e)!=0)return!1}}return!0}function Px(){return{nextBytes:function(r){for(var e=0;e<r.length;++e)r[e]=Math.floor(Math.random()*256)}}}N.prototype.chunkSize=N2;N.prototype.toRadix=O2;N.prototype.fromRadix=M2;N.prototype.fromNumber=U2;N.prototype.bitwiseTo=z2;N.prototype.changeBit=nx;N.prototype.addTo=ax;N.prototype.dMultiply=px;N.prototype.dAddOffset=mx;N.prototype.multiplyLowerTo=Ex;N.prototype.multiplyUpperTo=wx;N.prototype.modInt=Cx;N.prototype.millerRabin=kx;N.prototype.clone=T2;N.prototype.intValue=L2;N.prototype.byteValue=k2;N.prototype.shortValue=P2;N.prototype.signum=B2;N.prototype.toByteArray=$2;N.prototype.equals=F2;N.prototype.min=K2;N.prototype.max=V2;N.prototype.and=H2;N.prototype.or=W2;N.prototype.xor=G2;N.prototype.andNot=Y2;N.prototype.not=Q2;N.prototype.shiftLeft=X2;N.prototype.shiftRight=Z2;N.prototype.getLowestSetBit=J2;N.prototype.bitCount=tx;N.prototype.testBit=rx;N.prototype.setBit=ix;N.prototype.clearBit=sx;N.prototype.flipBit=ox;N.prototype.add=cx;N.prototype.subtract=ux;N.prototype.multiply=lx;N.prototype.divide=hx;N.prototype.remainder=fx;N.prototype.divideAndRemainder=dx;N.prototype.modPow=Rx;N.prototype.modInverse=Dx;N.prototype.pow=bx;N.prototype.gcd=Ix;N.prototype.isProbablePrime=Lx;var mr=Be,N0=mr.sha1=mr.sha1||{};mr.md.sha1=mr.md.algorithms.sha1=N0;N0.create=function(){B0||Nx();var r=null,e=mr.util.createBuffer(),t=new Array(80),n={algorithm:"sha1",blockLength:64,digestLength:20,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var i=n.messageLengthSize/4,s=0;s<i;++s)n.fullMessageLength.push(0);return e=mr.util.createBuffer(),r={h0:1732584193,h1:4023233417,h2:2562383102,h3:271733878,h4:3285377520},n},n.start(),n.update=function(i,s){s==="utf8"&&(i=mr.util.encodeUtf8(i));var o=i.length;n.messageLength+=o,o=[o/4294967296>>>0,o>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=o[1],o[1]=o[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,o[0]=o[1]/4294967296>>>0;return e.putBytes(i),fh(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var i=mr.util.createBuffer();i.putBytes(e.bytes());var s=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,o=s&n.blockLength-1;i.putBytes(Mc.substr(0,n.blockLength-o));for(var a,c,u=n.fullMessageLength[0]*8,l=0;l<n.fullMessageLength.length-1;++l)a=n.fullMessageLength[l+1]*8,c=a/4294967296>>>0,u+=c,i.putInt32(u>>>0),u=a>>>0;i.putInt32(u);var h={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4};fh(h,t,i);var p=mr.util.createBuffer();return p.putInt32(h.h0),p.putInt32(h.h1),p.putInt32(h.h2),p.putInt32(h.h3),p.putInt32(h.h4),p},n};var Mc=null,B0=!1;function Nx(){Mc=String.fromCharCode(128),Mc+=mr.util.fillString(String.fromCharCode(0),64),B0=!0}function fh(r,e,t){for(var n,i,s,o,a,c,u,l,h=t.length();h>=64;){for(i=r.h0,s=r.h1,o=r.h2,a=r.h3,c=r.h4,l=0;l<16;++l)n=t.getInt32(),e[l]=n,u=a^s&(o^a),n=(i<<5|i>>>27)+u+c+1518500249+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;l<20;++l)n=e[l-3]^e[l-8]^e[l-14]^e[l-16],n=n<<1|n>>>31,e[l]=n,u=a^s&(o^a),n=(i<<5|i>>>27)+u+c+1518500249+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;l<32;++l)n=e[l-3]^e[l-8]^e[l-14]^e[l-16],n=n<<1|n>>>31,e[l]=n,u=s^o^a,n=(i<<5|i>>>27)+u+c+1859775393+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;l<40;++l)n=e[l-6]^e[l-16]^e[l-28]^e[l-32],n=n<<2|n>>>30,e[l]=n,u=s^o^a,n=(i<<5|i>>>27)+u+c+1859775393+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;l<60;++l)n=e[l-6]^e[l-16]^e[l-28]^e[l-32],n=n<<2|n>>>30,e[l]=n,u=s&o|a&(s^o),n=(i<<5|i>>>27)+u+c+2400959708+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;for(;l<80;++l)n=e[l-6]^e[l-16]^e[l-28]^e[l-32],n=n<<2|n>>>30,e[l]=n,u=s^o^a,n=(i<<5|i>>>27)+u+c+3395469782+n,c=a,a=o,o=(s<<30|s>>>2)>>>0,s=i,i=n;r.h0=r.h0+i|0,r.h1=r.h1+s|0,r.h2=r.h2+o|0,r.h3=r.h3+a|0,r.h4=r.h4+c|0,h-=64}}var yr=Be,O0=yr.pkcs1=yr.pkcs1||{};O0.encode_rsa_oaep=function(r,e,t){var n,i,s,o;typeof t=="string"?(n=t,i=arguments[3]||void 0,s=arguments[4]||void 0):t&&(n=t.label||void 0,i=t.seed||void 0,s=t.md||void 0,t.mgf1&&t.mgf1.md&&(o=t.mgf1.md)),s?s.start():s=yr.md.sha1.create(),o||(o=s);var a=Math.ceil(r.n.bitLength()/8),c=a-2*s.digestLength-2;if(e.length>c){var u=new Error("RSAES-OAEP input message length is too long.");throw u.length=e.length,u.maxLength=c,u}n||(n=""),s.update(n,"raw");for(var l=s.digest(),h="",p=c-e.length,g=0;g<p;g++)h+="\0";var f=l.getBytes()+h+""+e;if(!i)i=yr.random.getBytes(s.digestLength);else if(i.length!==s.digestLength){var u=new Error("Invalid RSAES-OAEP seed. The seed length must match the digest length.");throw u.seedLength=i.length,u.digestLength=s.digestLength,u}var d=fo(i,a-s.digestLength-1,o),m=yr.util.xorBytes(f,d,f.length),y=fo(m,s.digestLength,o),E=yr.util.xorBytes(i,y,i.length);return"\0"+E+m};O0.decode_rsa_oaep=function(r,e,t){var n,i,s;typeof t=="string"?(n=t,i=arguments[3]||void 0):t&&(n=t.label||void 0,i=t.md||void 0,t.mgf1&&t.mgf1.md&&(s=t.mgf1.md));var o=Math.ceil(r.n.bitLength()/8);if(e.length!==o){var m=new Error("RSAES-OAEP encoded message length is invalid.");throw m.length=e.length,m.expectedLength=o,m}if(i===void 0?i=yr.md.sha1.create():i.start(),s||(s=i),o<2*i.digestLength+2)throw new Error("RSAES-OAEP key is too short for the hash function.");n||(n=""),i.update(n,"raw");for(var a=i.digest().getBytes(),c=e.charAt(0),u=e.substring(1,i.digestLength+1),l=e.substring(1+i.digestLength),h=fo(l,i.digestLength,s),p=yr.util.xorBytes(u,h,u.length),g=fo(p,o-i.digestLength-1,s),f=yr.util.xorBytes(l,g,l.length),d=f.substring(0,i.digestLength),m=c!=="\0",y=0;y<i.digestLength;++y)m|=a.charAt(y)!==d.charAt(y);for(var E=1,b=i.digestLength,x=i.digestLength;x<f.length;x++){var w=f.charCodeAt(x),v=w&1^1,S=E?65534:0;m|=w&S,E=E&v,b+=E}if(m||f.charCodeAt(b)!==1)throw new Error("Invalid RSAES-OAEP padding.");return f.substring(b+1)};function fo(r,e,t){t||(t=yr.md.sha1.create());for(var n="",i=Math.ceil(e/t.digestLength),s=0;s<i;++s){var o=String.fromCharCode(s>>24&255,s>>16&255,s>>8&255,s&255);t.start(),t.update(r+o),n+=t.digest().getBytes()}return n.substring(0,e)}var zr=Be;(function(){if(zr.prime){zr.prime;return}var r=zr.prime=zr.prime||{},e=zr.jsbn.BigInteger,t=[6,4,2,4,2,4,6,2],n=new e(null);n.fromInt(30);var i=function(h,p){return h|p};r.generateProbablePrime=function(h,p,g){typeof p=="function"&&(g=p,p={}),p=p||{};var f=p.algorithm||"PRIMEINC";typeof f=="string"&&(f={name:f}),f.options=f.options||{};var d=p.prng||zr.random,m={nextBytes:function(y){for(var E=d.getBytesSync(y.length),b=0;b<y.length;++b)y[b]=E.charCodeAt(b)}};if(f.name==="PRIMEINC")return s(h,m,f.options,g);throw new Error("Invalid prime generation algorithm: "+f.name)};function s(h,p,g,f){return"workers"in g?c(h,p,g,f):o(h,p,g,f)}function o(h,p,g,f){var d=u(h,p),m=0,y=l(d.bitLength());"millerRabinTests"in g&&(y=g.millerRabinTests);var E=10;"maxBlockTime"in g&&(E=g.maxBlockTime),a(d,h,p,m,y,E,f)}function a(h,p,g,f,d,m,y){var E=+new Date;do{if(h.bitLength()>p&&(h=u(p,g)),h.isProbablePrime(d))return y(null,h);h.dAddOffset(t[f++%8],0)}while(m<0||+new Date-E<m);zr.util.setImmediate(function(){a(h,p,g,f,d,m,y)})}function c(h,p,g,f){if(typeof Worker>"u")return o(h,p,g,f);var d=u(h,p),m=g.workers,y=g.workLoad||100,E=y*30/8,b=g.workerScript||"forge/prime.worker.js";if(m===-1)return zr.util.estimateCores(function(w,v){w&&(v=2),m=v-1,x()});x();function x(){m=Math.max(1,m);for(var w=[],v=0;v<m;++v)w[v]=new Worker(b);for(var v=0;v<m;++v)w[v].addEventListener("message",C);var S=!1;function C(B){if(!S){var F=B.data;if(F.found){for(var U=0;U<w.length;++U)w[U].terminate();return S=!0,f(null,new e(F.prime,16))}d.bitLength()>h&&(d=u(h,p));var q=d.toString(16);B.target.postMessage({hex:q,workLoad:y}),d.dAddOffset(E,0)}}}}function u(h,p){var g=new e(h,p),f=h-1;return g.testBit(f)||g.bitwiseTo(e.ONE.shiftLeft(f),i,g),g.dAddOffset(31-g.mod(n).byteValue(),0),g}function l(h){return h<=100?27:h<=150?18:h<=200?15:h<=250?12:h<=300?9:h<=350?8:h<=400?7:h<=500?6:h<=600?5:h<=800?4:h<=1250?3:2}})();var Q=Be;if(typeof de>"u")var de=Q.jsbn.BigInteger;var Uc=Q.util.isNodejs?Kn:null,R=Q.asn1,Wt=Q.util;Q.pki=Q.pki||{};Q.pki.rsa=Q.rsa=Q.rsa||{};var te=Q.pki,Bx=[6,4,2,4,2,4,6,2],Ox={name:"PrivateKeyInfo",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:R.Class.UNIVERSAL,type:R.Type.OCTETSTRING,constructed:!1,capture:"privateKey"}]},Mx={name:"RSAPrivateKey",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPrivateKey.version",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"RSAPrivateKey.modulus",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyModulus"},{name:"RSAPrivateKey.publicExponent",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyPublicExponent"},{name:"RSAPrivateKey.privateExponent",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyPrivateExponent"},{name:"RSAPrivateKey.prime1",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyPrime1"},{name:"RSAPrivateKey.prime2",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyPrime2"},{name:"RSAPrivateKey.exponent1",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyExponent1"},{name:"RSAPrivateKey.exponent2",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyExponent2"},{name:"RSAPrivateKey.coefficient",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"privateKeyCoefficient"}]},Ux={name:"RSAPublicKey",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPublicKey.modulus",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"publicKeyModulus"},{name:"RSAPublicKey.exponent",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"publicKeyExponent"}]},$x=Q.pki.rsa.publicKeyValidator={name:"SubjectPublicKeyInfo",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"subjectPublicKeyInfo",value:[{name:"SubjectPublicKeyInfo.AlgorithmIdentifier",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"publicKeyOid"}]},{name:"SubjectPublicKeyInfo.subjectPublicKey",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,value:[{name:"SubjectPublicKeyInfo.subjectPublicKey.RSAPublicKey",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"rsaPublicKey"}]}]},Fx={name:"DigestInfo",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm.algorithmIdentifier",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"algorithmIdentifier"},{name:"DigestInfo.DigestAlgorithm.parameters",tagClass:R.Class.UNIVERSAL,type:R.Type.NULL,capture:"parameters",optional:!0,constructed:!1}]},{name:"DigestInfo.digest",tagClass:R.Class.UNIVERSAL,type:R.Type.OCTETSTRING,constructed:!1,capture:"digest"}]},Kx=function(r){var e;if(r.algorithm in te.oids)e=te.oids[r.algorithm];else{var t=new Error("Unknown message digest algorithm.");throw t.algorithm=r.algorithm,t}var n=R.oidToDer(e).getBytes(),i=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]),s=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);s.value.push(R.create(R.Class.UNIVERSAL,R.Type.OID,!1,n)),s.value.push(R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,""));var o=R.create(R.Class.UNIVERSAL,R.Type.OCTETSTRING,!1,r.digest().getBytes());return i.value.push(s),i.value.push(o),R.toDer(i).getBytes()},M0=function(r,e,t){if(t)return r.modPow(e.e,e.n);if(!e.p||!e.q)return r.modPow(e.d,e.n);e.dP||(e.dP=e.d.mod(e.p.subtract(de.ONE))),e.dQ||(e.dQ=e.d.mod(e.q.subtract(de.ONE))),e.qInv||(e.qInv=e.q.modInverse(e.p));var n;do n=new de(Q.util.bytesToHex(Q.random.getBytes(e.n.bitLength()/8)),16);while(n.compareTo(e.n)>=0||!n.gcd(e.n).equals(de.ONE));r=r.multiply(n.modPow(e.e,e.n)).mod(e.n);for(var i=r.mod(e.p).modPow(e.dP,e.p),s=r.mod(e.q).modPow(e.dQ,e.q);i.compareTo(s)<0;)i=i.add(e.p);var o=i.subtract(s).multiply(e.qInv).mod(e.p).multiply(e.q).add(s);return o=o.multiply(n.modInverse(e.n)).mod(e.n),o};te.rsa.encrypt=function(r,e,t){var n=t,i,s=Math.ceil(e.n.bitLength()/8);t!==!1&&t!==!0?(n=t===2,i=U0(r,e,t)):(i=Q.util.createBuffer(),i.putBytes(r));for(var o=new de(i.toHex(),16),a=M0(o,e,n),c=a.toString(16),u=Q.util.createBuffer(),l=s-Math.ceil(c.length/2);l>0;)u.putByte(0),--l;return u.putBytes(Q.util.hexToBytes(c)),u.getBytes()};te.rsa.decrypt=function(r,e,t,n){var i=Math.ceil(e.n.bitLength()/8);if(r.length!==i){var s=new Error("Encrypted message length is invalid.");throw s.length=r.length,s.expected=i,s}var o=new de(Q.util.createBuffer(r).toHex(),16);if(o.compareTo(e.n)>=0)throw new Error("Encrypted message is invalid.");for(var a=M0(o,e,t),c=a.toString(16),u=Q.util.createBuffer(),l=i-Math.ceil(c.length/2);l>0;)u.putByte(0),--l;return u.putBytes(Q.util.hexToBytes(c)),n!==!1?po(u.getBytes(),e,t):u.getBytes()};te.rsa.createKeyPairGenerationState=function(r,e,t){typeof r=="string"&&(r=parseInt(r,10)),r=r||2048,t=t||{};var n=t.prng||Q.random,i={nextBytes:function(a){for(var c=n.getBytesSync(a.length),u=0;u<a.length;++u)a[u]=c.charCodeAt(u)}},s=t.algorithm||"PRIMEINC",o;if(s==="PRIMEINC")o={algorithm:s,state:0,bits:r,rng:i,eInt:e||65537,e:new de(null),p:null,q:null,qBits:r>>1,pBits:r-(r>>1),pqState:0,num:null,keys:null},o.e.fromInt(o.eInt);else throw new Error("Invalid key generation algorithm: "+s);return o};te.rsa.stepKeyPairGenerationState=function(r,e){"algorithm"in r||(r.algorithm="PRIMEINC");var t=new de(null);t.fromInt(30);for(var n=0,i=function(h,p){return h|p},s=+new Date,o,a=0;r.keys===null&&(e<=0||a<e);){if(r.state===0){var c=r.p===null?r.pBits:r.qBits,u=c-1;r.pqState===0?(r.num=new de(c,r.rng),r.num.testBit(u)||r.num.bitwiseTo(de.ONE.shiftLeft(u),i,r.num),r.num.dAddOffset(31-r.num.mod(t).byteValue(),0),n=0,++r.pqState):r.pqState===1?r.num.bitLength()>c?r.pqState=0:r.num.isProbablePrime(zx(r.num.bitLength()))?++r.pqState:r.num.dAddOffset(Bx[n++%8],0):r.pqState===2?r.pqState=r.num.subtract(de.ONE).gcd(r.e).compareTo(de.ONE)===0?3:0:r.pqState===3&&(r.pqState=0,r.p===null?r.p=r.num:r.q=r.num,r.p!==null&&r.q!==null&&++r.state,r.num=null)}else if(r.state===1)r.p.compareTo(r.q)<0&&(r.num=r.p,r.p=r.q,r.q=r.num),++r.state;else if(r.state===2)r.p1=r.p.subtract(de.ONE),r.q1=r.q.subtract(de.ONE),r.phi=r.p1.multiply(r.q1),++r.state;else if(r.state===3)r.phi.gcd(r.e).compareTo(de.ONE)===0?++r.state:(r.p=null,r.q=null,r.state=0);else if(r.state===4)r.n=r.p.multiply(r.q),r.n.bitLength()===r.bits?++r.state:(r.q=null,r.state=0);else if(r.state===5){var l=r.e.modInverse(r.phi);r.keys={privateKey:te.rsa.setPrivateKey(r.n,r.e,l,r.p,r.q,l.mod(r.p1),l.mod(r.q1),r.q.modInverse(r.p)),publicKey:te.rsa.setPublicKey(r.n,r.e)}}o=+new Date,a+=o-s,s=o}return r.keys!==null};te.rsa.generateKeyPair=function(r,e,t,n){if(arguments.length===1?typeof r=="object"?(t=r,r=void 0):typeof r=="function"&&(n=r,r=void 0):arguments.length===2?typeof r=="number"?typeof e=="function"?(n=e,e=void 0):typeof e!="number"&&(t=e,e=void 0):(t=r,n=e,r=void 0,e=void 0):arguments.length===3&&(typeof e=="number"?typeof t=="function"&&(n=t,t=void 0):(n=t,t=e,e=void 0)),t=t||{},r===void 0&&(r=t.bits||2048),e===void 0&&(e=t.e||65537),!Q.options.usePureJavaScript&&!t.prng&&r>=256&&r<=16384&&(e===65537||e===3)){if(n){if(dh("generateKeyPair"))return Uc.generateKeyPair("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}},function(a,c,u){if(a)return n(a);n(null,{privateKey:te.privateKeyFromPem(u),publicKey:te.publicKeyFromPem(c)})});if(ph("generateKey")&&ph("exportKey"))return Wt.globalScope.crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:yh(e),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return Wt.globalScope.crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(void 0,function(a){n(a)}).then(function(a){if(a){var c=te.privateKeyFromAsn1(R.fromDer(Q.util.createBuffer(a)));n(null,{privateKey:c,publicKey:te.setRsaPublicKey(c.n,c.e)})}});if(mh("generateKey")&&mh("exportKey")){var i=Wt.globalScope.msCrypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:yh(e),hash:{name:"SHA-256"}},!0,["sign","verify"]);i.oncomplete=function(a){var c=a.target.result,u=Wt.globalScope.msCrypto.subtle.exportKey("pkcs8",c.privateKey);u.oncomplete=function(l){var h=l.target.result,p=te.privateKeyFromAsn1(R.fromDer(Q.util.createBuffer(h)));n(null,{privateKey:p,publicKey:te.setRsaPublicKey(p.n,p.e)})},u.onerror=function(l){n(l)}},i.onerror=function(a){n(a)};return}}else if(dh("generateKeyPairSync")){var s=Uc.generateKeyPairSync("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}});return{privateKey:te.privateKeyFromPem(s.privateKey),publicKey:te.publicKeyFromPem(s.publicKey)}}}var o=te.rsa.createKeyPairGenerationState(r,e,t);if(!n)return te.rsa.stepKeyPairGenerationState(o,0),o.keys;Vx(o,t,n)};te.setRsaPublicKey=te.rsa.setPublicKey=function(r,e){var t={n:r,e};return t.encrypt=function(n,i,s){if(typeof i=="string"?i=i.toUpperCase():i===void 0&&(i="RSAES-PKCS1-V1_5"),i==="RSAES-PKCS1-V1_5")i={encode:function(a,c,u){return U0(a,c,2).getBytes()}};else if(i==="RSA-OAEP"||i==="RSAES-OAEP")i={encode:function(a,c){return Q.pkcs1.encode_rsa_oaep(c,a,s)}};else if(["RAW","NONE","NULL",null].indexOf(i)!==-1)i={encode:function(a){return a}};else if(typeof i=="string")throw new Error('Unsupported encryption scheme: "'+i+'".');var o=i.encode(n,t,!0);return te.rsa.encrypt(o,t,!0)},t.verify=function(n,i,s,o){typeof s=="string"?s=s.toUpperCase():s===void 0&&(s="RSASSA-PKCS1-V1_5"),o===void 0&&(o={_parseAllDigestBytes:!0}),"_parseAllDigestBytes"in o||(o._parseAllDigestBytes=!0),s==="RSASSA-PKCS1-V1_5"?s={verify:function(c,u){u=po(u,t,!0);var l=R.fromDer(u,{parseAllBytes:o._parseAllDigestBytes}),h={},p=[];if(!R.validate(l,Fx,h,p)){var g=new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value.");throw g.errors=p,g}var f=R.derToOid(h.algorithmIdentifier);if(!(f===Q.oids.md2||f===Q.oids.md5||f===Q.oids.sha1||f===Q.oids.sha224||f===Q.oids.sha256||f===Q.oids.sha384||f===Q.oids.sha512||f===Q.oids["sha512-224"]||f===Q.oids["sha512-256"])){var g=new Error("Unknown RSASSA-PKCS1-v1_5 DigestAlgorithm identifier.");throw g.oid=f,g}if((f===Q.oids.md2||f===Q.oids.md5)&&!("parameters"in h))throw new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value. Missing algorithm identifer NULL parameters.");return c===h.digest}}:(s==="NONE"||s==="NULL"||s===null)&&(s={verify:function(c,u){return u=po(u,t,!0),c===u}});var a=te.rsa.decrypt(i,t,!0,!1);return s.verify(n,a,t.n.bitLength())},t};te.setRsaPrivateKey=te.rsa.setPrivateKey=function(r,e,t,n,i,s,o,a){var c={n:r,e,d:t,p:n,q:i,dP:s,dQ:o,qInv:a};return c.decrypt=function(u,l,h){typeof l=="string"?l=l.toUpperCase():l===void 0&&(l="RSAES-PKCS1-V1_5");var p=te.rsa.decrypt(u,c,!1,!1);if(l==="RSAES-PKCS1-V1_5")l={decode:po};else if(l==="RSA-OAEP"||l==="RSAES-OAEP")l={decode:function(g,f){return Q.pkcs1.decode_rsa_oaep(f,g,h)}};else if(["RAW","NONE","NULL",null].indexOf(l)!==-1)l={decode:function(g){return g}};else throw new Error('Unsupported encryption scheme: "'+l+'".');return l.decode(p,c,!1)},c.sign=function(u,l){var h=!1;typeof l=="string"&&(l=l.toUpperCase()),l===void 0||l==="RSASSA-PKCS1-V1_5"?(l={encode:Kx},h=1):(l==="NONE"||l==="NULL"||l===null)&&(l={encode:function(){return u}},h=1);var p=l.encode(u,c.n.bitLength());return te.rsa.encrypt(p,c,h)},c};te.wrapRsaPrivateKey=function(r){return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(0).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(te.oids.rsaEncryption).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")]),R.create(R.Class.UNIVERSAL,R.Type.OCTETSTRING,!1,R.toDer(r).getBytes())])};te.privateKeyFromAsn1=function(r){var e={},t=[];if(R.validate(r,Ox,e,t)&&(r=R.fromDer(Q.util.createBuffer(e.privateKey))),e={},t=[],!R.validate(r,Mx,e,t)){var n=new Error("Cannot read private key. ASN.1 object does not contain an RSAPrivateKey.");throw n.errors=t,n}var i,s,o,a,c,u,l,h;return i=Q.util.createBuffer(e.privateKeyModulus).toHex(),s=Q.util.createBuffer(e.privateKeyPublicExponent).toHex(),o=Q.util.createBuffer(e.privateKeyPrivateExponent).toHex(),a=Q.util.createBuffer(e.privateKeyPrime1).toHex(),c=Q.util.createBuffer(e.privateKeyPrime2).toHex(),u=Q.util.createBuffer(e.privateKeyExponent1).toHex(),l=Q.util.createBuffer(e.privateKeyExponent2).toHex(),h=Q.util.createBuffer(e.privateKeyCoefficient).toHex(),te.setRsaPrivateKey(new de(i,16),new de(s,16),new de(o,16),new de(a,16),new de(c,16),new de(u,16),new de(l,16),new de(h,16))};te.privateKeyToAsn1=te.privateKeyToRSAPrivateKey=function(r){return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(0).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.n)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.e)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.d)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.p)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.q)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.dP)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.dQ)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.qInv))])};te.publicKeyFromAsn1=function(r){var e={},t=[];if(R.validate(r,$x,e,t)){var n=R.derToOid(e.publicKeyOid);if(n!==te.oids.rsaEncryption){var i=new Error("Cannot read public key. Unknown OID.");throw i.oid=n,i}r=e.rsaPublicKey}if(t=[],!R.validate(r,Ux,e,t)){var i=new Error("Cannot read public key. ASN.1 object does not contain an RSAPublicKey.");throw i.errors=t,i}var s=Q.util.createBuffer(e.publicKeyModulus).toHex(),o=Q.util.createBuffer(e.publicKeyExponent).toHex();return te.setRsaPublicKey(new de(s,16),new de(o,16))};te.publicKeyToAsn1=te.publicKeyToSubjectPublicKeyInfo=function(r){return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(te.oids.rsaEncryption).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")]),R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,[te.publicKeyToRSAPublicKey(r)])])};te.publicKeyToRSAPublicKey=function(r){return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.n)),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,hr(r.e))])};function U0(r,e,t){var n=Q.util.createBuffer(),i=Math.ceil(e.n.bitLength()/8);if(r.length>i-11){var s=new Error("Message is too long for PKCS#1 v1.5 padding.");throw s.length=r.length,s.max=i-11,s}n.putByte(0),n.putByte(t);var o=i-3-r.length,a;if(t===0||t===1){a=t===0?0:255;for(var c=0;c<o;++c)n.putByte(a)}else for(;o>0;){for(var u=0,l=Q.random.getBytes(o),c=0;c<o;++c)a=l.charCodeAt(c),a===0?++u:n.putByte(a);o=u}return n.putByte(0),n.putBytes(r),n}function po(r,e,t,n){var i=Math.ceil(e.n.bitLength()/8),s=Q.util.createBuffer(r),o=s.getByte(),a=s.getByte();if(o!==0||t&&a!==0&&a!==1||!t&&a!=2||t&&a===0&&typeof n>"u")throw new Error("Encryption block is invalid.");var c=0;if(a===0){c=i-3-n;for(var u=0;u<c;++u)if(s.getByte()!==0)throw new Error("Encryption block is invalid.")}else if(a===1)for(c=0;s.length()>1;){if(s.getByte()!==255){--s.read;break}++c}else if(a===2)for(c=0;s.length()>1;){if(s.getByte()===0){--s.read;break}++c}var l=s.getByte();if(l!==0||c!==i-3-s.length())throw new Error("Encryption block is invalid.");return s.getBytes()}function Vx(r,e,t){typeof e=="function"&&(t=e,e={}),e=e||{};var n={algorithm:{name:e.algorithm||"PRIMEINC",options:{workers:e.workers||2,workLoad:e.workLoad||100,workerScript:e.workerScript}}};"prng"in e&&(n.prng=e.prng),i();function i(){s(r.pBits,function(a,c){if(a)return t(a);if(r.p=c,r.q!==null)return o(a,r.q);s(r.qBits,o)})}function s(a,c){Q.prime.generateProbablePrime(a,n,c)}function o(a,c){if(a)return t(a);if(r.q=c,r.p.compareTo(r.q)<0){var u=r.p;r.p=r.q,r.q=u}if(r.p.subtract(de.ONE).gcd(r.e).compareTo(de.ONE)!==0){r.p=null,i();return}if(r.q.subtract(de.ONE).gcd(r.e).compareTo(de.ONE)!==0){r.q=null,s(r.qBits,o);return}if(r.p1=r.p.subtract(de.ONE),r.q1=r.q.subtract(de.ONE),r.phi=r.p1.multiply(r.q1),r.phi.gcd(r.e).compareTo(de.ONE)!==0){r.p=r.q=null,i();return}if(r.n=r.p.multiply(r.q),r.n.bitLength()!==r.bits){r.q=null,s(r.qBits,o);return}var l=r.e.modInverse(r.phi);r.keys={privateKey:te.rsa.setPrivateKey(r.n,r.e,l,r.p,r.q,l.mod(r.p1),l.mod(r.q1),r.q.modInverse(r.p)),publicKey:te.rsa.setPublicKey(r.n,r.e)},t(null,r.keys)}}function hr(r){var e=r.toString(16);e[0]>="8"&&(e="00"+e);var t=Q.util.hexToBytes(e);return t.length>1&&(t.charCodeAt(0)===0&&!(t.charCodeAt(1)&128)||t.charCodeAt(0)===255&&(t.charCodeAt(1)&128)===128)?t.substr(1):t}function zx(r){return r<=100?27:r<=150?18:r<=200?15:r<=250?12:r<=300?9:r<=350?8:r<=400?7:r<=500?6:r<=600?5:r<=800?4:r<=1250?3:2}function dh(r){return Q.util.isNodejs&&typeof Uc[r]=="function"}function ph(r){return typeof Wt.globalScope<"u"&&typeof Wt.globalScope.crypto=="object"&&typeof Wt.globalScope.crypto.subtle=="object"&&typeof Wt.globalScope.crypto.subtle[r]=="function"}function mh(r){return typeof Wt.globalScope<"u"&&typeof Wt.globalScope.msCrypto=="object"&&typeof Wt.globalScope.msCrypto.subtle=="object"&&typeof Wt.globalScope.msCrypto.subtle[r]=="function"}function yh(r){for(var e=Q.util.hexToBytes(r.toString(16)),t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t}var z=Be;if(typeof qx>"u")var qx=z.jsbn.BigInteger;var T=z.asn1,se=z.pki=z.pki||{};se.pbe=z.pbe=z.pbe||{};var pn=se.oids,Hx={name:"EncryptedPrivateKeyInfo",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:T.Class.UNIVERSAL,type:T.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:T.Class.UNIVERSAL,type:T.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]},Wx={name:"PBES2Algorithms",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc.oid",tagClass:T.Class.UNIVERSAL,type:T.Type.OID,constructed:!1,capture:"kdfOid"},{name:"PBES2Algorithms.params",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.params.salt",tagClass:T.Class.UNIVERSAL,type:T.Type.OCTETSTRING,constructed:!1,capture:"kdfSalt"},{name:"PBES2Algorithms.params.iterationCount",tagClass:T.Class.UNIVERSAL,type:T.Type.INTEGER,constructed:!1,capture:"kdfIterationCount"},{name:"PBES2Algorithms.params.keyLength",tagClass:T.Class.UNIVERSAL,type:T.Type.INTEGER,constructed:!1,optional:!0,capture:"keyLength"},{name:"PBES2Algorithms.params.prf",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,optional:!0,value:[{name:"PBES2Algorithms.params.prf.algorithm",tagClass:T.Class.UNIVERSAL,type:T.Type.OID,constructed:!1,capture:"prfOid"}]}]}]},{name:"PBES2Algorithms.encryptionScheme",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.encryptionScheme.oid",tagClass:T.Class.UNIVERSAL,type:T.Type.OID,constructed:!1,capture:"encOid"},{name:"PBES2Algorithms.encryptionScheme.iv",tagClass:T.Class.UNIVERSAL,type:T.Type.OCTETSTRING,constructed:!1,capture:"encIv"}]}]},Gx={name:"pkcs-12PbeParams",tagClass:T.Class.UNIVERSAL,type:T.Type.SEQUENCE,constructed:!0,value:[{name:"pkcs-12PbeParams.salt",tagClass:T.Class.UNIVERSAL,type:T.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"pkcs-12PbeParams.iterations",tagClass:T.Class.UNIVERSAL,type:T.Type.INTEGER,constructed:!1,capture:"iterations"}]};se.encryptPrivateKeyInfo=function(r,e,t){t=t||{},t.saltSize=t.saltSize||8,t.count=t.count||2048,t.algorithm=t.algorithm||"aes128",t.prfAlgorithm=t.prfAlgorithm||"sha1";var n=z.random.getBytesSync(t.saltSize),i=t.count,s=T.integerToDer(i),o,a,c;if(t.algorithm.indexOf("aes")===0||t.algorithm==="des"){var u,l,h;switch(t.algorithm){case"aes128":o=16,u=16,l=pn["aes128-CBC"],h=z.aes.createEncryptionCipher;break;case"aes192":o=24,u=16,l=pn["aes192-CBC"],h=z.aes.createEncryptionCipher;break;case"aes256":o=32,u=16,l=pn["aes256-CBC"],h=z.aes.createEncryptionCipher;break;case"des":o=8,u=8,l=pn.desCBC,h=z.des.createEncryptionCipher;break;default:var p=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw p.algorithm=t.algorithm,p}var g="hmacWith"+t.prfAlgorithm.toUpperCase(),f=F0(g),d=z.pkcs5.pbkdf2(e,n,i,o,f),m=z.random.getBytesSync(u),y=h(d);y.start(m),y.update(T.toDer(r)),y.finish(),c=y.output.getBytes();var E=Yx(n,s,o,g);a=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(pn.pkcs5PBES2).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(pn.pkcs5PBKDF2).getBytes()),E]),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(l).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,m)])])])}else if(t.algorithm==="3des"){o=24;var b=new z.util.ByteBuffer(n),d=se.pbe.generatePkcs12Key(e,b,1,i,o),m=se.pbe.generatePkcs12Key(e,b,2,i,o),y=z.des.createEncryptionCipher(d);y.start(m),y.update(T.toDer(r)),y.finish(),c=y.output.getBytes(),a=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(pn["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,n),T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,s.getBytes())])])}else{var p=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw p.algorithm=t.algorithm,p}var x=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[a,T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,c)]);return x};se.decryptPrivateKeyInfo=function(r,e){var t=null,n={},i=[];if(!T.validate(r,Hx,n,i)){var s=new Error("Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw s.errors=i,s}var o=T.derToOid(n.encryptionOid),a=se.pbe.getCipher(o,n.encryptionParams,e),c=z.util.createBuffer(n.encryptedData);return a.update(c),a.finish()&&(t=T.fromDer(a.output)),t};se.encryptedPrivateKeyToPem=function(r,e){var t={type:"ENCRYPTED PRIVATE KEY",body:T.toDer(r).getBytes()};return z.pem.encode(t,{maxline:e})};se.encryptedPrivateKeyFromPem=function(r){var e=z.pem.decode(r)[0];if(e.type!=="ENCRYPTED PRIVATE KEY"){var t=new Error('Could not convert encrypted private key from PEM; PEM header type is "ENCRYPTED PRIVATE KEY".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert encrypted private key from PEM; PEM is encrypted.");return T.fromDer(e.body)};se.encryptRsaPrivateKey=function(r,e,t){if(t=t||{},!t.legacy){var n=se.wrapRsaPrivateKey(se.privateKeyToAsn1(r));return n=se.encryptPrivateKeyInfo(n,e,t),se.encryptedPrivateKeyToPem(n)}var i,s,o,a;switch(t.algorithm){case"aes128":i="AES-128-CBC",o=16,s=z.random.getBytesSync(16),a=z.aes.createEncryptionCipher;break;case"aes192":i="AES-192-CBC",o=24,s=z.random.getBytesSync(16),a=z.aes.createEncryptionCipher;break;case"aes256":i="AES-256-CBC",o=32,s=z.random.getBytesSync(16),a=z.aes.createEncryptionCipher;break;case"3des":i="DES-EDE3-CBC",o=24,s=z.random.getBytesSync(8),a=z.des.createEncryptionCipher;break;case"des":i="DES-CBC",o=8,s=z.random.getBytesSync(8),a=z.des.createEncryptionCipher;break;default:var c=new Error('Could not encrypt RSA private key; unsupported encryption algorithm "'+t.algorithm+'".');throw c.algorithm=t.algorithm,c}var u=z.pbe.opensslDeriveBytes(e,s.substr(0,8),o),l=a(u);l.start(s),l.update(T.toDer(se.privateKeyToAsn1(r))),l.finish();var h={type:"RSA PRIVATE KEY",procType:{version:"4",type:"ENCRYPTED"},dekInfo:{algorithm:i,parameters:z.util.bytesToHex(s).toUpperCase()},body:l.output.getBytes()};return z.pem.encode(h)};se.decryptRsaPrivateKey=function(r,e){var t=null,n=z.pem.decode(r)[0];if(n.type!=="ENCRYPTED PRIVATE KEY"&&n.type!=="PRIVATE KEY"&&n.type!=="RSA PRIVATE KEY"){var i=new Error('Could not convert private key from PEM; PEM header type is not "ENCRYPTED PRIVATE KEY", "PRIVATE KEY", or "RSA PRIVATE KEY".');throw i.headerType=i,i}if(n.procType&&n.procType.type==="ENCRYPTED"){var s,o;switch(n.dekInfo.algorithm){case"DES-CBC":s=8,o=z.des.createDecryptionCipher;break;case"DES-EDE3-CBC":s=24,o=z.des.createDecryptionCipher;break;case"AES-128-CBC":s=16,o=z.aes.createDecryptionCipher;break;case"AES-192-CBC":s=24,o=z.aes.createDecryptionCipher;break;case"AES-256-CBC":s=32,o=z.aes.createDecryptionCipher;break;case"RC2-40-CBC":s=5,o=function(h){return z.rc2.createDecryptionCipher(h,40)};break;case"RC2-64-CBC":s=8,o=function(h){return z.rc2.createDecryptionCipher(h,64)};break;case"RC2-128-CBC":s=16,o=function(h){return z.rc2.createDecryptionCipher(h,128)};break;default:var i=new Error('Could not decrypt private key; unsupported encryption algorithm "'+n.dekInfo.algorithm+'".');throw i.algorithm=n.dekInfo.algorithm,i}var a=z.util.hexToBytes(n.dekInfo.parameters),c=z.pbe.opensslDeriveBytes(e,a.substr(0,8),s),u=o(c);if(u.start(a),u.update(z.util.createBuffer(n.body)),u.finish())t=u.output.getBytes();else return t}else t=n.body;return n.type==="ENCRYPTED PRIVATE KEY"?t=se.decryptPrivateKeyInfo(T.fromDer(t),e):t=T.fromDer(t),t!==null&&(t=se.privateKeyFromAsn1(t)),t};se.pbe.generatePkcs12Key=function(r,e,t,n,i,s){var o,a;if(typeof s>"u"||s===null){if(!("sha1"in z.md))throw new Error('"sha1" hash algorithm unavailable.');s=z.md.sha1.create()}var c=s.digestLength,u=s.blockLength,l=new z.util.ByteBuffer,h=new z.util.ByteBuffer;if(r!=null){for(a=0;a<r.length;a++)h.putInt16(r.charCodeAt(a));h.putInt16(0)}var p=h.length(),g=e.length(),f=new z.util.ByteBuffer;f.fillWithByte(t,u);var d=u*Math.ceil(g/u),m=new z.util.ByteBuffer;for(a=0;a<d;a++)m.putByte(e.at(a%g));var y=u*Math.ceil(p/u),E=new z.util.ByteBuffer;for(a=0;a<y;a++)E.putByte(h.at(a%p));var b=m;b.putBuffer(E);for(var x=Math.ceil(i/c),w=1;w<=x;w++){var v=new z.util.ByteBuffer;v.putBytes(f.bytes()),v.putBytes(b.bytes());for(var S=0;S<n;S++)s.start(),s.update(v.getBytes()),v=s.digest();var C=new z.util.ByteBuffer;for(a=0;a<u;a++)C.putByte(v.at(a%c));var B=Math.ceil(g/u)+Math.ceil(p/u),F=new z.util.ByteBuffer;for(o=0;o<B;o++){var U=new z.util.ByteBuffer(b.getBytes(u)),q=511;for(a=C.length()-1;a>=0;a--)q=q>>8,q+=C.at(a)+U.at(a),U.setAt(a,q&255);F.putBuffer(U)}b=F,l.putBuffer(v)}return l.truncate(l.length()-i),l};se.pbe.getCipher=function(r,e,t){switch(r){case se.oids.pkcs5PBES2:return se.pbe.getCipherForPBES2(r,e,t);case se.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:case se.oids["pbewithSHAAnd40BitRC2-CBC"]:return se.pbe.getCipherForPKCS12PBE(r,e,t);default:var n=new Error("Cannot read encrypted PBE data block. Unsupported OID.");throw n.oid=r,n.supportedOids=["pkcs5PBES2","pbeWithSHAAnd3-KeyTripleDES-CBC","pbewithSHAAnd40BitRC2-CBC"],n}};se.pbe.getCipherForPBES2=function(r,e,t){var n={},i=[];if(!T.validate(e,Wx,n,i)){var s=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw s.errors=i,s}if(r=T.derToOid(n.kdfOid),r!==se.oids.pkcs5PBKDF2){var s=new Error("Cannot read encrypted private key. Unsupported key derivation function OID.");throw s.oid=r,s.supportedOids=["pkcs5PBKDF2"],s}if(r=T.derToOid(n.encOid),r!==se.oids["aes128-CBC"]&&r!==se.oids["aes192-CBC"]&&r!==se.oids["aes256-CBC"]&&r!==se.oids["des-EDE3-CBC"]&&r!==se.oids.desCBC){var s=new Error("Cannot read encrypted private key. Unsupported encryption scheme OID.");throw s.oid=r,s.supportedOids=["aes128-CBC","aes192-CBC","aes256-CBC","des-EDE3-CBC","desCBC"],s}var o=n.kdfSalt,a=z.util.createBuffer(n.kdfIterationCount);a=a.getInt(a.length()<<3);var c,u;switch(se.oids[r]){case"aes128-CBC":c=16,u=z.aes.createDecryptionCipher;break;case"aes192-CBC":c=24,u=z.aes.createDecryptionCipher;break;case"aes256-CBC":c=32,u=z.aes.createDecryptionCipher;break;case"des-EDE3-CBC":c=24,u=z.des.createDecryptionCipher;break;case"desCBC":c=8,u=z.des.createDecryptionCipher;break}var l=$0(n.prfOid),h=z.pkcs5.pbkdf2(t,o,a,c,l),p=n.encIv,g=u(h);return g.start(p),g};se.pbe.getCipherForPKCS12PBE=function(r,e,t){var n={},i=[];if(!T.validate(e,Gx,n,i)){var s=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw s.errors=i,s}var o=z.util.createBuffer(n.salt),a=z.util.createBuffer(n.iterations);a=a.getInt(a.length()<<3);var c,u,l;switch(r){case se.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:c=24,u=8,l=z.des.startDecrypting;break;case se.oids["pbewithSHAAnd40BitRC2-CBC"]:c=5,u=8,l=function(d,m){var y=z.rc2.createDecryptionCipher(d,40);return y.start(m,null),y};break;default:var s=new Error("Cannot read PKCS #12 PBE data block. Unsupported OID.");throw s.oid=r,s}var h=$0(n.prfOid),p=se.pbe.generatePkcs12Key(t,o,1,a,c,h);h.start();var g=se.pbe.generatePkcs12Key(t,o,2,a,u,h);return l(p,g)};se.pbe.opensslDeriveBytes=function(r,e,t,n){if(typeof n>"u"||n===null){if(!("md5"in z.md))throw new Error('"md5" hash algorithm unavailable.');n=z.md.md5.create()}e===null&&(e="");for(var i=[gh(n,r+e)],s=16,o=1;s<t;++o,s+=16)i.push(gh(n,i[o-1]+r+e));return i.join("").substr(0,t)};function gh(r,e){return r.start().update(e).digest().getBytes()}function $0(r){var e;if(!r)e="hmacWithSHA1";else if(e=se.oids[T.derToOid(r)],!e){var t=new Error("Unsupported PRF OID.");throw t.oid=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}return F0(e)}function F0(r){var e=z.md;switch(r){case"hmacWithSHA224":e=z.md.sha512;case"hmacWithSHA1":case"hmacWithSHA256":case"hmacWithSHA384":case"hmacWithSHA512":r=r.substr(8).toLowerCase();break;default:var t=new Error("Unsupported PRF algorithm.");throw t.algorithm=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}if(!e||!(r in e))throw new Error("Unknown hash algorithm: "+r);return e[r].create()}function Yx(r,e,t,n){var i=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r),T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,e.getBytes())]);return n!=="hmacWithSHA1"&&i.value.push(T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,z.util.hexToBytes(t.toString(16))),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(se.oids[n]).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")])),i}const us=32,Yr=64,mo=32;async function Qx(){const r=cs.utils.randomPrivateKey(),e=cs.getPublicKey(r);return{privateKey:K0(r,e),publicKey:e}}async function Xx(r){if(r.length!==mo)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const e=r,t=cs.getPublicKey(e);return{privateKey:K0(e,t),publicKey:t}}async function Zx(r,e){const t=r.subarray(0,mo);return cs.sign(e,t)}async function jx(r,e,t){return cs.verify(e,t,r)}function K0(r,e){const t=new Uint8Array(Yr);for(let n=0;n<mo;n++)t[n]=r[n],t[mo+n]=e[n];return t}const Er={get(r=globalThis){const e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},Ba={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function V0(r){const e=r?.algorithm??"AES-GCM";let t=r?.keyLength??16;const n=r?.nonceLength??12,i=r?.digest??"SHA-256",s=r?.saltLength??16,o=r?.iterations??32767,a=Er.get();t*=8;async function c(h,p){const g=a.getRandomValues(new Uint8Array(s)),f=a.getRandomValues(new Uint8Array(n)),d={name:e,iv:f};typeof p=="string"&&(p=re(p));let m;if(p.length===0){m=await a.subtle.importKey("jwk",Ba,{name:"AES-GCM"},!0,["encrypt"]);try{const E={name:"PBKDF2",salt:g,iterations:o,hash:{name:i}},b=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(E,b,{name:e,length:t},!0,["encrypt"])}catch{m=await a.subtle.importKey("jwk",Ba,{name:"AES-GCM"},!0,["encrypt"])}}else{const E={name:"PBKDF2",salt:g,iterations:o,hash:{name:i}},b=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(E,b,{name:e,length:t},!0,["encrypt"])}const y=await a.subtle.encrypt(d,m,h);return et([g,d.iv,new Uint8Array(y)])}async function u(h,p){const g=h.subarray(0,s),f=h.subarray(s,s+n),d=h.subarray(s+n),m={name:e,iv:f};typeof p=="string"&&(p=re(p));let y;if(p.length===0)try{const b={name:"PBKDF2",salt:g,iterations:o,hash:{name:i}},x=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(b,x,{name:e,length:t},!0,["decrypt"])}catch{y=await a.subtle.importKey("jwk",Ba,{name:"AES-GCM"},!0,["decrypt"])}else{const b={name:"PBKDF2",salt:g,iterations:o,hash:{name:i}},x=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(b,x,{name:e,length:t},!0,["decrypt"])}const E=await a.subtle.decrypt(m,y,d);return new Uint8Array(E)}return{encrypt:c,decrypt:u}}async function Tu(r,e){const n=await V0().encrypt(r,e);return No.encode(n)}var He;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(He||(He={}));var $c;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})($c||($c={}));(function(r){r.codec=()=>Si($c)})(He||(He={}));var yi;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),He.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Type=He.codec().decode(t);break;case 2:i.Data=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(yi||(yi={}));var gi;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),He.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Type=He.codec().decode(t);break;case 2:i.Data=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(gi||(gi={}));class Lu{_key;constructor(e){this._key=bi(e,us)}async verify(e,t){return jx(this._key,t,e)}marshal(){return this._key}get bytes(){return yi.encode({Type:He.Ed25519,Data:this.marshal()}).subarray()}equals(e){return St(this.bytes,e.bytes)}async hash(){const{bytes:e}=await Zt.digest(this.bytes);return e}}class ls{_key;_publicKey;constructor(e,t){this._key=bi(e,Yr),this._publicKey=bi(t,us)}async sign(e){return Zx(this._key,e)}get public(){return new Lu(this._publicKey)}marshal(){return this._key}get bytes(){return gi.encode({Type:He.Ed25519,Data:this.marshal()}).subarray()}equals(e){return St(this.bytes,e.bytes)}async hash(){const{bytes:e}=await Zt.digest(this.bytes);return e}async id(){const e=rs.digest(this.public.bytes);return gt.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Tu(this.bytes,e);throw new I(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Jx(r){if(r.length>Yr){r=bi(r,Yr+us);const n=r.subarray(0,Yr),i=r.subarray(Yr,r.length);return new ls(n,i)}r=bi(r,Yr);const e=r.subarray(0,Yr),t=r.subarray(us);return new ls(e,t)}function ev(r){return r=bi(r,us),new Lu(r)}async function tv(){const{privateKey:r,publicKey:e}=await Qx();return new ls(r,e)}async function rv(r){const{privateKey:e,publicKey:t}=await Xx(r);return new ls(e,t)}function bi(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new I(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}const nv=Object.freeze(Object.defineProperty({__proto__:null,Ed25519PrivateKey:ls,Ed25519PublicKey:Lu,generateKeyPair:tv,generateKeyPairFromSeed:rv,unmarshalEd25519PrivateKey:Jx,unmarshalEd25519PublicKey:ev},Symbol.toStringTag,{value:"Module"}));function fr(r,e){let t=Uint8Array.from(r.abs().toByteArray());if(t=t[0]===0?t.subarray(1):t,e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=et([new Uint8Array(e-t.length),t])}return ie(t,"base64url")}function or(r){const e=iv(r);return new Ze.jsbn.BigInteger(ie(e,"base16"),16)}function iv(r,e){let t=re(r,"base64urlpad");if(e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=et([new Uint8Array(e-t.length),t])}return t}const sv={"P-256":256,"P-384":384,"P-521":521},ov=Object.keys(sv);ov.join(" / ");async function av(r,e){const t=No.decode(r);return V0().decrypt(t,e)}var Te=Be,xs=Te.sha512=Te.sha512||{};Te.md.sha512=Te.md.algorithms.sha512=xs;var z0=Te.sha384=Te.sha512.sha384=Te.sha512.sha384||{};z0.create=function(){return xs.create("SHA-384")};Te.md.sha384=Te.md.algorithms.sha384=z0;Te.sha512.sha256=Te.sha512.sha256||{create:function(){return xs.create("SHA-512/256")}};Te.md["sha512/256"]=Te.md.algorithms["sha512/256"]=Te.sha512.sha256;Te.sha512.sha224=Te.sha512.sha224||{create:function(){return xs.create("SHA-512/224")}};Te.md["sha512/224"]=Te.md.algorithms["sha512/224"]=Te.sha512.sha224;xs.create=function(r){if(q0||cv(),typeof r>"u"&&(r="SHA-512"),!(r in In))throw new Error("Invalid SHA-512 algorithm: "+r);for(var e=In[r],t=null,n=Te.util.createBuffer(),i=new Array(80),s=0;s<80;++s)i[s]=new Array(2);var o=64;switch(r){case"SHA-384":o=48;break;case"SHA-512/256":o=32;break;case"SHA-512/224":o=28;break}var a={algorithm:r.replace("-","").toLowerCase(),blockLength:128,digestLength:o,messageLength:0,fullMessageLength:null,messageLengthSize:16};return a.start=function(){a.messageLength=0,a.fullMessageLength=a.messageLength128=[];for(var c=a.messageLengthSize/4,u=0;u<c;++u)a.fullMessageLength.push(0);n=Te.util.createBuffer(),t=new Array(e.length);for(var u=0;u<e.length;++u)t[u]=e[u].slice(0);return a},a.start(),a.update=function(c,u){u==="utf8"&&(c=Te.util.encodeUtf8(c));var l=c.length;a.messageLength+=l,l=[l/4294967296>>>0,l>>>0];for(var h=a.fullMessageLength.length-1;h>=0;--h)a.fullMessageLength[h]+=l[1],l[1]=l[0]+(a.fullMessageLength[h]/4294967296>>>0),a.fullMessageLength[h]=a.fullMessageLength[h]>>>0,l[0]=l[1]/4294967296>>>0;return n.putBytes(c),bh(t,i,n),(n.read>2048||n.length()===0)&&n.compact(),a},a.digest=function(){var c=Te.util.createBuffer();c.putBytes(n.bytes());var u=a.fullMessageLength[a.fullMessageLength.length-1]+a.messageLengthSize,l=u&a.blockLength-1;c.putBytes(Fc.substr(0,a.blockLength-l));for(var h,p,g=a.fullMessageLength[0]*8,f=0;f<a.fullMessageLength.length-1;++f)h=a.fullMessageLength[f+1]*8,p=h/4294967296>>>0,g+=p,c.putInt32(g>>>0),g=h>>>0;c.putInt32(g);for(var d=new Array(t.length),f=0;f<t.length;++f)d[f]=t[f].slice(0);bh(d,i,c);var m=Te.util.createBuffer(),y;r==="SHA-512"?y=d.length:r==="SHA-384"?y=d.length-2:y=d.length-4;for(var f=0;f<y;++f)m.putInt32(d[f][0]),(f!==y-1||r!=="SHA-512/224")&&m.putInt32(d[f][1]);return m},a};var Fc=null,q0=!1,Kc=null,In=null;function cv(){Fc=String.fromCharCode(128),Fc+=Te.util.fillString(String.fromCharCode(0),128),Kc=[[1116352408,3609767458],[1899447441,602891725],[3049323471,3964484399],[3921009573,2173295548],[961987163,4081628472],[1508970993,3053834265],[2453635748,2937671579],[2870763221,3664609560],[3624381080,2734883394],[310598401,1164996542],[607225278,1323610764],[1426881987,3590304994],[1925078388,4068182383],[2162078206,991336113],[2614888103,633803317],[3248222580,3479774868],[3835390401,2666613458],[4022224774,944711139],[264347078,2341262773],[604807628,2007800933],[770255983,1495990901],[1249150122,1856431235],[1555081692,3175218132],[1996064986,2198950837],[2554220882,3999719339],[2821834349,766784016],[2952996808,2566594879],[3210313671,3203337956],[3336571891,1034457026],[3584528711,2466948901],[113926993,3758326383],[338241895,168717936],[666307205,1188179964],[773529912,1546045734],[1294757372,1522805485],[1396182291,2643833823],[1695183700,2343527390],[1986661051,1014477480],[2177026350,1206759142],[2456956037,344077627],[2730485921,1290863460],[2820302411,3158454273],[3259730800,3505952657],[3345764771,106217008],[3516065817,3606008344],[3600352804,1432725776],[4094571909,1467031594],[275423344,851169720],[430227734,3100823752],[506948616,1363258195],[659060556,3750685593],[883997877,3785050280],[958139571,3318307427],[1322822218,3812723403],[1537002063,2003034995],[1747873779,3602036899],[1955562222,1575990012],[2024104815,1125592928],[2227730452,2716904306],[2361852424,442776044],[2428436474,593698344],[2756734187,3733110249],[3204031479,2999351573],[3329325298,3815920427],[3391569614,3928383900],[3515267271,566280711],[3940187606,3454069534],[4118630271,4000239992],[116418474,1914138554],[174292421,2731055270],[289380356,3203993006],[460393269,320620315],[685471733,587496836],[852142971,1086792851],[1017036298,365543100],[1126000580,2618297676],[1288033470,3409855158],[1501505948,4234509866],[1607167915,987167468],[1816402316,1246189591]],In={},In["SHA-512"]=[[1779033703,4089235720],[3144134277,2227873595],[1013904242,4271175723],[2773480762,1595750129],[1359893119,2917565137],[2600822924,725511199],[528734635,4215389547],[1541459225,327033209]],In["SHA-384"]=[[3418070365,3238371032],[1654270250,914150663],[2438529370,812702999],[355462360,4144912697],[1731405415,4290775857],[2394180231,1750603025],[3675008525,1694076839],[1203062813,3204075428]],In["SHA-512/256"]=[[573645204,4230739756],[2673172387,3360449730],[596883563,1867755857],[2520282905,1497426621],[2519219938,2827943907],[3193839141,1401305490],[721525244,746961066],[246885852,2177182882]],In["SHA-512/224"]=[[2352822216,424955298],[1944164710,2312950998],[502970286,855612546],[1738396948,1479516111],[258812777,2077511080],[2011393907,79989058],[1067287976,1780299464],[286451373,2446758561]],q0=!0}function bh(r,e,t){for(var n,i,s,o,a,c,u,l,h,p,g,f,d,m,y,E,b,x,w,v,S,C,B,F,U,q,W,J,D,P,L,k,A,M,$,V=t.length();V>=128;){for(D=0;D<16;++D)e[D][0]=t.getInt32()>>>0,e[D][1]=t.getInt32()>>>0;for(;D<80;++D)k=e[D-2],P=k[0],L=k[1],n=((P>>>19|L<<13)^(L>>>29|P<<3)^P>>>6)>>>0,i=((P<<13|L>>>19)^(L<<3|P>>>29)^(P<<26|L>>>6))>>>0,M=e[D-15],P=M[0],L=M[1],s=((P>>>1|L<<31)^(P>>>8|L<<24)^P>>>7)>>>0,o=((P<<31|L>>>1)^(P<<24|L>>>8)^(P<<25|L>>>7))>>>0,A=e[D-7],$=e[D-16],L=i+A[1]+o+$[1],e[D][0]=n+A[0]+s+$[0]+(L/4294967296>>>0)>>>0,e[D][1]=L>>>0;for(d=r[0][0],m=r[0][1],y=r[1][0],E=r[1][1],b=r[2][0],x=r[2][1],w=r[3][0],v=r[3][1],S=r[4][0],C=r[4][1],B=r[5][0],F=r[5][1],U=r[6][0],q=r[6][1],W=r[7][0],J=r[7][1],D=0;D<80;++D)u=((S>>>14|C<<18)^(S>>>18|C<<14)^(C>>>9|S<<23))>>>0,l=((S<<18|C>>>14)^(S<<14|C>>>18)^(C<<23|S>>>9))>>>0,h=(U^S&(B^U))>>>0,p=(q^C&(F^q))>>>0,a=((d>>>28|m<<4)^(m>>>2|d<<30)^(m>>>7|d<<25))>>>0,c=((d<<4|m>>>28)^(m<<30|d>>>2)^(m<<25|d>>>7))>>>0,g=(d&y|b&(d^y))>>>0,f=(m&E|x&(m^E))>>>0,L=J+l+p+Kc[D][1]+e[D][1],n=W+u+h+Kc[D][0]+e[D][0]+(L/4294967296>>>0)>>>0,i=L>>>0,L=c+f,s=a+g+(L/4294967296>>>0)>>>0,o=L>>>0,W=U,J=q,U=B,q=F,B=S,F=C,L=v+i,S=w+n+(L/4294967296>>>0)>>>0,C=L>>>0,w=b,v=x,b=y,x=E,y=d,E=m,L=i+o,d=n+s+(L/4294967296>>>0)>>>0,m=L>>>0;L=r[0][1]+m,r[0][0]=r[0][0]+d+(L/4294967296>>>0)>>>0,r[0][1]=L>>>0,L=r[1][1]+E,r[1][0]=r[1][0]+y+(L/4294967296>>>0)>>>0,r[1][1]=L>>>0,L=r[2][1]+x,r[2][0]=r[2][0]+b+(L/4294967296>>>0)>>>0,r[2][1]=L>>>0,L=r[3][1]+v,r[3][0]=r[3][0]+w+(L/4294967296>>>0)>>>0,r[3][1]=L>>>0,L=r[4][1]+C,r[4][0]=r[4][0]+S+(L/4294967296>>>0)>>>0,r[4][1]=L>>>0,L=r[5][1]+F,r[5][0]=r[5][0]+B+(L/4294967296>>>0)>>>0,r[5][1]=L>>>0,L=r[6][1]+q,r[6][0]=r[6][0]+U+(L/4294967296>>>0)>>>0,r[6][1]=L>>>0,L=r[7][1]+J,r[7][0]=r[7][0]+W+(L/4294967296>>>0)>>>0,r[7][1]=L>>>0,V-=128}}function H0(r){if(isNaN(r)||r<=0)throw new I("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Ho(r)}function W0(r,e){return e.map(t=>or(r[t]))}function uv(r){return Ze.pki.setRsaPrivateKey(...W0(r,["n","e","d","p","q","dp","dq","qi"]))}function lv(r){return Ze.pki.setRsaPublicKey(...W0(r,["n","e"]))}function hv(r){const e=Ze.asn1.fromDer(ie(r,"ascii")),t=Ze.pki.privateKeyFromAsn1(e);return{kty:"RSA",n:fr(t.n),e:fr(t.e),d:fr(t.d),p:fr(t.p),q:fr(t.q),dp:fr(t.dP),dq:fr(t.dQ),qi:fr(t.qInv),alg:"RS256"}}function fv(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new I("JWK was missing components","ERR_INVALID_PARAMETERS");const e=Ze.pki.privateKeyToAsn1({n:or(r.n),e:or(r.e),d:or(r.d),p:or(r.p),q:or(r.q),dP:or(r.dp),dQ:or(r.dq),qInv:or(r.qi)});return re(Ze.asn1.toDer(e).getBytes(),"ascii")}function dv(r){const e=Ze.asn1.fromDer(ie(r,"ascii")),t=Ze.pki.publicKeyFromAsn1(e);return{kty:"RSA",n:fr(t.n),e:fr(t.e)}}function pv(r){if(r.n==null||r.e==null)throw new I("JWK was missing components","ERR_INVALID_PARAMETERS");const e=Ze.pki.publicKeyToAsn1({n:or(r.n),e:or(r.e)});return re(Ze.asn1.toDer(e).getBytes(),"ascii")}async function mv(r){const e=await Er.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await Y0(e);return{privateKey:t[0],publicKey:t[1]}}async function G0(r){const t=[await Er.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await bv(r)],n=await Y0({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function yv(r,e){const t=await Er.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await Er.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,Uint8Array.from(e));return new Uint8Array(n,0,n.byteLength)}async function gv(r,e,t){const n=await Er.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Er.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t)}async function Y0(r){if(r.privateKey==null||r.publicKey==null)throw new I("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Er.get().subtle.exportKey("jwk",r.privateKey),Er.get().subtle.exportKey("jwk",r.publicKey)])}async function bv(r){return Er.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function Q0(r,e,t,n){const i=e?lv(r):uv(r),s=ie(Uint8Array.from(t),"ascii"),o=n(s,i);return re(o,"ascii")}function Ev(r,e){return Q0(r,!0,e,(t,n)=>n.encrypt(t))}function wv(r,e){return Q0(r,!1,e,(t,n)=>n.decrypt(t))}function ku(r){if(r.kty!=="RSA")throw new I("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new I("invalid key modulus","ERR_INVALID_KEY_MODULUS");return re(r.n,"base64url").length*8}const vs=8192;class Pu{_key;constructor(e){this._key=e}async verify(e,t){return gv(this._key,t,e)}marshal(){return pv(this._key)}get bytes(){return yi.encode({Type:He.RSA,Data:this.marshal()}).subarray()}encrypt(e){return Ev(this._key,e)}equals(e){return St(this.bytes,e.bytes)}async hash(){const{bytes:e}=await Zt.digest(this.bytes);return e}}class ra{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return H0(16)}async sign(e){return yv(this._key,e)}get public(){if(this._publicKey==null)throw new I("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Pu(this._publicKey)}decrypt(e){return wv(this._key,e)}marshal(){return fv(this._key)}get bytes(){return gi.encode({Type:He.RSA,Data:this.marshal()}).subarray()}equals(e){return St(this.bytes,e.bytes)}async hash(){const{bytes:e}=await Zt.digest(this.bytes);return e}async id(){const e=await this.public.hash();return ie(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8"){const n=new Ze.util.ByteBuffer(this.marshal()),i=Ze.asn1.fromDer(n),s=Ze.pki.privateKeyFromAsn1(i),o={algorithm:"aes256",count:1e4,saltSize:128/8,prfAlgorithm:"sha512"};return Ze.pki.encryptRsaPrivateKey(s,e,o)}else{if(t==="libp2p-key")return Tu(this.bytes,e);throw new I(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}}async function xv(r){const e=hv(r);if(ku(e)>vs)throw new I("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await G0(e);return new ra(t.privateKey,t.publicKey)}function vv(r){const e=dv(r);if(ku(e)>vs)throw new I("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Pu(e)}async function _v(r){if(ku(r)>vs)throw new I("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await G0(r);return new ra(e.privateKey,e.publicKey)}async function Sv(r){if(r>vs)throw new I("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await mv(r);return new ra(e.privateKey,e.publicKey)}const Av=Object.freeze(Object.defineProperty({__proto__:null,MAX_KEY_SIZE:vs,RsaPrivateKey:ra,RsaPublicKey:Pu,fromJwk:_v,generateKeyPair:Sv,unmarshalRsaPrivateKey:xv,unmarshalRsaPublicKey:vv},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Rv(r){const e=Eu(r);Fn(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:t,Fp:n,a:i}=e;if(t){if(!n.eql(i,n.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:Iv,hexToBytes:Cv}=PE,Dn={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(r){const{Err:e}=Dn;if(r.length<2||r[0]!==2)throw new e("Invalid signature integer tag");const t=r[1],n=r.subarray(2,t+2);if(!t||n.length!==t)throw new e("Invalid signature integer: wrong length");if(n[0]&128)throw new e("Invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:Iv(n),l:r.subarray(t+2)}},toSig(r){const{Err:e}=Dn,t=typeof r=="string"?Cv(r):r;if(!(t instanceof Uint8Array))throw new Error("ui8a expected");let n=t.length;if(n<2||t[0]!=48)throw new e("Invalid signature tag");if(t[1]!==n-2)throw new e("Invalid signature: incorrect length");const{d:i,l:s}=Dn._parseInt(t.subarray(2)),{d:o,l:a}=Dn._parseInt(s);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:i,s:o}},hexFromSig(r){const e=u=>Number.parseInt(u[0],16)&8?"00"+u:u,t=u=>{const l=u.toString(16);return l.length&1?`0${l}`:l},n=e(t(r.s)),i=e(t(r.r)),s=n.length/2,o=i.length/2,a=t(s),c=t(o);return`30${t(o+s+4)}02${c}${i}02${a}${n}`}},Lr=BigInt(0),Vt=BigInt(1);BigInt(2);const Eh=BigInt(3);BigInt(4);function Dv(r){const e=Rv(r),{Fp:t}=e,n=e.toBytes||((f,d,m)=>{const y=d.toAffine();return On(Uint8Array.from([4]),t.toBytes(y.x),t.toBytes(y.y))}),i=e.fromBytes||(f=>{const d=f.subarray(1),m=t.fromBytes(d.subarray(0,t.BYTES)),y=t.fromBytes(d.subarray(t.BYTES,2*t.BYTES));return{x:m,y}});function s(f){const{a:d,b:m}=e,y=t.sqr(f),E=t.mul(y,f);return t.add(t.add(E,t.mul(f,d)),m)}if(!t.eql(t.sqr(e.Gy),s(e.Gx)))throw new Error("bad generator point: equation left != right");function o(f){return typeof f=="bigint"&&Lr<f&&f<e.n}function a(f){if(!o(f))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(f){const{allowedPrivateKeyLengths:d,nByteLength:m,wrapPrivateKey:y,n:E}=e;if(d&&typeof f!="bigint"){if(f instanceof Uint8Array&&(f=Bn(f)),typeof f!="string"||!d.includes(f.length))throw new Error("Invalid key");f=f.padStart(m*2,"0")}let b;try{b=typeof f=="bigint"?f:Ln(Ke("private key",f,m))}catch{throw new Error(`private key must be ${m} bytes, hex or bigint, not ${typeof f}`)}return y&&(b=Ie(b,E)),a(b),b}const u=new Map;function l(f){if(!(f instanceof h))throw new Error("ProjectivePoint expected")}class h{constructor(d,m,y){if(this.px=d,this.py=m,this.pz=y,d==null||!t.isValid(d))throw new Error("x required");if(m==null||!t.isValid(m))throw new Error("y required");if(y==null||!t.isValid(y))throw new Error("z required")}static fromAffine(d){const{x:m,y}=d||{};if(!d||!t.isValid(m)||!t.isValid(y))throw new Error("invalid affine point");if(d instanceof h)throw new Error("projective point not allowed");const E=b=>t.eql(b,t.ZERO);return E(m)&&E(y)?h.ZERO:new h(m,y,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(d){const m=t.invertBatch(d.map(y=>y.pz));return d.map((y,E)=>y.toAffine(m[E])).map(h.fromAffine)}static fromHex(d){const m=h.fromAffine(i(Ke("pointHex",d)));return m.assertValidity(),m}static fromPrivateKey(d){return h.BASE.multiply(c(d))}_setWindowSize(d){this._WINDOW_SIZE=d,u.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!t.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:d,y:m}=this.toAffine();if(!t.isValid(d)||!t.isValid(m))throw new Error("bad point: x or y not FE");const y=t.sqr(m),E=s(d);if(!t.eql(y,E))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:d}=this.toAffine();if(t.isOdd)return!t.isOdd(d);throw new Error("Field doesn't support isOdd")}equals(d){l(d);const{px:m,py:y,pz:E}=this,{px:b,py:x,pz:w}=d,v=t.eql(t.mul(m,w),t.mul(b,E)),S=t.eql(t.mul(y,w),t.mul(x,E));return v&&S}negate(){return new h(this.px,t.neg(this.py),this.pz)}double(){const{a:d,b:m}=e,y=t.mul(m,Eh),{px:E,py:b,pz:x}=this;let w=t.ZERO,v=t.ZERO,S=t.ZERO,C=t.mul(E,E),B=t.mul(b,b),F=t.mul(x,x),U=t.mul(E,b);return U=t.add(U,U),S=t.mul(E,x),S=t.add(S,S),w=t.mul(d,S),v=t.mul(y,F),v=t.add(w,v),w=t.sub(B,v),v=t.add(B,v),v=t.mul(w,v),w=t.mul(U,w),S=t.mul(y,S),F=t.mul(d,F),U=t.sub(C,F),U=t.mul(d,U),U=t.add(U,S),S=t.add(C,C),C=t.add(S,C),C=t.add(C,F),C=t.mul(C,U),v=t.add(v,C),F=t.mul(b,x),F=t.add(F,F),C=t.mul(F,U),w=t.sub(w,C),S=t.mul(F,B),S=t.add(S,S),S=t.add(S,S),new h(w,v,S)}add(d){l(d);const{px:m,py:y,pz:E}=this,{px:b,py:x,pz:w}=d;let v=t.ZERO,S=t.ZERO,C=t.ZERO;const B=e.a,F=t.mul(e.b,Eh);let U=t.mul(m,b),q=t.mul(y,x),W=t.mul(E,w),J=t.add(m,y),D=t.add(b,x);J=t.mul(J,D),D=t.add(U,q),J=t.sub(J,D),D=t.add(m,E);let P=t.add(b,w);return D=t.mul(D,P),P=t.add(U,W),D=t.sub(D,P),P=t.add(y,E),v=t.add(x,w),P=t.mul(P,v),v=t.add(q,W),P=t.sub(P,v),C=t.mul(B,D),v=t.mul(F,W),C=t.add(v,C),v=t.sub(q,C),C=t.add(q,C),S=t.mul(v,C),q=t.add(U,U),q=t.add(q,U),W=t.mul(B,W),D=t.mul(F,D),q=t.add(q,W),W=t.sub(U,W),W=t.mul(B,W),D=t.add(D,W),U=t.mul(q,D),S=t.add(S,U),U=t.mul(P,D),v=t.mul(J,v),v=t.sub(v,U),U=t.mul(J,q),C=t.mul(P,C),C=t.add(C,U),new h(v,S,C)}subtract(d){return this.add(d.negate())}is0(){return this.equals(h.ZERO)}wNAF(d){return g.wNAFCached(this,u,d,m=>{const y=t.invertBatch(m.map(E=>E.pz));return m.map((E,b)=>E.toAffine(y[b])).map(h.fromAffine)})}multiplyUnsafe(d){const m=h.ZERO;if(d===Lr)return m;if(a(d),d===Vt)return this;const{endo:y}=e;if(!y)return g.unsafeLadder(this,d);let{k1neg:E,k1:b,k2neg:x,k2:w}=y.splitScalar(d),v=m,S=m,C=this;for(;b>Lr||w>Lr;)b&Vt&&(v=v.add(C)),w&Vt&&(S=S.add(C)),C=C.double(),b>>=Vt,w>>=Vt;return E&&(v=v.negate()),x&&(S=S.negate()),S=new h(t.mul(S.px,y.beta),S.py,S.pz),v.add(S)}multiply(d){a(d);let m=d,y,E;const{endo:b}=e;if(b){const{k1neg:x,k1:w,k2neg:v,k2:S}=b.splitScalar(m);let{p:C,f:B}=this.wNAF(w),{p:F,f:U}=this.wNAF(S);C=g.constTimeNegate(x,C),F=g.constTimeNegate(v,F),F=new h(t.mul(F.px,b.beta),F.py,F.pz),y=C.add(F),E=B.add(U)}else{const{p:x,f:w}=this.wNAF(m);y=x,E=w}return h.normalizeZ([y,E])[0]}multiplyAndAddUnsafe(d,m,y){const E=h.BASE,b=(w,v)=>v===Lr||v===Vt||!w.equals(E)?w.multiplyUnsafe(v):w.multiply(v),x=b(this,m).add(b(d,y));return x.is0()?void 0:x}toAffine(d){const{px:m,py:y,pz:E}=this,b=this.is0();d==null&&(d=b?t.ONE:t.inv(E));const x=t.mul(m,d),w=t.mul(y,d),v=t.mul(E,d);if(b)return{x:t.ZERO,y:t.ZERO};if(!t.eql(v,t.ONE))throw new Error("invZ was invalid");return{x,y:w}}isTorsionFree(){const{h:d,isTorsionFree:m}=e;if(d===Vt)return!0;if(m)return m(h,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:d,clearCofactor:m}=e;return d===Vt?this:m?m(h,this):this.multiplyUnsafe(e.h)}toRawBytes(d=!0){return this.assertValidity(),n(h,this,d)}toHex(d=!0){return Bn(this.toRawBytes(d))}}h.BASE=new h(e.Gx,e.Gy,t.ONE),h.ZERO=new h(t.ZERO,t.ONE,t.ZERO);const p=e.nBitLength,g=m0(h,e.endo?Math.ceil(p/2):p);return{CURVE:e,ProjectivePoint:h,normPrivateKeyToScalar:c,weierstrassEquation:s,isWithinCurveOrder:o}}function Tv(r){const e=Eu(r);return Fn(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function Lv(r){const e=Tv(r),{Fp:t,n}=e,i=t.BYTES+1,s=2*t.BYTES+1;function o(D){return Lr<D&&D<t.ORDER}function a(D){return Ie(D,n)}function c(D){return Dc(D,n)}const{ProjectivePoint:u,normPrivateKeyToScalar:l,weierstrassEquation:h,isWithinCurveOrder:p}=Dv({...e,toBytes(D,P,L){const k=P.toAffine(),A=t.toBytes(k.x),M=On;return L?M(Uint8Array.from([P.hasEvenY()?2:3]),A):M(Uint8Array.from([4]),A,t.toBytes(k.y))},fromBytes(D){const P=D.length,L=D[0],k=D.subarray(1);if(P===i&&(L===2||L===3)){const A=Ln(k);if(!o(A))throw new Error("Point is not on curve");const M=h(A);let $=t.sqrt(M);const V=($&Vt)===Vt;return(L&1)===1!==V&&($=t.neg($)),{x:A,y:$}}else if(P===s&&L===4){const A=t.fromBytes(k.subarray(0,t.BYTES)),M=t.fromBytes(k.subarray(t.BYTES,2*t.BYTES));return{x:A,y:M}}else throw new Error(`Point of length ${P} was invalid. Expected ${i} compressed bytes or ${s} uncompressed bytes`)}}),g=D=>Bn(pi(D,e.nByteLength));function f(D){const P=n>>Vt;return D>P}function d(D){return f(D)?a(-D):D}const m=(D,P,L)=>Ln(D.slice(P,L));class y{constructor(P,L,k){this.r=P,this.s=L,this.recovery=k,this.assertValidity()}static fromCompact(P){const L=e.nByteLength;return P=Ke("compactSignature",P,L*2),new y(m(P,0,L),m(P,L,2*L))}static fromDER(P){const{r:L,s:k}=Dn.toSig(Ke("DER",P));return new y(L,k)}assertValidity(){if(!p(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!p(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(P){return new y(this.r,this.s,P)}recoverPublicKey(P){const{r:L,s:k,recovery:A}=this,M=S(Ke("msgHash",P));if(A==null||![0,1,2,3].includes(A))throw new Error("recovery id invalid");const $=A===2||A===3?L+e.n:L;if($>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");const V=A&1?"03":"02",X=u.fromHex(V+g($)),j=c($),ae=a(-M*j),ee=a(k*j),ne=u.BASE.multiplyAndAddUnsafe(X,ae,ee);if(!ne)throw new Error("point at infinify");return ne.assertValidity(),ne}hasHighS(){return f(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return di(this.toDERHex())}toDERHex(){return Dn.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return di(this.toCompactHex())}toCompactHex(){return g(this.r)+g(this.s)}}const E={isValidPrivateKey(D){try{return l(D),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const D=p0(e.n);return zE(e.randomBytes(D),e.n)},precompute(D=8,P=u.BASE){return P._setWindowSize(D),P.multiply(BigInt(3)),P}};function b(D,P=!0){return u.fromPrivateKey(D).toRawBytes(P)}function x(D){const P=D instanceof Uint8Array,L=typeof D=="string",k=(P||L)&&D.length;return P?k===i||k===s:L?k===2*i||k===2*s:D instanceof u}function w(D,P,L=!0){if(x(D))throw new Error("first arg must be private key");if(!x(P))throw new Error("second arg must be public key");return u.fromHex(P).multiply(l(D)).toRawBytes(L)}const v=e.bits2int||function(D){const P=Ln(D),L=D.length*8-e.nBitLength;return L>0?P>>BigInt(L):P},S=e.bits2int_modN||function(D){return a(v(D))},C=bu(e.nBitLength);function B(D){if(typeof D!="bigint")throw new Error("bigint expected");if(!(Lr<=D&&D<C))throw new Error(`bigint expected < 2^${e.nBitLength}`);return pi(D,e.nByteLength)}function F(D,P,L=U){if(["recovered","canonical"].some(we=>we in L))throw new Error("sign() legacy options not supported");const{hash:k,randomBytes:A}=e;let{lowS:M,prehash:$,extraEntropy:V}=L;M==null&&(M=!0),D=Ke("msgHash",D),$&&(D=Ke("prehashed msgHash",k(D)));const X=S(D),j=l(P),ae=[B(j),B(X)];if(V!=null){const we=V===!0?A(t.BYTES):V;ae.push(Ke("extraEntropy",we))}const ee=On(...ae),ne=X;function Se(we){const tt=v(we);if(!p(tt))return;const rt=c(tt),We=u.BASE.multiply(tt).toAffine(),ht=a(We.x);if(ht===Lr)return;const Sr=a(rt*a(ne+ht*j));if(Sr===Lr)return;let dn=(We.x===ht?0:2)|Number(We.y&Vt),Ti=Sr;return M&&f(Sr)&&(Ti=d(Sr),dn^=1),new y(ht,Ti,dn)}return{seed:ee,k2sig:Se}}const U={lowS:e.lowS,prehash:!1},q={lowS:e.lowS,prehash:!1};function W(D,P,L=U){const{seed:k,k2sig:A}=F(D,P,L),M=e;return u0(M.hash.outputLen,M.nByteLength,M.hmac)(k,A)}u.BASE._setWindowSize(8);function J(D,P,L,k=q){const A=D;if(P=Ke("msgHash",P),L=Ke("publicKey",L),"strict"in k)throw new Error("options.strict was renamed to lowS");const{lowS:M,prehash:$}=k;let V,X;try{if(typeof A=="string"||A instanceof Uint8Array)try{V=y.fromDER(A)}catch(We){if(!(We instanceof Dn.Err))throw We;V=y.fromCompact(A)}else if(typeof A=="object"&&typeof A.r=="bigint"&&typeof A.s=="bigint"){const{r:We,s:ht}=A;V=new y(We,ht)}else throw new Error("PARSE");X=u.fromHex(L)}catch(We){if(We.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(M&&V.hasHighS())return!1;$&&(P=e.hash(P));const{r:j,s:ae}=V,ee=S(P),ne=c(ae),Se=a(ee*ne),we=a(j*ne),tt=u.BASE.multiplyAndAddUnsafe(X,Se,we)?.toAffine();return tt?a(tt.x)===j:!1}return{CURVE:e,getPublicKey:b,getSharedSecret:w,sign:W,verify:J,ProjectivePoint:u,Signature:y,utils:E}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function kv(r){return{hash:r,hmac:(e,...t)=>Yo(r,e,t0(...t)),randomBytes:Ho}}function Pv(r,e){const t=n=>Lv({...r,...kv(n)});return Object.freeze({...t(e),create:t})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const X0=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),wh=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),Nv=BigInt(1),Vc=BigInt(2),xh=(r,e)=>(r+e/Vc)/e;function Bv(r){const e=X0,t=BigInt(3),n=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,l=u*u*r%e,h=Pe(l,t,e)*l%e,p=Pe(h,t,e)*l%e,g=Pe(p,Vc,e)*u%e,f=Pe(g,i,e)*g%e,d=Pe(f,s,e)*f%e,m=Pe(d,a,e)*d%e,y=Pe(m,c,e)*m%e,E=Pe(y,a,e)*d%e,b=Pe(E,t,e)*l%e,x=Pe(b,o,e)*f%e,w=Pe(x,n,e)*u%e,v=Pe(w,Vc,e);if(!zc.eql(zc.sqr(v),r))throw new Error("Cannot find square root");return v}const zc=f0(X0,void 0,void 0,{sqrt:Bv}),hn=Pv({a:BigInt(0),b:BigInt(7),Fp:zc,n:wh,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{const e=wh,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-Nv*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=t,o=BigInt("0x100000000000000000000000000000000"),a=xh(s*r,e),c=xh(-n*r,e);let u=Ie(r-a*t-c*i,e),l=Ie(-a*n-c*s,e);const h=u>o,p=l>o;if(h&&(u=e-u),p&&(l=e-l),u>o||l>o)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:h,k1:u,k2neg:p,k2:l}}}},Ks);BigInt(0);hn.ProjectivePoint;function Ov(){return hn.utils.randomPrivateKey()}async function Mv(r,e){const{digest:t}=await Zt.digest(e);try{return hn.sign(t,r).toDERRawBytes()}catch(n){throw new I(String(n),"ERR_INVALID_INPUT")}}async function Uv(r,e,t){try{const{digest:n}=await Zt.digest(t);return hn.verify(e,n,r)}catch(n){throw new I(String(n),"ERR_INVALID_INPUT")}}function $v(r){return hn.ProjectivePoint.fromHex(r).toRawBytes(!0)}function Fv(r){try{hn.getPublicKey(r,!0)}catch(e){throw new I(String(e),"ERR_INVALID_PRIVATE_KEY")}}function Z0(r){try{hn.ProjectivePoint.fromHex(r)}catch(e){throw new I(String(e),"ERR_INVALID_PUBLIC_KEY")}}function Kv(r){try{return hn.getPublicKey(r,!0)}catch(e){throw new I(String(e),"ERR_INVALID_PRIVATE_KEY")}}class Nu{_key;constructor(e){Z0(e),this._key=e}async verify(e,t){return Uv(this._key,t,e)}marshal(){return $v(this._key)}get bytes(){return yi.encode({Type:He.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return St(this.bytes,e.bytes)}async hash(){const{bytes:e}=await Zt.digest(this.bytes);return e}}class Bu{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??Kv(e),Fv(this._key),Z0(this._publicKey)}async sign(e){return Mv(this._key,e)}get public(){return new Nu(this._publicKey)}marshal(){return this._key}get bytes(){return gi.encode({Type:He.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return St(this.bytes,e.bytes)}async hash(){const{bytes:e}=await Zt.digest(this.bytes);return e}async id(){const e=await this.public.hash();return ie(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return Tu(this.bytes,e);throw new I(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Vv(r){return new Bu(r)}function zv(r){return new Nu(r)}async function qv(){const r=Ov();return new Bu(r)}const Hv=Object.freeze(Object.defineProperty({__proto__:null,Secp256k1PrivateKey:Bu,Secp256k1PublicKey:Nu,generateKeyPair:qv,unmarshalSecp256k1PrivateKey:Vv,unmarshalSecp256k1PublicKey:zv},Symbol.toStringTag,{value:"Module"})),Or={rsa:Av,ed25519:nv,secp256k1:Hv};function Ou(r){const e=Object.keys(Or).join(" / ");return new I(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function Mu(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return Or[r];throw Ou(r)}async function j0(r,e){return Mu(r).generateKeyPair(e??2048)}function Uu(r){const e=yi.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case He.RSA:return Or.rsa.unmarshalRsaPublicKey(t);case He.Ed25519:return Or.ed25519.unmarshalEd25519PublicKey(t);case He.Secp256k1:return Or.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw Ou(e.Type??"unknown")}}function Wv(r,e){return e=(e??"rsa").toLowerCase(),Mu(e),r.bytes}async function na(r){const e=gi.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case He.RSA:return Or.rsa.unmarshalRsaPrivateKey(t);case He.Ed25519:return Or.ed25519.unmarshalEd25519PrivateKey(t);case He.Secp256k1:return Or.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw Ou(e.Type??"RSA")}}function Gv(r,e){return e=(e??"rsa").toLowerCase(),Mu(e),r.bytes}async function Ns(r,e){try{const i=await av(r,e);return await na(i)}catch{}const t=Ze.pki.decryptRsaPrivateKey(r,e);if(t===null)throw new I("Cannot read the key, most likely the password is wrong or not a RSA key","ERR_CANNOT_DECRYPT_PEM");let n=Ze.asn1.toDer(Ze.pki.privateKeyToAsn1(t));return n=re(n.getBytes(),"ascii"),Or.rsa.unmarshalRsaPrivateKey(n)}var yo;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const s of t.webtransportCerthashes)n.uint32(10),n.bytes(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={webtransportCerthashes:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.webtransportCerthashes.push(t.bytes());break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(yo||(yo={}));var go;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),(i.writeDefaults===!0||t.identityKey!=null&&t.identityKey.byteLength>0)&&(n.uint32(10),n.bytes(t.identityKey??new Uint8Array(0))),(i.writeDefaults===!0||t.identitySig!=null&&t.identitySig.byteLength>0)&&(n.uint32(18),n.bytes(t.identitySig??new Uint8Array(0))),t.extensions!=null&&(n.uint32(34),yo.codec().encode(t.extensions,n,{writeDefaults:!1})),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.identityKey=t.bytes();break;case 2:i.identitySig=t.bytes();break;case 4:i.extensions=yo.codec().decode(t,t.uint32());break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(go||(go={}));async function Yv(r,e,t){const n=await Xv(r,J0(e));if(r.publicKey==null)throw new Error("PublicKey was missing from local PeerId");return Qv(r.publicKey,n,t)}function Qv(r,e,t){return go.encode({identityKey:r,identitySig:e,extensions:t??{webtransportCerthashes:[]}}).subarray()}async function Xv(r,e){if(r.privateKey==null)throw new Error("PrivateKey was missing from PeerId");return(await na(r.privateKey)).sign(e)}async function vh(r){return _i(r.identityKey)}function _h(r){return go.decode(r)}function J0(r){const e=re("noise-libp2p-static-key:");return et([e,r],e.length+r.length)}async function Sh(r,e,t){const n=await _i(e.identityKey);if(!n.equals(t))throw new Error(`Payload identity key ${n.toString()} does not match expected remote peer ${t.toString()}`);const i=J0(r);if(n.publicKey==null)throw new Error("PublicKey was missing from PeerId");if(e.identitySig==null)throw new Error("Signature was missing from message");if(!await Uu(n.publicKey).verify(i,e.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return n}function Bs(r){return!(!(r instanceof Uint8Array)||r.length!==32)}const pt=ue("libp2p:noise");let Qt;R1?Qt=pt:Qt=Object.assign(()=>{},{enabled:!1,trace:()=>{},error:()=>{}});function Zv(r){Qt(`LOCAL_STATIC_PUBLIC_KEY ${ie(r.publicKey,"hex")}`),Qt(`LOCAL_STATIC_PRIVATE_KEY ${ie(r.privateKey,"hex")}`)}function Ah(r){r?(Qt(`LOCAL_PUBLIC_EPHEMERAL_KEY ${ie(r.publicKey,"hex")}`),Qt(`LOCAL_PRIVATE_EPHEMERAL_KEY ${ie(r.privateKey,"hex")}`)):Qt("Missing local ephemeral keys.")}function jv(r){Qt(`REMOTE_STATIC_PUBLIC_KEY ${ie(r,"hex")}`)}function Rh(r){Qt(`REMOTE_EPHEMERAL_PUBLIC_KEY ${ie(r,"hex")}`)}function Jv(r){r.cs1&&r.cs2?(Qt(`CIPHER_STATE_1 ${r.cs1.n.getUint64()} ${ie(r.cs1.k,"hex")}`),Qt(`CIPHER_STATE_2 ${r.cs2.n.getUint64()} ${ie(r.cs2.k,"hex")}`)):Qt("Missing cipher state.")}const e_=0,t_=4294967295,r_="Cipherstate has reached maximum n, a new handshake must be performed";class n_{n;bytes;view;constructor(e=e_){this.n=e,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>t_)throw new Error(r_)}}class i_{crypto;constructor(e){this.crypto=e}encryptWithAd(e,t,n){const i=this.encrypt(e.k,e.n,t,n);return e.n.increment(),i}decryptWithAd(e,t,n,i){const{plaintext:s,valid:o}=this.decrypt(e.k,e.n,t,n,i);return o&&e.n.increment(),{plaintext:s,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return new Uint8Array(32)}isEmptyKey(e){const t=this.createEmptyKey();return St(t,e)}encrypt(e,t,n,i){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(i,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return this.hasKey(e.cs)?n=this.encryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,n),n}decrypt(e,t,n,i,s){t.assertValue();const o=this.crypto.chaCha20Poly1305Decrypt(i,t.getBytes(),n,e,s);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}decryptAndHash(e,t){let n,i=!0;return this.hasKey(e.cs)?{plaintext:n,valid:i}=this.decryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,t),{plaintext:n,valid:i}}dh(e,t){try{const n=this.crypto.generateX25519SharedKey(e,t);return n.length===32?n:n.subarray(0,32)}catch(n){const i=n;return pt.error(i),new Uint8Array(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256(et([e,t],e.length+t.length))}mixKey(e,t){const[n,i]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(i),e.ck=n}initializeKey(e){return{k:e,n:new n_}}initializeSymmetric(e){const t=re(e,"utf-8"),n=this.hashProtocolName(t),i=n,s=this.createEmptyKey();return{cs:this.initializeKey(s),ck:i,h:n}}hashProtocolName(e){if(e.length<=32){const t=new Uint8Array(32);return t.set(e),t}else return this.getHash(e,new Uint8Array(0))}split(e){const[t,n]=this.crypto.getHKDF(e.ck,new Uint8Array(0)),i=this.initializeKey(t),s=this.initializeKey(n);return{cs1:i,cs2:s}}writeMessageRegular(e,t){const n=this.encryptWithAd(e,new Uint8Array(0),t),i=this.createEmptyKey(),s=new Uint8Array(0);return{ne:i,ns:s,ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}}class s_ extends i_{initializeInitiator(e,t,n,i){const s="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(s);this.mixHash(o,e);const a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:i,re:a}}initializeResponder(e,t,n,i){const s="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(s);this.mixHash(o,e);const a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:i,re:a}}writeMessageA(e,t,n){const i=new Uint8Array(0);n!==void 0?e.e=n:e.e=this.crypto.generateX25519KeyPair();const s=e.e.publicKey;this.mixHash(e.ss,s);const o=this.encryptAndHash(e.ss,t);return{ne:s,ns:i,ciphertext:o}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();const n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const i=e.s.publicKey,s=this.encryptAndHash(e.ss,i);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const o=this.encryptAndHash(e.ss,t);return{ne:n,ns:s,ciphertext:o}}writeMessageC(e,t){const n=e.s.publicKey,i=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const s=this.encryptAndHash(e.ss,t),a={ne:this.createEmptyKey(),ns:i,ciphertext:s},{cs1:c,cs2:u}=this.split(e.ss);return{h:e.ss.h,messageBuffer:a,cs1:c,cs2:u}}readMessageA(e,t){return Bs(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(Bs(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const{plaintext:n,valid:i}=this.decryptAndHash(e.ss,t.ns);i&&Bs(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:s,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:s,valid:i&&o}}readMessageC(e,t){const{plaintext:n,valid:i}=this.decryptAndHash(e.ss,t.ns);if(i&&Bs(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:s,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:a,cs2:c}=this.split(e.ss);return{h:e.ss.h,plaintext:s,valid:i&&o,cs1:a,cs2:c}}initSession(e,t,n){const i=this.createEmptyKey(),s=new Uint8Array(32);let o;return e?o=this.initializeInitiator(t,n,s,i):o=this.initializeResponder(t,n,s,i),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let i;if(e.mc===0)i=this.writeMessageA(e.hs,t,n);else if(e.mc===1)i=this.writeMessageB(e.hs,t);else if(e.mc===2){const{h:s,messageBuffer:o,cs1:a,cs2:c}=this.writeMessageC(e.hs,t);i=o,e.h=s,e.cs1=a,e.cs2=c}else if(e.mc>2)if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");i=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");i=this.writeMessageRegular(e.cs2,t)}else throw new Error("Session invalid.");return e.mc++,i}recvMessage(e,t){let n=new Uint8Array(0),i=!1;if(e.mc===0)({plaintext:n,valid:i}=this.readMessageA(e.hs,t));else if(e.mc===1)({plaintext:n,valid:i}=this.readMessageB(e.hs,t));else if(e.mc===2){const{h:s,plaintext:o,valid:a,cs1:c,cs2:u}=this.readMessageC(e.hs,t);n=o,i=a,e.h=s,e.cs1=c,e.cs2=u}return e.mc++,{plaintext:n,valid:i}}}class o_{isInitiator;session;remotePeer;remoteExtensions={webtransportCerthashes:[]};payload;connection;xx;staticKeypair;prologue;constructor(e,t,n,i,s,o,a,c){this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=s,this.connection=o,a&&(this.remotePeer=a),this.xx=c??new s_(i),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){if(Zv(this.session.hs.s),this.isInitiator){pt.trace("Stage 0 - Initiator starting to send first message.");const e=this.xx.sendMessage(this.session,new Uint8Array(0));await this.connection.write(lw(e)),pt.trace("Stage 0 - Initiator finished sending first message."),Ah(this.session.hs.e)}else{pt.trace("Stage 0 - Responder waiting to receive first message...");const e=dw((await this.connection.read()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new jn("xx handshake stage 0 validation fail");pt.trace("Stage 0 - Responder received first message."),Rh(this.session.hs.re)}}async exchange(){if(this.isInitiator){pt.trace("Stage 1 - Initiator waiting to receive first message from responder...");const e=pw((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new jn("xx handshake stage 1 validation fail");pt.trace("Stage 1 - Initiator received the message."),Rh(this.session.hs.re),jv(this.session.hs.rs),pt.trace("Initiator going to check remote's signature...");try{const i=_h(t);this.remotePeer=this.remotePeer||await vh(i),await Sh(this.session.hs.rs,i,this.remotePeer),this.setRemoteNoiseExtension(i.extensions)}catch(i){const s=i;throw new Js(`Error occurred while verifying signed payload: ${s.message}`)}pt.trace("All good with the signature!")}else{pt.trace("Stage 1 - Responder sending out first message with signed payload and static key.");const e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(hw(e)),pt.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Ah(this.session.hs.e)}}async finish(){if(this.isInitiator){pt.trace("Stage 2 - Initiator sending third handshake message.");const e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(fw(e)),pt.trace("Stage 2 - Initiator sent message with signed payload.")}else{pt.trace("Stage 2 - Responder waiting for third handshake message...");const e=mw((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new jn("xx handshake stage 2 validation fail");pt.trace("Stage 2 - Responder received the message, finished handshake.");try{const i=_h(t);this.remotePeer=this.remotePeer||await vh(i),await Sh(this.session.hs.rs,i,this.remotePeer),this.setRemoteNoiseExtension(i.extensions)}catch(i){const s=i;throw new Js(`Error occurred while verifying signed payload: ${s.message}`)}}Jv(this.session)}encrypt(e,t){const n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}decrypt(e,t,n){const i=this.getCS(t,!1);return this.xx.decryptWithAd(i,new Uint8Array(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e,t=!0){if(!e.cs1||!e.cs2)throw new jn("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}}function a_(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}class c_{protocol="/noise";crypto;prologue;staticKeys;extensions;metrics;constructor(e={}){const{staticNoiseKey:t,extensions:n,crypto:i,prologueBytes:s,metrics:o}=e;this.crypto=i??cw,this.extensions=n,this.metrics=o?a_(o):void 0,t?this.staticKeys=this.crypto.generateX25519KeyPairFromSeed(t):this.staticKeys=this.crypto.generateX25519KeyPair(),this.prologue=s??new Uint8Array(0)}async secureOutbound(e,t,n){const i=yc(t,{lengthEncoder:uo,lengthDecoder:Vs,maxDataLength:ss}),s=await this.performHandshake({connection:i,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(i,s),remoteExtensions:s.remoteExtensions,remotePeer:s.remotePeer}}async secureInbound(e,t,n){const i=yc(t,{lengthEncoder:uo,lengthDecoder:Vs,maxDataLength:ss}),s=await this.performHandshake({connection:i,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(i,s),remotePeer:s.remotePeer,remoteExtensions:s.remoteExtensions}}async performHandshake(e){const t=await Yv(e.localPeer,this.staticKeys.publicKey,this.extensions);return this.performXXHandshake(e,t)}async performXXHandshake(e,t){const{isInitiator:n,remotePeer:i,connection:s}=e,o=new o_(n,t,this.prologue,this.crypto,this.staticKeys,s,i);try{await o.propose(),await o.exchange(),await o.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){if(this.metrics?.xxHandshakeErrors.increment(),a instanceof Error)throw a.message=`Error occurred during XX handshake: ${a.message}`,a}return o}async createSecureConnection(e,t){const[n,i]=A1(),s=e.unwrap();return await kn(n,yw(t,this.metrics),s,o=>li(o,{lengthDecoder:Vs}),gw(t,this.metrics),n),i}}function u_(r={}){return()=>new c_(r)}var Ih={exports:{}};function l_(r){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var n=0;n<r.length;n++){var i=r.charAt(n),s=i.charCodeAt(0);if(e[s]!==255)throw new TypeError(i+" is ambiguous");e[s]=n}var o=r.length,a=r.charAt(0),c=Math.log(o)/Math.log(256),u=Math.log(256)/Math.log(o);function l(g){if(g instanceof Uint8Array||(ArrayBuffer.isView(g)?g=new Uint8Array(g.buffer,g.byteOffset,g.byteLength):Array.isArray(g)&&(g=Uint8Array.from(g))),!(g instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(g.length===0)return"";for(var f=0,d=0,m=0,y=g.length;m!==y&&g[m]===0;)m++,f++;for(var E=(y-m)*u+1>>>0,b=new Uint8Array(E);m!==y;){for(var x=g[m],w=0,v=E-1;(x!==0||w<d)&&v!==-1;v--,w++)x+=256*b[v]>>>0,b[v]=x%o>>>0,x=x/o>>>0;if(x!==0)throw new Error("Non-zero carry");d=w,m++}for(var S=E-d;S!==E&&b[S]===0;)S++;for(var C=a.repeat(f);S<E;++S)C+=r.charAt(b[S]);return C}function h(g){if(typeof g!="string")throw new TypeError("Expected String");if(g.length===0)return new Uint8Array;var f=0;if(g[f]!==" "){for(var d=0,m=0;g[f]===a;)d++,f++;for(var y=(g.length-f)*c+1>>>0,E=new Uint8Array(y);g[f];){var b=e[g.charCodeAt(f)];if(b===255)return;for(var x=0,w=y-1;(b!==0||x<m)&&w!==-1;w--,x++)b+=o*E[w]>>>0,E[w]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");m=x,f++}if(g[f]!==" "){for(var v=y-m;v!==y&&E[v]===0;)v++;for(var S=new Uint8Array(d+(y-v)),C=d;v!==y;)S[C++]=E[v++];return S}}}function p(g){var f=h(g);if(f)return f;throw new Error("Non-base"+o+" character")}return{encode:l,decodeUnsafe:h,decode:p}}var h_=l_;const f_=new TextDecoder,d_=r=>f_.decode(r),p_=new TextEncoder,m_=r=>p_.encode(r);function y_(r,e){const t=new Uint8Array(e);let n=0;for(const i of r)t.set(i,n),n+=i.length;return t}var $u={decodeText:d_,encodeText:m_,concat:y_};const{encodeText:g_}=$u;let b_=class{constructor(e,t,n,i){this.name=e,this.code=t,this.codeBuf=g_(this.code),this.alphabet=i,this.codec=n(i)}encode(e){return this.codec.encode(e)}decode(e){for(const t of e)if(this.alphabet&&this.alphabet.indexOf(t)<0)throw new Error(`invalid character '${t}' in '${e}'`);return this.codec.decode(e)}};var E_=b_;const w_=(r,e,t)=>{const n={};for(let u=0;u<e.length;++u)n[e[u]]=u;let i=r.length;for(;r[i-1]==="=";)--i;const s=new Uint8Array(i*t/8|0);let o=0,a=0,c=0;for(let u=0;u<i;++u){const l=n[r[u]];if(l===void 0)throw new SyntaxError("Invalid character "+r[u]);a=a<<t|l,o+=t,o>=8&&(o-=8,s[c++]=255&a>>o)}if(o>=t||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return s},x_=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},v_=r=>e=>({encode(t){return x_(t,e,r)},decode(t){return w_(t,e,r)}});var __={rfc4648:v_};const Bi=h_,S_=E_,{rfc4648:it}=__,{decodeText:A_,encodeText:R_}=$u,I_=()=>({encode:A_,decode:R_}),ep=[["identity","\0",I_,""],["base2","0",it(1),"01"],["base8","7",it(3),"01234567"],["base10","9",Bi,"0123456789"],["base16","f",it(4),"0123456789abcdef"],["base16upper","F",it(4),"0123456789ABCDEF"],["base32hex","v",it(5),"0123456789abcdefghijklmnopqrstuv"],["base32hexupper","V",it(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV"],["base32hexpad","t",it(5),"0123456789abcdefghijklmnopqrstuv="],["base32hexpadupper","T",it(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV="],["base32","b",it(5),"abcdefghijklmnopqrstuvwxyz234567"],["base32upper","B",it(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"],["base32pad","c",it(5),"abcdefghijklmnopqrstuvwxyz234567="],["base32padupper","C",it(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567="],["base32z","h",it(5),"ybndrfg8ejkmcpqxot1uwisza345h769"],["base36","k",Bi,"0123456789abcdefghijklmnopqrstuvwxyz"],["base36upper","K",Bi,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"],["base58btc","z",Bi,"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"],["base58flickr","Z",Bi,"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"],["base64","m",it(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"],["base64pad","M",it(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="],["base64url","u",it(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"],["base64urlpad","U",it(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_="]],tp=ep.reduce((r,e)=>(r[e[0]]=new S_(e[0],e[1],e[2],e[3]),r),{}),C_=ep.reduce((r,e)=>(r[e[1]]=tp[e[0]],r),{});var D_={names:tp,codes:C_};(function(r,e){const t=D_,{encodeText:n,decodeText:i,concat:s}=$u;function o(d,m){if(!m)throw new Error("requires an encoded Uint8Array");const{name:y,codeBuf:E}=h(d);return l(y,m),s([E,m],E.length+m.length)}function a(d,m){const y=h(d),E=n(y.encode(m));return s([y.codeBuf,E],y.codeBuf.length+E.length)}function c(d){d instanceof Uint8Array&&(d=i(d));const m=d[0];return["f","F","v","V","t","T","b","B","c","C","h","k","K"].includes(m)&&(d=d.toLowerCase()),h(d[0]).decode(d.substring(1))}function u(d){if(d instanceof Uint8Array&&(d=i(d)),Object.prototype.toString.call(d)!=="[object String]")return!1;try{return h(d[0]).name}catch{return!1}}function l(d,m){h(d).decode(i(m))}function h(d){if(Object.prototype.hasOwnProperty.call(t.names,d))return t.names[d];if(Object.prototype.hasOwnProperty.call(t.codes,d))return t.codes[d];throw new Error(`Unsupported encoding: ${d}`)}function p(d){return d instanceof Uint8Array&&(d=i(d)),h(d[0])}e=r.exports=o,e.encode=a,e.decode=c,e.isEncoded=u,e.encoding=h,e.encodingFromData=p;const g=Object.freeze(t.names),f=Object.freeze(t.codes);e.names=g,e.codes=f})(Ih,Ih.exports);const T_=Object.freeze({identity:0,sha1:17,"sha2-256":18,"sha2-512":19,"sha3-512":20,"sha3-384":21,"sha3-256":22,"sha3-224":23,"shake-128":24,"shake-256":25,"keccak-224":26,"keccak-256":27,"keccak-384":28,"keccak-512":29,blake3:30,"murmur3-128":34,"murmur3-32":35,"dbl-sha2-256":86,md4:212,md5:213,bmt:214,"sha2-256-trunc254-padded":4114,"ripemd-128":4178,"ripemd-160":4179,"ripemd-256":4180,"ripemd-320":4181,x11:4352,kangarootwelve:7425,"sm3-256":21325,"blake2b-8":45569,"blake2b-16":45570,"blake2b-24":45571,"blake2b-32":45572,"blake2b-40":45573,"blake2b-48":45574,"blake2b-56":45575,"blake2b-64":45576,"blake2b-72":45577,"blake2b-80":45578,"blake2b-88":45579,"blake2b-96":45580,"blake2b-104":45581,"blake2b-112":45582,"blake2b-120":45583,"blake2b-128":45584,"blake2b-136":45585,"blake2b-144":45586,"blake2b-152":45587,"blake2b-160":45588,"blake2b-168":45589,"blake2b-176":45590,"blake2b-184":45591,"blake2b-192":45592,"blake2b-200":45593,"blake2b-208":45594,"blake2b-216":45595,"blake2b-224":45596,"blake2b-232":45597,"blake2b-240":45598,"blake2b-248":45599,"blake2b-256":45600,"blake2b-264":45601,"blake2b-272":45602,"blake2b-280":45603,"blake2b-288":45604,"blake2b-296":45605,"blake2b-304":45606,"blake2b-312":45607,"blake2b-320":45608,"blake2b-328":45609,"blake2b-336":45610,"blake2b-344":45611,"blake2b-352":45612,"blake2b-360":45613,"blake2b-368":45614,"blake2b-376":45615,"blake2b-384":45616,"blake2b-392":45617,"blake2b-400":45618,"blake2b-408":45619,"blake2b-416":45620,"blake2b-424":45621,"blake2b-432":45622,"blake2b-440":45623,"blake2b-448":45624,"blake2b-456":45625,"blake2b-464":45626,"blake2b-472":45627,"blake2b-480":45628,"blake2b-488":45629,"blake2b-496":45630,"blake2b-504":45631,"blake2b-512":45632,"blake2s-8":45633,"blake2s-16":45634,"blake2s-24":45635,"blake2s-32":45636,"blake2s-40":45637,"blake2s-48":45638,"blake2s-56":45639,"blake2s-64":45640,"blake2s-72":45641,"blake2s-80":45642,"blake2s-88":45643,"blake2s-96":45644,"blake2s-104":45645,"blake2s-112":45646,"blake2s-120":45647,"blake2s-128":45648,"blake2s-136":45649,"blake2s-144":45650,"blake2s-152":45651,"blake2s-160":45652,"blake2s-168":45653,"blake2s-176":45654,"blake2s-184":45655,"blake2s-192":45656,"blake2s-200":45657,"blake2s-208":45658,"blake2s-216":45659,"blake2s-224":45660,"blake2s-232":45661,"blake2s-240":45662,"blake2s-248":45663,"blake2s-256":45664,"skein256-8":45825,"skein256-16":45826,"skein256-24":45827,"skein256-32":45828,"skein256-40":45829,"skein256-48":45830,"skein256-56":45831,"skein256-64":45832,"skein256-72":45833,"skein256-80":45834,"skein256-88":45835,"skein256-96":45836,"skein256-104":45837,"skein256-112":45838,"skein256-120":45839,"skein256-128":45840,"skein256-136":45841,"skein256-144":45842,"skein256-152":45843,"skein256-160":45844,"skein256-168":45845,"skein256-176":45846,"skein256-184":45847,"skein256-192":45848,"skein256-200":45849,"skein256-208":45850,"skein256-216":45851,"skein256-224":45852,"skein256-232":45853,"skein256-240":45854,"skein256-248":45855,"skein256-256":45856,"skein512-8":45857,"skein512-16":45858,"skein512-24":45859,"skein512-32":45860,"skein512-40":45861,"skein512-48":45862,"skein512-56":45863,"skein512-64":45864,"skein512-72":45865,"skein512-80":45866,"skein512-88":45867,"skein512-96":45868,"skein512-104":45869,"skein512-112":45870,"skein512-120":45871,"skein512-128":45872,"skein512-136":45873,"skein512-144":45874,"skein512-152":45875,"skein512-160":45876,"skein512-168":45877,"skein512-176":45878,"skein512-184":45879,"skein512-192":45880,"skein512-200":45881,"skein512-208":45882,"skein512-216":45883,"skein512-224":45884,"skein512-232":45885,"skein512-240":45886,"skein512-248":45887,"skein512-256":45888,"skein512-264":45889,"skein512-272":45890,"skein512-280":45891,"skein512-288":45892,"skein512-296":45893,"skein512-304":45894,"skein512-312":45895,"skein512-320":45896,"skein512-328":45897,"skein512-336":45898,"skein512-344":45899,"skein512-352":45900,"skein512-360":45901,"skein512-368":45902,"skein512-376":45903,"skein512-384":45904,"skein512-392":45905,"skein512-400":45906,"skein512-408":45907,"skein512-416":45908,"skein512-424":45909,"skein512-432":45910,"skein512-440":45911,"skein512-448":45912,"skein512-456":45913,"skein512-464":45914,"skein512-472":45915,"skein512-480":45916,"skein512-488":45917,"skein512-496":45918,"skein512-504":45919,"skein512-512":45920,"skein1024-8":45921,"skein1024-16":45922,"skein1024-24":45923,"skein1024-32":45924,"skein1024-40":45925,"skein1024-48":45926,"skein1024-56":45927,"skein1024-64":45928,"skein1024-72":45929,"skein1024-80":45930,"skein1024-88":45931,"skein1024-96":45932,"skein1024-104":45933,"skein1024-112":45934,"skein1024-120":45935,"skein1024-128":45936,"skein1024-136":45937,"skein1024-144":45938,"skein1024-152":45939,"skein1024-160":45940,"skein1024-168":45941,"skein1024-176":45942,"skein1024-184":45943,"skein1024-192":45944,"skein1024-200":45945,"skein1024-208":45946,"skein1024-216":45947,"skein1024-224":45948,"skein1024-232":45949,"skein1024-240":45950,"skein1024-248":45951,"skein1024-256":45952,"skein1024-264":45953,"skein1024-272":45954,"skein1024-280":45955,"skein1024-288":45956,"skein1024-296":45957,"skein1024-304":45958,"skein1024-312":45959,"skein1024-320":45960,"skein1024-328":45961,"skein1024-336":45962,"skein1024-344":45963,"skein1024-352":45964,"skein1024-360":45965,"skein1024-368":45966,"skein1024-376":45967,"skein1024-384":45968,"skein1024-392":45969,"skein1024-400":45970,"skein1024-408":45971,"skein1024-416":45972,"skein1024-424":45973,"skein1024-432":45974,"skein1024-440":45975,"skein1024-448":45976,"skein1024-456":45977,"skein1024-464":45978,"skein1024-472":45979,"skein1024-480":45980,"skein1024-488":45981,"skein1024-496":45982,"skein1024-504":45983,"skein1024-512":45984,"skein1024-520":45985,"skein1024-528":45986,"skein1024-536":45987,"skein1024-544":45988,"skein1024-552":45989,"skein1024-560":45990,"skein1024-568":45991,"skein1024-576":45992,"skein1024-584":45993,"skein1024-592":45994,"skein1024-600":45995,"skein1024-608":45996,"skein1024-616":45997,"skein1024-624":45998,"skein1024-632":45999,"skein1024-640":46e3,"skein1024-648":46001,"skein1024-656":46002,"skein1024-664":46003,"skein1024-672":46004,"skein1024-680":46005,"skein1024-688":46006,"skein1024-696":46007,"skein1024-704":46008,"skein1024-712":46009,"skein1024-720":46010,"skein1024-728":46011,"skein1024-736":46012,"skein1024-744":46013,"skein1024-752":46014,"skein1024-760":46015,"skein1024-768":46016,"skein1024-776":46017,"skein1024-784":46018,"skein1024-792":46019,"skein1024-800":46020,"skein1024-808":46021,"skein1024-816":46022,"skein1024-824":46023,"skein1024-832":46024,"skein1024-840":46025,"skein1024-848":46026,"skein1024-856":46027,"skein1024-864":46028,"skein1024-872":46029,"skein1024-880":46030,"skein1024-888":46031,"skein1024-896":46032,"skein1024-904":46033,"skein1024-912":46034,"skein1024-920":46035,"skein1024-928":46036,"skein1024-936":46037,"skein1024-944":46038,"skein1024-952":46039,"skein1024-960":46040,"skein1024-968":46041,"skein1024-976":46042,"skein1024-984":46043,"skein1024-992":46044,"skein1024-1000":46045,"skein1024-1008":46046,"skein1024-1016":46047,"skein1024-1024":46048,"poseidon-bls12_381-a2-fc1":46081,"poseidon-bls12_381-a2-fc1-sc":46082});var L_={names:T_};function k_(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var d=0,m=0,y=0,E=f.length;y!==E&&f[y]===0;)y++,d++;for(var b=(E-y)*l+1>>>0,x=new Uint8Array(b);y!==E;){for(var w=f[y],v=0,S=b-1;(w!==0||v<m)&&S!==-1;S--,v++)w+=256*x[S]>>>0,x[S]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");m=v,y++}for(var C=b-m;C!==b&&x[C]===0;)C++;for(var B=c.repeat(d);C<b;++C)B+=r.charAt(x[C]);return B}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var d=0;if(f[d]!==" "){for(var m=0,y=0;f[d]===c;)m++,d++;for(var E=(f.length-d)*u+1>>>0,b=new Uint8Array(E);f[d];){var x=t[f.charCodeAt(d)];if(x===255)return;for(var w=0,v=E-1;(x!==0||w<y)&&v!==-1;v--,w++)x+=a*b[v]>>>0,b[v]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");y=w,d++}if(f[d]!==" "){for(var S=E-y;S!==E&&b[S]===0;)S++;for(var C=new Uint8Array(m+(E-S)),B=m;S!==E;)C[B++]=b[S++];return C}}}function g(f){var d=p(f);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:g}}var P_=k_,N_=P_;const B_=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},O_=r=>new TextEncoder().encode(r),M_=r=>new TextDecoder().decode(r);let U_=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},$_=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return rp(this,e)}},F_=class{constructor(e){this.decoders=e}or(e){return rp(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const rp=(r,e)=>new F_({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let K_=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new U_(e,t,n),this.decoder=new $_(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const ia=({name:r,prefix:e,encode:t,decode:n})=>new K_(r,e,t,n),_s=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:i}=N_(t,e);return ia({prefix:r,name:e,encode:n,decode:s=>B_(i(s))})},V_=(r,e,t,n)=>{const i={};for(let l=0;l<e.length;++l)i[e[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,u=0;for(let l=0;l<s;++l){const h=i[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},z_=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},lt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>ia({prefix:e,name:r,encode(i){return z_(i,n,t)},decode(i){return V_(i,n,t,r)}});ia({prefix:"\0",name:"identity",encode:r=>M_(r),decode:r=>O_(r)});lt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});lt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});_s({prefix:"9",name:"base10",alphabet:"0123456789"});lt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4});lt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});lt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});lt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});lt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});lt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});lt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});lt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});lt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});lt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});lt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});_s({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});_s({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});_s({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});_s({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});lt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});lt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});lt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});lt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const np=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),q_=np.reduce((r,e,t)=>(r[t]=e,r),[]),H_=np.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function W_(r){return r.reduce((e,t)=>(e+=q_[t],e),"")}function G_(r){const e=[];for(const t of r){const n=H_[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}ia({prefix:"ðŸš€",name:"base256emoji",encode:W_,decode:G_});new TextEncoder;new TextDecoder;const{names:Ch}=L_,ip={};for(const r in Ch){const e=r;ip[Ch[e]]=e}Object.freeze(ip);ue("libp2p:webrtc:sdp");Object.values(ci).map(r=>r.decoder).reduce((r,e)=>r.or(e));Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/");ue("libp2p:webrtc:transport");he("webrtc-direct").code;he("certhash").code;function Y_(r){return e=>new _1(e,r)}const Q_=Symbol.for("@libp2p/transport");var Dh;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Dh||(Dh={}));let Th=class qc extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.code=qc.code,this.type=qc.type}static code="ABORT_ERR";static type="aborted"};class Qi extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}}function X_(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var d=0,m=0,y=0,E=f.length;y!==E&&f[y]===0;)y++,d++;for(var b=(E-y)*l+1>>>0,x=new Uint8Array(b);y!==E;){for(var w=f[y],v=0,S=b-1;(w!==0||v<m)&&S!==-1;S--,v++)w+=256*x[S]>>>0,x[S]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");m=v,y++}for(var C=b-m;C!==b&&x[C]===0;)C++;for(var B=c.repeat(d);C<b;++C)B+=r.charAt(x[C]);return B}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var d=0;if(f[d]!==" "){for(var m=0,y=0;f[d]===c;)m++,d++;for(var E=(f.length-d)*u+1>>>0,b=new Uint8Array(E);f[d];){var x=t[f.charCodeAt(d)];if(x===255)return;for(var w=0,v=E-1;(x!==0||w<y)&&v!==-1;v--,w++)x+=a*b[v]>>>0,b[v]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");y=w,d++}if(f[d]!==" "){for(var S=E-y;S!==E&&b[S]===0;)S++;for(var C=new Uint8Array(m+(E-S)),B=m;S!==E;)C[B++]=b[S++];return C}}}function g(f){var d=p(f);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:g}}var Z_=X_,j_=Z_;const J_=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let eS=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},tS=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return sp(this,e)}},rS=class{constructor(e){this.decoders=e}or(e){return sp(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const sp=(r,e)=>new rS({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let nS=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new eS(e,t,n),this.decoder=new tS(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const op=({name:r,prefix:e,encode:t,decode:n})=>new nS(r,e,t,n),ap=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:i}=j_(t,e);return op({prefix:r,name:e,encode:n,decode:s=>J_(i(s))})},iS=(r,e,t,n)=>{const i={};for(let l=0;l<e.length;++l)i[e[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,u=0;for(let l=0;l<s;++l){const h=i[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},sS=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},Mt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>op({prefix:e,name:r,encode(i){return sS(i,n,t)},decode(i){return iS(i,n,t,r)}}),oS=ap({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});ap({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const aS=Mt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Mt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Mt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Mt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Mt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Mt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Mt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Mt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Mt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const cS=Mt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});Mt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});Mt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});Mt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});Z.formatters.b=r=>r==null?"undefined":oS.baseEncode(r);Z.formatters.t=r=>r==null?"undefined":aS.baseEncode(r);Z.formatters.m=r=>r==null?"undefined":cS.baseEncode(r);Z.formatters.p=r=>r==null?"undefined":r.toString();Z.formatters.c=r=>r==null?"undefined":r.toString();Z.formatters.k=r=>r==null?"undefined":r.toString();Z.formatters.a=r=>r==null?"undefined":r.toString();function uS(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function cp(r){let e=uS(`${r}:trace`);return Z.enabled(`${r}:trace`)&&Z.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Z(`${r}:trace`)),Object.assign(Z(r),{error:Z(`${r}:error`),trace:e})}function Lh(r){let e;try{e=he("sni").code}catch{return null}for(const[t,n]of r)if(t===e&&n!==void 0)return n;return null}function kh(r){return r.some(([e,t])=>e===he("tls").code)}function Ct(r,e,t){const n=up[he(r).name];if(n===void 0)throw new Error(`Can't interpret protocol ${he(r).name}`);const i=n(e,t);return r===he("ip6").code?`[${i}]`:i}const up={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`tcp://${Ct(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`udp://${Ct(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Ct(t[0],t[1]??"",e)}/ipfs/${r}`},p2p:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Ct(t[0],t[1]??"",e)}/p2p/${r}`},http:(r,e)=>{const t=kh(e),n=Lh(e);if(t&&n!==null)return`https://${n}`;const i=t?"https://":"http://",s=e.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");let o=Ct(s[0],s[1]??"",e);return o=o.replace("tcp://",""),`${i}${o}`},tls:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return Ct(t[0],t[1]??"",e)},sni:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return Ct(t[0],t[1]??"",e)},https:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=Ct(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=kh(e),n=Lh(e);if(t&&n!==null)return`wss://${n}`;const i=t?"wss://":"ws://",s=e.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");let o=Ct(s[0],s[1]??"",e);return o=o.replace("tcp://",""),`${i}${o}`},wss:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=Ct(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`},"p2p-websocket-star":(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Ct(t[0],t[1]??"",e)}/p2p-websocket-star`},"p2p-webrtc-star":(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Ct(t[0],t[1]??"",e)}/p2p-webrtc-star`},"p2p-webrtc-direct":(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${Ct(t[0],t[1]??"",e)}/p2p-webrtc-direct`}};function lS(r,e){const n=ge(r).stringTuples(),i=n.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");const s=he(i[0]),o=up[s.name];if(o==null)throw new Error(`No interpreter found for ${s.name}`);let a=o(i[1]??"",n);return e?.assumeHttp!==!1&&i[0]===he("tcp").code&&(a=a.replace("tcp://","http://"),(i[1]==="443"||i[1]==="80")&&(i[1]==="443"&&(a=a.replace("http://","https://")),a=a.substring(0,a.lastIndexOf(":")))),a}const hS=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",i),r.removeEventListener("error",s)}function i(){n(),e()}function s(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",i),r.addEventListener("error",s)})},fS=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const i of n){try{await hS(r)}catch(s){if(s.message==="socket closed")break;throw s}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(i)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((i,s)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)i();else{const a=Object.assign(new Error("ws error"),{event:o});s(a)}}),setTimeout(()=>{r.close()})})});var sa={},oa={};Object.defineProperty(oa,"__esModule",{value:!0});class dS{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,i)=>{this.pullQueue.push({resolve:n,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let lp=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){const i=new dS;i.highWaterMark=t,i.lowWaterMark=n,i.removeCallback=e({push:s=>i.push(s),stop:()=>i.stop(),fail:s=>i.fail(s),on:(s,o)=>{i.eventHandlers[s]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};oa.EventIterator=lp;oa.default=lp;Object.defineProperty(sa,"__esModule",{value:!0});const Fu=oa;var pS=sa.EventIterator=Fu.EventIterator;function mS(r,e,t){return new Fu.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}sa.subscribe=mS;sa.default=Fu.EventIterator;function Ph(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}const yS=r=>{r.binaryType="arraybuffer";const e=async()=>{await new Promise((s,o)=>{if(n){s();return}if(i!=null){o(i);return}const a=l=>{r.removeEventListener("open",c),r.removeEventListener("error",u),l()},c=()=>{a(s)},u=l=>{a(()=>{o(l.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",u)})},t=async function*(){const s=new pS(({push:o,stop:a,fail:c})=>{const u=h=>{let p=null;typeof h.data=="string"&&(p=re(h.data)),Ph(h.data)&&(p=new Uint8Array(h.data)),h.data instanceof Uint8Array&&(p=h.data),p!=null&&o(p)},l=h=>{c(h.error??new Error("Socket error"))};return r.addEventListener("message",u),r.addEventListener("error",l),r.addEventListener("close",a),()=>{r.removeEventListener("message",u),r.removeEventListener("error",l),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of s)yield Ph(o)?new Uint8Array(o):o}();let n=r.readyState===1,i;return r.addEventListener("open",()=>{n=!0,i=null}),r.addEventListener("close",()=>{n=!1,i=null}),r.addEventListener("error",s=>{n||(i=s.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},gS=(r,e)=>{e=e??{};const t=yS(r);let n=e.remoteAddress,i=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,i=parseInt(o.port,10)}catch{}if(n==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:fS(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:i,socket:r}},bS=WebSocket,ES=typeof navigator<"u"&&navigator.product==="ReactNative";function wS(){return ES?"http://localhost":self.location?self.location.protocol+"//"+self.location.host:""}const Xi=self.URL,hp=wS();let xS=class{constructor(e="",t=hp){this.super=new Xi(e,t),this.path=this.pathname+this.search,this.auth=this.username&&this.password?this.username+":"+this.password:null,this.query=this.search&&this.search.startsWith("?")?this.search.slice(1):null}get hash(){return this.super.hash}get host(){return this.super.host}get hostname(){return this.super.hostname}get href(){return this.super.href}get origin(){return this.super.origin}get password(){return this.super.password}get pathname(){return this.super.pathname}get port(){return this.super.port}get protocol(){return this.super.protocol}get search(){return this.super.search}get searchParams(){return this.super.searchParams}get username(){return this.super.username}set hash(e){this.super.hash=e}set host(e){this.super.host=e}set hostname(e){this.super.hostname=e}set href(e){this.super.href=e}set password(e){this.super.password=e}set pathname(e){this.super.pathname=e}set port(e){this.super.port=e}set protocol(e){this.super.protocol=e}set search(e){this.super.search=e}set username(e){this.super.username=e}static createObjectURL(e){return Xi.createObjectURL(e)}static revokeObjectURL(e){Xi.revokeObjectURL(e)}toJSON(){return this.super.toJSON()}toString(){return this.super.toString()}format(){return this.toString()}};function vS(r){if(typeof r=="string")return new Xi(r).toString();if(!(r instanceof Xi)){const e=r.username&&r.password?`${r.username}:${r.password}@`:"",t=r.auth?r.auth+"@":"",n=r.port?":"+r.port:"",i=r.protocol?r.protocol+"//":"",s=r.host||"",o=r.hostname||"",a=r.search||(r.query?"?"+r.query:""),c=r.hash||"",u=r.pathname||"",l=r.path||u+a;return`${i}${e||t}${s||o+n}${l}${c}`}}var fp={URLWithLegacySupport:xS,URLSearchParams:self.URLSearchParams,defaultBase:hp,format:vS};const{URLWithLegacySupport:Nh,format:_S}=fp;var SS=(r,e={},t={},n)=>{let i=e.protocol?e.protocol.replace(":",""):"http";i=(t[i]||n||i)+":";let s;try{s=new Nh(r)}catch{s={}}const o=Object.assign({},e,{protocol:i||s.protocol,host:e.host||s.host});return new Nh(r,_S(o)).toString()};const{URLWithLegacySupport:AS,format:RS,URLSearchParams:IS,defaultBase:CS}=fp,DS=SS;var TS={URL:AS,URLSearchParams:IS,format:RS,relative:DS,defaultBase:CS};const LS={http:"ws",https:"wss"},kS="ws",PS=(r,e)=>TS.relative(r,e,LS,kS);function NS(r,e){const t=typeof window>"u"?"":window.location;e=e??{};const n=PS(r,t.toString()),i=new bS(n,e.websocket);return gS(i,e)}function BS(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var OS=BS;const MS=jt(OS),Ku=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,aa=MS(),dp=Ku&&!aa,US=aa&&!Ku,$S=aa&&Ku,FS=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!aa,pp=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope;typeof globalThis.process<"u"&&typeof globalThis.process.env<"u"&&globalThis.process.env["NODE"+(()=>"_")()+"ENV"];const KS=typeof navigator<"u"&&navigator.product==="ReactNative",mp=421,yp=290,VS=2e3;function gp(r){return r.filter(e=>{if(e.protoCodes().includes(yp))return!1;const t=e.decapsulateCode(mp);return bc.matches(t)||ao.matches(t)})}function zS(r){return r.filter(e=>{if(e.protoCodes().includes(yp))return!1;const t=e.decapsulateCode(mp);return ao.matches(t)})}function qS(){throw new Error("WebSocket Servers can not be created in the browser!")}const Bh=cp("libp2p:websockets:socket");function HS(r,e,t){t=t??{};const n={async sink(i){t?.signal!=null&&(i=Pn(i,t.signal));try{await r.sink(i)}catch(s){s.type!=="aborted"&&Bh.error(s)}},source:t.signal!=null?Pn(r.source,t.signal):r.source,remoteAddr:e,timeline:{open:Date.now()},async close(){const i=Date.now();try{await gs(r.close(),{milliseconds:VS})}catch{const{host:o,port:a}=n.remoteAddr.toOptions();Bh("timeout closing stream to %s:%s after %dms, destroying it manually",o,a,Date.now()-i),r.destroy()}finally{n.timeline.close=Date.now()}}};return r.socket.addEventListener("close",()=>{n.timeline.close==null&&(n.timeline.close=Date.now())},{once:!0}),n}const qr=cp("libp2p:websockets");class WS{init;constructor(e){this.init=e}[Symbol.toStringTag]="@libp2p/websockets";[Q_]=!0;async dial(e,t){qr("dialing %s",e),t=t??{};const n=await this._connect(e,t),i=HS(n,e);qr("new outbound connection %s",i.remoteAddr);const s=await t.upgrader.upgradeOutbound(i);return qr("outbound connection %s upgraded",i.remoteAddr),s}async _connect(e,t){if(t?.signal?.aborted===!0)throw new Th;const n=e.toOptions();qr("dialing %s:%s",n.host,n.port);const i=At(),s=u=>{qr.error("connection error:",u),i.reject(u)},o=NS(lS(e),this.init);if(o.socket.on!=null?o.socket.on("error",s):o.socket.onerror=s,t.signal==null)return await Promise.race([o.connected(),i.promise]),qr("connected %s",e),o;let a;const c=new Promise((u,l)=>{if(a=()=>{l(new Th),o.close().catch(h=>{qr.error("error closing raw socket",h)})},t?.signal?.aborted===!0){a();return}t?.signal?.addEventListener("abort",a)});try{await Promise.race([c,i.promise,o.connected()])}finally{a!=null&&t?.signal?.removeEventListener("abort",a)}return qr("connected %s",e),o}createListener(e){return qS({...this.init,...e})}filter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):dp||pp?zS(e):gp(e)}}function GS(r={}){return()=>new WS(r)}function YS(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var d=0,m=0,y=0,E=f.length;y!==E&&f[y]===0;)y++,d++;for(var b=(E-y)*l+1>>>0,x=new Uint8Array(b);y!==E;){for(var w=f[y],v=0,S=b-1;(w!==0||v<m)&&S!==-1;S--,v++)w+=256*x[S]>>>0,x[S]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");m=v,y++}for(var C=b-m;C!==b&&x[C]===0;)C++;for(var B=c.repeat(d);C<b;++C)B+=r.charAt(x[C]);return B}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var d=0;if(f[d]!==" "){for(var m=0,y=0;f[d]===c;)m++,d++;for(var E=(f.length-d)*u+1>>>0,b=new Uint8Array(E);f[d];){var x=t[f.charCodeAt(d)];if(x===255)return;for(var w=0,v=E-1;(x!==0||w<y)&&v!==-1;v--,w++)x+=a*b[v]>>>0,b[v]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");y=w,d++}if(f[d]!==" "){for(var S=E-y;S!==E&&b[S]===0;)S++;for(var C=new Uint8Array(m+(E-S)),B=m;S!==E;)C[B++]=b[S++];return C}}}function g(f){var d=p(f);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:g}}var QS=YS,XS=QS;const ZS=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let jS=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},JS=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return bp(this,e)}},eA=class{constructor(e){this.decoders=e}or(e){return bp(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const bp=(r,e)=>new eA({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let tA=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new jS(e,t,n),this.decoder=new JS(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Ep=({name:r,prefix:e,encode:t,decode:n})=>new tA(r,e,t,n),wp=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:i}=XS(t,e);return Ep({prefix:r,name:e,encode:n,decode:s=>ZS(i(s))})},rA=(r,e,t,n)=>{const i={};for(let l=0;l<e.length;++l)i[e[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,u=0;for(let l=0;l<s;++l){const h=i[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},nA=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},Ut=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Ep({prefix:e,name:r,encode(i){return nA(i,n,t)},decode(i){return rA(i,n,t,r)}}),iA=wp({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});wp({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const sA=Ut({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Ut({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Ut({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Ut({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Ut({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Ut({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Ut({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Ut({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Ut({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const oA=Ut({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});Ut({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});Ut({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});Ut({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});Z.formatters.b=r=>r==null?"undefined":iA.baseEncode(r);Z.formatters.t=r=>r==null?"undefined":sA.baseEncode(r);Z.formatters.m=r=>r==null?"undefined":oA.baseEncode(r);Z.formatters.p=r=>r==null?"undefined":r.toString();Z.formatters.c=r=>r==null?"undefined":r.toString();Z.formatters.k=r=>r==null?"undefined":r.toString();Z.formatters.a=r=>r==null?"undefined":r.toString();function aA(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function cA(r){let e=aA(`${r}:trace`);return Z.enabled(`${r}:trace`)&&Z.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Z(`${r}:trace`)),Object.assign(Z(r),{error:Z(`${r}:error`),trace:e})}var ca=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=typeof e>"u"?1:e}get msDuration(){return this.duration*1e3}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=typeof e>"u"?0:e}get msBlockDuration(){return this.blockDuration*1e3}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=typeof e>"u"?!1:!!e}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=typeof e>"u"?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(typeof e>"u"&&(e="rlflx"),typeof e!="string")throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}},uA=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){const e=Date.now();Object.keys(this._keys).forEach(t=>{this._keys[t]<=e&&delete this._keys[t]}),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,t*1e3)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){const t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();const n=Date.now();return t>=n?t-n:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach(t=>{delete this._keys[t]})}};const lA=uA;var hA=lA,Jt=class{constructor(e,t,n,i){this.remainingPoints=typeof e>"u"?0:e,this.msBeforeNext=typeof t>"u"?0:t,this.consumedPoints=typeof n>"u"?0:n,this.isFirstInDuration=typeof i>"u"?!1:i}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=!!e}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}};const Oa=ca,fA=hA,Oh=Jt;var Ss=class extends Oa{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed||e.inmemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration||e.inmemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new fA}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,n,i,s,o={}){const a=this._getRateLimiterRes(n,i,s);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&a.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(n,a.msBeforeNext),a.consumedPoints>this.points?t(a):e(a);if(a.consumedPoints>this.points){let c=Promise.resolve();this.blockDuration>0&&a.consumedPoints<=this.points+i&&(a.msBeforeNext=this.msBlockDuration,c=this._block(n,a.consumedPoints,this.msBlockDuration,o)),this.inMemoryBlockOnConsumed>0&&a.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(n,this.inMemoryBlockDuration),a.msBeforeNext=this.msInMemoryBlockDuration),c.then(()=>{t(a)}).catch(u=>{t(u)})}else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,c,a)}else e(a)}_handleError(e,t,n,i,s,o=!1,a={}){this.insuranceLimiter instanceof Oa?this.insuranceLimiter[t](s,o,a).then(c=>{n(c)}).catch(c=>{i(c)}):i(e)}get _inmemoryBlockedKeys(){return this._inMemoryBlockedKeys}getInmemoryBlockMsBeforeExpire(e){return this.getInMemoryBlockMsBeforeExpire(e)}get inmemoryBlockOnConsumed(){return this.inMemoryBlockOnConsumed}set inmemoryBlockOnConsumed(e){this.inMemoryBlockOnConsumed=e}get inmemoryBlockDuration(){return this.inMemoryBlockDuration}set inmemoryBlockDuration(e){this.inMemoryBlockDuration=e}get msInmemoryBlockDuration(){return this.inMemoryBlockDuration*1e3}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&this.inMemoryBlockOnConsumed===0)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return this._inMemoryBlockDuration*1e3}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(typeof e<"u"&&!(e instanceof Oa))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,n={}){const i=t*1e3;return this._block(this.getKey(e),this.points+1,i,n)}set(e,t,n,i={}){const s=(n>=0?n:this.duration)*1e3;return this._block(this.getKey(e),t,s,i)}consume(e,t=1,n={}){return new Promise((i,s)=>{const o=this.getKey(e),a=this.getInMemoryBlockMsBeforeExpire(o);if(a>0)return s(new Oh(0,a));this._upsert(o,t,this._getKeySecDuration(n)*1e3,!1,n).then(c=>{this._afterConsume(i,s,o,t,c)}).catch(c=>{this._handleError(c,"consume",i,s,e,t,n)})})}penalty(e,t=1,n={}){const i=this.getKey(e);return new Promise((s,o)=>{this._upsert(i,t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{s(this._getRateLimiterRes(i,t,a))}).catch(a=>{this._handleError(a,"penalty",s,o,e,t,n)})})}reward(e,t=1,n={}){const i=this.getKey(e);return new Promise((s,o)=>{this._upsert(i,-t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{s(this._getRateLimiterRes(i,-t,a))}).catch(a=>{this._handleError(a,"reward",s,o,e,t,n)})})}get(e,t={}){const n=this.getKey(e);return new Promise((i,s)=>{this._get(n,t).then(o=>{i(o===null||typeof o>"u"?null:this._getRateLimiterRes(n,0,o))}).catch(o=>{this._handleError(o,"get",i,s,e,t)})})}delete(e,t={}){const n=this.getKey(e);return new Promise((i,s)=>{this._delete(n,t).then(o=>{this._inMemoryBlockedKeys.delete(n),i(o)}).catch(o=>{this._handleError(o,"delete",i,s,e,t)})})}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,n){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,n,i={}){return new Promise((s,o)=>{this._upsert(e,t,n,!0,i).then(()=>{s(new Oh(0,n>0?n:-1,t))}).catch(a=>{this._handleError(a,"block",s,o,this.parseKey(e),n/1e3,i)})})}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,n,i=!1,s={}){throw new Error("You have to implement the method '_upsert'!")}};const dA=Ss,pA=Jt,Mh="redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ";let mA=class extends dA{constructor(e){super(e),e.redis?this.client=e.redis:this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,typeof this.client.defineCommand=="function"&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:Mh})}_isRedisReady(){return this._rejectIfRedisNotReady?!(this.client.status&&this.client.status!=="ready"||typeof this.client.isReady=="function"&&!this.client.isReady()):!0}_getRateLimiterRes(e,t,n){let[i,s]=n;Array.isArray(i)&&([,i]=i,[,s]=s);const o=new pA;return o.consumedPoints=parseInt(i),o.isFirstInDuration=o.consumedPoints===t,o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.msBeforeNext=s,o}_upsert(e,t,n,i=!1){return new Promise((s,o)=>{if(!this._isRedisReady())return o(new Error("Redis connection is not ready"));const a=Math.floor(n/1e3),c=this.client.multi();if(i)a>0?c.set(e,t,"EX",a):c.set(e,t),c.pttl(e).exec((u,l)=>u?o(u):s(l));else if(a>0){const u=function(l,h){return l?o(l):s(h)};typeof this.client.rlflxIncr=="function"?this.client.rlflxIncr(e,t,a,u):this.client.eval(Mh,1,e,t,a,u)}else c.incrby(e,t).pttl(e).exec((u,l)=>u?o(u):s(l))})}_get(e){return new Promise((t,n)=>{if(!this._isRedisReady())return n(new Error("Redis connection is not ready"));this.client.multi().get(e).pttl(e).exec((i,s)=>{if(i)n(i);else{const[o]=s;if(o===null)return t(null);t(s)}})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(i,s)=>{i?n(i):t(s>0)})})}};var yA=mA;const gA=Ss,bA=Jt;function Uh(r){try{const e=r.client?r.client:r,{version:t}=e.topology.s.options.metadata.driver,n=t.split(".").map(i=>parseInt(i));return{major:n[0],feature:n[1],patch:n[2]}}catch{return{major:0,feature:0,patch:0}}}let EA=class xp extends gA{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,typeof this.client.then=="function"?this.client.then(t=>{this.client=t,this._initCollection(),this._driverVersion=Uh(this.client)}):(this._initCollection(),this._driverVersion=Uh(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?xp.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){const t=(typeof this.client.db=="function"?this.client.db(this.dbName):this.client).collection(this.tableName);t.createIndex({expire:-1},{expireAfterSeconds:0}),t.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=t}_getRateLimiterRes(e,t,n){const i=new bA;let s;return typeof n.value>"u"?s=n:s=n.value,i.isFirstInDuration=s.points===t,i.consumedPoints=s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire!==null?Math.max(new Date(s.expire).getTime()-Date.now(),0):-1,i}_upsert(e,t,n,i=!1,s={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const o=s.attrs||{};let a,c;i?(a={key:e},a=Object.assign(a,o),c={$set:{key:e,points:t,expire:n>0?new Date(Date.now()+n):null}},c.$set=Object.assign(c.$set,o)):(a={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},a=Object.assign(a,o),c={$setOnInsert:{key:e,expire:n>0?new Date(Date.now()+n):null},$inc:{points:t}},c.$setOnInsert=Object.assign(c.$setOnInsert,o));const u={upsert:!0};return this._driverVersion.major>=4||this._driverVersion.major===3&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?u.returnDocument="after":u.returnOriginal=!1,new Promise((l,h)=>{this._collection.findOneAndUpdate(a,c,u).then(p=>{l(p)}).catch(p=>{if(p&&p.code===11e3){const g=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},o),f={$set:Object.assign({key:e,points:t,expire:n>0?new Date(Date.now()+n):null},o)};this._collection.findOneAndUpdate(g,f,u).then(d=>{l(d)}).catch(d=>{d&&d.code===11e3?this._upsert(e,t,n,i).then(m=>l(m)).catch(m=>h(m)):h(d)})}else h(p)})})}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},i=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},n);return this._collection.findOne(i)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},i=Object.assign({key:e},n);return this._collection.deleteOne(i).then(s=>s.deletedCount>0)}};var wA=EA;const xA=Ss,vA=Jt;let _A=class extends xA{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createDbAndTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{this._getConnection().then(n=>{n.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],()=>{this._releaseConnection(n),t()})}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise((e,t)=>{this.client.getConnection((n,i)=>{if(n)return t(n);e(i)})});case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise((e,t)=>{this._getConnection().then(n=>{n.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,i=>{if(i)return this._releaseConnection(n),t(i);n.query(this._getCreateTableStmt(),s=>{if(s)return this._releaseConnection(n),t(s);this._releaseConnection(n),e()})})}).catch(n=>{t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(typeof e>"u")if(this.client.constructor.name==="Connection")e="connection";else if(this.client.constructor.name==="Pool")e="pool";else if(this.client.constructor.name==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){const i=new vA,[s]=n;return i.isFirstInDuration=t===s.points,i.consumedPoints=i.isFirstInDuration?t:s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire?Math.max(s.expire-Date.now(),0):-1,i}_upsertTransaction(e,t,n,i,s){return new Promise((o,a)=>{e.query("BEGIN",c=>{if(c)return e.rollback(),a(c);const u=Date.now(),l=i>0?u+i:null;let h,p;s?(h=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = ?, 
            expire = ?;`,p=[this.dbName,this.tableName,t,n,l,n,l]):(h=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = IF(expire <= ?, ?, points + (?)), 
            expire = IF(expire <= ?, ?, expire);`,p=[this.dbName,this.tableName,t,n,l,u,n,n,u,l]),e.query(h,p,g=>{if(g)return e.rollback(),a(g);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],(f,d)=>{if(f)return e.rollback(),a(f);e.query("COMMIT",m=>{if(m)return e.rollback(),a(m);o(d)})})})})})}_upsert(e,t,n,i=!1){return this.tableCreated?new Promise((s,o)=>{this._getConnection().then(a=>{this._upsertTransaction(a,e,t,n,i).then(c=>{s(c),this._releaseConnection(a)}).catch(c=>{o(c),this._releaseConnection(a)})}).catch(a=>{o(a)})}):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(i=>{i.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],(s,o)=>{s?n(s):o.length===0?t(null):t(o),this._releaseConnection(i)})}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(i=>{i.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],(s,o)=>{s?n(s):t(o.affectedRows>0),this._releaseConnection(i)})}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}};var SA=_A;const AA=Ss,RA=Jt;let IA=class extends AA{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?typeof t=="function"&&t():this._createTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{const n={name:"rlflx-clear-expired",text:`DELETE FROM ${this.tableName} WHERE expire < $1`,values:[e]};this._query(n).then(()=>{t()}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master);default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);case"typeorm":return!0;default:return!0}}_createTable(){return new Promise((e,t)=>{this._query({text:this._getCreateTableStmt()}).then(()=>{e()}).catch(n=>{n.code==="23505"?e():t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this.tableName} ( 
      key varchar(255) PRIMARY KEY,
      points integer NOT NULL DEFAULT 0,
      expire bigint
    );`}get clientType(){return this._clientType}set clientType(e){const t=this.client.constructor.name;if(typeof e>"u")if(t==="Client")e="client";else if(t==="Pool"||t==="BoundPool")e="pool";else if(t==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){const i=new RA,s=n.rows[0];return i.isFirstInDuration=t===s.points,i.consumedPoints=i.isFirstInDuration?t:s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire?Math.max(s.expire-Date.now(),0):-1,i}_query(e){const n={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise((i,s)=>{this._getConnection().then(o=>{o.query(n).then(a=>{i(a),this._releaseConnection(o)}).catch(a=>{s(a),this._releaseConnection(o)})}).catch(o=>{s(o)})})}_upsert(e,t,n,i=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));const s=n>0?Date.now()+n:null,o=i?" $3 ":` CASE
             WHEN ${this.tableName}.expire <= $4 THEN $3
             ELSE ${this.tableName}.expire
            END `;return this._query({name:i?"rlflx-upsert-force":"rlflx-upsert",text:`
            INSERT INTO ${this.tableName} VALUES ($1, $2, $3)
              ON CONFLICT(key) DO UPDATE SET
                points = CASE
                          WHEN (${this.tableName}.expire <= $4 OR 1=${i?1:0}) THEN $2
                          ELSE ${this.tableName}.points + ($2)
                         END,
                expire = ${o}
            RETURNING points, expire;`,values:[e,t,s,Date.now()]})}_get(e){return this.tableCreated?new Promise((t,n)=>{this._query({name:"rlflx-get",text:`
            SELECT points, expire FROM ${this.tableName} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then(i=>{i.rowCount===0&&(i=null),t(i)}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this.tableName} WHERE key = $1`,values:[e]}).then(t=>t.rowCount>0):Promise.reject(Error("Table is not created yet"))}};var CA=IA,DA=class{constructor(e,t,n=null){this.value=e,this.expiresAt=t,this.timeoutId=n}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){!(e instanceof Date)&&Number.isInteger(e)&&(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}};const TA=DA,Ma=Jt;var LA=class{constructor(){this._storage={}}incrby(e,t,n){if(this._storage[e]){const i=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return i!==0?(this._storage[e].value=this._storage[e].value+t,new Ma(0,i,this._storage[e].value,!1)):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const i=n*1e3;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new TA(t,i>0?new Date(Date.now()+i):null),i>0&&(this._storage[e].timeoutId=setTimeout(()=>{delete this._storage[e]},i),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new Ma(0,i===0?-1:i,this._storage[e].value,!0)}get(e){if(this._storage[e]){const t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return new Ma(0,t,this._storage[e].value,!1)}return null}delete(e){return this._storage[e]?(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0):!1}};const kA=ca,PA=LA,$h=Jt;let NA=class extends kA{constructor(e={}){super(e),this._memoryStorage=new PA}consume(e,t=1,n={}){return new Promise((i,s)=>{const o=this.getKey(e),a=this._getKeySecDuration(n);let c=this._memoryStorage.incrby(o,t,a);if(c.remainingPoints=Math.max(this.points-c.consumedPoints,0),c.consumedPoints>this.points)this.blockDuration>0&&c.consumedPoints<=this.points+t&&(c=this._memoryStorage.set(o,c.consumedPoints,this.blockDuration)),s(c);else if(this.execEvenly&&c.msBeforeNext>0&&!c.isFirstInDuration){let u=Math.ceil(c.msBeforeNext/(c.remainingPoints+2));u<this.execEvenlyMinDelayMs&&(u=c.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(i,u,c)}else i(c)})}penalty(e,t=1,n={}){const i=this.getKey(e);return new Promise(s=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(i,t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),s(a)})}reward(e,t=1,n={}){const i=this.getKey(e);return new Promise(s=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(i,-t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),s(a)})}block(e,t){const n=t*1e3,i=this.points+1;return this._memoryStorage.set(this.getKey(e),i,t),Promise.resolve(new $h(0,n===0?-1:n,i))}set(e,t,n){const i=(n>=0?n:this.duration)*1e3;return this._memoryStorage.set(this.getKey(e),t,n),Promise.resolve(new $h(0,i===0?-1:i,t))}get(e){const t=this._memoryStorage.get(this.getKey(e));return t!==null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};var vp=NA;const Fh=Kn,BA=Kn,OA=ca,_p=vp,MA=Jt,Gt="rate_limiter_flexible";let ri=null;const Kh=function(r,e,t,n){let i;n===null||n===!0||n===!1?i=n:i={remainingPoints:n.remainingPoints,msBeforeNext:n.msBeforeNext,consumedPoints:n.consumedPoints,isFirstInDuration:n.isFirstInDuration},r.send({channel:Gt,keyPrefix:e.keyPrefix,promiseId:e.promiseId,type:t,data:i})},Sp=function(r){setTimeout(()=>{this._initiated?process.send(r):typeof this._promises[r.promiseId]<"u"&&Sp.call(this,r)},30)},Hn=function(r,e,t,n,i){const s={channel:Gt,keyPrefix:this.keyPrefix,func:r,promiseId:e,data:{key:t,arg:n,opts:i}};this._initiated?process.send(s):Sp.call(this,s)},Ap=function(r,e){if(!e||e.channel!==Gt||typeof this._rateLimiters[e.keyPrefix]>"u")return!1;let t;switch(e.func){case"consume":t=this._rateLimiters[e.keyPrefix].consume(e.data.key,e.data.arg,e.data.opts);break;case"penalty":t=this._rateLimiters[e.keyPrefix].penalty(e.data.key,e.data.arg,e.data.opts);break;case"reward":t=this._rateLimiters[e.keyPrefix].reward(e.data.key,e.data.arg,e.data.opts);break;case"block":t=this._rateLimiters[e.keyPrefix].block(e.data.key,e.data.arg,e.data.opts);break;case"get":t=this._rateLimiters[e.keyPrefix].get(e.data.key,e.data.opts);break;case"delete":t=this._rateLimiters[e.keyPrefix].delete(e.data.key,e.data.opts);break;default:return!1}t&&t.then(n=>{Kh(r,e,"resolve",n)}).catch(n=>{Kh(r,e,"reject",n)})},UA=function(r){if(!r||r.channel!==Gt||r.keyPrefix!==this.keyPrefix)return!1;if(this._promises[r.promiseId]){clearTimeout(this._promises[r.promiseId].timeoutId);let e;switch(r.data===null||r.data===!0||r.data===!1?e=r.data:e=new MA(r.data.remainingPoints,r.data.msBeforeNext,r.data.consumedPoints,r.data.isFirstInDuration),r.type){case"resolve":this._promises[r.promiseId].resolve(e);break;case"reject":this._promises[r.promiseId].reject(e);break;default:throw new Error(`RateLimiterCluster: no such message type '${r.type}'`)}delete this._promises[r.promiseId]}},$A=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},Wn=function(r,e){const t=process.hrtime();let n=t[0].toString()+t[1].toString();return typeof this._promises[n]<"u"&&(n+=BA.randomBytes(12).toString("base64")),this._promises[n]={resolve:r,reject:e,timeoutId:setTimeout(()=>{delete this._promises[n],e(new Error("RateLimiterCluster timeout: no answer from master in time"))},this.timeoutMs)},n};let FA=class{constructor(){if(ri)return ri;this._rateLimiters={},Fh.setMaxListeners(0),Fh.on("message",(e,t)=>{t&&t.channel===Gt&&t.type==="init"?(typeof this._rateLimiters[t.opts.keyPrefix]>"u"&&(this._rateLimiters[t.opts.keyPrefix]=new _p(t.opts)),e.send({channel:Gt,type:"init",keyPrefix:t.opts.keyPrefix})):Ap.call(this,e,t)}),ri=this}},KA=class{constructor(e){if(ri)return ri;this._rateLimiters={},e.launchBus((t,n)=>{n.on("process:msg",i=>{const s=i.raw;if(s&&s.channel===Gt&&s.type==="init")typeof this._rateLimiters[s.opts.keyPrefix]>"u"&&(this._rateLimiters[s.opts.keyPrefix]=new _p(s.opts)),e.sendDataToProcessId(i.process.pm_id,{data:{},topic:Gt,channel:Gt,type:"init",keyPrefix:s.opts.keyPrefix},(o,a)=>{o&&console.log(o,a)});else{const o={send:a=>{const c=a;c.topic=Gt,typeof c.data>"u"&&(c.data={}),e.sendDataToProcessId(i.process.pm_id,c,(u,l)=>{u&&console.log(u,l)})}};Ap.call(this,o,s)}})}),ri=this}},VA=class extends OA{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=typeof e>"u"?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),process.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,process.on("message",t=>{t&&t.channel===Gt&&t.type==="init"&&t.keyPrefix===this.keyPrefix?this._initiated=!0:UA.call(this,t)}),process.send({channel:Gt,type:"init",opts:$A.call(this)}),this._promises={}}consume(e,t=1,n={}){return new Promise((i,s)=>{const o=Wn.call(this,i,s);Hn.call(this,"consume",o,e,t,n)})}penalty(e,t=1,n={}){return new Promise((i,s)=>{const o=Wn.call(this,i,s);Hn.call(this,"penalty",o,e,t,n)})}reward(e,t=1,n={}){return new Promise((i,s)=>{const o=Wn.call(this,i,s);Hn.call(this,"reward",o,e,t,n)})}block(e,t,n={}){return new Promise((i,s)=>{const o=Wn.call(this,i,s);Hn.call(this,"block",o,e,t,n)})}get(e,t={}){return new Promise((n,i)=>{const s=Wn.call(this,n,i);Hn.call(this,"get",s,e,t)})}delete(e,t={}){return new Promise((n,i)=>{const s=Wn.call(this,n,i);Hn.call(this,"delete",s,e,t)})}};var zA={RateLimiterClusterMaster:FA,RateLimiterClusterMasterPM2:KA,RateLimiterCluster:VA};const qA=Ss,HA=Jt;let WA=class extends qA{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,n){const i=new HA;return i.consumedPoints=parseInt(n.consumedPoints),i.isFirstInDuration=n.consumedPoints===t,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=n.msBeforeNext,i}_upsert(e,t,n,i=!1,s={}){return new Promise((o,a)=>{const c=Date.now(),u=Math.floor(n/1e3);i?this.client.set(e,t,u,l=>{l?a(l):this.client.set(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const h={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(h)})}):this.client.incr(e,t,(l,h)=>{l||h===!1?this.client.add(e,t,u,(p,g)=>{if(p||!g)if(typeof s.attemptNumber>"u"||s.attemptNumber<3){const f=Object.assign({},s);f.attemptNumber=f.attemptNumber?f.attemptNumber+1:1,this._upsert(e,t,n,i,f).then(d=>o(d)).catch(d=>a(d))}else a(new Error("Can not add key"));else this.client.add(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const f={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(f)})}):this.client.get(`${e}_expire`,(p,g)=>{if(p)a(p);else{const f=g===!1?0:g,d={consumedPoints:h,msBeforeNext:f>=0?Math.max(f-c,0):-1};o(d)}})})})}_get(e){return new Promise((t,n)=>{const i=Date.now();this.client.get(e,(s,o)=>{o?this.client.get(`${e}_expire`,(a,c)=>{if(a)n(a);else{const u=c===!1?0:c,l={consumedPoints:o,msBeforeNext:u>=0?Math.max(u-i,0):-1};t(l)}}):t(null)})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(i,s)=>{i?n(i):s===!1?t(s):this.client.del(`${e}_expire`,o=>{o?n(o):t(s)})})})}};var GA=WA;const Vh=Jt;var YA=class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(typeof e>"u")throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=typeof e>"u"?!1:e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new Vh(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new Vh(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.rejectBlack()),typeof n>"u"?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch(()=>{}),n)}block(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch(()=>{}),n)}penalty(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch(()=>{}),n)}reward(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch(()=>{}),n)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),typeof t>"u"||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}};const QA=ca;var XA=class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach(t=>{if(!(t instanceof QA))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")}),this._limiters=e}consume(e,t=1){return new Promise((n,i)=>{const s=[];this._limiters.forEach(o=>{s.push(o.consume(e,t).catch(a=>({rejected:!0,rej:a})))}),Promise.all(s).then(o=>{const a={};let c=!1;o.forEach(u=>{u.rejected===!0&&(c=!0)});for(let u=0;u<o.length;u++)c&&o[u].rejected===!0?a[this._limiters[u].keyPrefix]=o[u].rej:c||(a[this._limiters[u].keyPrefix]=o[u]);c?i(a):n(a)})})}},ZA=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}};const zh=ZA,Rp=4294967295,Hc="limiter";var jA=class{constructor(e,t={maxQueueSize:Rp}){this._queueLimiters={KEY_DEFAULT:new qh(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=Hc){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=Hc){return this._queueLimiters[t]||(this._queueLimiters[t]=new qh(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}};let qh=class{constructor(e,t={maxQueueSize:Rp,key:Hc}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then(e=>e!==null?e.remainingPoints:this._limiterFlexible.points)}removeTokens(e){const t=this;return new Promise((n,i)=>{if(e>t._limiterFlexible.points){i(new zh(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`));return}t._queue.length>0?t._queueRequest.call(t,n,i,e):t._limiterFlexible.consume(t._key,e).then(s=>{n(s.remainingPoints)}).catch(s=>{s instanceof Error?i(s):(t._queueRequest.call(t,n,i,e),t._waitTimeout===null&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),s.msBeforeNext)))})})}_queueRequest(e,t,n){const i=this;i._queue.length<i._maxQueueSize?i._queue.push({resolve:e,reject:t,tokens:n}):t(new zh(`Number of requests reached it's maximum ${i._maxQueueSize}`))}_processFIFO(){const e=this;if(e._waitTimeout!==null&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),e._queue.length===0)return;const t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then(n=>{t.resolve(n.remainingPoints),e._processFIFO.call(e)}).catch(n=>{n instanceof Error?(t.reject(n),e._processFIFO.call(e)):(e._queue.unshift(t),e._waitTimeout===null&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),n.msBeforeNext)))})}};const Ua=Jt;var JA=class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return e?new Ua(e.remainingPoints,Math.min(e.msBeforeNext,t?t.msBeforeNext:0),e.consumedPoints,e.isFirstInDuration):null}consume(e,t=1,n={}){return this._rateLimiter.consume(e,t,n).catch(i=>i instanceof Ua?this._burstLimiter.consume(e,t,n).then(s=>Promise.resolve(this._combineRes(i,s))).catch(s=>s instanceof Ua?Promise.reject(this._combineRes(i,s)):Promise.reject(s)):Promise.reject(i))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then(([t,n])=>this._combineRes(t,n))}get points(){return this._rateLimiter.points}};const eR=yA,tR=wA,rR=SA,nR=CA,{RateLimiterClusterMaster:iR,RateLimiterClusterMasterPM2:sR,RateLimiterCluster:oR}=zA,aR=vp,cR=GA,uR=YA,lR=XA,hR=jA,fR=JA,dR=Jt;var pR={RateLimiterRedis:eR,RateLimiterMongo:tR,RateLimiterMySQL:rR,RateLimiterPostgres:nR,RateLimiterMemory:aR,RateLimiterMemcache:cR,RateLimiterClusterMaster:iR,RateLimiterClusterMasterPM2:sR,RateLimiterCluster:oR,RLWrapperBlackAndWhite:uR,RateLimiterUnion:lR,RateLimiterQueue:hR,BurstyRateLimiter:fR,RateLimiterRes:dR},ye;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(ye||(ye={}));const Vu=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),Hh=Object.freeze({NEW_STREAM:ye.NEW_STREAM,MESSAGE:ye.MESSAGE_INITIATOR,CLOSE:ye.CLOSE_INITIATOR,RESET:ye.RESET_INITIATOR}),mR=Object.freeze({MESSAGE:ye.MESSAGE_RECEIVER,CLOSE:ye.CLOSE_RECEIVER,RESET:ye.RESET_RECEIVER}),Ip=1<<20,yR=4<<20;let gR=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=Ip,t=yR){this._buffer=new ve,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(u){if(u.code==="ERR_MSG_TOO_BIG")throw u;break}const{id:n,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;const c={id:n,type:i};(i===ye.NEW_STREAM||i===ye.MESSAGE_INITIATOR||i===ye.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+s)),t.push(c),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=Gh(e),{value:i,offset:s}=Gh(e,n),o=t&7;if(Vu[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+s,length:i}}};const bR=128,Wh=127;function Gh(r,e=0){let t=0,n=0,i=e,s;const o=r.length;do{if(i>=o||n>49)throw e=0,new RangeError("Could not decode varint");s=r.get(i++),t+=n<28?(s&Wh)<<n:(s&Wh)*Math.pow(2,n),n+=7}while(s>=bR);return e=i-e,{value:t,offset:e}}function ER(r){return r[Symbol.asyncIterator]!=null}const Os=1024*1024,Yh=(r,e)=>{e.append(r)};function wR(r,e){return ER(r)?async function*(){let t=new ve,n=!1,i=At(),s=Number(e?.size??Os);if((isNaN(s)||s===0||s<0)&&(s=Os),s!==Math.round(s))throw new Error("Batch size must be an integer");const o=e?.yieldAfter??0,a=e?.serialize??Yh;for(Promise.resolve().then(async()=>{try{let c;for await(const u of r){if(a(u,t),t.byteLength>=s){clearTimeout(c),i.resolve();continue}c=setTimeout(()=>{i.resolve()},o)}clearTimeout(c),i.resolve()}catch(c){i.reject(c)}finally{n=!0}});!n;)if(await i.promise,i=At(),t.byteLength>0){const c=t;t=new ve,yield c.subarray()}}():function*(){const t=new ve;let n=Number(e?.size??Os);if((isNaN(n)||n===0||n<0)&&(n=Os),n!==Math.round(n))throw new Error("Batch size must be an integer");const i=e?.serialize??Yh;for(const s of r)i(s,t),t.byteLength>=n&&(yield t.subarray(0,n),t.consume(n));t.byteLength>0&&(yield t.subarray())}()}var xR=Wc,Qh=128,vR=127,_R=~vR,SR=Math.pow(2,31);function Wc(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw Wc.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=SR;)e[t++]=r&255|Qh,r/=128;for(;r&_R;)e[t++]=r&255|Qh,r>>>=7;return e[t]=r|0,Wc.bytes=t-n+1,e}var AR=Gc,RR=128,Xh=127;function Gc(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a||i>49)throw Gc.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&Xh)<<i:(o&Xh)*Math.pow(2,i),i+=7}while(o>=RR);return Gc.bytes=s-n,t}var IR=Math.pow(2,7),CR=Math.pow(2,14),DR=Math.pow(2,21),TR=Math.pow(2,28),LR=Math.pow(2,35),kR=Math.pow(2,42),PR=Math.pow(2,49),NR=Math.pow(2,56),BR=Math.pow(2,63),OR=function(r){return r<IR?1:r<CR?2:r<DR?3:r<TR?4:r<LR?5:r<kR?6:r<PR?7:r<NR?8:r<BR?9:10},MR={encode:xR,decode:AR,encodingLength:OR};const Oi=jt(MR);function Zh(r){return new Uint8Array(r)}const $a=10*1024;let UR=class{_pool;_poolOffset;constructor(){this._pool=Zh($a),this._poolOffset=0}write(e,t){const n=this._pool;let i=this._poolOffset;Oi.encode(e.id<<3|e.type,n,i),i+=Oi.encode.bytes??0,(e.type===ye.NEW_STREAM||e.type===ye.MESSAGE_INITIATOR||e.type===ye.MESSAGE_RECEIVER)&&e.data!=null?Oi.encode(e.data.length,n,i):Oi.encode(0,n,i),i+=Oi.encode.bytes??0;const s=n.subarray(this._poolOffset,i);$a-i<100?(this._pool=Zh($a),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===ye.NEW_STREAM||e.type===ye.MESSAGE_INITIATOR||e.type===ye.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const jh=new UR;async function*$R(r,e=0){if(e==null||e===0){for await(const t of r){const n=new ve;for(const i of t)jh.write(i,n);yield n.subarray()}return}yield*wR(r,{size:e,serialize:(t,n)=>{for(const i of t)jh.write(i,n)}})}function FR(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var d=0,m=0,y=0,E=f.length;y!==E&&f[y]===0;)y++,d++;for(var b=(E-y)*l+1>>>0,x=new Uint8Array(b);y!==E;){for(var w=f[y],v=0,S=b-1;(w!==0||v<m)&&S!==-1;S--,v++)w+=256*x[S]>>>0,x[S]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");m=v,y++}for(var C=b-m;C!==b&&x[C]===0;)C++;for(var B=c.repeat(d);C<b;++C)B+=r.charAt(x[C]);return B}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var d=0;if(f[d]!==" "){for(var m=0,y=0;f[d]===c;)m++,d++;for(var E=(f.length-d)*u+1>>>0,b=new Uint8Array(E);f[d];){var x=t[f.charCodeAt(d)];if(x===255)return;for(var w=0,v=E-1;(x!==0||w<y)&&v!==-1;v--,w++)x+=a*b[v]>>>0,b[v]=x%256>>>0,x=x/256>>>0;if(x!==0)throw new Error("Non-zero carry");y=w,d++}if(f[d]!==" "){for(var S=E-y;S!==E&&b[S]===0;)S++;for(var C=new Uint8Array(m+(E-S)),B=m;S!==E;)C[B++]=b[S++];return C}}}function g(f){var d=p(f);if(d)return d;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:g}}var KR=FR,VR=KR;const zR=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};class qR{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class HR{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Cp(this,e)}}class WR{constructor(e){this.decoders=e}or(e){return Cp(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const Cp=(r,e)=>new WR({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class GR{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new qR(e,t,n),this.decoder=new HR(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Dp=({name:r,prefix:e,encode:t,decode:n})=>new GR(r,e,t,n),Tp=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:i}=VR(t,e);return Dp({prefix:r,name:e,encode:n,decode:s=>zR(i(s))})},YR=(r,e,t,n)=>{const i={};for(let l=0;l<e.length;++l)i[e[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,u=0;for(let l=0;l<s;++l){const h=i[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},QR=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},$t=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Dp({prefix:e,name:r,encode(i){return QR(i,n,t)},decode(i){return YR(i,n,t,r)}}),XR=Tp({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Tp({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const ZR=$t({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});$t({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});$t({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});$t({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});$t({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});$t({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});$t({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});$t({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});$t({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const jR=$t({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});$t({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});$t({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});$t({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});Z.formatters.b=r=>r==null?"undefined":XR.baseEncode(r);Z.formatters.t=r=>r==null?"undefined":ZR.baseEncode(r);Z.formatters.m=r=>r==null?"undefined":jR.baseEncode(r);Z.formatters.p=r=>r==null?"undefined":r.toString();Z.formatters.c=r=>r==null?"undefined":r.toString();Z.formatters.k=r=>r==null?"undefined":r.toString();Z.formatters.a=r=>r==null?"undefined":r.toString();function JR(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function eI(r){let e=JR(`${r}:trace`);return Z.enabled(`${r}:trace`)&&Z.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Z(`${r}:trace`)),Object.assign(Z(r),{error:Z(`${r}:error`),trace:e})}const Dt=eI("libp2p:stream"),Fa="ERR_STREAM_RESET",tI="ERR_STREAM_ABORT",rI="ERR_SINK_ENDED",nI="ERR_DOUBLE_SINK";function mn(r){return r!=null&&typeof r.then=="function"}class iI{id;stat;metadata;source;abortController;resetController;closeController;sourceEnded;sinkEnded;sinkSunk;endErr;streamSource;onEnd;maxDataSize;constructor(e){this.abortController=new AbortController,this.resetController=new AbortController,this.closeController=new AbortController,this.sourceEnded=!1,this.sinkEnded=!1,this.sinkSunk=!1,this.id=e.id,this.metadata=e.metadata??{},this.stat={direction:e.direction,timeline:{open:Date.now()}},this.maxDataSize=e.maxDataSize,this.onEnd=e.onEnd,this.source=this.streamSource=ln({onEnd:()=>{if(this.stat.timeline.reset!==null){const t=this.sendCloseRead();mn(t)&&t.catch(n=>{Dt.error("error while sending close read",n)})}this.onSourceEnd()}}),this.sink=this.sink.bind(this)}onSourceEnd(e){this.sourceEnded||(this.stat.timeline.closeRead=Date.now(),this.sourceEnded=!0,Dt.trace("%s stream %s source end - err: %o",this.stat.direction,this.id,e),e!=null&&this.endErr==null&&(this.endErr=e),this.sinkEnded&&(this.stat.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)))}onSinkEnd(e){this.sinkEnded||(this.stat.timeline.closeWrite=Date.now(),this.sinkEnded=!0,Dt.trace("%s stream %s sink end - err: %o",this.stat.direction,this.id,e),e!=null&&this.endErr==null&&(this.endErr=e),this.sourceEnded&&(this.stat.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)))}close(){Dt.trace("%s stream %s close",this.stat.direction,this.id),this.closeRead(),this.closeWrite()}closeRead(){Dt.trace("%s stream %s closeRead",this.stat.direction,this.id),!this.sourceEnded&&this.streamSource.end()}closeWrite(){if(Dt.trace("%s stream %s closeWrite",this.stat.direction,this.id),!this.sinkEnded){this.closeController.abort();try{const e=this.sendCloseWrite();mn(e)&&e.catch(t=>{Dt.error("error while sending close write",t)})}catch(e){Dt.trace("%s stream %s error sending close",this.stat.direction,this.id,e)}this.onSinkEnd()}}abort(e){Dt.trace("%s stream %s abort",this.stat.direction,this.id,e),this.streamSource.end(e),this.abortController.abort(),this.onSinkEnd(e)}reset(){const e=new Qi("stream reset",Fa);this.resetController.abort(),this.streamSource.end(e),this.onSinkEnd(e)}async sink(e){if(this.sinkSunk)throw new Qi("sink already called on stream",nI);if(this.sinkSunk=!0,this.sinkEnded)throw new Qi("stream closed for writing",rI);const t=bs([this.abortController.signal,this.resetController.signal,this.closeController.signal]);try{if(e=Pn(e,t),this.stat.direction==="outbound"){const n=this.sendNewStream();mn(n)&&await n}for await(let n of e)for(;n.length>0;){if(n.length<=this.maxDataSize){const s=this.sendData(n instanceof Uint8Array?new ve(n):n);mn(s)&&await s;break}n=n instanceof Uint8Array?new ve(n):n;const i=this.sendData(n.sublist(0,this.maxDataSize));mn(i)&&await i,n.consume(this.maxDataSize)}}catch(n){if(n.type==="aborted"&&n.message==="The operation was aborted"){if(this.closeController.signal.aborted)return;this.resetController.signal.aborted&&(n.message="stream reset",n.code=Fa),this.abortController.signal.aborted&&(n.message="stream aborted",n.code=tI)}if(n.code===Fa)Dt.trace("%s stream %s reset",this.stat.direction,this.id);else{Dt.trace("%s stream %s error",this.stat.direction,this.id,n);try{const i=this.sendReset();mn(i)&&await i,this.stat.timeline.reset=Date.now()}catch(i){Dt.trace("%s stream %s error sending reset",this.stat.direction,this.id,i)}}throw this.streamSource.end(n),this.onSinkEnd(n),n}finally{t.clear()}try{const n=this.sendCloseWrite();mn(n)&&await n}catch(n){Dt.trace("%s stream %s error sending close",this.stat.direction,this.id,n)}this.onSinkEnd()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}class sI extends iI{name;streamId;send;types;constructor(e){super(e),this.types=e.direction==="outbound"?Hh:mR,this.send=e.send,this.name=e.name,this.streamId=e.streamId}sendNewStream(){this.send({id:this.streamId,type:Hh.NEW_STREAM,data:new ve(re(this.name))})}sendData(e){this.send({id:this.streamId,type:this.types.MESSAGE,data:e})}sendReset(){this.send({id:this.streamId,type:this.types.RESET})}sendCloseWrite(){this.send({id:this.streamId,type:this.types.CLOSE})}sendCloseRead(){}}function oI(r){const{id:e,name:t,send:n,onEnd:i,type:s="initiator",maxMsgSize:o=Ip}=r;return new sI({id:s==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:s==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:i,send:n})}const nr=cA("libp2p:mplex"),aI=1024,cI=1024,uI=1024*1024*4,lI=5;function Jh(r){const e={...r,type:`${Vu[r.type]} (${r.type})`};return r.type===ye.NEW_STREAM&&(e.data=ie(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===ye.MESSAGE_INITIATOR||r.type===ye.MESSAGE_RECEIVER)&&(e.data=ie(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class hI{protocol="/mplex/6.7.0";sink;source;_streamId;_streams;_init;_source;closeController;rateLimiter;constructor(e){e=e??{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.sink=this._createSink();const t=this._createSource();this._source=t,this.source=t,this.closeController=new AbortController,this.rateLimiter=new pR.RateLimiterMemory({points:e.disconnectThreshold??lI,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}close(e){this.closeController.signal.aborted||(e!=null?this.streams.forEach(t=>{t.abort(e)}):this.streams.forEach(t=>{t.close()}),this.closeController.abort())}_newReceiverStream(e){const{id:t,name:n}=e,i=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:i})}_newStream(e){const{id:t,name:n,type:i,registry:s}=e;if(nr("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??cI))throw new Qi("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(s.has(t))throw new Error(`${i} stream ${t} already exists!`);const c=oI({id:t,name:n,send:u=>{nr.enabled&&nr.trace("%s stream %s send",i,t,Jh(u)),this._source.push(u)},type:i,onEnd:()=>{nr("%s stream with id %s and protocol %s ended",i,t,c.stat.protocol),s.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize});return s.set(t,c),c}_createSink(){return async t=>{const n=bs([this.closeController.signal,this._init.signal]);try{t=Pn(t,n);const i=new gR(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const s of t)for(const o of i.write(s))await this._handleIncoming(o);this._source.end()}catch(i){nr("error in sink",i),this._source.end(i)}finally{n.clear()}}}_createSource(){const t=Ng({objectMode:!0,onEnd:n=>{this.close(n)}});return Object.assign($R(t,this._init.minSendBytes),{push:t.push,end:t.end,return:t.return})}async _handleIncoming(e){const{id:t,type:n}=e;if(nr.enabled&&nr.trace("incoming message",Jh(e)),e.type===ye.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??aI)){nr("too many inbound streams open"),this._source.push({id:t,type:ye.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{nr("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this._source.end(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:ie(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const s=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(s==null){nr("missing stream %s for message type %s",t,Vu[n]);return}const o=this._init.maxStreamBufferSize??uI;switch(n){case ye.MESSAGE_INITIATOR:case ye.MESSAGE_RECEIVER:if(s.sourceReadableLength()>o){this._source.push({id:e.id,type:n===ye.MESSAGE_INITIATOR?ye.RESET_RECEIVER:ye.RESET_INITIATOR});const a=new Qi("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");s.abort(a);return}s.sourcePush(e.data);break;case ye.CLOSE_INITIATOR:case ye.CLOSE_RECEIVER:s.closeRead();break;case ye.RESET_INITIATOR:case ye.RESET_RECEIVER:s.reset();break;default:nr("unknown message type %s",n)}}}class fI{protocol="/mplex/6.7.0";_init;constructor(e={}){this._init=e}createStreamMuxer(e={}){return new hI({...e,...this._init})}}function dI(r={}){return()=>new fI(r)}var zu={exports:{}},ni=typeof Reflect=="object"?Reflect:null,ef=ni&&typeof ni.apply=="function"?ni.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},Hs;ni&&typeof ni.ownKeys=="function"?Hs=ni.ownKeys:Object.getOwnPropertySymbols?Hs=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Hs=function(e){return Object.getOwnPropertyNames(e)};function pI(r){console&&console.warn&&console.warn(r)}var Lp=Number.isNaN||function(e){return e!==e};function _e(){_e.init.call(this)}zu.exports=_e;zu.exports.once=bI;_e.EventEmitter=_e;_e.prototype._events=void 0;_e.prototype._eventsCount=0;_e.prototype._maxListeners=void 0;var tf=10;function ua(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(_e,"defaultMaxListeners",{enumerable:!0,get:function(){return tf},set:function(r){if(typeof r!="number"||r<0||Lp(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");tf=r}});_e.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};_e.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Lp(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function kp(r){return r._maxListeners===void 0?_e.defaultMaxListeners:r._maxListeners}_e.prototype.getMaxListeners=function(){return kp(this)};_e.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(c===void 0)return!1;if(typeof c=="function")ef(c,this,t);else for(var u=c.length,l=Mp(c,u),n=0;n<u;++n)ef(l[n],this,t);return!0};function Pp(r,e,t,n){var i,s,o;if(ua(t),s=r._events,s===void 0?(s=r._events=Object.create(null),r._eventsCount=0):(s.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),s=r._events),o=s[e]),o===void 0)o=s[e]=t,++r._eventsCount;else if(typeof o=="function"?o=s[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),i=kp(r),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,pI(a)}return r}_e.prototype.addListener=function(e,t){return Pp(this,e,t,!1)};_e.prototype.on=_e.prototype.addListener;_e.prototype.prependListener=function(e,t){return Pp(this,e,t,!0)};function mI(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Np(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=mI.bind(n);return i.listener=t,n.wrapFn=i,i}_e.prototype.once=function(e,t){return ua(t),this.on(e,Np(this,e,t)),this};_e.prototype.prependOnceListener=function(e,t){return ua(t),this.prependListener(e,Np(this,e,t)),this};_e.prototype.removeListener=function(e,t){var n,i,s,o,a;if(ua(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,s=o;break}if(s<0)return this;s===0?n.shift():yI(n,s),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};_e.prototype.off=_e.prototype.removeListener;_e.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var s=Object.keys(n),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function Bp(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?gI(i):Mp(i,i.length)}_e.prototype.listeners=function(e){return Bp(this,e,!0)};_e.prototype.rawListeners=function(e){return Bp(this,e,!1)};_e.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):Op.call(r,e)};_e.prototype.listenerCount=Op;function Op(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}_e.prototype.eventNames=function(){return this._eventsCount>0?Hs(this._events):[]};function Mp(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function yI(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function gI(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function bI(r,e){return new Promise(function(t,n){function i(o){r.removeListener(e,s),n(o)}function s(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}Up(r,e,s,{once:!0}),e!=="error"&&EI(r,i,{once:!0})})}function EI(r,e,t){typeof r.on=="function"&&Up(r,"error",e,t)}function Up(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(s){n.once&&r.removeEventListener(e,i),t(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var wr=zu.exports;const rf=Symbol.for("@libp2p/content-routing"),nf=Symbol.for("@libp2p/peer-discovery"),sf=Symbol.for("@libp2p/peer-routing"),of={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function af(r,e,t,n,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){const a=Object.keys(of).join(" / ");throw new I(`Hash '${i}' is unknown or not supported. Must be ${a}`,"ERR_UNSUPPORTED_HASH_TYPE")}const s=of[i],o=zw(r,e,t,n,s);return Iw.encode64(o,null)}let $p=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");const Ir="/",Fp=new TextEncoder().encode(Ir),Ms=Fp[0];class ot{_buf;constructor(e,t){if(typeof e=="string")this._buf=re(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Ms)throw new Error("Invalid key")}toString(e="utf8"){return ie(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new ot(e.join(Ir))}static random(){return new ot($p().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new ot(e):typeof e.uint8Array=="function"?new ot(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=Fp),this._buf[0]!==Ms){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Ms,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Ms;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let i=0;i<t.length;i++){if(n.length<i+1)return!1;const s=t[i],o=n[i];if(s<o)return!0;if(s>o)return!1}return t.length<n.length}reverse(){return ot.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Ir).slice(1)}type(){return wI(this.baseNamespace())}name(){return xI(this.baseNamespace())}instance(e){return new ot(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Ir)||(e+=Ir),e+=this.type(),new ot(e)}parent(){const e=this.list();return e.length===1?new ot(Ir):new ot(e.slice(0,-1).join(Ir))}child(e){return this.toString()===Ir?e:e.toString()===Ir?this:new ot(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return ot.withNamespaces([...this.namespaces(),...vI(e.map(t=>t.namespaces()))])}}function wI(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function xI(r){const e=r.split(":");return e[e.length-1]}function vI(r){return[].concat(...r)}var _I=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;const e=Object.getPrototypeOf(r);return e===null||e===Object.prototype};const bo=_I,{hasOwnProperty:Kp}=Object.prototype,{propertyIsEnumerable:SI}=Object,Ei=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),AI=Mo,cf={concatArrays:!1,ignoreUndefined:!1},la=r=>{const e=[];for(const t in r)Kp.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)SI.call(r,n)&&e.push(n)}return e};function Ci(r){return Array.isArray(r)?RI(r):bo(r)?II(r):r}function RI(r){const e=r.slice(0,0);return la(r).forEach(t=>{Ei(e,t,Ci(r[t]))}),e}function II(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return la(r).forEach(t=>{Ei(e,t,Ci(r[t]))}),e}const Vp=(r,e,t,n)=>(t.forEach(i=>{typeof e[i]>"u"&&n.ignoreUndefined||(i in r&&r[i]!==Object.getPrototypeOf(r)?Ei(r,i,Yc(r[i],e[i],n)):Ei(r,i,Ci(e[i])))}),r),CI=(r,e,t)=>{let n=r.slice(0,0),i=0;return[r,e].forEach(s=>{const o=[];for(let a=0;a<s.length;a++)Kp.call(s,a)&&(o.push(String(a)),s===r?Ei(n,i++,s[a]):Ei(n,i++,Ci(s[a])));n=Vp(n,s,la(s).filter(a=>!o.includes(a)),t)}),n};function Yc(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?CI(r,e,t):!bo(e)||!bo(r)?Ci(e):Vp(r,e,la(e),t)}var DI=function(...r){const e=Yc(Ci(cf),this!==AI&&this||{},cf);let t={_:{}};for(const n of r)if(n!==void 0){if(!bo(n))throw new TypeError("`"+n+"` is not an Option Object");t=Yc(t,{_:n},e)}return t._};const ha=jt(DI);function TI(r){return r>=55296&&r<=56319}function LI(r){return r>=56320&&r<=57343}var kI=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,s=0,o,a,c=0;c<i;c+=1){if(o=t.charCodeAt(c),a=t[c],TI(o)&&LI(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),s+=e(a),s===n)return t.slice(0,c+1);if(s>n)return t.slice(0,c-a.length+1)}return t};function PI(r){return r>=55296&&r<=56319}function NI(r){return r>=56320&&r<=57343}var BI=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,i=null,s=null,o=0;o<t;o++)i=e.charCodeAt(o),NI(i)?s!=null&&PI(s)?n+=1:n+=3:i<=127?n+=1:i>=128&&i<=2047?n+=2:i>=2048&&i<=65535&&(n+=3),s=i;return n},OI=kI,MI=BI,UI=OI.bind(null,MI),$I=UI,FI=/[\/\?<>\\:\*\|"]/g,KI=/[\x00-\x1f\x80-\x9f]/g,VI=/^\.+$/,zI=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,qI=/[\. ]+$/;function uf(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(FI,e).replace(KI,e).replace(VI,e).replace(zI,e).replace(qI,e);return $I(t,255)}var HI=function(r,e){var t=e&&e.replacement||"",n=uf(r,t);return t===""?n:uf(n,"")};const WI=jt(HI);var fe;(function(r){r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"})(fe||(fe={}));const Us=ue("libp2p:keychain"),GI="/pkcs8/",zp="/info/",yn=new WeakMap,gn={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Ka={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Ar(r){return r==null||typeof r!="string"?!1:r===WI(r.trim())&&r.length>0}async function xe(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function lr(r){return new ot(GI+r)}function Hr(r){return new ot(zp+r)}class Eo{components;init;constructor(e,t){if(this.components=e,this.init=ha(Ka,t),this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<gn.minKeyLength)throw new Error(`dek.keyLength must be least ${gn.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<gn.minSaltLength)throw new Error(`dek.saltLength must be least ${gn.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<gn.minIterationCount)throw new Error(`dek.iterationCount must be least ${gn.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?af(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";yn.set(this,{dek:n})}static generateOptions(){const e=Object.assign({},Ka),t=Math.ceil(gn.minSaltLength/3)*3;return e.dek.salt=ie(H0(t),"base64"),e}static get options(){return Ka}async createKey(e,t,n=2048){if(!Ar(e)||e==="self")throw await xe(),new I("Invalid key name",fe.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await xe(),new I("Invalid key type",fe.ERR_INVALID_KEY_TYPE);const i=lr(e);if(await this.components.datastore.has(i))throw await xe(),new I("Key name already exists",fe.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(n)||n<2048)throw await xe(),new I("Invalid RSA key size",fe.ERR_INVALID_KEY_SIZE);break}let o;try{const a=await j0(t,n),c=await a.id(),u=yn.get(this);if(u==null)throw new I("dek missing",fe.ERR_INVALID_PARAMETERS);const l=u.dek,h=await a.export(l);o={name:e,id:c};const p=this.components.datastore.batch();p.put(i,re(h)),p.put(Hr(e),re(JSON.stringify(o))),await p.commit()}catch(a){throw await xe(),a}return o}async listKeys(){const e={prefix:zp},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(ie(n.value)));return t}async findKeyById(e){try{const n=(await this.listKeys()).find(i=>i.id===e);if(n==null)throw new I(`Key with id '${e}' does not exist.`,fe.ERR_KEY_NOT_FOUND);return n}catch(t){throw await xe(),t}}async findKeyByName(e){if(!Ar(e))throw await xe(),new I(`Invalid key name '${e}'`,fe.ERR_INVALID_KEY_NAME);const t=Hr(e);try{const n=await this.components.datastore.get(t);return JSON.parse(ie(n))}catch(n){throw await xe(),Us.error(n),new I(`Key '${e}' does not exist.`,fe.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!Ar(e)||e==="self")throw await xe(),new I(`Invalid key name '${e}'`,fe.ERR_INVALID_KEY_NAME);const t=lr(e),n=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(Hr(e)),await i.commit(),n}async renameKey(e,t){if(!Ar(e)||e==="self")throw await xe(),new I(`Invalid old key name '${e}'`,fe.ERR_OLD_KEY_NAME_INVALID);if(!Ar(t)||t==="self")throw await xe(),new I(`Invalid new key name '${t}'`,fe.ERR_NEW_KEY_NAME_INVALID);const n=lr(e),i=lr(t),s=Hr(e),o=Hr(t);if(await this.components.datastore.has(i))throw await xe(),new I(`Key '${t}' already exists`,fe.ERR_KEY_ALREADY_EXISTS);try{const c=await this.components.datastore.get(n),u=await this.components.datastore.get(s),l=JSON.parse(ie(u));l.name=t;const h=this.components.datastore.batch();return h.put(i,c),h.put(o,re(JSON.stringify(l))),h.delete(n),h.delete(s),await h.commit(),l}catch(c){throw await xe(),c}}async exportKey(e,t){if(!Ar(e))throw await xe(),new I(`Invalid key name '${e}'`,fe.ERR_INVALID_KEY_NAME);if(t==null)throw await xe(),new I("Password is required",fe.ERR_PASSWORD_REQUIRED);const n=lr(e);try{const i=await this.components.datastore.get(n),s=ie(i),o=yn.get(this);if(o==null)throw new I("dek missing",fe.ERR_INVALID_PARAMETERS);const a=o.dek;return await(await Ns(s,a)).export(t)}catch(i){throw await xe(),i}}async exportPeerId(e){const t="temporary-password",n=await this.exportKey(e,t),i=await Ns(n,t);return _i(i.public.bytes,i.bytes)}async importKey(e,t,n){if(!Ar(e)||e==="self")throw await xe(),new I(`Invalid key name '${e}'`,fe.ERR_INVALID_KEY_NAME);if(t==null)throw await xe(),new I("PEM encoded key is required",fe.ERR_PEM_REQUIRED);const i=lr(e);if(await this.components.datastore.has(i))throw await xe(),new I(`Key '${e}' already exists`,fe.ERR_KEY_ALREADY_EXISTS);let o;try{o=await Ns(t,n)}catch{throw await xe(),new I("Cannot read the key, most likely the password is wrong",fe.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();const l=yn.get(this);if(l==null)throw new I("dek missing",fe.ERR_INVALID_PARAMETERS);const h=l.dek;t=await o.export(h)}catch(l){throw await xe(),l}const c={name:e,id:a},u=this.components.datastore.batch();return u.put(i,re(t)),u.put(Hr(e),re(JSON.stringify(c))),await u.commit(),c}async importPeer(e,t){try{if(!Ar(e))throw new I(`Invalid key name '${e}'`,fe.ERR_INVALID_KEY_NAME);if(t==null)throw new I("PeerId is required",fe.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw new I("PeerId.privKey is required",fe.ERR_MISSING_PRIVATE_KEY);const n=await na(t.privateKey),i=lr(e);if(await this.components.datastore.has(i))throw await xe(),new I(`Key '${e}' already exists`,fe.ERR_KEY_ALREADY_EXISTS);const o=yn.get(this);if(o==null)throw new I("dek missing",fe.ERR_INVALID_PARAMETERS);const a=o.dek,c=await n.export(a),u={name:e,id:t.toString()},l=this.components.datastore.batch();return l.put(i,re(c)),l.put(Hr(e),re(JSON.stringify(u))),await l.commit(),u}catch(n){throw await xe(),n}}async getPrivateKey(e){if(!Ar(e))throw await xe(),new I(`Invalid key name '${e}'`,fe.ERR_INVALID_KEY_NAME);try{const t=lr(e),n=await this.components.datastore.get(t);return ie(n)}catch(t){throw await xe(),Us.error(t),new I(`Key '${e}' does not exist.`,fe.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await xe(),new I(`Invalid old pass type '${typeof e}'`,fe.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await xe(),new I(`Invalid new pass type '${typeof t}'`,fe.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await xe(),new I(`Invalid pass length ${t.length}`,fe.ERR_INVALID_PASS_LENGTH);Us("recreating keychain");const n=yn.get(this);if(n==null)throw new I("dek missing",fe.ERR_INVALID_PARAMETERS);const i=n.dek;this.init.pass=t;const s=t!=null&&this.init.dek?.salt!=null?af(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";yn.set(this,{dek:s});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(lr(a.name)),u=ie(c),l=await Ns(u,i),h=s.toString(),p=await l.export(h),g=this.components.datastore.batch(),f={name:a.name,id:a.id};g.put(lr(a.name),re(p)),g.put(Hr(a.name),re(JSON.stringify(f))),await g.commit()}Us("keychain reconstructed")}}function wo(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),i=n.value;return n.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}class Di{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return wo(this.map.entries(),e=>[je(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,je(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return wo(this.map.keys(),e=>je(e))}values(){return this.map.values()}get size(){return this.map.size}}class ii{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return wo(this.set.entries(),e=>{const t=je(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=je(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return wo(this.set.values(),e=>je(e))}intersection(e){const t=new ii;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new ii;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new ii;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}var lf;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubKey!=null&&(n.uint32(18),n.bytes(t.pubKey)),t.privKey!=null&&(n.uint32(26),n.bytes(t.privKey)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.id=t.bytes();break;case 2:i.pubKey=t.bytes();break;case 3:i.privKey=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(lf||(lf={}));const YI=async()=>{const r=await j0("Ed25519"),e=await QI(r);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)};async function QI(r){return _i(Wv(r.public),Gv(r))}const XI={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var xo;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.publicKey=t.bytes();break;case 2:i.payloadType=t.bytes();break;case 3:i.payload=t.bytes();break;case 5:i.signature=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(xo||(xo={}));class gr{static createFromProtobuf=async e=>{const t=xo.decode(e),n=await _i(t.publicKey);return new gr({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t)=>{if(t.privateKey==null)throw new Error("Missing private key");const n=e.domain,i=e.codec,s=e.marshal(),o=hf(n,i,s),c=await(await na(t.privateKey)).sign(o.subarray());return new gr({peerId:t,payloadType:i,payload:s,signature:c})};static openAndCertify=async(e,t)=>{const n=await gr.createFromProtobuf(e);if(!await n.validate(t))throw new I("envelope signature is not valid for the given domain",XI.ERR_SIGNATURE_NOT_VALID);return n};peerId;payloadType;payload;signature;marshaled;constructor(e){const{peerId:t,payloadType:n,payload:i,signature:s}=e;this.peerId=t,this.payloadType=n,this.payload=i,this.signature=s}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=xo.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return St(this.marshal(),e.marshal())}async validate(e){const t=hf(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return Uu(this.peerId.publicKey).verify(t.subarray(),this.signature)}}const hf=(r,e,t)=>{const n=re(r),i=sn(n.byteLength),s=sn(e.length),o=sn(t.length);return new ve(i,n,s,e,o,t)};function ZI(r,e){const t=(n,i)=>n.toString().localeCompare(i.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,i)=>e[i].equals(n)))}const jI="libp2p-peer-record",JI=Uint8Array.from([3,1]);var vo;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ue((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{const o={multiaddr:new Uint8Array(0)},a=s==null?i.len:i.pos+s;for(;i.pos<a;){const c=i.uint32();switch(c>>>3){case 1:o.multiaddr=i.bytes();break;default:i.skipType(c&7);break}}return o})),n),t.encode=i=>Me(i,t.codec()),t.decode=i=>Oe(i,t.codec())})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const s of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(s,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={peerId:new Uint8Array(0),seq:0n,addresses:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.peerId=t.bytes();break;case 2:i.seq=t.uint64();break;case 3:i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(vo||(vo={}));class Bt{static createFromProtobuf=e=>{const t=vo.decode(e),n=Uo(t.peerId),i=(t.addresses??[]).map(o=>ge(o.multiaddr)),s=t.seq;return new Bt({peerId:n,multiaddrs:i,seqNumber:s})};static DOMAIN=jI;static CODEC=JI;peerId;multiaddrs;seqNumber;domain=Bt.DOMAIN;codec=Bt.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:i}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=vo.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Bt)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!ZI(this.multiaddrs,e.multiaddrs))}}function eC(r){return r[Symbol.asyncIterator]!=null}function Qc(r){if(eC(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}var qp={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function i(c,u,l){this.fn=c,this.context=u,this.once=l||!1}function s(c,u,l,h,p){if(typeof l!="function")throw new TypeError("The listener must be a function");var g=new i(l,h||c,p),f=t?t+u:u;return c._events[f]?c._events[f].fn?c._events[f]=[c._events[f],g]:c._events[f].push(g):(c._events[f]=g,c._eventsCount++),c}function o(c,u){--c._eventsCount===0?c._events=new n:delete c._events[u]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var u=[],l,h;if(this._eventsCount===0)return u;for(h in l=this._events)e.call(l,h)&&u.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(l)):u},a.prototype.listeners=function(u){var l=t?t+u:u,h=this._events[l];if(!h)return[];if(h.fn)return[h.fn];for(var p=0,g=h.length,f=new Array(g);p<g;p++)f[p]=h[p].fn;return f},a.prototype.listenerCount=function(u){var l=t?t+u:u,h=this._events[l];return h?h.fn?1:h.length:0},a.prototype.emit=function(u,l,h,p,g,f){var d=t?t+u:u;if(!this._events[d])return!1;var m=this._events[d],y=arguments.length,E,b;if(m.fn){switch(m.once&&this.removeListener(u,m.fn,void 0,!0),y){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,l),!0;case 3:return m.fn.call(m.context,l,h),!0;case 4:return m.fn.call(m.context,l,h,p),!0;case 5:return m.fn.call(m.context,l,h,p,g),!0;case 6:return m.fn.call(m.context,l,h,p,g,f),!0}for(b=1,E=new Array(y-1);b<y;b++)E[b-1]=arguments[b];m.fn.apply(m.context,E)}else{var x=m.length,w;for(b=0;b<x;b++)switch(m[b].once&&this.removeListener(u,m[b].fn,void 0,!0),y){case 1:m[b].fn.call(m[b].context);break;case 2:m[b].fn.call(m[b].context,l);break;case 3:m[b].fn.call(m[b].context,l,h);break;case 4:m[b].fn.call(m[b].context,l,h,p);break;default:if(!E)for(w=1,E=new Array(y-1);w<y;w++)E[w-1]=arguments[w];m[b].fn.apply(m[b].context,E)}}return!0},a.prototype.on=function(u,l,h){return s(this,u,l,h,!1)},a.prototype.once=function(u,l,h){return s(this,u,l,h,!0)},a.prototype.removeListener=function(u,l,h,p){var g=t?t+u:u;if(!this._events[g])return this;if(!l)return o(this,g),this;var f=this._events[g];if(f.fn)f.fn===l&&(!p||f.once)&&(!h||f.context===h)&&o(this,g);else{for(var d=0,m=[],y=f.length;d<y;d++)(f[d].fn!==l||p&&!f[d].once||h&&f[d].context!==h)&&m.push(f[d]);m.length?this._events[g]=m.length===1?m[0]:m:o(this,g)}return this},a.prototype.removeAllListeners=function(u){var l;return u?(l=t?t+u:u,this._events[l]&&o(this,l)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(qp);var tC=qp.exports;const rC=jt(tC);class Hp extends Error{constructor(e){super(e),this.name="TimeoutError"}}let nC=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const ff=r=>globalThis.DOMException===void 0?new nC(r):new DOMException(r),df=r=>{const e=r.reason===void 0?ff("This operation was aborted."):r.reason;return e instanceof Error?e:ff(e)};function iC(r,e,t,n){let i;const s=new Promise((o,a)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e===Number.POSITIVE_INFINITY){o(r);return}if(n={customTimers:{setTimeout,clearTimeout},...n},n.signal){const{signal:c}=n;c.aborted&&a(df(c)),c.addEventListener("abort",()=>{a(df(c))})}i=n.customTimers.setTimeout.call(void 0,()=>{if(typeof t=="function"){try{o(t())}catch(l){a(l)}return}const c=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,u=t instanceof Error?t:new Hp(c);typeof r.cancel=="function"&&r.cancel(),a(u)},e),(async()=>{try{o(await r)}catch(c){a(c)}finally{n.customTimers.clearTimeout.call(void 0,i)}})()});return s.clear=()=>{clearTimeout(i),i=void 0},s}function sC(r,e,t){let n=0,i=r.length;for(;i>0;){const s=Math.trunc(i/2);let o=n+s;t(r[o],e)<=0?(n=++o,i-=s+1):i=s}return n}var bn=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Cr;class oC{constructor(){Cr.set(this,[])}enqueue(e,t){t={priority:0,...t};const n={priority:t.priority,run:e};if(this.size&&bn(this,Cr,"f")[this.size-1].priority>=t.priority){bn(this,Cr,"f").push(n);return}const i=sC(bn(this,Cr,"f"),n,(s,o)=>o.priority-s.priority);bn(this,Cr,"f").splice(i,0,n)}dequeue(){const e=bn(this,Cr,"f").shift();return e?.run}filter(e){return bn(this,Cr,"f").filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return bn(this,Cr,"f").length}}Cr=new WeakMap;var ke=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},G=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Fe,Zi,ji,Zr,_o,Ji,Ws,ir,Hi,Pt,Gs,Nt,es,Qr,Ys,pf,mf,Wp,yf,gf,Qs,Va,za,So,Gp,Xs;class Yp extends Error{}class hs extends rC{constructor(e){var t,n,i,s;if(super(),Fe.add(this),Zi.set(this,void 0),ji.set(this,void 0),Zr.set(this,0),_o.set(this,void 0),Ji.set(this,void 0),Ws.set(this,0),ir.set(this,void 0),Hi.set(this,void 0),Pt.set(this,void 0),Gs.set(this,void 0),Nt.set(this,0),es.set(this,void 0),Qr.set(this,void 0),Ys.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:oC,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(i=e.interval)===null||i===void 0?void 0:i.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);ke(this,Zi,e.carryoverConcurrencyCount,"f"),ke(this,ji,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,"f"),ke(this,_o,e.intervalCap,"f"),ke(this,Ji,e.interval,"f"),ke(this,Pt,new e.queueClass,"f"),ke(this,Gs,e.queueClass,"f"),this.concurrency=e.concurrency,this.timeout=e.timeout,ke(this,Ys,e.throwOnTimeout===!0,"f"),ke(this,Qr,e.autoStart===!1,"f")}get concurrency(){return G(this,es,"f")}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);ke(this,es,e,"f"),G(this,Fe,"m",So).call(this)}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:G(this,Ys,"f"),...t},new Promise((n,i)=>{G(this,Pt,"f").enqueue(async()=>{var s,o,a;ke(this,Nt,(o=G(this,Nt,"f"),o++,o),"f"),ke(this,Zr,(a=G(this,Zr,"f"),a++,a),"f");try{if(!((s=t.signal)===null||s===void 0)&&s.aborted)throw new Yp("The task was aborted.");let c=e({signal:t.signal});t.timeout&&(c=iC(Promise.resolve(c),t.timeout)),t.signal&&(c=Promise.race([c,G(this,Fe,"m",Gp).call(this,t.signal)]));const u=await c;n(u),this.emit("completed",u)}catch(c){if(c instanceof Hp&&!t.throwOnTimeout){n();return}i(c),this.emit("error",c)}finally{G(this,Fe,"m",Wp).call(this)}},t),this.emit("add"),G(this,Fe,"m",Qs).call(this)})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return G(this,Qr,"f")?(ke(this,Qr,!1,"f"),G(this,Fe,"m",So).call(this),this):this}pause(){ke(this,Qr,!0,"f")}clear(){ke(this,Pt,new(G(this,Gs,"f")),"f")}async onEmpty(){G(this,Pt,"f").size!==0&&await G(this,Fe,"m",Xs).call(this,"empty")}async onSizeLessThan(e){G(this,Pt,"f").size<e||await G(this,Fe,"m",Xs).call(this,"next",()=>G(this,Pt,"f").size<e)}async onIdle(){G(this,Nt,"f")===0&&G(this,Pt,"f").size===0||await G(this,Fe,"m",Xs).call(this,"idle")}get size(){return G(this,Pt,"f").size}sizeBy(e){return G(this,Pt,"f").filter(e).length}get pending(){return G(this,Nt,"f")}get isPaused(){return G(this,Qr,"f")}}Zi=new WeakMap,ji=new WeakMap,Zr=new WeakMap,_o=new WeakMap,Ji=new WeakMap,Ws=new WeakMap,ir=new WeakMap,Hi=new WeakMap,Pt=new WeakMap,Gs=new WeakMap,Nt=new WeakMap,es=new WeakMap,Qr=new WeakMap,Ys=new WeakMap,Fe=new WeakSet,pf=function(){return G(this,ji,"f")||G(this,Zr,"f")<G(this,_o,"f")},mf=function(){return G(this,Nt,"f")<G(this,es,"f")},Wp=function(){var e;ke(this,Nt,(e=G(this,Nt,"f"),e--,e),"f"),G(this,Fe,"m",Qs).call(this),this.emit("next")},yf=function(){G(this,Fe,"m",za).call(this),G(this,Fe,"m",Va).call(this),ke(this,Hi,void 0,"f")},gf=function(){const e=Date.now();if(G(this,ir,"f")===void 0){const t=G(this,Ws,"f")-e;if(t<0)ke(this,Zr,G(this,Zi,"f")?G(this,Nt,"f"):0,"f");else return G(this,Hi,"f")===void 0&&ke(this,Hi,setTimeout(()=>{G(this,Fe,"m",yf).call(this)},t),"f"),!0}return!1},Qs=function(){if(G(this,Pt,"f").size===0)return G(this,ir,"f")&&clearInterval(G(this,ir,"f")),ke(this,ir,void 0,"f"),this.emit("empty"),G(this,Nt,"f")===0&&this.emit("idle"),!1;if(!G(this,Qr,"f")){const e=!G(this,Fe,"a",gf);if(G(this,Fe,"a",pf)&&G(this,Fe,"a",mf)){const t=G(this,Pt,"f").dequeue();return t?(this.emit("active"),t(),e&&G(this,Fe,"m",Va).call(this),!0):!1}}return!1},Va=function(){G(this,ji,"f")||G(this,ir,"f")!==void 0||(ke(this,ir,setInterval(()=>{G(this,Fe,"m",za).call(this)},G(this,Ji,"f")),"f"),ke(this,Ws,Date.now()+G(this,Ji,"f"),"f"))},za=function(){G(this,Zr,"f")===0&&G(this,Nt,"f")===0&&G(this,ir,"f")&&(clearInterval(G(this,ir,"f")),ke(this,ir,void 0,"f")),ke(this,Zr,G(this,Zi,"f")?G(this,Nt,"f"):0,"f"),G(this,Fe,"m",So).call(this)},So=function(){for(;G(this,Fe,"m",Qs).call(this););},Gp=async function(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(new Yp("The task was aborted."))},{once:!0})})},Xs=async function(e,t){return new Promise(n=>{const i=()=>{t&&!t()||(this.off(e,i),n())};this.on(e,i)})};const bf="lock:worker:request-read",Ef="lock:worker:release-read",wf="lock:master:grant-read",xf="lock:worker:request-write",vf="lock:worker:release-write",_f="lock:master:grant-write",cn={},Mn=r=>{r.addEventListener("message",e=>{Mn.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{Mn.dispatchEvent("message",r,e)})};Mn.addEventListener=(r,e)=>{cn[r]==null&&(cn[r]=[]),cn[r].push(e)};Mn.removeEventListener=(r,e)=>{cn[r]!=null&&(cn[r]=cn[r].filter(t=>t===e))};Mn.dispatchEvent=function(r,e,t){cn[r]!=null&&cn[r].forEach(n=>n(e,t))};const Sf=(r,e,t,n,i)=>(s,o)=>{if(o.data.type!==t)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>(s.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise(c=>{const u=l=>{if(l==null||l.data==null)return;const h={type:l.data.type,name:l.data.name,identifier:l.data.identifier};h.type===n&&h.identifier===a.identifier&&(s.removeEventListener("message",u),c())};s.addEventListener("message",u)}))}}))},Af=(r,e,t,n)=>async()=>{const i=$p();return globalThis.postMessage({type:e,identifier:i,name:r}),await new Promise(s=>{const o=a=>{if(a==null||a.data==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===i&&(globalThis.removeEventListener("message",o),s(()=>{globalThis.postMessage({type:n,identifier:i,name:r})}))};globalThis.addEventListener("message",o)})},aC={singleProcess:!1},cC=r=>{if(r=Object.assign({},aC,r),!!globalThis.document||r.singleProcess){const t=new EventTarget;return Mn.addEventListener("message",Sf(t,"requestReadLock",bf,Ef,wf)),Mn.addEventListener("message",Sf(t,"requestWriteLock",xf,vf,_f)),t}return{isWorker:!0,readLock:t=>Af(t,bf,wf,Ef),writeLock:t=>Af(t,xf,_f,vf)}},En={};let jr;async function qa(r,e){let t;const n=new Promise(i=>{t=i});return r.add(async()=>await gs((async()=>await new Promise(i=>{t(()=>{i()})}))(),{milliseconds:e.timeout})),await n}const uC=(r,e)=>{if(jr.isWorker===!0)return{readLock:jr.readLock(r,e),writeLock:jr.writeLock(r,e)};const t=new hs({concurrency:1});let n;return{async readLock(){if(n!=null)return await qa(n,e);n=new hs({concurrency:e.concurrency,autoStart:!1});const i=n,s=qa(n,e);return t.add(async()=>(i.start(),await i.onIdle().then(()=>{n===i&&(n=null)}))),await s},async writeLock(){return n=null,await qa(t,e)}}},lC={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function hC(r){const e=Object.assign({},lC,r);return jr==null&&(jr=cC(e),jr.isWorker!==!0&&(jr.addEventListener("requestReadLock",t=>{En[t.data.name]!=null&&En[t.data.name].readLock().then(async n=>await t.data.handler().finally(()=>n()))}),jr.addEventListener("requestWriteLock",async t=>{En[t.data.name]!=null&&En[t.data.name].writeLock().then(async n=>await t.data.handler().finally(()=>n()))}))),En[e.name]==null&&(En[e.name]=uC(e.name,e)),En[e.name]}const Ot={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var Ao;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ue((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&i.value.byteLength>0&&(s.uint32(18),s.bytes(i.value)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{const o={key:"",value:new Uint8Array(0)},a=s==null?i.len:i.pos+s;for(;i.pos<a;){const c=i.uint32();switch(c>>>3){case 1:o.key=i.string();break;case 2:o.value=i.bytes();break;default:i.skipType(c&7);break}}return o})),n),t.encode=i=>Me(i,t.codec()),t.decode=i=>Oe(i,t.codec())})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),function(t){let n;t.codec=()=>(n==null&&(n=Ue((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&(s.uint32(18),Io.codec().encode(i.value,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s)=>{const o={key:""},a=s==null?i.len:i.pos+s;for(;i.pos<a;){const c=i.uint32();switch(c>>>3){case 1:o.key=i.string();break;case 2:o.value=Io.codec().decode(i,i.uint32());break;default:i.skipType(c&7);break}}return o})),n),t.encode=i=>Me(i,t.codec()),t.decode=i=>Oe(i,t.codec())}(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const s of t.addresses)n.uint32(10),Ro.codec().encode(s,n);if(t.protocols!=null)for(const s of t.protocols)n.uint32(18),n.string(s);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[s,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:s,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[s,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:s,value:o},n);i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.addresses.push(Ro.codec().decode(t,t.uint32()));break;case 2:i.protocols.push(t.string());break;case 4:i.publicKey=t.bytes();break;case 5:i.peerRecordEnvelope=t.bytes();break;case 6:{const a=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(a.key,a.value);break}case 7:{const a=r.Peer$tagsEntry.codec().decode(t,t.uint32());i.tags.set(a.key,a.value);break}default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(Ao||(Ao={}));var Ro;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={multiaddr:new Uint8Array(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.multiaddr=t.bytes();break;case 2:i.isCertified=t.bool();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(Ro||(Ro={}));var Io;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={value:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.value=t.uint32();break;case 2:i.expiry=t.uint64();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(Io||(Io={}));function Wi(r,e){const t=Ao.decode(e);t.publicKey!=null&&r.publicKey==null&&(r=Hg({...r,publicKey:r.publicKey}));const n=new Map,i=BigInt(Date.now());for(const[s,o]of t.tags.entries())o.expiry!=null&&o.expiry<i||n.set(s,o);return{...t,id:r,addresses:t.addresses.map(({multiaddr:s,isCertified:o})=>({multiaddr:ge(s),isCertified:o??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:n}}const Qp="/peers/";function Mi(r){if(!xd(r)||r.type==null)throw new I("Invalid PeerId",Ot.ERR_INVALID_PARAMETERS);const e=r.toCID().toString();return new ot(`${Qp}${e}`)}async function fC(r,e,t){const n=new Map;for(const i of t){if(i==null)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=ge(i.multiaddr)),!Oo(i.multiaddr))throw new I("Multiaddr was invalid",Ot.ERR_INVALID_PARAMETERS);if(!await e(r,i.multiaddr))continue;const s=i.isCertified??!1,o=i.multiaddr.toString(),a=n.get(o);a!=null?i.isCertified=a.isCertified||s:n.set(o,{multiaddr:i.multiaddr,isCertified:s})}return[...n.values()].sort((i,s)=>i.multiaddr.toString().localeCompare(s.multiaddr.toString())).map(({isCertified:i,multiaddr:s})=>({isCertified:i,multiaddr:s.bytes}))}async function Ha(r,e,t,n){if(e==null)throw new I("Invalid PeerData",Ot.ERR_INVALID_PARAMETERS);if(e.publicKey!=null&&r.publicKey!=null&&!St(e.publicKey,r.publicKey))throw new I("publicKey bytes do not match peer id publicKey bytes",Ot.ERR_INVALID_PARAMETERS);const i=n.existingPeer;if(i!=null&&!r.equals(i.id))throw new I("peer id did not match existing peer id",Ot.ERR_INVALID_PARAMETERS);let s=i?.addresses??[],o=new Set(i?.protocols??[]),a=i?.metadata??new Map,c=i?.tags??new Map,u=i?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=$s(h,{validate:Rf})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=$s(h,{validate:If,map:Cf})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[p,g]of h)g==null?a.delete(p):a.set(p,g);a=$s([...a.entries()],{validate:Rf})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),p=new Map(c);for(const[g,f]of h)f==null?p.delete(g):p.set(g,f);c=$s([...p.entries()],{validate:If,map:Cf})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}const l={addresses:await fC(r,n.addressFilter??(async()=>!0),s),protocols:[...o.values()].sort((h,p)=>h.localeCompare(p)),metadata:a,tags:c,publicKey:i?.id.publicKey??e.publicKey??r.publicKey,peerRecordEnvelope:u};return r.type!=="RSA"&&delete l.publicKey,l}function $s(r,e){const t=new Map;for(const[n,i]of r)i!=null&&e.validate(n,i);for(const[n,i]of r.sort(([s],[o])=>s.localeCompare(o)))i!=null&&t.set(n,e.map?.(n,i)??i);return t}function Rf(r,e){if(typeof r!="string")throw new I("Metadata key must be a string",Ot.ERR_INVALID_PARAMETERS);if(!(e instanceof Uint8Array))throw new I("Metadata value must be a Uint8Array",Ot.ERR_INVALID_PARAMETERS)}function If(r,e){if(typeof r!="string")throw new I("Tag name must be a string",Ot.ERR_INVALID_PARAMETERS);if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new I("Tag value must be an integer",Ot.ERR_INVALID_PARAMETERS);if(e.value<0||e.value>100)throw new I("Tag value must be between 0-100",Ot.ERR_INVALID_PARAMETERS)}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new I("Tag ttl must be an integer",Ot.ERR_INVALID_PARAMETERS);if(e.ttl<0)throw new I("Tag ttl must be between greater than 0",Ot.ERR_INVALID_PARAMETERS)}}function Cf(r,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function Zs(r,e,t){const n=r.toString().split("/")[2],i=Nr.decode(n),s=Uo(i),o=t.get(s);if(o!=null)return o;const a=Wi(s,e);return t.set(s,a),a}function dC(r,e){return r==null?{}:{prefix:Qp,filters:(r.filters??[]).map(t=>({key:n,value:i})=>t(Zs(n,i,e))),orders:(r.orders??[]).map(t=>(n,i)=>t(Zs(n.key,n.value,e),Zs(i.key,i.value,e)))}}class pC{peerId;datastore;lock;addressFilter;constructor(e,t={}){this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=hC({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(Mi(e))}async delete(e){if(this.peerId.equals(e))throw new I("Cannot delete self peer",Ot.ERR_INVALID_PARAMETERS);await this.datastore.delete(Mi(e))}async load(e){const t=await this.datastore.get(Mi(e));return Wi(e,t)}async save(e,t){const{existingBuf:n,existingPeer:i}=await this.#e(e),s=await Ha(e,t,"patch",{addressFilter:this.addressFilter});return this.#t(e,s,n,i)}async patch(e,t){const{existingBuf:n,existingPeer:i}=await this.#e(e),s=await Ha(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,n,i)}async merge(e,t){const{existingBuf:n,existingPeer:i}=await this.#e(e),s=await Ha(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,n,i)}async*all(e){const t=new Di;for await(const{key:n,value:i}of this.datastore.query(dC(e??{},t))){const s=Zs(n,i,t);s.id.equals(this.peerId)||(yield s)}}async#e(e){try{const t=await this.datastore.get(Mi(e)),n=Wi(e,t);return{existingBuf:t,existingPeer:n}}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}return{}}async#t(e,t,n,i){const s=Ao.encode(t);return n!=null&&St(s,n)?{peer:Wi(e,s),previous:i,updated:!1}:(await this.datastore.put(Mi(e),s),{peer:Wi(e,s),previous:i,updated:!0})}}const Re=ue("libp2p:peer-store");class mC{store;events;peerId;constructor(e,t={}){this.events=e.events,this.peerId=e.peerId,this.store=new pC(e,t)}async forEach(e,t){Re.trace("forEach await read lock");const n=await this.store.lock.readLock();Re.trace("forEach got read lock");try{for await(const i of this.store.all(t))e(i)}finally{Re.trace("forEach release read lock"),n()}}async all(e){Re.trace("all await read lock");const t=await this.store.lock.readLock();Re.trace("all got read lock");try{return await Qc(this.store.all(e))}finally{Re.trace("all release read lock"),t()}}async delete(e){Re.trace("delete await write lock");const t=await this.store.lock.writeLock();Re.trace("delete got write lock");try{await this.store.delete(e)}finally{Re.trace("delete release write lock"),t()}}async has(e){Re.trace("has await read lock");const t=await this.store.lock.readLock();Re.trace("has got read lock");try{return await this.store.has(e)}finally{Re.trace("has release read lock"),t()}}async get(e){Re.trace("get await read lock");const t=await this.store.lock.readLock();Re.trace("get got read lock");try{return await this.store.load(e)}finally{Re.trace("get release read lock"),t()}}async save(e,t){Re.trace("save await write lock");const n=await this.store.lock.writeLock();Re.trace("save got write lock");try{const i=await this.store.save(e,t);return this.#e(e,i),i.peer}finally{Re.trace("save release write lock"),n()}}async patch(e,t){Re.trace("patch await write lock");const n=await this.store.lock.writeLock();Re.trace("patch got write lock");try{const i=await this.store.patch(e,t);return this.#e(e,i),i.peer}finally{Re.trace("patch release write lock"),n()}}async merge(e,t){Re.trace("merge await write lock");const n=await this.store.lock.writeLock();Re.trace("merge got write lock");try{const i=await this.store.merge(e,t);return this.#e(e,i),i.peer}finally{Re.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){const n=await gr.openAndCertify(e,Bt.DOMAIN);if(t?.equals(n.peerId)===!1)return Re("envelope peer id was not the expected peer id - expected: %p received: %p",t,n.peerId),!1;const i=Bt.createFromProtobuf(n.payload);let s;try{s=await this.get(n.peerId)}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if(s?.peerRecordEnvelope!=null){const o=await gr.createFromProtobuf(s.peerRecordEnvelope),a=Bt.createFromProtobuf(o.payload);if(a.seqNumber>=i.seqNumber)return Re("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:e,addresses:i.multiaddrs.map(o=>({isCertified:!0,multiaddr:o}))}),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function yC(r){return r[Symbol.asyncIterator]!=null}function Df(r){if(yC(r))return(async()=>{for await(const e of r);})();for(const e of r);}function Xp(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function gC(r){return r[Symbol.asyncIterator]!=null}function Xr(r,e){if(gC(r))return async function*(){for await(const a of r)await e(a)&&(yield a)}();const t=Xp(r),{value:n,done:i}=t.next();if(i===!0)return function*(){}();const s=e(n);if(typeof s.then=="function")return async function*(){await s&&(yield n);for await(const a of t)await e(a)&&(yield a)}();const o=e;return function*(){s===!0&&(yield n);for(const a of t)o(a)&&(yield a)}()}function bC(r){return r[Symbol.asyncIterator]!=null}function Tf(r,e){return bC(r)?async function*(){yield*(await Qc(r)).sort(e)}():function*(){yield*Qc(r).sort(e)}()}function EC(r){return r[Symbol.asyncIterator]!=null}function Lf(r,e){return EC(r)?async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}}()}class wC{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:i}of e)await this.put(n,i,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,i){e.push({key:n,value:i})},delete(n){t.push(n)},commit:async n=>{await Df(this.putMany(e,n)),e=[],await Df(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const i=e.prefix;n=Xr(n,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>Xr(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>Tf(i,s),n)),e.offset!=null){let i=0;const s=e.offset;n=Xr(n,()=>i++>=s)}return e.limit!=null&&(n=Lf(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const i=e.prefix;n=Xr(n,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>Xr(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>Tf(i,s),n)),e.offset!=null){const i=e.offset;let s=0;n=Xr(n,()=>s++>=i)}return e.limit!=null&&(n=Lf(n,e.limit)),n}}function xC(r){return r=r??new Error("Not Found"),Zn(r,"ERR_NOT_FOUND")}class vC extends wC{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){const t=this.data.get(e.toString());if(t==null)throw xC();return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,t]of this.data.entries())yield{key:new ot(e),value:t}}*_allKeys(){for(const e of this.data.keys())yield new ot(e)}}function _C(r,e){let t;return function(){const n=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(n,e)}}const SC=ue("libp2p:address-manager"),AC=r=>r;function Wa(r,e){const t=r.getPeerId();return t!=null&&je(t).equals(e)&&(r=r.decapsulate(ge(`/p2p/${e.toString()}`))),r}class RC{components;listen;announce;observed;announceFilter;constructor(e,t={}){const{listen:n=[],announce:i=[]}=t;this.components=e,this.listen=n.map(s=>s.toString()),this.announce=new Set(i.map(s=>s.toString())),this.observed=new Map,this.announceFilter=t.announceFilter??AC,this._updatePeerStoreAddresses=_C(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([t,n])=>n.confident).map(([t])=>ge(t))).map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{SC.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>ge(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>ge(e))}getObservedAddrs(){return Array.from(this.observed).map(([e])=>ge(e))}addObservedAddr(e){e=Wa(e,this.components.peerId);const t=e.toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){e=Wa(e,this.components.peerId);const t=e.toString(),i=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),i||this._updatePeerStoreAddresses()}removeObservedAddr(e){e=Wa(e,this.components.peerId);const t=e.toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map(n=>n.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(n=>n.toString())),e=e.concat(Array.from(this.observed).filter(([n,i])=>i.confident).map(([n])=>n));const t=new Set(e);return this.announceFilter(Array.from(t).map(n=>ge(n))).map(n=>n.protos().pop()?.path===!0||n.getPeerId()===this.components.peerId.toString()?n:n.encapsulate(`/p2p/${this.components.peerId.toString()}`))}}function IC(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}class CC{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>IC(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const DC=["metrics","connectionProtector"],TC=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function LC(r={}){const e=new CC(r);return new Proxy(e,{get(n,i,s){if(typeof i=="string"&&!TC.includes(i)){const o=e.components[i];if(o==null&&!DC.includes(i))throw new I(`${i} not set`,"ERR_SERVICE_MISSING");return o}return Reflect.get(n,i,s)},set(n,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(n,i,s),!0}})}var Zp;(function(){var r,e,t,n,i,s,o,a;a=function(c){var u,l,h,p;return u=(c&255<<24)>>>24,l=(c&255<<16)>>>16,h=(c&65280)>>>8,p=c&255,[u,l,h,p].join(".")},o=function(c){var u,l,h,p,g,f;for(u=[],h=p=0;p<=3&&c.length!==0;h=++p){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}f=e(c),g=f[0],l=f[1],c=c.substring(l),u.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),s=t("a"),i=t("A"),e=function(c){var u,l,h,p,g;for(p=0,u=10,l="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,u=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,u=8,l="7")),g=h;h<c.length;){if("0"<=c[h]&&c[h]<=l)p=p*u+(t(c[h])-n)>>>0;else if(u===16)if("a"<=c[h]&&c[h]<="f")p=p*u+(10+t(c[h])-s)>>>0;else if("A"<=c[h]&&c[h]<="F")p=p*u+(10+t(c[h])-i)>>>0;else break;else break;if(p>4294967295)throw new Error("too large");h++}if(h===g)throw new Error("empty octet");return[p,h]},r=function(){function c(u,l){var h,p,g;if(typeof u!="string")throw new Error("Missing `net' parameter");if(l||(g=u.split("/",2),u=g[0],l=g[1]),l||(l=32),typeof l=="string"&&l.indexOf(".")>-1){try{this.maskLong=o(l)}catch{throw new Error("Invalid mask: "+l)}for(h=p=32;p>=0;h=--p)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(l||l===0)this.bitmask=parseInt(l,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(u)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+l);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new c(u)),u instanceof c?this.contains(u.base)&&this.contains(u.broadcast||u.last):(o(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(u){return u==null&&(u=1),new c(a(this.netLong+this.size*u),this.mask)},c.prototype.forEach=function(u){var l,h,p;for(p=o(this.first),h=o(this.last),l=0;p<=h;)u(a(p),p,l),l++,p++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),Zp=r}).call(Mo);const kf="[a-fA-F\\d:]",nn=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${kf})|(?<=${kf})(?=\\s|$))`:"",ar="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",qe="[a-fA-F\\d]{1,4}",fa=`
(?:
(?:${qe}:){7}(?:${qe}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${qe}:){6}(?:${ar}|:${qe}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${qe}:){5}(?::${ar}|(?::${qe}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${qe}:){4}(?:(?::${qe}){0,1}:${ar}|(?::${qe}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${qe}:){3}(?:(?::${qe}){0,2}:${ar}|(?::${qe}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${qe}:){2}(?:(?::${qe}){0,3}:${ar}|(?::${qe}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${qe}:){1}(?:(?::${qe}){0,4}:${ar}|(?::${qe}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${qe}){0,5}:${ar}|(?::${qe}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),kC=new RegExp(`(?:^${ar}$)|(?:^${fa}$)`),PC=new RegExp(`^${ar}$`),NC=new RegExp(`^${fa}$`),qu=r=>r&&r.exact?kC:new RegExp(`(?:${nn(r)}${ar}${nn(r)})|(?:${nn(r)}${fa}${nn(r)})`,"g");qu.v4=r=>r&&r.exact?PC:new RegExp(`${nn(r)}${ar}${nn(r)}`,"g");qu.v6=r=>r&&r.exact?NC:new RegExp(`${nn(r)}${fa}${nn(r)}`,"g");var jp={exports:{}};(function(r){(function(e){const t="(0?\\d+|0x[a-f0-9]+)",n={fourOctet:new RegExp(`^${t}\\.${t}\\.${t}\\.${t}$`,"i"),threeOctet:new RegExp(`^${t}\\.${t}\\.${t}$`,"i"),twoOctet:new RegExp(`^${t}\\.${t}$`,"i"),longValue:new RegExp(`^${t}$`,"i")},i=new RegExp("^0[0-7]+$","i"),s=new RegExp("^0x[a-f0-9]+$","i"),o="%[0-9a-z]{1,}",a="(?:[0-9a-f]+::?)+",c={zoneIndex:new RegExp(o,"i"),native:new RegExp(`^(::)?(${a})?([0-9a-f]+)?(::)?(${o})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${t}\\.${t}\\.${t}\\.${t}(${o})?)$`,"i"),transitional:new RegExp(`^((?:${a})|(?:::)(?:${a})?)${t}\\.${t}\\.${t}\\.${t}(${o})?$`,"i")};function u(f,d){if(f.indexOf("::")!==f.lastIndexOf("::"))return null;let m=0,y=-1,E=(f.match(c.zoneIndex)||[])[0],b,x;for(E&&(E=E.substring(1),f=f.replace(/%.+$/,""));(y=f.indexOf(":",y+1))>=0;)m++;if(f.substr(0,2)==="::"&&m--,f.substr(-2,2)==="::"&&m--,m>d)return null;for(x=d-m,b=":";x--;)b+="0:";return f=f.replace("::",b),f[0]===":"&&(f=f.slice(1)),f[f.length-1]===":"&&(f=f.slice(0,-1)),d=function(){const w=f.split(":"),v=[];for(let S=0;S<w.length;S++)v.push(parseInt(w[S],16));return v}(),{parts:d,zoneId:E}}function l(f,d,m,y){if(f.length!==d.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let E=0,b;for(;y>0;){if(b=m-y,b<0&&(b=0),f[E]>>b!==d[E]>>b)return!1;y-=m,E+=1}return!0}function h(f){if(s.test(f))return parseInt(f,16);if(f[0]==="0"&&!isNaN(parseInt(f[1],10))){if(i.test(f))return parseInt(f,8);throw new Error(`ipaddr: cannot parse ${f} as octal`)}return parseInt(f,10)}function p(f,d){for(;f.length<d;)f=`0${f}`;return f}const g={};g.IPv4=function(){function f(d){if(d.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let m,y;for(m=0;m<d.length;m++)if(y=d[m],!(0<=y&&y<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=d}return f.prototype.SpecialRanges={unspecified:[[new f([0,0,0,0]),8]],broadcast:[[new f([255,255,255,255]),32]],multicast:[[new f([224,0,0,0]),4]],linkLocal:[[new f([169,254,0,0]),16]],loopback:[[new f([127,0,0,0]),8]],carrierGradeNat:[[new f([100,64,0,0]),10]],private:[[new f([10,0,0,0]),8],[new f([172,16,0,0]),12],[new f([192,168,0,0]),16]],reserved:[[new f([192,0,0,0]),24],[new f([192,0,2,0]),24],[new f([192,88,99,0]),24],[new f([198,18,0,0]),15],[new f([198,51,100,0]),24],[new f([203,0,113,0]),24],[new f([240,0,0,0]),4]]},f.prototype.kind=function(){return"ipv4"},f.prototype.match=function(d,m){let y;if(m===void 0&&(y=d,d=y[0],m=y[1]),d.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return l(this.octets,d.octets,8,m)},f.prototype.prefixLengthFromSubnetMask=function(){let d=0,m=!1;const y={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0};let E,b,x;for(E=3;E>=0;E-=1)if(b=this.octets[E],b in y){if(x=y[b],m&&x!==0)return null;x!==8&&(m=!0),d+=x}else return null;return 32-d},f.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},f.prototype.toByteArray=function(){return this.octets.slice(0)},f.prototype.toIPv4MappedAddress=function(){return g.IPv6.parse(`::ffff:${this.toString()}`)},f.prototype.toNormalizedString=function(){return this.toString()},f.prototype.toString=function(){return this.octets.join(".")},f}(),g.IPv4.broadcastAddressFromCIDR=function(f){try{const d=this.parseCIDR(f),m=d[0].toByteArray(),y=this.subnetMaskFromPrefixLength(d[1]).toByteArray(),E=[];let b=0;for(;b<4;)E.push(parseInt(m[b],10)|parseInt(y[b],10)^255),b++;return new this(E)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.isIPv4=function(f){return this.parser(f)!==null},g.IPv4.isValid=function(f){try{return new this(this.parser(f)),!0}catch{return!1}},g.IPv4.isValidFourPartDecimal=function(f){return!!(g.IPv4.isValid(f)&&f.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},g.IPv4.networkAddressFromCIDR=function(f){let d,m,y,E,b;try{for(d=this.parseCIDR(f),y=d[0].toByteArray(),b=this.subnetMaskFromPrefixLength(d[1]).toByteArray(),E=[],m=0;m<4;)E.push(parseInt(y[m],10)&parseInt(b[m],10)),m++;return new this(E)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.parse=function(f){const d=this.parser(f);if(d===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(d)},g.IPv4.parseCIDR=function(f){let d;if(d=f.match(/^(.+)\/(\d+)$/)){const m=parseInt(d[2]);if(m>=0&&m<=32){const y=[this.parse(d[1]),m];return Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},g.IPv4.parser=function(f){let d,m,y;if(d=f.match(n.fourOctet))return function(){const E=d.slice(1,6),b=[];for(let x=0;x<E.length;x++)m=E[x],b.push(h(m));return b}();if(d=f.match(n.longValue)){if(y=h(d[1]),y>4294967295||y<0)throw new Error("ipaddr: address outside defined range");return function(){const E=[];let b;for(b=0;b<=24;b+=8)E.push(y>>b&255);return E}().reverse()}else return(d=f.match(n.twoOctet))?function(){const E=d.slice(1,4),b=[];if(y=h(E[1]),y>16777215||y<0)throw new Error("ipaddr: address outside defined range");return b.push(h(E[0])),b.push(y>>16&255),b.push(y>>8&255),b.push(y&255),b}():(d=f.match(n.threeOctet))?function(){const E=d.slice(1,5),b=[];if(y=h(E[2]),y>65535||y<0)throw new Error("ipaddr: address outside defined range");return b.push(h(E[0])),b.push(h(E[1])),b.push(y>>8&255),b.push(y&255),b}():null},g.IPv4.subnetMaskFromPrefixLength=function(f){if(f=parseInt(f),f<0||f>32)throw new Error("ipaddr: invalid IPv4 prefix length");const d=[0,0,0,0];let m=0;const y=Math.floor(f/8);for(;m<y;)d[m]=255,m++;return y<4&&(d[y]=Math.pow(2,f%8)-1<<8-f%8),new this(d)},g.IPv6=function(){function f(d,m){let y,E;if(d.length===16)for(this.parts=[],y=0;y<=14;y+=2)this.parts.push(d[y]<<8|d[y+1]);else if(d.length===8)this.parts=d;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(y=0;y<this.parts.length;y++)if(E=this.parts[y],!(0<=E&&E<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");m&&(this.zoneId=m)}return f.prototype.SpecialRanges={unspecified:[new f([0,0,0,0,0,0,0,0]),128],linkLocal:[new f([65152,0,0,0,0,0,0,0]),10],multicast:[new f([65280,0,0,0,0,0,0,0]),8],loopback:[new f([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new f([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new f([0,0,0,0,0,65535,0,0]),96],rfc6145:[new f([0,0,0,0,65535,0,0,0]),96],rfc6052:[new f([100,65435,0,0,0,0,0,0]),96],"6to4":[new f([8194,0,0,0,0,0,0,0]),16],teredo:[new f([8193,0,0,0,0,0,0,0]),32],reserved:[[new f([8193,3512,0,0,0,0,0,0]),32]],benchmarking:[new f([8193,2,0,0,0,0,0,0]),48],amt:[new f([8193,3,0,0,0,0,0,0]),32],as112v6:[new f([8193,4,274,0,0,0,0,0]),48],deprecated:[new f([8193,16,0,0,0,0,0,0]),28],orchid2:[new f([8193,32,0,0,0,0,0,0]),28]},f.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},f.prototype.kind=function(){return"ipv6"},f.prototype.match=function(d,m){let y;if(m===void 0&&(y=d,d=y[0],m=y[1]),d.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return l(this.parts,d.parts,16,m)},f.prototype.prefixLengthFromSubnetMask=function(){let d=0,m=!1;const y={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0};let E,b;for(let x=7;x>=0;x-=1)if(E=this.parts[x],E in y){if(b=y[E],m&&b!==0)return null;b!==16&&(m=!0),d+=b}else return null;return 128-d},f.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},f.prototype.toByteArray=function(){let d;const m=[],y=this.parts;for(let E=0;E<y.length;E++)d=y[E],m.push(d>>8),m.push(d&255);return m},f.prototype.toFixedLengthString=function(){const d=function(){const y=[];for(let E=0;E<this.parts.length;E++)y.push(p(this.parts[E].toString(16),4));return y}.call(this).join(":");let m="";return this.zoneId&&(m=`%${this.zoneId}`),d+m},f.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");const d=this.parts.slice(-2),m=d[0],y=d[1];return new g.IPv4([m>>8,m&255,y>>8,y&255])},f.prototype.toNormalizedString=function(){const d=function(){const y=[];for(let E=0;E<this.parts.length;E++)y.push(this.parts[E].toString(16));return y}.call(this).join(":");let m="";return this.zoneId&&(m=`%${this.zoneId}`),d+m},f.prototype.toRFC5952String=function(){const d=/((^|:)(0(:|$)){2,})/g,m=this.toNormalizedString();let y=0,E=-1,b;for(;b=d.exec(m);)b[0].length>E&&(y=b.index,E=b[0].length);return E<0?m:`${m.substring(0,y)}::${m.substring(y+E)}`},f.prototype.toString=function(){return this.toRFC5952String()},f}(),g.IPv6.broadcastAddressFromCIDR=function(f){try{const d=this.parseCIDR(f),m=d[0].toByteArray(),y=this.subnetMaskFromPrefixLength(d[1]).toByteArray(),E=[];let b=0;for(;b<16;)E.push(parseInt(m[b],10)|parseInt(y[b],10)^255),b++;return new this(E)}catch(d){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${d})`)}},g.IPv6.isIPv6=function(f){return this.parser(f)!==null},g.IPv6.isValid=function(f){if(typeof f=="string"&&f.indexOf(":")===-1)return!1;try{const d=this.parser(f);return new this(d.parts,d.zoneId),!0}catch{return!1}},g.IPv6.networkAddressFromCIDR=function(f){let d,m,y,E,b;try{for(d=this.parseCIDR(f),y=d[0].toByteArray(),b=this.subnetMaskFromPrefixLength(d[1]).toByteArray(),E=[],m=0;m<16;)E.push(parseInt(y[m],10)&parseInt(b[m],10)),m++;return new this(E)}catch(x){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${x})`)}},g.IPv6.parse=function(f){const d=this.parser(f);if(d.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(d.parts,d.zoneId)},g.IPv6.parseCIDR=function(f){let d,m,y;if((m=f.match(/^(.+)\/(\d+)$/))&&(d=parseInt(m[2]),d>=0&&d<=128))return y=[this.parse(m[1]),d],Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},g.IPv6.parser=function(f){let d,m,y,E,b,x;if(y=f.match(c.deprecatedTransitional))return this.parser(`::ffff:${y[1]}`);if(c.native.test(f))return u(f,8);if((y=f.match(c.transitional))&&(x=y[6]||"",d=u(y[1].slice(0,-1)+x,6),d.parts)){for(b=[parseInt(y[2]),parseInt(y[3]),parseInt(y[4]),parseInt(y[5])],m=0;m<b.length;m++)if(E=b[m],!(0<=E&&E<=255))return null;return d.parts.push(b[0]<<8|b[1]),d.parts.push(b[2]<<8|b[3]),{parts:d.parts,zoneId:d.zoneId}}return null},g.IPv6.subnetMaskFromPrefixLength=function(f){if(f=parseInt(f),f<0||f>128)throw new Error("ipaddr: invalid IPv6 prefix length");const d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let m=0;const y=Math.floor(f/8);for(;m<y;)d[m]=255,m++;return y<16&&(d[y]=Math.pow(2,f%8)-1<<8-f%8),new this(d)},g.fromByteArray=function(f){const d=f.length;if(d===4)return new g.IPv4(f);if(d===16)return new g.IPv6(f);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},g.isValid=function(f){return g.IPv6.isValid(f)||g.IPv4.isValid(f)},g.parse=function(f){if(g.IPv6.isValid(f))return g.IPv6.parse(f);if(g.IPv4.isValid(f))return g.IPv4.parse(f);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},g.parseCIDR=function(f){try{return g.IPv6.parseCIDR(f)}catch{try{return g.IPv4.parseCIDR(f)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},g.process=function(f){const d=this.parse(f);return d.kind()==="ipv6"&&d.isIPv4MappedAddress()?d.toIPv4Address():d},g.subnetMatch=function(f,d,m){let y,E,b,x;m==null&&(m="unicast");for(E in d)if(Object.prototype.hasOwnProperty.call(d,E)){for(b=d[E],b[0]&&!(b[0]instanceof Array)&&(b=[b]),y=0;y<b.length;y++)if(x=b[y],f.kind()===x[0].kind()&&f.match.apply(f,x))return E}return m},r.exports?r.exports=g:e.ipaddr=g})(Mo)})(jp);var BC=jp.exports;const OC=jt(BC),{isValid:MC,parse:UC}=OC,$C=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],FC=$C.map(r=>new Zp(r));function KC(r){for(let e of FC)if(e.contains(r))return!0;return!1}function Pf(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}const Jp=r=>{if(MC(r)){const e=UC(r);if(e.kind()==="ipv4")return KC(e.toNormalizedString());if(e.kind()==="ipv6")return Pf(r)}else if(iu(r)&&qu.v6().test(r))return Pf(r)};function VC(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{const t=e.stringTuples();return t[0][0]===4||t[0][0]===41?!!Jp(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}function Nf(r){try{const{address:e}=r.nodeAddress();return!!Jp(e)}catch{return!0}}function zC(r,e){const t=Nf(r.multiaddr),n=Nf(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function qC(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function HC(r,e){const t=bl.exactMatch(r.multiaddr),n=bl.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function Hu(r,e){const t=zC(r,e);if(t!==0)return t;const n=HC(r,e);return n!==0?n:qC(r,e)}var WC=em,GC=Ed(),fn=em.prototype,YC=new Date%1e9;function QC(){return(Math.random()*1e9>>>0)+YC++}function em(r){r=r||{},this.id=r.id||QC(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var e,t,n=this.items.length;n--;)e=this.items[n],t=new Date(e.expires)-new Date,this._lookup[e.key]=e,t>0?this.expire(e.key,t):t<=0&&this.delete(e.key)}fn.has=function(r){return r in this._lookup};fn.get=function(r){if(!this.has(r))return null;var e=this._lookup[r];return e.refresh&&this.expire(r,e.refresh),this.items.splice(this.items.indexOf(e),1),this.items.push(e),e.value};fn.meta=function(r){if(!this.has(r))return null;var e=this._lookup[r];return"meta"in e?e.meta:null};fn.set=function(r,e,t){var n=this._lookup[r],i=this._lookup[r]={key:r,value:e};return this.lastModified=new Date,n?(clearTimeout(n.timeout),this.items.splice(this.items.indexOf(n),1,i)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(i),this.size++),t&&("ttl"in t&&this.expire(r,t.ttl),"meta"in t&&(i.meta=t.meta),t.refresh&&(i.refresh=t.ttl)),this};fn.delete=function(r){var e=this._lookup[r];return e?(this.lastModified=new Date,this.items.splice(this.items.indexOf(e),1),clearTimeout(e.timeout),delete this._lookup[r],this.size--,this):!1};fn.expire=function(r,e){var t=e||0,n=this._lookup[r];if(!n)return this;if(typeof t=="string"&&(t=GC(e)),typeof t!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(n.timeout),n.timeout=setTimeout(this.delete.bind(this,n.key),t),n.expires=Number(new Date)+t,this};fn.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};fn.toJSON=function(){for(var r=new Array(this.items.length),e,t=r.length;t--;)e=this.items[t],r[t]={key:e.key,meta:e.meta,value:e.value,expires:e.expires,refresh:e.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}};const Bf=jt(WC),XC=globalThis.fetch,ZC=globalThis.Headers;function Ga(r,e,t){return`${r}?name=${e}&type=${t}`}async function jC(r,e){return await(await XC(r,{headers:new ZC({accept:"application/dns-json"}),signal:e})).json()}function Gn(r,e){return`${e}_${r}`}const Ya=Object.assign(Z("dns-over-http-resolver"),{error:Z("dns-over-http-resolver:error")});class JC{_cache;_TXTcache;_servers;_request;_abortControllers;constructor(e={}){this._cache=new Bf({max:e?.maxCache??100}),this._TXTcache=new Bf({max:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??jC,this._abortControllers=[]}cancel(){this._abortControllers.forEach(e=>{e.abort()})}getServers(){return this._servers}_getShuffledServers(){const e=[...this._servers];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),i=e[t];e[t]=e[n],e[n]=i}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return this.resolve4(e);case"AAAA":return this.resolve6(e);case"TXT":return this.resolveTxt(e);default:throw new Error(`${t} is not supported`)}}async resolve4(e){const t="A",n=this._cache.get(Gn(e,t));if(n!=null)return n;let i=!1;for(const s of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(Ga(s,e,t),o.signal),c=a.Answer.map(l=>l.data),u=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(Gn(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(i=!0),Ya.error(`${s} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw i?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){const t="AAAA",n=this._cache.get(Gn(e,t));if(n!=null)return n;let i=!1;for(const s of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(Ga(s,e,t),o.signal),c=a.Answer.map(l=>l.data),u=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(Gn(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(i=!0),Ya.error(`${s} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw i?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){const t="TXT",n=this._TXTcache.get(Gn(e,t));if(n!=null)return n;let i=!1;for(const s of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(Ga(s,e,t),o.signal),c=a.Answer.map(l=>[l.data.replace(/['"]+/g,"")]),u=Math.min(...a.Answer.map(l=>l.TTL));return this._TXTcache.set(Gn(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(i=!0),Ya.error(`${s} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw i?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}}const{code:eD}=he("dnsaddr");async function Wu(r,e={}){const t=new JC;e.signal!=null&&e.signal.addEventListener("abort",()=>{t.cancel()});const n=r.getPeerId(),[,i]=r.stringTuples().find(([a])=>a===eD)??[];if(i==null)throw new Error("No hostname found in multiaddr");let o=(await t.resolveTxt(`_dnsaddr.${i}`)).flat().map(a=>a.split("=")[1]).filter(Boolean);return n!=null&&(o=o.filter(a=>a.includes(n))),o}var Un;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.DHT_DISABLED="DHT is not available",r.PUBSUB_DISABLED="PubSub is not available",r.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",r.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",r.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",r.NOT_FOUND="Not found"})(Un||(Un={}));var H;(function(r){r.DHT_DISABLED="ERR_DHT_DISABLED",r.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",r.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",r.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",r.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",r.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",r.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",r.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",r.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",r.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",r.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",r.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",r.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",r.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",r.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",r.ERR_DIALED_SELF="ERR_DIALED_SELF",r.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",r.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",r.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",r.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",r.ERR_INVALID_KEY="ERR_INVALID_KEY",r.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_PEER="ERR_INVALID_PEER",r.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",r.ERR_NOT_FOUND="ERR_NOT_FOUND",r.ERR_TIMEOUT="ERR_TIMEOUT",r.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",r.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",r.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",r.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",r.ERR_FIND_SELF="ERR_FIND_SELF",r.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",r.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",r.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",r.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",r.ERR_INVALID_CMS="ERR_INVALID_CMS",r.ERR_MISSING_KEYS="ERR_MISSING_KEYS",r.ERR_NO_KEY="ERR_NO_KEY",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",r.ERR_INVALID_RECORD="ERR_INVALID_RECORD",r.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",r.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",r.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"})(H||(H={}));const tD={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:Wu},addressSorter:Hu},transportManager:{faultTolerance:ti.FATAL_ALL}};function rD(r){const e=ha(tD,r);if(e.transports==null||e.transports.length<1)throw new I(Un.ERR_TRANSPORTS_REQUIRED,H.ERR_TRANSPORTS_REQUIRED);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new I(Un.ERR_PROTECTOR_REQUIRED,H.ERR_PROTECTOR_REQUIRED);return e}const nD="keep-alive";var da=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=typeof e>"u"?1:e}get msDuration(){return this.duration*1e3}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=typeof e>"u"?0:e}get msBlockDuration(){return this.blockDuration*1e3}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=typeof e>"u"?!1:!!e}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=typeof e>"u"?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(typeof e>"u"&&(e="rlflx"),typeof e!="string")throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}},iD=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){const e=Date.now();Object.keys(this._keys).forEach(t=>{this._keys[t]<=e&&delete this._keys[t]}),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,t*1e3)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){const t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();const n=Date.now();return t>=n?t-n:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach(t=>{delete this._keys[t]})}};const sD=iD;var oD=sD,er=class{constructor(e,t,n,i){this.remainingPoints=typeof e>"u"?0:e,this.msBeforeNext=typeof t>"u"?0:t,this.consumedPoints=typeof n>"u"?0:n,this.isFirstInDuration=typeof i>"u"?!1:i}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=!!e}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}};const Qa=da,aD=oD,Of=er;var As=class extends Qa{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new aD}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,n,i,s,o={}){const a=this._getRateLimiterRes(n,i,s);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&a.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(n,a.msBeforeNext),a.consumedPoints>this.points?t(a):e(a);if(a.consumedPoints>this.points){let c=Promise.resolve();this.blockDuration>0&&a.consumedPoints<=this.points+i&&(a.msBeforeNext=this.msBlockDuration,c=this._block(n,a.consumedPoints,this.msBlockDuration,o)),this.inMemoryBlockOnConsumed>0&&a.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(n,this.inMemoryBlockDuration),a.msBeforeNext=this.msInMemoryBlockDuration),c.then(()=>{t(a)}).catch(u=>{t(u)})}else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,c,a)}else e(a)}_handleError(e,t,n,i,s,o=!1,a={}){this.insuranceLimiter instanceof Qa?this.insuranceLimiter[t](s,o,a).then(c=>{n(c)}).catch(c=>{i(c)}):i(e)}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&this.inMemoryBlockOnConsumed===0)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return this._inMemoryBlockDuration*1e3}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(typeof e<"u"&&!(e instanceof Qa))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,n={}){const i=t*1e3;return this._block(this.getKey(e),this.points+1,i,n)}set(e,t,n,i={}){const s=(n>=0?n:this.duration)*1e3;return this._block(this.getKey(e),t,s,i)}consume(e,t=1,n={}){return new Promise((i,s)=>{const o=this.getKey(e),a=this.getInMemoryBlockMsBeforeExpire(o);if(a>0)return s(new Of(0,a));this._upsert(o,t,this._getKeySecDuration(n)*1e3,!1,n).then(c=>{this._afterConsume(i,s,o,t,c)}).catch(c=>{this._handleError(c,"consume",i,s,e,t,n)})})}penalty(e,t=1,n={}){const i=this.getKey(e);return new Promise((s,o)=>{this._upsert(i,t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{s(this._getRateLimiterRes(i,t,a))}).catch(a=>{this._handleError(a,"penalty",s,o,e,t,n)})})}reward(e,t=1,n={}){const i=this.getKey(e);return new Promise((s,o)=>{this._upsert(i,-t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{s(this._getRateLimiterRes(i,-t,a))}).catch(a=>{this._handleError(a,"reward",s,o,e,t,n)})})}get(e,t={}){const n=this.getKey(e);return new Promise((i,s)=>{this._get(n,t).then(o=>{i(o===null||typeof o>"u"?null:this._getRateLimiterRes(n,0,o))}).catch(o=>{this._handleError(o,"get",i,s,e,t)})})}delete(e,t={}){const n=this.getKey(e);return new Promise((i,s)=>{this._delete(n,t).then(o=>{this._inMemoryBlockedKeys.delete(n),i(o)}).catch(o=>{this._handleError(o,"delete",i,s,e,t)})})}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,n){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,n,i={}){return new Promise((s,o)=>{this._upsert(e,t,n,!0,i).then(()=>{s(new Of(0,n>0?n:-1,t))}).catch(a=>{this._handleError(a,"block",s,o,this.parseKey(e),n/1e3,i)})})}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,n,i=!1,s={}){throw new Error("You have to implement the method '_upsert'!")}};const cD=As,uD=er,Xa="redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ";let lD=class extends cD{constructor(e){super(e),this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,this.useRedisPackage=e.useRedisPackage,this.useRedis3AndLowerPackage=e.useRedis3AndLowerPackage,typeof this.client.defineCommand=="function"&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:Xa})}_isRedisReady(){return this._rejectIfRedisNotReady?!(this.client.status&&this.client.status!=="ready"||typeof this.client.isReady=="function"&&!this.client.isReady()):!0}_getRateLimiterRes(e,t,n){let[i,s]=n;Array.isArray(i)&&([,i]=i,[,s]=s);const o=new uD;return o.consumedPoints=parseInt(i),o.isFirstInDuration=o.consumedPoints===t,o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.msBeforeNext=s,o}async _upsert(e,t,n,i=!1){if(!this._isRedisReady())throw new Error("Redis connection is not ready");const s=Math.floor(n/1e3),o=this.client.multi();return i?(s>0?!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.set(e,t,"EX",s):o.set(e,t,{EX:s}):o.set(e,t),!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.pttl(e).exec(!0):o.pTTL(e).exec(!0)):s>0?!this.useRedisPackage&&!this.useRedis3AndLowerPackage?this.client.rlflxIncr([e].concat([String(t),String(s)])):this.useRedis3AndLowerPackage?new Promise((a,c)=>{const u=function(l,h){return l?c(l):a(h)};typeof this.client.rlflxIncr=="function"?this.client.rlflxIncr(e,t,s,u):this.client.eval(Xa,1,e,t,s,u)}):this.client.eval(Xa,{keys:[e],arguments:[String(t),String(s)]}):!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.incrby(e,t).pttl(e).exec(!0):o.incrBy(e,t).pTTL(e).exec(!0)}async _get(e){if(!this._isRedisReady())throw new Error("Redis connection is not ready");return!this.useRedisPackage&&!this.useRedis3AndLowerPackage?this.client.multi().get(e).pttl(e).exec().then(t=>{const[[,n]]=t;return n===null?null:t}):this.client.multi().get(e).pTTL(e).exec(!0).then(t=>{const[n]=t;return n===null?null:t})}_delete(e){return this.client.del(e).then(t=>t>0)}};var hD=lD;const fD=As,dD=er;function Mf(r){try{const e=r.client?r.client:r,{version:t}=e.topology.s.options.metadata.driver,n=t.split(".").map(i=>parseInt(i));return{major:n[0],feature:n[1],patch:n[2]}}catch{return{major:0,feature:0,patch:0}}}let pD=class tm extends fD{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,typeof this.client.then=="function"?this.client.then(t=>{this.client=t,this._initCollection(),this._driverVersion=Mf(this.client)}):(this._initCollection(),this._driverVersion=Mf(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?tm.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){const t=(typeof this.client.db=="function"?this.client.db(this.dbName):this.client).collection(this.tableName);t.createIndex({expire:-1},{expireAfterSeconds:0}),t.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=t}_getRateLimiterRes(e,t,n){const i=new dD;let s;return typeof n.value>"u"?s=n:s=n.value,i.isFirstInDuration=s.points===t,i.consumedPoints=s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire!==null?Math.max(new Date(s.expire).getTime()-Date.now(),0):-1,i}_upsert(e,t,n,i=!1,s={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const o=s.attrs||{};let a,c;i?(a={key:e},a=Object.assign(a,o),c={$set:{key:e,points:t,expire:n>0?new Date(Date.now()+n):null}},c.$set=Object.assign(c.$set,o)):(a={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},a=Object.assign(a,o),c={$setOnInsert:{key:e,expire:n>0?new Date(Date.now()+n):null},$inc:{points:t}},c.$setOnInsert=Object.assign(c.$setOnInsert,o));const u={upsert:!0};return this._driverVersion.major>=4||this._driverVersion.major===3&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?u.returnDocument="after":u.returnOriginal=!1,new Promise((l,h)=>{this._collection.findOneAndUpdate(a,c,u).then(p=>{l(p)}).catch(p=>{if(p&&p.code===11e3){const g=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},o),f={$set:Object.assign({key:e,points:t,expire:n>0?new Date(Date.now()+n):null},o)};this._collection.findOneAndUpdate(g,f,u).then(d=>{l(d)}).catch(d=>{d&&d.code===11e3?this._upsert(e,t,n,i).then(m=>l(m)).catch(m=>h(m)):h(d)})}else h(p)})})}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},i=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},n);return this._collection.findOne(i)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},i=Object.assign({key:e},n);return this._collection.deleteOne(i).then(s=>s.deletedCount>0)}};var mD=pD;const yD=As,gD=er;let bD=class extends yD{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createDbAndTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{this._getConnection().then(n=>{n.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],()=>{this._releaseConnection(n),t()})}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise((e,t)=>{this.client.getConnection((n,i)=>{if(n)return t(n);e(i)})});case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise((e,t)=>{this._getConnection().then(n=>{n.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,i=>{if(i)return this._releaseConnection(n),t(i);n.query(this._getCreateTableStmt(),s=>{if(s)return this._releaseConnection(n),t(s);this._releaseConnection(n),e()})})}).catch(n=>{t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(typeof e>"u")if(this.client.constructor.name==="Connection")e="connection";else if(this.client.constructor.name==="Pool")e="pool";else if(this.client.constructor.name==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){const i=new gD,[s]=n;return i.isFirstInDuration=t===s.points,i.consumedPoints=i.isFirstInDuration?t:s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire?Math.max(s.expire-Date.now(),0):-1,i}_upsertTransaction(e,t,n,i,s){return new Promise((o,a)=>{e.query("BEGIN",c=>{if(c)return e.rollback(),a(c);const u=Date.now(),l=i>0?u+i:null;let h,p;s?(h=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = ?, 
            expire = ?;`,p=[this.dbName,this.tableName,t,n,l,n,l]):(h=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = IF(expire <= ?, ?, points + (?)), 
            expire = IF(expire <= ?, ?, expire);`,p=[this.dbName,this.tableName,t,n,l,u,n,n,u,l]),e.query(h,p,g=>{if(g)return e.rollback(),a(g);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],(f,d)=>{if(f)return e.rollback(),a(f);e.query("COMMIT",m=>{if(m)return e.rollback(),a(m);o(d)})})})})})}_upsert(e,t,n,i=!1){return this.tableCreated?new Promise((s,o)=>{this._getConnection().then(a=>{this._upsertTransaction(a,e,t,n,i).then(c=>{s(c),this._releaseConnection(a)}).catch(c=>{o(c),this._releaseConnection(a)})}).catch(a=>{o(a)})}):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(i=>{i.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],(s,o)=>{s?n(s):o.length===0?t(null):t(o),this._releaseConnection(i)})}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(i=>{i.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],(s,o)=>{s?n(s):t(o.affectedRows>0),this._releaseConnection(i)})}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}};var ED=bD;const wD=As,xD=er;let vD=class extends wD{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.schemaName=e.schemaName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}_getTableIdentifier(){return this.schemaName?`"${this.schemaName}"."${this.tableName}"`:`"${this.tableName}"`}clearExpired(e){return new Promise(t=>{const n={name:"rlflx-clear-expired",text:`DELETE FROM ${this._getTableIdentifier()} WHERE expire < $1`,values:[e]};this._query(n).then(()=>{t()}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master);default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);case"typeorm":return!0;default:return!0}}_createTable(){return new Promise((e,t)=>{this._query({text:this._getCreateTableStmt()}).then(()=>{e()}).catch(n=>{n.code==="23505"?e():t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this._getTableIdentifier()} (
      key varchar(255) PRIMARY KEY,
      points integer NOT NULL DEFAULT 0,
      expire bigint
    );`}get clientType(){return this._clientType}set clientType(e){const t=this.client.constructor.name;if(typeof e>"u")if(t==="Client")e="client";else if(t==="Pool"||t==="BoundPool")e="pool";else if(t==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get schemaName(){return this._schemaName}set schemaName(e){this._schemaName=e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){const i=new xD,s=n.rows[0];return i.isFirstInDuration=t===s.points,i.consumedPoints=i.isFirstInDuration?t:s.points,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=s.expire?Math.max(s.expire-Date.now(),0):-1,i}_query(e){const n={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise((i,s)=>{this._getConnection().then(o=>{o.query(n).then(a=>{i(a),this._releaseConnection(o)}).catch(a=>{s(a),this._releaseConnection(o)})}).catch(o=>{s(o)})})}_upsert(e,t,n,i=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));const s=n>0?Date.now()+n:null,o=i?" $3 ":` CASE
             WHEN ${this._getTableIdentifier()}.expire <= $4 THEN $3
             ELSE ${this._getTableIdentifier()}.expire
            END `;return this._query({name:i?"rlflx-upsert-force":"rlflx-upsert",text:`
            INSERT INTO ${this._getTableIdentifier()} VALUES ($1, $2, $3)
              ON CONFLICT(key) DO UPDATE SET
                points = CASE
                          WHEN (${this._getTableIdentifier()}.expire <= $4 OR 1=${i?1:0}) THEN $2
                          ELSE ${this._getTableIdentifier()}.points + ($2)
                         END,
                expire = ${o}
            RETURNING points, expire;`,values:[e,t,s,Date.now()]})}_get(e){return this.tableCreated?new Promise((t,n)=>{this._query({name:"rlflx-get",text:`
            SELECT points, expire FROM ${this._getTableIdentifier()} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then(i=>{i.rowCount===0&&(i=null),t(i)}).catch(i=>{n(i)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this._getTableIdentifier()} WHERE key = $1`,values:[e]}).then(t=>t.rowCount>0):Promise.reject(Error("Table is not created yet"))}};var _D=vD,SD=class{constructor(e,t,n=null){this.value=e,this.expiresAt=t,this.timeoutId=n}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){!(e instanceof Date)&&Number.isInteger(e)&&(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}};const AD=SD,Za=er;var RD=class{constructor(){this._storage={}}incrby(e,t,n){if(this._storage[e]){const i=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return i!==0?(this._storage[e].value=this._storage[e].value+t,new Za(0,i,this._storage[e].value,!1)):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const i=n*1e3;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new AD(t,i>0?new Date(Date.now()+i):null),i>0&&(this._storage[e].timeoutId=setTimeout(()=>{delete this._storage[e]},i),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new Za(0,i===0?-1:i,this._storage[e].value,!0)}get(e){if(this._storage[e]){const t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return new Za(0,t,this._storage[e].value,!1)}return null}delete(e){return this._storage[e]?(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0):!1}};const ID=da,CD=RD,Uf=er;let DD=class extends ID{constructor(e={}){super(e),this._memoryStorage=new CD}consume(e,t=1,n={}){return new Promise((i,s)=>{const o=this.getKey(e),a=this._getKeySecDuration(n);let c=this._memoryStorage.incrby(o,t,a);if(c.remainingPoints=Math.max(this.points-c.consumedPoints,0),c.consumedPoints>this.points)this.blockDuration>0&&c.consumedPoints<=this.points+t&&(c=this._memoryStorage.set(o,c.consumedPoints,this.blockDuration)),s(c);else if(this.execEvenly&&c.msBeforeNext>0&&!c.isFirstInDuration){let u=Math.ceil(c.msBeforeNext/(c.remainingPoints+2));u<this.execEvenlyMinDelayMs&&(u=c.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(i,u,c)}else i(c)})}penalty(e,t=1,n={}){const i=this.getKey(e);return new Promise(s=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(i,t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),s(a)})}reward(e,t=1,n={}){const i=this.getKey(e);return new Promise(s=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(i,-t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),s(a)})}block(e,t){const n=t*1e3,i=this.points+1;return this._memoryStorage.set(this.getKey(e),i,t),Promise.resolve(new Uf(0,n===0?-1:n,i))}set(e,t,n){const i=(n>=0?n:this.duration)*1e3;return this._memoryStorage.set(this.getKey(e),t,n),Promise.resolve(new Uf(0,i===0?-1:i,t))}get(e){const t=this._memoryStorage.get(this.getKey(e));return t!==null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};var rm=DD;const $f=Kn,TD=Kn,LD=da,nm=rm,kD=er,Yt="rate_limiter_flexible";let si=null;const Ff=function(r,e,t,n){let i;n===null||n===!0||n===!1?i=n:i={remainingPoints:n.remainingPoints,msBeforeNext:n.msBeforeNext,consumedPoints:n.consumedPoints,isFirstInDuration:n.isFirstInDuration},r.send({channel:Yt,keyPrefix:e.keyPrefix,promiseId:e.promiseId,type:t,data:i})},im=function(r){setTimeout(()=>{this._initiated?process.send(r):typeof this._promises[r.promiseId]<"u"&&im.call(this,r)},30)},Yn=function(r,e,t,n,i){const s={channel:Yt,keyPrefix:this.keyPrefix,func:r,promiseId:e,data:{key:t,arg:n,opts:i}};this._initiated?process.send(s):im.call(this,s)},sm=function(r,e){if(!e||e.channel!==Yt||typeof this._rateLimiters[e.keyPrefix]>"u")return!1;let t;switch(e.func){case"consume":t=this._rateLimiters[e.keyPrefix].consume(e.data.key,e.data.arg,e.data.opts);break;case"penalty":t=this._rateLimiters[e.keyPrefix].penalty(e.data.key,e.data.arg,e.data.opts);break;case"reward":t=this._rateLimiters[e.keyPrefix].reward(e.data.key,e.data.arg,e.data.opts);break;case"block":t=this._rateLimiters[e.keyPrefix].block(e.data.key,e.data.arg,e.data.opts);break;case"get":t=this._rateLimiters[e.keyPrefix].get(e.data.key,e.data.opts);break;case"delete":t=this._rateLimiters[e.keyPrefix].delete(e.data.key,e.data.opts);break;default:return!1}t&&t.then(n=>{Ff(r,e,"resolve",n)}).catch(n=>{Ff(r,e,"reject",n)})},PD=function(r){if(!r||r.channel!==Yt||r.keyPrefix!==this.keyPrefix)return!1;if(this._promises[r.promiseId]){clearTimeout(this._promises[r.promiseId].timeoutId);let e;switch(r.data===null||r.data===!0||r.data===!1?e=r.data:e=new kD(r.data.remainingPoints,r.data.msBeforeNext,r.data.consumedPoints,r.data.isFirstInDuration),r.type){case"resolve":this._promises[r.promiseId].resolve(e);break;case"reject":this._promises[r.promiseId].reject(e);break;default:throw new Error(`RateLimiterCluster: no such message type '${r.type}'`)}delete this._promises[r.promiseId]}},ND=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},Qn=function(r,e){const t=process.hrtime();let n=t[0].toString()+t[1].toString();return typeof this._promises[n]<"u"&&(n+=TD.randomBytes(12).toString("base64")),this._promises[n]={resolve:r,reject:e,timeoutId:setTimeout(()=>{delete this._promises[n],e(new Error("RateLimiterCluster timeout: no answer from master in time"))},this.timeoutMs)},n};let BD=class{constructor(){if(si)return si;this._rateLimiters={},$f.setMaxListeners(0),$f.on("message",(e,t)=>{t&&t.channel===Yt&&t.type==="init"?(typeof this._rateLimiters[t.opts.keyPrefix]>"u"&&(this._rateLimiters[t.opts.keyPrefix]=new nm(t.opts)),e.send({channel:Yt,type:"init",keyPrefix:t.opts.keyPrefix})):sm.call(this,e,t)}),si=this}},OD=class{constructor(e){if(si)return si;this._rateLimiters={},e.launchBus((t,n)=>{n.on("process:msg",i=>{const s=i.raw;if(s&&s.channel===Yt&&s.type==="init")typeof this._rateLimiters[s.opts.keyPrefix]>"u"&&(this._rateLimiters[s.opts.keyPrefix]=new nm(s.opts)),e.sendDataToProcessId(i.process.pm_id,{data:{},topic:Yt,channel:Yt,type:"init",keyPrefix:s.opts.keyPrefix},(o,a)=>{o&&console.log(o,a)});else{const o={send:a=>{const c=a;c.topic=Yt,typeof c.data>"u"&&(c.data={}),e.sendDataToProcessId(i.process.pm_id,c,(u,l)=>{u&&console.log(u,l)})}};sm.call(this,o,s)}})}),si=this}};class MD extends LD{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=typeof e>"u"?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),process.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,process.on("message",t=>{t&&t.channel===Yt&&t.type==="init"&&t.keyPrefix===this.keyPrefix?this._initiated=!0:PD.call(this,t)}),process.send({channel:Yt,type:"init",opts:ND.call(this)}),this._promises={}}consume(e,t=1,n={}){return new Promise((i,s)=>{const o=Qn.call(this,i,s);Yn.call(this,"consume",o,e,t,n)})}penalty(e,t=1,n={}){return new Promise((i,s)=>{const o=Qn.call(this,i,s);Yn.call(this,"penalty",o,e,t,n)})}reward(e,t=1,n={}){return new Promise((i,s)=>{const o=Qn.call(this,i,s);Yn.call(this,"reward",o,e,t,n)})}block(e,t,n={}){return new Promise((i,s)=>{const o=Qn.call(this,i,s);Yn.call(this,"block",o,e,t,n)})}get(e,t={}){return new Promise((n,i)=>{const s=Qn.call(this,n,i);Yn.call(this,"get",s,e,t)})}delete(e,t={}){return new Promise((n,i)=>{const s=Qn.call(this,n,i);Yn.call(this,"delete",s,e,t)})}}var UD={RateLimiterClusterMaster:BD,RateLimiterClusterMasterPM2:OD,RateLimiterCluster:MD};const $D=As,FD=er;let KD=class extends $D{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,n){const i=new FD;return i.consumedPoints=parseInt(n.consumedPoints),i.isFirstInDuration=n.consumedPoints===t,i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.msBeforeNext=n.msBeforeNext,i}_upsert(e,t,n,i=!1,s={}){return new Promise((o,a)=>{const c=Date.now(),u=Math.floor(n/1e3);i?this.client.set(e,t,u,l=>{l?a(l):this.client.set(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const h={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(h)})}):this.client.incr(e,t,(l,h)=>{l||h===!1?this.client.add(e,t,u,(p,g)=>{if(p||!g)if(typeof s.attemptNumber>"u"||s.attemptNumber<3){const f=Object.assign({},s);f.attemptNumber=f.attemptNumber?f.attemptNumber+1:1,this._upsert(e,t,n,i,f).then(d=>o(d)).catch(d=>a(d))}else a(new Error("Can not add key"));else this.client.add(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const f={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(f)})}):this.client.get(`${e}_expire`,(p,g)=>{if(p)a(p);else{const f=g===!1?0:g,d={consumedPoints:h,msBeforeNext:f>=0?Math.max(f-c,0):-1};o(d)}})})})}_get(e){return new Promise((t,n)=>{const i=Date.now();this.client.get(e,(s,o)=>{o?this.client.get(`${e}_expire`,(a,c)=>{if(a)n(a);else{const u=c===!1?0:c,l={consumedPoints:o,msBeforeNext:u>=0?Math.max(u-i,0):-1};t(l)}}):t(null)})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(i,s)=>{i?n(i):s===!1?t(s):this.client.del(`${e}_expire`,o=>{o?n(o):t(s)})})})}};var VD=KD;const Kf=er;var zD=class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(typeof e>"u")throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=typeof e>"u"?!1:e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new Kf(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new Kf(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.rejectBlack()),typeof n>"u"?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch(()=>{}),n)}block(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch(()=>{}),n)}penalty(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch(()=>{}),n)}reward(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch(()=>{}),n)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),typeof t>"u"||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}};const qD=da;var HD=class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach(t=>{if(!(t instanceof qD))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")}),this._limiters=e}consume(e,t=1){return new Promise((n,i)=>{const s=[];this._limiters.forEach(o=>{s.push(o.consume(e,t).catch(a=>({rejected:!0,rej:a})))}),Promise.all(s).then(o=>{const a={};let c=!1;o.forEach(u=>{u.rejected===!0&&(c=!0)});for(let u=0;u<o.length;u++)c&&o[u].rejected===!0?a[this._limiters[u].keyPrefix]=o[u].rej:c||(a[this._limiters[u].keyPrefix]=o[u]);c?i(a):n(a)})})}},WD=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}};const Vf=WD,om=4294967295,Xc="limiter";var GD=class{constructor(e,t={maxQueueSize:om}){this._queueLimiters={KEY_DEFAULT:new zf(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=Xc){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=Xc){return this._queueLimiters[t]||(this._queueLimiters[t]=new zf(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}};class zf{constructor(e,t={maxQueueSize:om,key:Xc}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then(e=>e!==null?e.remainingPoints:this._limiterFlexible.points)}removeTokens(e){const t=this;return new Promise((n,i)=>{if(e>t._limiterFlexible.points){i(new Vf(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`));return}t._queue.length>0?t._queueRequest.call(t,n,i,e):t._limiterFlexible.consume(t._key,e).then(s=>{n(s.remainingPoints)}).catch(s=>{s instanceof Error?i(s):(t._queueRequest.call(t,n,i,e),t._waitTimeout===null&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),s.msBeforeNext)))})})}_queueRequest(e,t,n){const i=this;i._queue.length<i._maxQueueSize?i._queue.push({resolve:e,reject:t,tokens:n}):t(new Vf(`Number of requests reached it's maximum ${i._maxQueueSize}`))}_processFIFO(){const e=this;if(e._waitTimeout!==null&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),e._queue.length===0)return;const t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then(n=>{t.resolve(n.remainingPoints),e._processFIFO.call(e)}).catch(n=>{n instanceof Error?(t.reject(n),e._processFIFO.call(e)):(e._queue.unshift(t),e._waitTimeout===null&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),n.msBeforeNext)))})}}const ja=er;var YD=class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return e?new ja(e.remainingPoints,Math.min(e.msBeforeNext,t?t.msBeforeNext:0),e.consumedPoints,e.isFirstInDuration):null}consume(e,t=1,n={}){return this._rateLimiter.consume(e,t,n).catch(i=>i instanceof ja?this._burstLimiter.consume(e,t,n).then(s=>Promise.resolve(this._combineRes(i,s))).catch(s=>s instanceof ja?Promise.reject(this._combineRes(i,s)):Promise.reject(s)):Promise.reject(i))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then(([t,n])=>this._combineRes(t,n))}get points(){return this._rateLimiter.points}};const QD=hD,XD=mD,ZD=ED,jD=_D,{RateLimiterClusterMaster:JD,RateLimiterClusterMasterPM2:e3,RateLimiterCluster:t3}=UD,r3=rm,n3=VD,i3=zD,s3=HD,o3=GD,a3=YD,c3=er;var u3={RateLimiterRedis:QD,RateLimiterMongo:XD,RateLimiterMySQL:ZD,RateLimiterPostgres:jD,RateLimiterMemory:r3,RateLimiterMemcache:n3,RateLimiterClusterMaster:JD,RateLimiterClusterMasterPM2:e3,RateLimiterCluster:t3,RLWrapperBlackAndWhite:i3,RateLimiterUnion:s3,RateLimiterQueue:o3,BurstyRateLimiter:a3,RateLimiterRes:c3};const l3=ue("libp2p:get-peer");function am(r){if(xd(r))return{peerId:r,multiaddrs:[]};Array.isArray(r)||(r=[r]);let e;if(r.length>0){const t=r[0].getPeerId();e=t==null?void 0:je(t),r.forEach(n=>{if(!Oo(n))throw l3.error("multiaddr %s was invalid",n),new I("Invalid Multiaddr",H.ERR_INVALID_MULTIADDR);const i=n.getPeerId();if(i==null){if(e!=null)throw new I("Multiaddrs must all have the same peer id or have no peer id",H.ERR_INVALID_PARAMETERS)}else{const s=je(i);if(e==null||!e.equals(s))throw new I("Multiaddrs must all have the same peer id or have no peer id",H.ERR_INVALID_PARAMETERS)}})}return{peerId:e,multiaddrs:r}}function h3(r,e,t){let n=0,i=r.length;for(;i>0;){const s=Math.trunc(i/2);let o=n+s;t(r[o],e)<=0?(n=++o,i-=s+1):i=s}return n}class f3{#e=[];enqueue(e,t){const n=t?.peerId,i=t?.priority??0;if(n==null)throw new I("missing peer id",H.ERR_INVALID_PARAMETERS);const s={priority:i,peerId:n,run:e};if(this.size>0&&this.#e[this.size-1].priority>=i){this.#e.push(s);return}const o=h3(this.#e,s,(a,c)=>c.priority-a.priority);this.#e.splice(o,0,s)}dequeue(){return this.#e.shift()?.run}filter(e){if(e.peerId!=null){const t=e.peerId;return this.#e.filter(n=>t.equals(n.peerId)).map(n=>n.run)}return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}}class cm extends hs{constructor(e={}){super({...e,queueClass:f3})}hasJob(e){return this.sizeBy({peerId:e})>0}}const um=3e4,d3=3e4,lm=25,hm=1,p3=5e3,fm=25,dm=0,pm=100,m3=10,y3=5,g3=10,mm="last-dial-failure",ym=5,Co=100,gm=50,b3=1e3*60*7,Ye=ue("libp2p:connection-manager:auto-dial"),wn={minConnections:ym,maxQueueLength:pm,autoDialConcurrency:fm,autoDialPriority:dm,autoDialInterval:p3,autoDialPeerRetryThreshold:b3,autoDialDiscoveredPeersDebounce:m3};class E3{connectionManager;peerStore;queue;minConnections;autoDialPriority;autoDialIntervalMs;autoDialMaxQueueLength;autoDialPeerRetryThresholdMs;autoDialDiscoveredPeersDebounce;autoDialInterval;started;running;constructor(e,t){this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??wn.minConnections,this.autoDialPriority=t.autoDialPriority??wn.autoDialPriority,this.autoDialIntervalMs=t.autoDialInterval??wn.autoDialInterval,this.autoDialMaxQueueLength=t.maxQueueLength??wn.maxQueueLength,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??wn.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??wn.autoDialDiscoveredPeersDebounce,this.started=!1,this.running=!1,this.queue=new cm({concurrency:t.autoDialConcurrency??wn.autoDialConcurrency}),this.queue.addListener("error",i=>{Ye.error("error during auto-dial",i)}),e.events.addEventListener("connection:close",()=>{this.autoDial().catch(i=>{Ye.error(i)})});let n;e.events.addEventListener("peer:discovery",()=>{clearTimeout(n),n=setTimeout(()=>{this.autoDial().catch(i=>{Ye.error(i)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(e=>{Ye.error("error while autodialing",e)})},this.autoDialIntervalMs),this.started=!0}afterStart(){this.autoDial().catch(e=>{Ye.error("error while autodialing",e)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started)return;const e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections){this.minConnections>0&&Ye.trace("have enough connections %d/%d",t,this.minConnections);return}if(this.queue.size>this.autoDialMaxQueueLength){Ye("not enough connections %d/%d but auto dial queue is full",t,this.minConnections);return}if(this.running){Ye("not enough connections %d/%d - but skipping autodial as it is already running",t,this.minConnections);return}this.running=!0,Ye("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);const n=new ii(this.connectionManager.getDialQueue().map(u=>u.peerId).filter(Boolean)),i=await this.peerStore.all({filters:[u=>u.addresses.length===0?(Ye.trace("not autodialing %p because they have no addresses",u.id),!1):e.has(u.id)?(Ye.trace("not autodialing %p because they are already connected",u.id),!1):n.has(u.id)?(Ye.trace("not autodialing %p because they are already being dialed",u.id),!1):this.queue.hasJob(u.id)?(Ye.trace("not autodialing %p because they are already being autodialed",u.id),!1):!0]}),s=i.sort(()=>Math.random()>.5?1:-1),o=new Di;for(const u of s)o.has(u.id)||o.set(u.id,[...u.tags.values()].reduce((l,h)=>l+h.value,0));const c=s.sort((u,l)=>{const h=o.get(u.id)??0,p=o.get(l.id)??0;return h>p?-1:h<p?1:0}).filter(u=>{const l=u.metadata.get(mm);if(l==null)return!0;const h=parseInt(ie(l));return isNaN(h)?!0:Date.now()-h>this.autoDialPeerRetryThresholdMs});Ye("selected %d/%d peers to dial",c.length,i.length);for(const u of c)this.queue.add(async()=>{const l=this.connectionManager.getConnectionsMap().size;if(l>=this.minConnections){Ye("got enough connections now %d/%d",l,this.minConnections),this.queue.clear();return}Ye("connecting to a peerStore stored peer %p",u.id),await this.connectionManager.openConnection(u.id,{priority:this.autoDialPriority})},{peerId:u.id}).catch(l=>{Ye.error("could not connect to peerStore stored peer",l)});this.running=!1,this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(u=>{Ye.error("error while autodialing",u)})},this.autoDialIntervalMs))}}const Xn=ue("libp2p:connection-manager:connection-pruner"),qf={maxConnections:Co,allow:[]};class w3{maxConnections;connectionManager;peerStore;allow;events;constructor(e,t={}){this.maxConnections=t.maxConnections??qf.maxConnections,this.allow=t.allow??qf.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,e.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(n=>{Xn.error(n)})})}async maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=Math.max(t-this.maxConnections,0);if(Xn("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;Xn("max connections limit exceeded %d/%d, pruning %d connection(s)",t,this.maxConnections,n);const i=new Di;for(const a of e){const c=a.remotePeer;if(!i.has(c)){i.set(c,0);try{const u=await this.peerStore.get(c);i.set(c,[...u.tags.values()].reduce((l,h)=>l+h.value,0))}catch(u){u.code!=="ERR_NOT_FOUND"&&Xn.error("error loading peer tags",u)}}}const s=e.sort((a,c)=>{const u=i.get(a.remotePeer)??0,l=i.get(c.remotePeer)??0;if(u>l)return 1;if(u<l)return-1;const h=a.timeline.open,p=c.timeline.open;return h<p?1:h>p?-1:0}),o=[];for(const a of s)if(Xn("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(u=>a.remoteAddr.toString().startsWith(u.toString()))||o.push(a),o.length===n)break;await Promise.all(o.map(async a=>{try{await a.close()}catch(c){Xn.error(c)}})),this.events.safeDispatchEvent("connection:prune",{detail:o})}}const bm=ue("libp2p:connection-manager:utils");async function Em(r,e){if(!r.protoNames().includes("dnsaddr"))return[r];const n=await x3(r,e),o=(await Promise.all(n.map(async a=>Em(a,e)))).flat().reduce((a,c)=>(a.find(u=>u.equals(c))==null&&a.push(c),a),[]);return bm("resolved %s to",r,o.map(a=>a.toString())),o}async function x3(r,e){try{return r=ge(r.toString()),await r.resolve(e)}catch(t){return bm.error(`multiaddr ${r.toString()} could not be resolved`,t),[]}}function v3(...r){const e=[];for(const n of r)if(n!=null){try{wr.setMaxListeners?.(1/0,n)}catch{}e.push(n)}const t=bs(e);try{wr.setMaxListeners?.(1/0,t)}catch{}return t}const st=ue("libp2p:connection-manager:dial-queue"),Ui={addressSorter:Hu,maxParallelDials:gm,maxPeerAddrsToDial:lm,maxParallelDialsPerPeer:hm,dialTimeout:um,resolvers:{dnsaddr:Wu}};class _3{pendingDials;queue;peerId;peerStore;connectionGater;transportManager;addressSorter;maxPeerAddrsToDial;maxParallelDialsPerPeer;dialTimeout;inProgressDialCount;pendingDialCount;shutDownController;constructor(e,t={}){this.addressSorter=t.addressSorter??Ui.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Ui.maxPeerAddrsToDial,this.maxParallelDialsPerPeer=t.maxParallelDialsPerPeer??Ui.maxParallelDialsPerPeer,this.dialTimeout=t.dialTimeout??Ui.dialTimeout,this.peerId=e.peerId,this.peerStore=e.peerStore,this.connectionGater=e.connectionGater,this.transportManager=e.transportManager,this.shutDownController=new AbortController;try{wr.setMaxListeners?.(1/0,this.shutDownController.signal)}catch{}this.pendingDialCount=e.metrics?.registerMetric("libp2p_dialler_pending_dials"),this.inProgressDialCount=e.metrics?.registerMetric("libp2p_dialler_in_progress_dials"),this.pendingDials=[];for(const[n,i]of Object.entries(t.resolvers??{}))dd.set(n,i);this.queue=new hs({concurrency:t.maxParallelDials??Ui.maxParallelDials}),this.queue.on("add",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("active",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("completed",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("error",n=>{st.error("error in dial queue",n),this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("empty",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("idle",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)})}stop(){this.shutDownController.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:i}=am(e),s=i.map(l=>({multiaddr:l,isCertified:!1})),o=this.createDialAbortControllers(t.signal);let a;try{a=await this.calculateMultiaddrs(n,s,{...t,signal:o})}catch(l){throw o.clear(),l}const c=this.pendingDials.find(l=>!!(l.peerId!=null&&n!=null&&l.peerId.equals(n)||a.map(({multiaddr:h})=>h.toString()).join()===l.multiaddrs.map(h=>h.toString()).join()));if(c!=null)return st("joining existing dial target for %p",n),o.clear(),c.promise;st("creating dial target for",a.map(({multiaddr:l})=>l.toString()));const u={id:S3(),status:"queued",peerId:n,multiaddrs:a.map(({multiaddr:l})=>l)};return u.promise=this.performDial(u,{...t,signal:o}).finally(()=>{this.pendingDials=this.pendingDials.filter(l=>l.id!==u.id),o.clear()}).catch(async l=>{if(st.error("dial failed to %s",u.multiaddrs.map(h=>h.toString()).join(", "),l),n!=null)try{await this.peerStore.patch(n,{metadata:{[mm]:re(Date.now().toString())}})}catch(h){st.error("could not update last dial failure key for %p",n,h)}throw o.aborted?new I(l.message,H.ERR_TIMEOUT):l}),this.pendingDials.push(u),u.promise}createDialAbortControllers(e){const t=bs([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);try{wr.setMaxListeners?.(1/0,t)}catch{}return t}async calculateMultiaddrs(e,t=[],n={}){if(e!=null){if(this.peerId.equals(e))throw new I("Tried to dial self",H.ERR_DIALED_SELF);if(await this.connectionGater.denyDialPeer?.(e)===!0)throw new I("The dial request is blocked by gater.allowDialPeer",H.ERR_PEER_DIAL_INTERCEPTED);if(t.length===0){st("loading multiaddrs for %p",e);try{const l=await this.peerStore.get(e);t.push(...l.addresses),st("loaded multiaddrs for %p",e,t.map(({multiaddr:h})=>h.toString()))}catch(l){if(l.code!==H.ERR_NOT_FOUND)throw l}}}const i=(await Promise.all(t.map(async l=>{const h=await Em(l.multiaddr,n);return h.length===1&&h[0].equals(l.multiaddr)?l:h.map(p=>({multiaddr:p,isCertified:!1}))}))).flat(),s=i.filter(l=>{if(this.transportManager.transportForMultiaddr(l.multiaddr)==null)return!1;const h=l.multiaddr.getPeerId();return e!=null&&h!=null?e.equals(h):!0}),o=new Map;for(const l of s){const h=l.multiaddr.toString(),p=o.get(h);if(p!=null){p.isCertified=p.isCertified||l.isCertified||!1;continue}o.set(h,l)}let a=[...o.values()];if((a.length===0||a.length>this.maxPeerAddrsToDial)&&(st("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:l})=>l.toString())),st("addresses for %p after filtering",e??"unknown peer",a.map(({multiaddr:l})=>l.toString()))),a.length===0)throw new I("The dial request has no valid addresses",H.ERR_NO_VALID_ADDRESSES);if(a.length>this.maxPeerAddrsToDial)throw new I("dial with more addresses than allowed",H.ERR_TOO_MANY_ADDRESSES);if(e!=null){const l=`/p2p/${e.toString()}`;a=a.map(h=>{const p=h.multiaddr.getPeerId();return h.multiaddr.protos().pop()?.path===!0?h:p!==e.toString()?{multiaddr:h.multiaddr.encapsulate(l),isCertified:h.isCertified}:h})}const c=[];for(const l of a)this.connectionGater.denyDialMultiaddr!=null&&await this.connectionGater.denyDialMultiaddr(l.multiaddr)||c.push(l);const u=c.sort(this.addressSorter);if(u.length===0)throw new I("The connection gater denied all addresses in the dial request",H.ERR_NO_VALID_ADDRESSES);return u}async performDial(e,t={}){const n=e.multiaddrs.map(()=>new AbortController);try{const i=new hs({concurrency:this.maxParallelDialsPerPeer});i.on("error",o=>{st.error("error dialling",o)});const s=await Promise.any(e.multiaddrs.map(async(o,a)=>{const c=n[a];if(c==null)throw new I("dialAction did not come with an AbortController",H.ERR_INVALID_PARAMETERS);const u=v3(c.signal,t.signal);u.addEventListener("abort",()=>{st("dial to %a aborted",o)});const l=At();return await i.add(async()=>{if(u.aborted){st("dial to %a was aborted before reaching the head of the peer dial queue",o),l.reject(new ma);return}await this.queue.add(async()=>{try{if(u.aborted){st("dial to %a was aborted before reaching the head of the dial queue",o),l.reject(new ma);return}e.status="active";const h=await this.transportManager.dial(o,{...t,signal:u});if(c.signal.aborted){st("multiple dials succeeded, closing superfluous connection"),h.close().catch(p=>{st.error("error closing superfluous connection",p)}),l.reject(new ma);return}n[a]=void 0,n.forEach(p=>{p!==void 0&&p.abort()}),st("dial to %a succeeded",o),l.resolve(h)}catch(h){st.error("error during dial of %a",o,h),l.reject(h)}},{...t,signal:u}).catch(h=>{l.reject(h)})},{signal:u}).catch(h=>{l.reject(h)}).finally(()=>{u.clear()}),l.promise}));if(s==null)throw new I("successful dial led to empty object returned from peer dial queue",H.ERR_TRANSPORT_DIAL_FAILED);return e.status="success",s}catch(i){throw e.status="error",e.multiaddrs.length===1&&i.name==="AggregateError"?i.errors[0]:i}}}function S3(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}const Tt=ue("libp2p:connection-manager"),A3=50,xn={minConnections:ym,maxConnections:Co,inboundConnectionThreshold:y3,maxIncomingPendingConnections:g3,autoDialConcurrency:fm,autoDialPriority:dm,autoDialMaxQueueLength:pm};class R3{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;maxConnections;dialQueue;autoDial;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;constructor(e,t={}){this.maxConnections=t.maxConnections??xn.maxConnections;const n=t.minConnections??xn.minConnections;if(this.maxConnections<n)throw new I("Connection Manager maxConnections must be greater than minConnections",H.ERR_INVALID_PARAMETERS);this.connections=new Di,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map(i=>ge(i)),this.deny=(t.deny??[]).map(i=>ge(i)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??xn.maxIncomingPendingConnections,this.inboundConnectionRateLimiter=new u3.RateLimiterMemory({points:t.inboundConnectionThreshold??xn.inboundConnectionThreshold,duration:1}),this.autoDial=new E3({connectionManager:this,peerStore:e.peerStore,events:e.events},{minConnections:n,autoDialConcurrency:t.autoDialConcurrency??xn.autoDialConcurrency,autoDialPriority:t.autoDialPriority??xn.autoDialPriority,maxQueueLength:t.autoDialMaxQueueLength??xn.autoDialMaxQueueLength}),this.connectionPruner=new w3({connectionManager:this,peerStore:e.peerStore,events:e.events},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new _3({peerId:e.peerId,metrics:e.metrics,peerStore:e.peerStore,transportManager:e.transportManager,connectionGater:e.connectionGater},{addressSorter:t.addressSorter??Hu,maxParallelDials:t.maxParallelDials??gm,maxPeerAddrsToDial:t.maxPeerAddrsToDial??lm,maxParallelDialsPerPeer:t.maxParallelDialsPerPeer??hm,dialTimeout:t.dialTimeout??um,resolvers:t.resolvers??{dnsaddr:Wu}})}isStarted(){return this.started}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)n.direction==="inbound"?e.inbound++:e.outbound++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const i of n.streams){const s=`${i.direction} ${i.protocol??"unnegotiated"}`;e[s]=(e[s]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const i of n){const s={};for(const o of i.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;s[a]=(s[a]??0)+1}for(const[o,a]of Object.entries(s))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,i]of Object.entries(e)){i=i.sort((o,a)=>o-a);const s=Math.floor(i.length*.9);t[n]=i[s]}return t}}),this.autoDial.start(),this.started=!0,Tt("started")}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(nD)]});await Promise.all(e.map(async t=>{await this.openConnection(t.id).catch(n=>{Tt.error(n)})}))}).catch(e=>{Tt.error(e)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(i){Tt.error(i)}})());Tt("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),Tt("stopped")}onConnect(e){this._onConnect(e).catch(t=>{Tt.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}const n=t.remotePeer,i=this.connections.get(n);let s=!1;i!=null?i.push(t):(s=!0,this.connections.set(n,[t])),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer;let i=this.connections.get(n);i!=null&&i.length>1?(i=i.filter(s=>s.id!==t.id),this.connections.set(n,i)):i!=null&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.isStarted())throw new I("Not started",H.ERR_NODE_NOT_STARTED);t.signal?.throwIfAborted();const{peerId:n}=am(e);if(n!=null&&t.force!==!0){Tt("dial %p",n);const a=this.getConnections(n);if(a.length>0)return Tt("had an existing connection to %p",n),a[0]}const i=await this.dialQueue.dial(e,{...t,priority:t.priority??A3});let s=this.connections.get(i.remotePeer);s==null&&(s=[],this.connections.set(i.remotePeer,s));let o=!1;for(const a of s)a.id===i.id&&(o=!0);return o||s.push(i),i}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async i=>{try{await i.close(t)}catch(s){i.abort(s)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>e.remoteAddr.toString().startsWith(i.toString())))return Tt("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>e.remoteAddr.toString().startsWith(i.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return Tt("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return Tt("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(Tt("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){return this.dialQueue.pendingDials}}function I3(r){return r[Symbol.asyncIterator]!=null}function C3(r,e){if(I3(r))return async function*(){for await(const a of r)yield e(a)}();const t=Xp(r),{value:n,done:i}=t.next();if(i===!0)return function*(){}();const s=e(n);if(typeof s.then=="function")return async function*(){yield await s;for await(const a of t)yield e(a)}();const o=e;return function*(){yield s;for(const a of t)yield o(a)}()}async function*Zc(r,e){yield*C3(r,async t=>(await e.merge(t.id,{multiaddrs:t.multiaddrs}),t))}function wm(r){const e=new Set;return Xr(r,t=>e.has(t.id.toString())?!1:(e.add(t.id.toString()),!0))}async function*xm(r,e=1){let t=0;for await(const n of r)t++,yield n;if(t<e)throw new I(`more peers required, seen: ${t}  min: ${e}`,"NOT_FOUND")}class D3{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new I("No content routers available",H.ERR_NO_ROUTERS_AVAILABLE);yield*kn(no(...this.routers.map(n=>n.findProviders(e,t))),n=>Zc(n,this.components.peerStore),n=>wm(n),n=>xm(n))}async provide(e,t={}){if(this.routers.length===0)throw new I("No content routers available",H.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new I(Un.NOT_STARTED_YET,H.DHT_NOT_STARTED);await Promise.all(this.routers.map(async i=>{await i.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new I(Un.NOT_STARTED_YET,H.DHT_NOT_STARTED);return Promise.any(this.routers.map(async n=>n.get(e,t)))}}function T3(r){return r[Symbol.asyncIterator]!=null}function vm(r){if(T3(r))return(async()=>{for await(const e of r)return e})();for(const e of r)return e}const L3=ue("libp2p:peer-routing");class k3{components;routers;constructor(e,t){this.components=e,this.routers=t.routers??[]}async findPeer(e,t){if(this.routers.length===0)throw new I("No peer routers available",H.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw new I("Should not try to find self",H.ERR_FIND_SELF);const n=await kn(no(...this.routers.map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(s){L3.error(s)}}())),i=>Xr(i,Boolean),i=>Zc(i,this.components.peerStore),async i=>vm(i));if(n!=null)return n;throw new I(Un.NOT_FOUND,H.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(this.routers.length===0)throw new I("No peer routers available",H.ERR_NO_ROUTERS_AVAILABLE);yield*kn(no(...this.routers.map(n=>n.getClosestPeers(e,t))),n=>Zc(n,this.components.peerStore),n=>wm(n),n=>xm(n))}}const Ja=ue("libp2p:registrar"),_m=32,Sm=64;class P3{topologies;handlers;components;constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onConnect=this._onConnect.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:connect",this._onConnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new I(`No handler registered for protocol ${e}`,H.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new I(`Handler already registered for protocol ${e}`,H.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const i=ha.bind({ignoreUndefined:!0})({maxInboundStreams:_m,maxOutboundStreams:Sm},n);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new I("invalid topology",H.ERR_INVALID_PARAMETERS);const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then(n=>{for(const i of n.protocols){const s=this.topologies.get(i);if(s!=null)for(const o of s.values())o.onDisconnect?.(t)}}).catch(n=>{n.code!==H.ERR_NOT_FOUND&&Ja.error("could not inform topologies of disconnecting peer %p",t,n)})}_onConnect(e){const t=e.detail;this.components.peerStore.get(t).then(n=>{const i=this.components.connectionManager.getConnections(n.id)[0];if(i==null){Ja("peer %p connected but the connection manager did not have a connection",n);return}for(const s of n.protocols){const o=this.topologies.get(s);if(o!=null)for(const a of o.values())a.onConnect?.(t,i)}}).catch(n=>{n.code!==H.ERR_NOT_FOUND&&Ja.error("could not inform topologies of connecting peer %p",t,n)})}_onPeerUpdate(e){const{peer:t,previous:n}=e.detail,i=(n?.protocols??[]).filter(o=>!t.protocols.includes(o)),s=t.protocols.filter(o=>!(n?.protocols??[]).includes(o));for(const o of i){const a=this.topologies.get(o);if(a!=null)for(const c of a.values())c.onDisconnect?.(t.id)}for(const o of s){const a=this.topologies.get(o);if(a!=null)for(const c of a.values()){const u=this.components.connectionManager.getConnections(t.id)[0];u!=null&&c.onConnect?.(t.id,u)}}}}class N3 extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function B3(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new N3({name:e,metrics:t}):n=new Map,n}const Wr=ue("libp2p:transports");class O3{components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.components=e,this.started=!1,this.transports=new Map,this.listeners=B3({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??ti.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw new I("Transport must have a valid tag",H.ERR_INVALID_KEY);if(this.transports.has(t))throw new I(`There is already a transport with the tag ${t}`,H.ERR_DUPLICATE_TRANSPORT);Wr("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(Wr("closing listeners for %s",t);n.length>0;){const i=n.pop();i!=null&&e.push(i.close())}await Promise.all(e),Wr("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.transportForMultiaddr(e);if(n==null)throw new I(`No transport available for address ${String(e)}`,H.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(i){throw i.code==null&&(i.code=H.ERR_TRANSPORT_DIAL_FAILED),i}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}transportForMultiaddr(e){for(const t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new I("Not started",H.ERR_NODE_NOT_STARTED);if(e==null||e.length===0){Wr("no addresses were provided for listening, this node is dial only");return}const t=[];for(const[n,i]of this.transports.entries()){const s=i.filter(e),o=[];for(const u of s){Wr("creating listener for %s on %a",n,u);const l=i.createListener({upgrader:this.components.upgrader});let h=this.listeners.get(n)??[];h==null&&(h=[],this.listeners.set(n,h)),h.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const p=h.findIndex(g=>g===l);h.splice(p,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),o.push(l.listen(u))}if(o.length===0){t.push(n);continue}if((await Promise.allSettled(o)).find(u=>u.status==="fulfilled")==null&&this.faultTolerance!==ti.NO_FATAL)throw new I(`Transport (${n}) could not listen on any available address`,H.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const n=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===ti.FATAL_ALL)throw new I(n,H.ERR_NO_VALID_ADDRESSES);Wr(`libp2p in dial mode only: ${n}`)}}async remove(e){const t=this.listeners.get(e)??[];Wr.trace("removing transport %s",e);const n=[];for(Wr.trace("closing listeners for %s",e);t.length>0;){const i=t.pop();i!=null&&n.push(i.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const oi="/multistream/1.0.0",M3=1024;function U3(r){const e=async function*(){let t=yield,n=new ve;for await(const i of r){if(t==null){n.append(i),t=yield n,n=new ve;continue}for(n.append(i);n.length>=t;){const s=n.sublist(0,t);if(n.consume(t),t=yield s,t==null){n.length>0&&(t=yield n,n=new ve);break}}}if(t!=null)throw Object.assign(new Error(`stream ended before ${t} bytes became available`),{code:"ERR_UNDER_READ",buffer:n})}();return e.next(),e}function Am(r){const e=ln(),t=U3(r.source),n=At();let i;const s=r.sink(async function*(){yield*e,yield*await n.promise}());return s.catch(a=>{i=a}),{reader:t,writer:e,stream:{sink:async a=>{if(i!=null){await Promise.reject(i);return}n.resolve(a),await s},source:t},rest:()=>e.end(),write:e.push,read:async()=>{const a=await t.next();if(a.value!=null)return a.value}}}const $3=ue("libp2p:mss"),Rm=re(`
`);function Gu(r){const e=new ve(r,Rm);return is.single(e)}function Gi(r,e,t={}){const n=Gu(e);t.writeBytes===!0?r.push(n.subarray()):r.push(n)}function F3(r,e,t={}){const n=new ve;for(const i of e)n.append(Gu(i));t.writeBytes===!0?r.push(n.subarray()):r.push(n)}async function K3(r,e){let t=1;const n={[Symbol.asyncIterator]:()=>n,next:async()=>r.next(t)};let i=n;e?.signal!=null&&(i=Pn(n,e.signal));const s=a=>{t=a},o=await kn(i,a=>li(a,{onLength:s,maxDataLength:M3}),async a=>vm(a));if(o==null||o.length===0)throw new I("no buffer returned","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==Rm[0])throw $3.error("Invalid mss message - missing newline - %s",o.subarray()),new I("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}async function js(r,e){const t=await K3(r,e);return ie(t.subarray())}const $i=ue("libp2p:mss:select");async function ec(r,e,t={}){e=Array.isArray(e)?[...e]:[e];const{reader:n,writer:i,rest:s,stream:o}=Am(r),a=e.shift();if(a==null)throw new Error("At least one protocol must be specified");$i.trace('select: write ["%s", "%s"]',oi,a);const c=re(oi),u=re(a);F3(i,[c,u],t);let l=await js(n,t);if($i.trace('select: read "%s"',l),l===oi&&(l=await js(n,t),$i.trace('select: read "%s"',l)),l===a)return s(),{stream:o,protocol:a};for(const h of e){$i.trace('select: write "%s"',h),Gi(i,re(h),t);const p=await js(n,t);if($i.trace('select: read "%s" for "%s"',p,h),p===h)return s(),{stream:o,protocol:h}}throw s(),new I("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}const Fi=ue("libp2p:mss:handle");async function tc(r,e,t){e=Array.isArray(e)?e:[e];const{writer:n,reader:i,rest:s,stream:o}=Am(r);for(;;){const a=await js(i,t);if(Fi.trace('read "%s"',a),a===oi){Fi.trace('respond with "%s" for "%s"',oi,a),Gi(n,re(oi),t);continue}if(e.includes(a))return Gi(n,re(a),t),Fi.trace('respond with "%s" for "%s"',a,a),s(),{stream:o,protocol:a};if(a==="ls"){Gi(n,new ve(...e.map(c=>Gu(re(c)))),t),Fi.trace('respond with "%s" for %s',e,a);continue}Gi(n,re("na"),t),Fi('respond with "na" for "%s"',a)}}const V3=Symbol.for("@libp2p/connection"),vn=ue("libp2p:connection"),z3=500;class q3{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;transient;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:n,newStream:i,close:s,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this._newStream=i,this._close=s,this._abort=o,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[V3]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new I("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if(this.status==="closed")throw new I("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&t?.runOnTransientConnection!==!0)throw new I("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){vn("closing connection to %a",this.remoteAddr),this.status="closing",e.signal=e?.signal??AbortSignal.timeout(z3);try{wr.setMaxListeners?.(1/0,e.signal)}catch{}try{vn.trace("closing all streams"),await Promise.all(this.streams.map(async t=>t.close(e))),vn.trace("closing underlying transport"),await this._close(e),vn.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){vn.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){vn.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach(t=>{t.abort(e)}),vn.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}}function H3(r){return new q3(r)}const Ae=ue("libp2p:upgrader");function W3(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.code!==H.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return _m}function G3(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.code!==H.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return t.maxOutboundStreams??Sm}function Hf(r,e,t){let n=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===r&&n++}),n}class Y3{components;connectionEncryption;muxers;inboundUpgradeTimeout;events;constructor(e,t){this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(n=>{this.connectionEncryption.set(n.protocol,n)}),this.muxers=new Map,t.muxers.forEach(n=>{this.muxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??d3,this.events=e.events}async shouldBlockConnection(e,t,n){const i=this.components.connectionGater[n];if(i!==void 0&&await i(e,t))throw new I(`The multiaddr connection is blocked by gater.${n}`,H.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new I("connection denied",H.ERR_CONNECTION_DENIED);let i,s,o,a,c;const u=AbortSignal.timeout(this.inboundUpgradeTimeout),l=()=>{e.abort(new I("inbound upgrade timeout",H.ERR_TIMEOUT))};u.addEventListener("abort",l,{once:!0});try{wr.setMaxListeners?.(1/0,u)}catch{}try{if(await this.components.connectionGater.denyInboundConnection?.(e)===!0)throw new I("The multiaddr connection is blocked by gater.acceptConnection",H.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),Ae("starting the inbound connection upgrade");let h=e;if(t?.skipProtection!==!0){const p=this.components.connectionProtector;p!=null&&(Ae("protecting the inbound connection"),h=await p.protect(e))}try{if(i=h,t?.skipEncryption!==!0){({conn:i,remotePeer:s,protocol:c}=await this._encryptInbound(h));const p={...h,...i};await this.shouldBlockConnection(s,p,"denyInboundEncryptedConnection")}else{const p=e.remoteAddr.getPeerId();if(p==null)throw new I("inbound connection that skipped encryption must have a peer id",H.ERR_INVALID_MULTIADDR);const g=je(p);c="native",s=g}if(o=i,t?.muxerFactory!=null)a=t.muxerFactory;else if(this.muxers.size>0){const p=await this._multiplexInbound({...h,...i},this.muxers);a=p.muxerFactory,o=p.stream}}catch(p){throw Ae.error("Failed to upgrade inbound connection",p),p}return await this.shouldBlockConnection(s,e,"denyInboundUpgradedConnection"),Ae("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:s,transient:t?.transient})}finally{u.removeEventListener("abort",l),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){const n=e.remoteAddr.getPeerId();let i;n!=null&&(i=je(n),await this.shouldBlockConnection(i,e,"denyOutboundConnection"));let s,o,a,c,u;this.components.metrics?.trackMultiaddrConnection(e),Ae("Starting the outbound connection upgrade");let l=e;if(t?.skipProtection!==!0){const h=this.components.connectionProtector;h!=null&&(l=await h.protect(e))}try{if(s=l,t?.skipEncryption!==!0){({conn:s,remotePeer:o,protocol:c}=await this._encryptOutbound(l,i));const h={...l,...s};await this.shouldBlockConnection(o,h,"denyOutboundEncryptedConnection")}else{if(i==null)throw new I("Encryption was skipped but no peer id was passed",H.ERR_INVALID_PEER);c="native",o=i}if(a=s,t?.muxerFactory!=null)u=t.muxerFactory;else if(this.muxers.size>0){const h=await this._multiplexOutbound({...l,...s},this.muxers);u=h.muxerFactory,a=h.stream}}catch(h){throw Ae.error("Failed to upgrade outbound connection",h),await e.close(h),h}return await this.shouldBlockConnection(o,e,"denyOutboundUpgradedConnection"),Ae("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:u,remotePeer:o,transient:t?.transient})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:i,upgradedConn:s,remotePeer:o,muxerFactory:a,transient:c}=e;let u,l,h;a!=null&&(u=a.createStreamMuxer({direction:n,onIncomingStream:f=>{h!=null&&Promise.resolve().then(async()=>{const d=this.components.registrar.getProtocols(),{stream:m,protocol:y}=await tc(f,d);if(Ae("%s: incoming stream opened on %s",n,y),h==null)return;const E=W3(y,this.components.registrar);if(Hf(y,"inbound",h)===E){const x=new I(`Too many inbound protocol streams for protocol "${y}" - limit ${E}`,H.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw f.abort(x),x}f.source=m.source,f.sink=m.sink,f.protocol=y,await this.components.peerStore.merge(o,{protocols:[y]}),this.components.metrics?.trackProtocolStream(f,h),this._onStream({connection:h,stream:f,protocol:y})}).catch(async d=>{Ae.error(d),f.timeline.close==null&&await f.close()})}}),l=async(f,d={})=>{if(u==null)throw new I("Stream is not multiplexed",H.ERR_MUXER_UNAVAILABLE);Ae("%s: starting new stream on %s",n,f);const m=await u.newStream();try{if(d.signal==null){Ae("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",f),d.signal=AbortSignal.timeout(3e4);try{wr.setMaxListeners?.(1/0,d.signal)}catch{}}const{stream:y,protocol:E}=await ec(m,f,d),b=G3(E,this.components.registrar,d);if(Hf(E,"outbound",h)>=b){const w=new I(`Too many outbound protocol streams for protocol "${E}" - limit ${b}`,H.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw m.abort(w),w}return await this.components.peerStore.merge(o,{protocols:[E]}),m.source=y.source,m.sink=y.sink,m.protocol=E,this.components.metrics?.trackProtocolStream(m,h),m}catch(y){throw Ae.error("could not create new stream for protocols %s on connection with address %a",f,h.remoteAddr,y),m.timeline.close==null&&m.abort(y),y.code!=null?y:new I(String(y),H.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([u.sink(s.source),s.sink(u.source)]).catch(f=>{Ae.error(f)}));const p=i.timeline;i.timeline=new Proxy(p,{set:(...f)=>(h!=null&&f[1]==="close"&&f[2]!=null&&p.close==null&&(async()=>{try{h.status==="open"&&await h.close()}catch(d){Ae.error(d)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(d=>{Ae.error(d)}),Reflect.set(...f))}),i.timeline.upgraded=Date.now();const g=()=>{throw new I("connection is not multiplexed",H.ERR_CONNECTION_NOT_MULTIPLEXED)};return h=H3({remoteAddr:i.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:i.timeline,multiplexer:u?.protocol,encryption:t,transient:c,newStream:l??g,getStreams:()=>u!=null?u.streams:[],close:async f=>{u!=null&&(Ae.trace("close muxer"),await u.close(f)),Ae.trace("close maconn"),await i.close(f),Ae.trace("closed maconn")},abort:f=>{i.abort(f),u?.abort(f)}}),this.events.safeDispatchEvent("connection:open",{detail:h}),h}_onStream(e){const{connection:t,stream:n,protocol:i}=e,{handler:s,options:o}=this.components.registrar.getHandler(i);if(t.transient&&o.runOnTransientConnection!==!0)throw new I("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");s({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());Ae("handling inbound crypto protocol selection",t);try{const{stream:n,protocol:i}=await tc(e,t,{writeBytes:!0}),s=this.connectionEncryption.get(i);if(s==null)throw new Error(`no crypto module found for ${i}`);return Ae("encrypting inbound connection..."),{...await s.secureInbound(this.components.peerId,n),protocol:i}}catch(n){throw new I(String(n),H.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());Ae("selecting outbound crypto protocol",n);try{const{stream:i,protocol:s}=await ec(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(s);if(o==null)throw new Error(`no crypto module found for ${s}`);return Ae("encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,i,t),protocol:s}}catch(i){throw new I(String(i),H.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());Ae("outbound selecting muxer %s",n);try{const{stream:i,protocol:s}=await ec(e,n,{writeBytes:!0});Ae("%s selected as muxer protocol",s);const o=t.get(s);return{stream:i,muxerFactory:o}}catch(i){throw Ae.error("error multiplexing outbound stream",i),new I(String(i),H.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());Ae("inbound handling muxers %s",n);try{const{stream:i,protocol:s}=await tc(e,n,{writeBytes:!0}),o=t.get(s);return{stream:i,muxerFactory:o}}catch(i){throw Ae.error("error multiplexing inbound stream",i),new I(String(i),H.ERR_MUXER_UNAVAILABLE)}}}const vt=ue("libp2p");class Q3 extends hi{peerId;peerStore;contentRouting;peerRouting;keychain;metrics;services;components;#e;constructor(e){super();const t=new hi,n=t.dispatchEvent.bind(t);t.dispatchEvent=c=>{const u=n(c),l=this.dispatchEvent(new zd(c.type,{detail:c.detail}));return u||l};try{wr.setMaxListeners?.(1/0,t)}catch{}this.#e=!1,this.peerId=e.peerId,this.services={};const i=this.components=LC({peerId:e.peerId,events:t,datastore:e.datastore??new vC,connectionGater:VC(e.connectionGater)});this.peerStore=this.configureComponent("peerStore",new mC(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),i.events.addEventListener("peer:update",c=>{if(c.detail.previous==null){const u={id:c.detail.peer.id,multiaddrs:c.detail.peer.addresses.map(l=>l.multiaddr),protocols:c.detail.peer.protocols};i.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(i)),this.components.upgrader=new Y3(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((c,u)=>this.configureComponent(`connection-encryption-${u}`,c(this.components))),muxers:(e.streamMuxers??[]).map((c,u)=>this.configureComponent(`stream-muxers-${u}`,c(this.components))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.configureComponent("transportManager",new O3(this.components,e.transportManager)),this.configureComponent("connectionManager",new R3(this.components,e.connectionManager)),this.configureComponent("registrar",new P3(this.components)),this.configureComponent("addressManager",new RC(this.components,e.addresses));const s=Eo.generateOptions();this.keychain=this.configureComponent("keyChain",new Eo(this.components,{...s,...e.keychain}));const o=(e.peerRouters??[]).map((c,u)=>this.configureComponent(`peer-router-${u}`,c(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new k3(this.components,{routers:o}));const a=(e.contentRouters??[]).map((c,u)=>this.configureComponent(`content-router-${u}`,c(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new D3(this.components,{routers:a})),(e.peerDiscovery??[]).forEach((c,u)=>{this.configureComponent(`peer-discovery-${u}`,c(this.components)).addEventListener("peer",h=>{this.#t(h)})}),e.transports.forEach((c,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,c(this.components)))}),e.services!=null)for(const c of Object.keys(e.services)){const u=e.services[c],l=u(this.components);if(l==null){vt.error("service factory %s returned null or undefined instance",c);continue}this.services[c]=l,this.configureComponent(c,l),l[rf]!=null&&(vt("registering service %s for content routing",c),a.push(l[rf])),l[sf]!=null&&(vt("registering service %s for peer routing",c),o.push(l[sf])),l[nf]!=null&&(vt("registering service %s for peer discovery",c),l[nf].addEventListener("peer",h=>{this.#t(h)}))}}configureComponent(e,t){return t==null&&vt.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.#e)return;this.#e=!0,vt("libp2p is starting"),(await this.keychain.listKeys()).find(t=>t.name==="self")==null&&(vt("importing self key into keychain"),await this.keychain.importPeer("self",this.components.peerId));try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.safeDispatchEvent("start",{detail:this}),vt("libp2p has started")}catch(t){throw vt.error("An error occurred starting libp2p",t),await this.stop(),t}}async stop(){this.#e&&(vt("libp2p is stopping"),this.#e=!1,await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.safeDispatchEvent("stop",{detail:this}),vt("libp2p has stopped"))}isStarted(){return this.#e}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new ii;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t,n={}){if(t==null)throw new I("no protocols were provided to open a stream",H.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(t=Array.isArray(t)?t:[t],t.length===0)throw new I("no protocols were provided to open a stream",H.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Oo(e)&&(e=je(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(vt("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;const n=await this.peerStore.get(e);if(n.id.publicKey!=null)return n.id.publicKey;const i=et([re("/pk/"),e.multihash.digest]),s=await this.contentRouting.get(i,t);return Uu(s),await this.peerStore.patch(e,{publicKey:s}),s}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}#t(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){vt.error(new Error(H.ERR_DISCOVERED_SELF));return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs,protocols:t.protocols}).catch(n=>{vt.error(n)})}}async function X3(r){if(r.peerId==null){const e=r.datastore;if(e!=null)try{const t=new Eo({datastore:e},ha(Eo.generateOptions(),r.keychain));r.peerId=await t.exportPeerId("self")}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}}return r.peerId==null&&(r.peerId=await YI()),new Q3(rD(r))}async function Z3(r){const e=await X3(r);return r.start!==!1&&await e.start(),e}const j3=290,J3="/libp2p/relay",eT=1,tT="circuit-relay-relay";BigInt(1<<17);const Do="/libp2p/circuit/relay/0.2.0/hop",Wf="/libp2p/circuit/relay/0.2.0/stop";var wi;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),function(n){n.codec=()=>Si(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ue((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),xi.codec().encode(n.peer,i)),n.reservation!=null&&(i.uint32(26),To.codec().encode(n.reservation,i)),n.limit!=null&&(i.uint32(34),vi.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(40),xt.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i)=>{const s={},o=i==null?n.len:n.pos+i;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:s.type=r.Type.codec().decode(n);break;case 2:s.peer=xi.codec().decode(n,n.uint32());break;case 3:s.reservation=To.codec().decode(n,n.uint32());break;case 4:s.limit=vi.codec().decode(n,n.uint32());break;case 5:s.status=xt.codec().decode(n);break;default:n.skipType(a&7);break}}return s})),t),r.encode=n=>Me(n,r.codec()),r.decode=n=>Oe(n,r.codec())})(wi||(wi={}));var Tr;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),function(n){n.codec=()=>Si(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ue((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),xi.codec().encode(n.peer,i)),n.limit!=null&&(i.uint32(26),vi.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(32),xt.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i)=>{const s={},o=i==null?n.len:n.pos+i;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:s.type=r.Type.codec().decode(n);break;case 2:s.peer=xi.codec().decode(n,n.uint32());break;case 3:s.limit=vi.codec().decode(n,n.uint32());break;case 4:s.status=xt.codec().decode(n);break;default:n.skipType(a&7);break}}return s})),t),r.encode=n=>Me(n,r.codec()),r.decode=n=>Oe(n,r.codec())})(Tr||(Tr={}));var xi;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={id:new Uint8Array(0),addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.id=t.bytes();break;case 2:i.addrs.push(t.bytes());break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(xi||(xi={}));var To;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);t.voucher!=null&&(n.uint32(26),n.bytes(t.voucher)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={expire:0n,addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.expire=t.uint64();break;case 2:i.addrs.push(t.bytes());break;case 3:i.voucher=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(To||(To={}));var vi;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.duration=t.uint32();break;case 2:i.data=t.uint64();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(vi||(vi={}));var xt;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(xt||(xt={}));var jc;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(jc||(jc={}));(function(r){r.codec=()=>Si(jc)})(xt||(xt={}));var Gf;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={relay:new Uint8Array(0),peer:new Uint8Array(0),expiration:0n},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.relay=t.bytes();break;case 2:i.peer=t.bytes();break;case 3:i.expiration=t.uint64();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(Gf||(Gf={}));ue("libp2p:circuit-relay:utils");async function rT(r){const e=new TextEncoder().encode(r),t=await Zt.digest(e);return $e.createV0(t)}function Yf(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var nT={};function Xt(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var iT=Xt;Xt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Xt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Xt.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Xt.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Xt.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Xt.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Xt.prototype.start=Xt.prototype.try;Xt.prototype.errors=function(){return this._errors};Xt.prototype.attempts=function(){return this._attempts};Xt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],s=i.message,o=(r[s]||0)+1;r[s]=o,o>=t&&(e=i,t=o)}return e};(function(r){var e=iT;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)n[i]=t[i];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],o=0;o<n.retries;o++)s.push(this.createTimeout(o,n));return t&&t.forever&&!s.length&&s.push(this.createTimeout(o,n)),s.sort(function(a,c){return a-c}),s},r.createTimeout=function(t,n){var i=n.randomize?Math.random()+1:1,s=Math.round(i*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return s=Math.min(s,n.maxTimeout),s},r.wrap=function(t,n,i){if(n instanceof Array&&(i=n,n=null),!i){i=[];for(var s in t)typeof t[s]=="function"&&i.push(s)}for(var o=0;o<i.length;o++){var a=i[o],c=t[a];t[a]=function(l){var h=r.operation(n),p=Array.prototype.slice.call(arguments,1),g=p.pop();p.push(function(f){h.retry(f)||(f&&(arguments[0]=h.mainError()),g.apply(this,arguments))}),h.attempt(function(){l.apply(t,p)})}.bind(t,c),t[a].options=n}}})(nT);ue("libp2p:circuit-relay:advert-service");ue("libp2p:circuit-relay:server");const sT=ue("libp2p:stream:converter");function Qf(r){const{stream:e,remoteAddr:t}=r,{sink:n,source:i}=e,s=async function*(){for await(const c of i)c instanceof Uint8Array?yield c:yield*c}(),o={async sink(c){try{await n(c),a()}catch(u){u.type!=="aborted"&&sT(u)}},source:s,remoteAddr:t,timeline:{open:Date.now(),close:void 0},async close(c){a(),await e.close(c)},abort(c){a(),e.abort(c)}};function a(){o.timeline.close==null&&(o.timeline.close=Date.now())}return o}const Gr=ue("libp2p:circuit-relay:discover-relays");class oT extends hi{peerId;peerStore;contentRouting;registrar;started;topologyId;constructor(e){super(),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.contentRouting=e.contentRouting,this.registrar=e.registrar}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(Do,{onConnect:e=>{this.safeDispatchEvent("relay:discover",{detail:e})}}),this.discover().catch(e=>{Gr.error("error listening on relays",e)}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async discover(){Gr("searching peer store for relays");const e=await this.peerStore.all({filters:[t=>t.protocols.includes(Do)],orders:[()=>Math.random()<.5?1:-1]});for(const t of e)Gr("found relay peer %p in content peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});Gr("found %d relay peers in peer store",e.length);try{Gr("searching content routing for relays");const t=await rT(J3);let n=0;for await(const i of this.contentRouting.findProviders(t))if(i.multiaddrs.length>0&&!i.id.equals(this.peerId)){const s=i.id;n++,await this.peerStore.merge(s,{multiaddrs:i.multiaddrs}),Gr("found relay peer %p in content routing",s),this.safeDispatchEvent("relay:discover",{detail:s})}Gr("found %d relay peers in content routing",n)}catch(t){Gr.error("failed when finding relays on the network",t)}}}const Fs=ue("libp2p:circuit-relay:transport:listener");class aT extends hi{connectionManager;relayStore;listeningAddrs;constructor(e){super(),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Di,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}_onRemoveRelayPeer=e=>{this.#e(e.detail)};async listen(e){Fs("listen on %a",e);const t=e.getPeerId();let n;if(t!=null){const s=je(t),o=this.connectionManager.getConnectionsMap().get(s)??[];o.length>0&&(n=o[0])}if(n==null){const s=e.toString().split("/p2p-circuit").find(a=>a!==""),o=ge(s);n=await this.connectionManager.openConnection(o)}if(!this.relayStore.hasReservation(n.remotePeer)){await this.relayStore.addRelay(n.remotePeer,"configured");return}const i=this.relayStore.getReservation(n.remotePeer);if(i==null)throw new I("Did not have reservation after making reservation","ERR_NO_RESERVATION");if(this.listeningAddrs.has(n.remotePeer)){Fs("already listening on relay %p",n.remotePeer);return}this.listeningAddrs.set(n.remotePeer,i.addrs.map(s=>ge(s).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{})}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}#e(e){const t=this.listeningAddrs.has(e);Fs("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(Fs.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}}function cT(r){return new aT(r)}const bt=ue("libp2p:circuit-relay:transport:reservation-store"),uT=60*1e3*10,lT=60*1e3*5,hT=30*1e3;class fT extends hi{peerId;connectionManager;transportManager;peerStore;events;reserveQueue;reservations;maxDiscoveredRelays;maxReservationQueueLength;reservationCompletionTimeout;started;constructor(e,t){super(),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Di,this.maxDiscoveredRelays=t?.discoverRelays??0,this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??1e4,this.started=!1,this.reserveQueue=new cm({concurrency:t?.reservationConcurrency??eT}),this.events.addEventListener("peer:disconnect",n=>{this.#t(n.detail)})}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}async addRelay(e,t){if(this.peerId.equals(e)){bt("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){bt("not adding relay as the queue is full");return}if(this.reserveQueue.hasJob(e)){bt("relay peer is already in the reservation queue");return}bt("add relay %p",e),await this.reserveQueue.add(async()=>{try{const n=this.reservations.get(e);if(n!=null){if(Yf(n.reservation.expire)>uT){bt("already have reservation on relay peer %p and it expires in more than 10 minutes",e);return}clearTimeout(n.timeout),this.reservations.delete(e)}if(t==="discovered"&&[...this.reservations.values()].reduce((l,h)=>(h.type==="discovered"&&l++,l),0)>=this.maxDiscoveredRelays){bt("already have enough discovered relays");return}const i=AbortSignal.timeout(this.reservationCompletionTimeout),s=await this.connectionManager.openConnection(e,{signal:i});if(s.remoteAddr.protoNames().includes("p2p-circuit")){bt("not creating reservation over relayed connection");return}const o=await this.#e(s,{signal:i});bt("created reservation on relay peer %p",e);const a=Yf(o.expire),c=Math.min(Math.max(a-lT,hT),Math.pow(2,31)-1),u=setTimeout(()=>{this.addRelay(e,t).catch(l=>{bt.error("could not refresh reservation to relay %p",e,l)})},c);this.reservations.set(e,{timeout:u,reservation:o,type:t}),await this.peerStore.merge(e,{tags:{[tT]:{value:1,ttl:a}}}),await this.transportManager.listen([ge(`/p2p/${e.toString()}/p2p-circuit`)])}catch(n){bt.error("could not reserve slot on %p",e,n);const i=this.reservations.get(e);i!=null&&clearTimeout(i.timeout),this.reservations.delete(e)}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}async#e(e,t){t.signal?.throwIfAborted(),bt("requesting reservation from %p",e.remotePeer);const n=await e.newStream(Do,t),s=kr(n).pb(wi);await s.write({type:wi.Type.RESERVE},t);let o;try{o=await s.read(t)}catch(c){throw bt.error("error parsing reserve message response from %p because",e.remotePeer,c),c}finally{await n.close()}if(o.status===xt.OK&&o.reservation!=null)return o.reservation;const a=`reservation failed with status ${o.status??"undefined"}`;throw bt.error(a),new Error(a)}#t(e){const t=this.reservations.get(e);t!=null&&(bt("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(bt("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}}const ft=ue("libp2p:circuit-relay:transport"),dT=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(ge)}catch{return!1}return!0},rc={maxInboundStopStreams:Co,maxOutboundStopStreams:Co,stopTimeout:3e4};class pT{discovery;registrar;peerStore;connectionManager;peerId;upgrader;addressManager;connectionGater;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;stopTimeout;started;constructor(e,t){this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??rc.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??rc.maxOutboundStopStreams,this.stopTimeout=t.stopTimeout??rc.stopTimeout,t.discoverRelays!=null&&t.discoverRelays>0&&(this.discovery=new oT(e),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(i=>{ft.error("could not add discovered relay %p",n.detail,i)})})),this.reservationStore=new fT(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.discover().catch(n=>{ft.error("could not discover relays",n)})}),this.started=!1}isStarted(){return this.started}async start(){await this.reservationStore.start(),await this.discovery?.start(),await this.registrar.handle(Wf,e=>{this.onStop(e).catch(t=>{ft.error("error while handling STOP protocol",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),this.started=!0}async stop(){this.discovery?.stop(),await this.reservationStore.stop(),await this.registrar.unhandle(Wf),this.started=!1}[bd]=!0;[Symbol.toStringTag]="libp2p/circuit-relay-v2";async dial(e,t={}){if(e.protoCodes().filter(f=>f===j3).length!==1){const f="Invalid circuit relay address";throw ft.error(f,e),new I(f,H.ERR_RELAYED_DIAL)}const n=e.toString().split("/p2p-circuit"),i=ge(n[0]),s=ge(n[n.length-1]),o=i.getPeerId(),a=s.getPeerId();if(o==null||a==null){const f=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw ft.error(f),new I(f,H.ERR_RELAYED_DIAL)}const c=je(o),u=je(a);let l=!1,p=this.connectionManager.getConnections(c)[0];p==null&&(await this.peerStore.merge(c,{multiaddrs:[i]}),p=await this.connectionManager.openConnection(c,t),l=!0);let g;try{return g=await p.newStream([Do]),await this.connectV2({stream:g,connection:p,destinationPeer:u,destinationAddr:s,relayAddr:i,ma:e,disconnectOnFailure:l})}catch(f){throw ft.error("circuit relay dial to destination %p via relay %p failed",u,c,f),g?.abort(f),l&&await p.close(),f}}async connectV2({stream:e,connection:t,destinationPeer:n,destinationAddr:i,relayAddr:s,ma:o,disconnectOnFailure:a}){try{const c=kr(e),u=c.pb(wi);await u.write({type:wi.Type.CONNECT,peer:{id:n.toBytes(),addrs:[ge(i).bytes]}});const l=await u.read();if(l.status!==xt.OK)throw new I(`failed to connect via relay with status ${l?.status?.toString()??"undefined"}`,H.ERR_HOP_REQUEST_FAILED);const h=Qf({stream:c.unwrap(),remoteAddr:o,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`)});return ft("new outbound transient connection %a",h.remoteAddr),await this.upgrader.upgradeOutbound(h,{transient:!0})}catch(c){throw ft.error(`Circuit relay dial to destination ${n.toString()} via relay ${t.remotePeer.toString()} failed`,c),a&&await t.close(),c}}createListener(e){return cT({connectionManager:this.connectionManager,relayStore:this.reservationStore})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Qd.matches(t))}async onStop({connection:e,stream:t}){const n=AbortSignal.timeout(this.stopTimeout),i=kr(t).pb(Tr),s=await i.read({signal:n});if(ft("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),s?.type===void 0){ft.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:Tr.Type.STATUS,status:xt.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(s.type!==Tr.Type.CONNECT){ft.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:Tr.Type.STATUS,status:xt.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!dT(s)){ft.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:Tr.Type.STATUS,status:xt.MALFORMED_MESSAGE},{signal:n}),await t.close();return}const o=Uo(s.peer.id);if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){ft.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:Tr.Type.STATUS,status:xt.PERMISSION_DENIED},{signal:n}),await t.close();return}ft.trace("sending success response to %p",e.remotePeer),await i.write({type:Tr.Type.STATUS,status:xt.OK},{signal:n});const a=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),c=this.addressManager.getAddresses()[0],u=Qf({stream:i.unwrap().unwrap(),remoteAddr:a,localAddr:c});ft("new inbound transient connection %a",u.remoteAddr),await this.upgrader.upgradeInbound(u,{transient:!0}),ft("%s connection %a upgraded","inbound",u.remoteAddr)}}function mT(r={}){return e=>new pT(e,r)}const yT="0.46.16",Im=`js-libp2p/${yT}`,gT="0.1.0",bT="id",ET="id/push",wT="1.0.0",xT="1.0.0";var ei;(function(r){let e;r.codec=()=>(e==null&&(e=Ue((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const s of t.listenAddrs)n.uint32(18),n.bytes(s);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const s of t.protocols)n.uint32(26),n.string(s);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={listenAddrs:[],protocols:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 5:i.protocolVersion=t.string();break;case 6:i.agentVersion=t.string();break;case 1:i.publicKey=t.bytes();break;case 2:i.listenAddrs.push(t.bytes());break;case 4:i.observedAddr=t.bytes();break;case 3:i.protocols.push(t.string());break;case 8:i.signedPeerRecord=t.bytes();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>Me(t,r.codec()),r.decode=t=>Oe(t,r.codec())})(ei||(ei={}));const dt=ue("libp2p:identify"),nc=1024*8,Lt={protocolPrefix:"ipfs",agentVersion:Im,timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1,maxObservedAddresses:10,maxIdentifyMessageSize:8192,runOnConnectionOpen:!0,runOnTransientConnection:!0};class vT{identifyProtocolStr;identifyPushProtocolStr;host;started;timeout;peerId;peerStore;registrar;connectionManager;addressManager;maxInboundStreams;maxOutboundStreams;maxPushIncomingStreams;maxPushOutgoingStreams;maxIdentifyMessageSize;maxObservedAddresses;events;runOnTransientConnection;constructor(e,t){this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.events=e.events,this.identifyProtocolStr=`/${t.protocolPrefix??Lt.protocolPrefix}/${bT}/${wT}`,this.identifyPushProtocolStr=`/${t.protocolPrefix??Lt.protocolPrefix}/${ET}/${xT}`,this.timeout=t.timeout??Lt.timeout,this.maxInboundStreams=t.maxInboundStreams??Lt.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Lt.maxOutboundStreams,this.maxPushIncomingStreams=t.maxPushIncomingStreams??Lt.maxPushIncomingStreams,this.maxPushOutgoingStreams=t.maxPushOutgoingStreams??Lt.maxPushOutgoingStreams,this.maxIdentifyMessageSize=t.maxIdentifyMessageSize??Lt.maxIdentifyMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Lt.maxObservedAddresses,this.runOnTransientConnection=t.runOnTransientConnection??Lt.runOnTransientConnection,this.host={protocolVersion:`${t.protocolPrefix??Lt.protocolPrefix}/${gT}`,agentVersion:t.agentVersion??Lt.agentVersion},(t.runOnConnectionOpen??Lt.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const i=n.detail;this.identify(i).catch(s=>{dt.error("error during identify trigged by connection:open",s)})}),e.events.addEventListener("self:peer:update",n=>{this.push().catch(i=>{dt.error(i)})}),this.host.agentVersion===Im&&(FS||US?this.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(dp||pp||$S||KS)&&(this.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`))}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:re(this.host.agentVersion),ProtocolVersion:re(this.host.protocolVersion)}}),await this.registrar.handle(this.identifyProtocolStr,e=>{this._handleIdentify(e).catch(t=>{dt.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),await this.registrar.handle(this.identifyPushProtocolStr,e=>{this._handlePush(e).catch(t=>{dt.error(t)})},{maxInboundStreams:this.maxPushIncomingStreams,maxOutboundStreams:this.maxPushOutgoingStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.identifyProtocolStr),await this.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async pushToConnections(e){const t=this.addressManager.getAddresses().map(l=>l.decapsulateCode(he("p2p").code)),n=new Bt({peerId:this.peerId,multiaddrs:t}),i=await gr.seal(n,this.peerId),s=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=ie(o.metadata.get("AgentVersion")??re(this.host.agentVersion)),c=ie(o.metadata.get("ProtocolVersion")??re(this.host.protocolVersion)),u=e.map(async l=>{let h;const p=AbortSignal.timeout(this.timeout);try{wr.setMaxListeners?.(1/0,p)}catch{}try{h=await l.newStream([this.identifyPushProtocolStr],{signal:p,runOnTransientConnection:this.runOnTransientConnection}),await kr(h,{maxDataLength:this.maxIdentifyMessageSize??nc}).pb(ei).write({listenAddrs:t.map(f=>f.bytes),signedPeerRecord:i.marshal(),protocols:s,agentVersion:a,protocolVersion:c},{signal:p}),await h.close({signal:p})}catch(g){dt.error("could not push identify update to peer",g),h?.abort(g)}});await Promise.all(u)}async push(){if(!this.isStarted())return;const e=[];await Promise.all(this.connectionManager.getConnections().map(async t=>{try{if(!(await this.peerStore.get(t.remotePeer)).protocols.includes(this.identifyPushProtocolStr))return;e.push(t)}catch(n){if(n.code!==H.ERR_NOT_FOUND)throw n}})),await this.pushToConnections(e)}async _identify(e,t={}){let n;t.signal=t.signal??AbortSignal.timeout(this.timeout);try{n=await e.newStream([this.identifyProtocolStr],{...t,runOnTransientConnection:this.runOnTransientConnection});const s=await kr(n,{maxDataLength:this.maxIdentifyMessageSize??nc}).pb(ei).read(t);return await n.close(t),s}catch(i){throw dt.error("error while reading identify message",i),n?.abort(i),i}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:i,protocols:s,observedAddr:o}=n;if(i==null)throw new I("public key was missing from identify message",H.ERR_MISSING_PUBLIC_KEY);const a=await _i(i);if(!e.remotePeer.equals(a))throw new I("identified peer does not match the expected peer",H.ERR_INVALID_PEER);if(this.peerId.equals(a))throw new I("identified peer is our own peer id?",H.ERR_INVALID_PEER);const c=_T(o);dt("identify completed for peer %p and protocols %o",a,s),dt("our observed address is %a",c),c!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(dt("storing our observed address %a",c),this.addressManager.addObservedAddr(c));const u=await this.#e(e.remotePeer,n),l={peerId:a,protocolVersion:n.protocolVersion,agentVersion:n.agentVersion,publicKey:n.publicKey,listenAddrs:n.listenAddrs.map(h=>ge(h)),observedAddr:n.observedAddr==null?void 0:ge(n.observedAddr),protocols:n.protocols,signedPeerRecord:u};return this.events.safeDispatchEvent("peer:identify",{detail:l}),l}async _handleIdentify(e){const{connection:t,stream:n}=e,i=AbortSignal.timeout(this.timeout);try{wr.setMaxListeners?.(1/0,i)}catch{}try{const s=this.peerId.publicKey??new Uint8Array(0),o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(l=>l.decapsulateCode(he("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const l=new Bt({peerId:this.peerId,multiaddrs:a});c=(await gr.seal(l,this.peerId)).marshal().subarray()}await kr(n).pb(ei).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:s,listenAddrs:a.map(l=>l.bytes),signedPeerRecord:c,observedAddr:t.remoteAddr.bytes,protocols:o.protocols},{signal:i}),await n.close({signal:i})}catch(s){dt.error("could not respond to identify request",s),n.abort(s)}}async _handlePush(e){const{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const i={signal:AbortSignal.timeout(this.timeout)},o=await kr(n,{maxDataLength:this.maxIdentifyMessageSize??nc}).pb(ei).read(i);await n.close(i),await this.#e(t.remotePeer,o)}catch(i){dt.error("received invalid message",i),n.abort(i);return}dt("handled push from %p",t.remotePeer)}async#e(e,t){if(dt("received identify from %p",e),t==null)throw new Error("Message was null or undefined");const n={addresses:t.listenAddrs.map(s=>({isCertified:!1,multiaddr:ge(s)})),protocols:t.protocols,metadata:new Map,peerRecordEnvelope:t.signedPeerRecord};let i;if(t.signedPeerRecord!=null){dt("received signedPeerRecord in push from %p",e);let s=t.signedPeerRecord;const o=await gr.openAndCertify(s,Bt.DOMAIN);let a=Bt.createFromProtobuf(o.payload);if(!a.peerId.equals(o.peerId))throw new Error("signing key does not match PeerId in the PeerRecord");if(!e.equals(a.peerId))throw new Error("signing key does not match remote PeerId");let c;try{c=await this.peerStore.get(a.peerId)}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u}if(c!=null&&(n.metadata=c.metadata,c.peerRecordEnvelope!=null)){const u=await gr.createFromProtobuf(c.peerRecordEnvelope),l=Bt.createFromProtobuf(u.payload);l.seqNumber>=a.seqNumber&&(dt("sequence number was lower or equal to existing sequence number - stored: %d received: %d",l.seqNumber,a.seqNumber),a=l,s=c.peerRecordEnvelope)}n.peerRecordEnvelope=s,n.addresses=a.multiaddrs.map(u=>({isCertified:!0,multiaddr:u})),i={seq:a.seqNumber,addresses:a.multiaddrs}}else dt("%p did not send a signed peer record",e);return t.agentVersion!=null&&n.metadata.set("AgentVersion",re(t.agentVersion)),t.protocolVersion!=null&&n.metadata.set("ProtocolVersion",re(t.protocolVersion)),await this.peerStore.patch(e,n),i}}function _T(r){if(r!=null&&r.length>0)try{return ge(r)}catch{}}function ST(r={}){return e=>new vT(e,r)}const Cm=he("webrtc").code,AT=document.getElementById("output"),RT=document.getElementById("send-section"),ts=r=>{const e=document.createElement("div");e.appendChild(document.createTextNode(r)),AT.append(e)},Yu=r=>r.replaceAll(`
`,""),Dm=ln(),un=await Z3({addresses:{listen:["/webrtc"]},transports:[GS({filter:gp}),Y_(),mT({discoverRelays:1})],connectionEncryption:[u_()],streamMuxers:[dI()],connectionGater:{denyDialMultiaddr:()=>!1},services:{identify:ST()}});await un.start();await un.handle("/echo/1.0.0",({stream:r})=>{kn(r,async function*(e){for await(const t of e){const n=ie(t.subarray());ts(`Received message '${Yu(n)}'`),yield t}},r)});function Tm(){const r=un.getConnections().map(e=>{e.remoteAddr.protoCodes().includes(Cm)&&(RT.style.display="block");const t=document.createElement("li");return t.textContent=e.remoteAddr.toString(),t});document.getElementById("connections").replaceChildren(...r)}un.addEventListener("connection:open",r=>{Tm()});un.addEventListener("connection:close",r=>{Tm()});un.addEventListener("self:peer:update",r=>{const e=un.getMultiaddrs().map(t=>{const n=document.createElement("li");return n.textContent=t.toString(),n});document.getElementById("multiaddrs").replaceChildren(...e)});const IT=r=>r.protoCodes().includes(Cm);window.connect.onclick=async()=>{const r=ge(window.peer.value);ts(`Dialing '${r}'`);const e=await un.dial(r);if(IT(r)){const t=await e.newStream(["/echo/1.0.0"]);kn(Dm,t,async n=>{for await(const i of n){const s=ie(i.subarray());ts(`Received message '${Yu(s)}'`)}})}ts(`Connected to '${r}'`)};window.send.onclick=async()=>{const r=`${window.message.value}
`;ts(`Sending message '${Yu(r)}'`),Dm.push(re(r))};
